<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIGECA â€” Sistema de GestiÃ³n de CatÃ¡strofes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600&family=IBM+Plex+Mono:wght@400;500&family=Fraunces:opsz,wght@9..144,300;9..144,700;9..144,900&display=swap"
    rel="stylesheet">

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc,
      onSnapshot, query, orderBy, serverTimestamp, getDoc, getDocs
    }
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // â”€â”€ CONFIGURACIÃ“N IA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let geminiApiKey = '__GEMINI_API_KEY__'; // Clave por defecto proporcionada por el usuario

    // â”€â”€ FIREBASE CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const firebaseConfig = {
      apiKey: "__FIREBASE_API_KEY__",
      authDomain: "emercre.firebaseapp.com",
      projectId: "emercre",
      storageBucket: "emercre.firebasestorage.app",
      messagingSenderId: "277256770434",
      appId: "1:277256770434:web:225aa9c7ff6b862d72b59b"
    };
    const fbApp = initializeApp(firebaseConfig);
    const auth = getAuth(fbApp);
    const db = getFirestore(fbApp);

    // â”€â”€ ESTADO GLOBAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let currentUser = null;
    let currentRole = null;
    let currentUserDoc = null;
    let selOpId = null;
    let filtro = 'all';
    let picking = false;
    let pickedCoords = null;
    let pickedAddress = '';
    let gmap = null;
    let mapReady = false;
    let gmMarkers = {};
    let autocomplete = null;
    let autocompleteEdit = null;
    let pickListener = null;
    let tempGmMarker = null;
    let unsubOps = null;
    let unsubAcciones = null;
    let unsubRecursos = null;
    let ops = {};
    let editingUserId = null;

    // â”€â”€ ESTRUCTURA AUTONÃ“MICA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const PROVINCIAS = ['AlmerÃ­a', 'CÃ¡diz', 'CÃ³rdoba', 'Granada', 'JaÃ©n', 'Huelva', 'MÃ¡laga', 'Sevilla'];
    let selectedProvincia = 'AndalucÃ­a'; // 'AndalucÃ­a' o una provincia concreta
    // Edit op state
    let editPickedCoords = null;
    let editPickedAddress = '';
    let editPickListener = null;
    let editTempGmMarker = null;
    let editPickMode = false;
    // Edit action state
    let currentAcciones = {};
    let editAccionId = null;

    // â”€â”€ NOTIFICACIONES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let lastSeenOps = {}; // Para saber quÃ© ops hemos visto (tracking nuevo op)
    let opsTimestamps = {}; // Para saber Ãºltimo timestamp y compararlo con nuestro "visto"
    let alertSound = new Audio('assets/alert.mp3');

    // â”€â”€ TIPO / NIVEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const TIPOS = {
      inundacion: { label: 'InundaciÃ³n', emoji: 'ğŸŒŠ', color: '#2980b9' },
      incendio: { label: 'Incendio forestal', emoji: 'ğŸ”¥', color: '#c0392b' },
      seismo: { label: 'SeÃ­smo', emoji: 'ğŸŒ', color: '#8e44ad' },
      temporal: { label: 'Temporal', emoji: 'ğŸŒª', color: '#16a085' },
      accidente: { label: 'Accidente', emoji: 'ğŸš›', color: '#d35400' },
      quimico: { label: 'Inc. QuÃ­mico', emoji: 'â˜£ï¸', color: '#c0392b' },
      sanitaria: { label: 'Emerg. Sanitaria', emoji: 'ğŸ¦ ', color: '#e74c3c' },
      logistica: { label: 'Op. LogÃ­stica', emoji: 'ğŸ“¦', color: '#8e44ad' },
      otro: { label: 'Otro', emoji: 'ğŸ“‹', color: '#7f8c8d' }
    };
    const NIVEL_LABELS = { 1: 'Baja', 2: 'Media', 3: 'Alta', 4: 'CrÃ­tica' };
    const NIVEL_COLORS = { 1: '#1a7a4a', 2: '#c08c00', 3: '#d35400', 4: '#c0392b' };
    const ROL_LABELS = {
      super_admin: 'Super Admin',
      manager: 'Administrador',
      admin: 'Responsable',
      usuario: 'Usuario'
    };

    // â”€â”€ GOOGLE MAPS INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.initGoogleMap = function () {
      gmap = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 40.4, lng: -3.7 },
        zoom: 6,
        mapId: 'bc56b7cd6850d53c', // Map ID para Advanced Markers
        mapTypeId: 'roadmap',
        mapTypeControl: true,
        mapTypeControlOptions: {
          style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
          position: google.maps.ControlPosition.TOP_RIGHT,
          mapTypeIds: ['roadmap', 'satellite', 'hybrid', 'terrain']
        },
        streetViewControl: false,
        fullscreenControl: false,
        zoomControlOptions: { position: google.maps.ControlPosition.RIGHT_BOTTOM }
      });

      google.maps.event.addListenerOnce(gmap, 'tilesloaded', function () {
        mapReady = true;
        if (Object.keys(ops).length) renderMapa();
      });

      gmap.addListener('click', () => {
        if (!picking && !editPickMode) window.cerrarDetalle();
      });

      // Force refresh when map container becomes visible
      new ResizeObserver(() => {
        if (gmap && mapReady && document.getElementById('map').offsetWidth > 0) {
          google.maps.event.trigger(gmap, 'resize');
          if (Object.keys(ops).length) renderMapa();
        }
      }).observe(document.getElementById('map'));
    };

    window.ensureAutocomplete = function () {
      if (!autocomplete) {
        const input = document.getElementById('f-lugar');
        autocomplete = new google.maps.places.Autocomplete(input, {
          fields: ['geometry', 'formatted_address', 'name'],
          componentRestrictions: { country: 'es' }
        });
        autocomplete.addListener('place_changed', () => {
          const place = autocomplete.getPlace();
          if (!place.geometry) return;
          pickedCoords = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() };
          pickedAddress = place.formatted_address || place.name || '';
          mostrarCoordBox();
          if (mapReady && gmap) {
            gmap.panTo(place.geometry.location);
            gmap.setZoom(15);
            if (tempGmMarker) tempGmMarker.map = null;
            tempGmMarker = new google.maps.marker.AdvancedMarkerElement({
              position: place.geometry.location,
              map: gmap,
              title: place.name
            });
          }
        });
      }
    };

    window.ensureAutocompleteEdit = function () {
      if (!autocompleteEdit) {
        const inputEdit = document.getElementById('fe-lugar');
        autocompleteEdit = new google.maps.places.Autocomplete(inputEdit, {
          fields: ['geometry', 'formatted_address', 'name'],
          componentRestrictions: { country: 'es' }
        });
        autocompleteEdit.addListener('place_changed', () => {
          const place = autocompleteEdit.getPlace();
          if (!place.geometry) return;
          editPickedCoords = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() };
          editPickedAddress = place.formatted_address || place.name || '';
          mostrarEditCoordBox();
          if (mapReady && gmap) {
            gmap.panTo(place.geometry.location);
            gmap.setZoom(15);
            if (editTempGmMarker) editTempGmMarker.map = null;
            editTempGmMarker = new google.maps.marker.AdvancedMarkerElement({
              position: place.geometry.location,
              map: gmap,
              title: place.name
            });
          }
        });
      }
    };

    // â”€â”€ ACTIVIDAD (HEARTBEAT) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let lastHeartbeat = 0;
    function actualizarActividad() {
      if (!currentUser) return;
      const now = Date.now();
      // Throttle: Max una actualizaciÃ³n cada 5 minutos (300.000 ms)
      if (now - lastHeartbeat < 300000) return;
      lastHeartbeat = now;
      updateDoc(doc(db, 'users', currentUser.uid), {
        ultimaActividad: serverTimestamp(),
        enLinea: true
      }).catch(() => { });
    }
    window.addEventListener('click', actualizarActividad);
    window.addEventListener('keypress', actualizarActividad);

    // â”€â”€ AUTH STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    onAuthStateChanged(auth, async user => {
      if (user) {
        let snap;
        try {
          snap = await getDoc(doc(db, 'users', user.uid));
        } catch (e) { console.error("Error fetching user doc:", e); }

        if (!snap || !snap.exists() || snap.data().activo === false) {
          await signOut(auth);
          mostrarLoginErr('Usuario no autorizado o desactivado.');
          return;
        }
        currentUser = user;
        currentUserDoc = snap.data();
        currentRole = currentUserDoc.role;

        // Inicializar provincia seleccionada segÃºn perfil
        if (currentUserDoc.provincia && currentUserDoc.provincia !== 'AndalucÃ­a') {
          selectedProvincia = currentUserDoc.provincia;
        } else {
          selectedProvincia = 'AndalucÃ­a';
        }

        // Registrar entrada y marcar online (No bloqueante)
        try {
          updateDoc(doc(db, 'users', user.uid), {
            enLinea: true,
            ultimaActividad: serverTimestamp()
          });
          addDoc(collection(db, 'users', user.uid, 'sessions'), {
            tipo: 'entrada',
            timestamp: serverTimestamp()
          });
        } catch (e) { console.warn("Presencia no registrada (posible falta de reglas):", e); }

        mostrarApp();
        initApp();
      } else {
        currentUser = null; currentRole = null;
        mostrarLogin();
        detenerListeners();
      }
    });

    // Cargar Google Maps dinÃ¡micamente para asegurar que los callbacks estÃ©n listos
    function cargarGoogleMaps() {
      const script = document.createElement('script');
      const apiKey = "__GOOGLE_MAPS_API_KEY__";
      script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places,marker&callback=initGoogleMap&language=es`;
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    }
    cargarGoogleMaps();

    // â”€â”€ LOGIN / LOGOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.doLogin = async () => {
      const email = document.getElementById('l-email').value.trim();
      const pass = document.getElementById('l-pass').value;
      if (!email || !pass) return;
      const btn = document.getElementById('btn-login');
      btn.disabled = true; btn.textContent = 'Accediendoâ€¦';
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (e) {
        mostrarLoginErr('Email o contraseÃ±a incorrectos.');
        btn.disabled = false; btn.textContent = 'Acceder';
      }
    };
    window.doLogout = async () => {
      if (currentUser) {
        try {
          await addDoc(collection(db, 'users', currentUser.uid, 'sessions'), {
            tipo: 'salida',
            timestamp: serverTimestamp()
          });
          await updateDoc(doc(db, 'users', currentUser.uid), { enLinea: false });
        } catch (e) { console.error("Error logout presence:", e); }
      }
      signOut(auth);
    };

    // â”€â”€ INIT APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function initApp() {
      document.getElementById('hdr-user').textContent = currentUserDoc.nombre || currentUser.email;
      document.getElementById('hdr-role').textContent = ROL_LABELS[currentRole] || currentRole;

      // Actualizar tÃ­tulo de oficina y selector de provincia
      const officeTitle = document.getElementById('hdr-office-title');
      const provSelectorWrap = document.getElementById('hdr-prov-selector-wrap');
      const provSelector = document.getElementById('hdr-prov-selector');

      if (currentUserDoc.provincia && currentUserDoc.provincia !== 'AndalucÃ­a') {
        officeTitle.textContent = `Oficina Provincial de ${currentUserDoc.provincia}`;
        provSelectorWrap.style.display = 'none';
        selectedProvincia = currentUserDoc.provincia;
      } else {
        officeTitle.textContent = 'Oficina AutonÃ³mica de AndalucÃ­a';
        provSelectorWrap.style.display = 'flex';
        // Poblar selector si estÃ¡ vacÃ­o
        if (provSelector.options.length <= 1) {
          PROVINCIAS.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p;
            opt.textContent = `Oficina Provincial de ${p}`;
            provSelector.appendChild(opt);
          });
        }
        provSelector.options[0].textContent = "Oficina AutonÃ³mica de AndalucÃ­a";
        provSelector.value = selectedProvincia;
      }

      const isAdmin = currentRole === 'admin' || currentRole === 'super_admin' || currentRole === 'autonomica' || currentRole === 'provincial' || currentRole === 'manager';
      document.getElementById('btn-nueva-op').style.display = isAdmin ? 'flex' : 'none';

      const canManageUsers = currentRole === 'super_admin' || currentRole === 'manager';
      document.getElementById('nav-usuarios').style.display = canManageUsers ? 'flex' : 'none';
      if (document.getElementById('nav-tablas')) {
        document.getElementById('nav-tablas').style.display = canManageUsers ? 'flex' : 'none';
      }

      suscribirOps();
      showSection('operaciones');
      if (gmap && mapReady) setTimeout(() => google.maps.event.trigger(gmap, 'resize'), 100);
    }

    function detenerListeners() {
      if (unsubOps) { unsubOps(); unsubOps = null; }
      if (unsubAcciones) { unsubAcciones(); unsubAcciones = null; }
      if (unsubRecursos) { unsubRecursos(); unsubRecursos = null; }
      ops = {};
    }

    // â”€â”€ SUSCRIPCIÃ“N OPERACIONES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function suscribirOps() {
      if (unsubOps) unsubOps();
      const q = query(collection(db, 'operaciones'), orderBy('creadoEn', 'desc'));
      let initialLoad = true;

      unsubOps = onSnapshot(q, snap => {
        let hasNewOp = false;

        snap.docChanges().forEach(ch => {
          const d = ch.doc.data();
          const dId = ch.doc.id;

          if (ch.type === 'removed') {
            delete ops[dId];
          } else {
            const oldOp = ops[dId];
            ops[dId] = { id: dId, ...d };

            if (oldOp) {
              ops[dId]._isNew = oldOp._isNew;
              ops[dId]._hasUpdate = oldOp._hasUpdate;
            }

            // Detectar nueva operacion:
            if (ch.type === 'added') {
              // Si es la carga inicial, asumimos que no es nueva "en tiempo real"
              // a no ser que tÃº mismo la hayas creado muy recientemente
              if (!initialLoad && d.creadoPor !== currentUser.uid) {
                hasNewOp = true;
                ops[dId]._isNew = true;
              }
            }

            if (ch.type === 'modified' && dId !== selOpId) {
              const tsOld = oldOp && oldOp.actualizadoEn?.toMillis ? oldOp.actualizadoEn.toMillis() : 0;
              const tsNew = d.actualizadoEn?.toMillis ? d.actualizadoEn.toMillis() : 0;
              if (tsOld > 0 && tsNew > tsOld) {
                ops[dId]._hasUpdate = true;
              }
            }
          }
        });

        if (hasNewOp && !initialLoad) {
          alertSound.play().catch(e => console.log('Ignored auto-play:', e));
        }

        initialLoad = false;

        renderSidebar();
        renderMapa();
        actualizarContadores();
        if (selOpId && ops[selOpId]) renderDetalle(ops[selOpId]);
      }, err => {
        console.error("Ops listener error:", err);
      });
    }

    // â”€â”€ MAPA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function nivelIcon(nivel, emoji, isNew, hasUpdate, recursosSummary) {
      const color = NIVEL_COLORS[nivel] || '#888';
      const container = document.createElement('div');
      container.className = 'custom-marker';
      container.style.setProperty('--nivel-color', color);

      let html = `
        <div class="marker-main">
          ${isNew ? '<div class="marker-new-glow"></div>' : ''}
          <div class="marker-cross">+</div>
          <div class="marker-emoji">${emoji}</div>
        </div>
      `;

      if (recursosSummary) {
        let badgesHtml = '<div class="marker-badges">';
        const types = [
          { key: 'camiones', icon: 'assets/icons/truck.png' },
          { key: 'ambulancias', icon: 'assets/icons/ambulance.png' },
          { key: 'offroad', icon: 'assets/icons/offroad.png' },
          { key: 'van', icon: 'assets/icons/van.png' }
        ];

        types.forEach(t => {
          const count = recursosSummary[t.key] || 0;
          if (count > 0) {
            badgesHtml += `
              <div class="badge-item">
                <img src="${t.icon}" class="badge-img">
                ${count > 1 ? `<div class="badge-count">${count}</div>` : ''}
              </div>`;
          }
        });
        badgesHtml += '</div>';
        html += badgesHtml;
      }

      container.innerHTML = html;
      return container;
    }

    let boundsTimeout = null;
    function renderMapa() {
      if (!gmap || !mapReady) return;
      Object.keys(gmMarkers).forEach(id => {
        if (!ops[id]) { gmMarkers[id].setMap(null); delete gmMarkers[id]; }
      });

      const bounds = new google.maps.LatLngBounds();
      let hasValidCoords = false;

      Object.values(ops).forEach(op => {
        // Filtrado por provincia
        if (selectedProvincia !== 'AndalucÃ­a' && op.provincia !== selectedProvincia) return;

        if (!op.coords) return;
        const t = TIPOS[op.tipo] || TIPOS.otro;
        const pos = { lat: op.coords.lat, lng: op.coords.lng };

        bounds.extend(pos);
        hasValidCoords = true;

        const iconContent = nivelIcon(op.nivel, t.emoji, op._isNew, op._hasUpdate, op.recursosSummary);
        if (gmMarkers[op.id]) {
          gmMarkers[op.id].position = pos;
          gmMarkers[op.id].content = iconContent;
        } else {
          const marker = new google.maps.marker.AdvancedMarkerElement({
            position: pos,
            map: gmap,
            content: iconContent,
            title: op.nombre
          });
          const iw = new google.maps.InfoWindow({ maxWidth: 260 });
          marker.addListener('click', () => {
            iw.setContent(`
          <div style="font-family:'IBM Plex Sans',sans-serif;padding:4px 2px;min-width:200px;">
            <div style="font-family:'Fraunces',serif;font-size:15px;font-weight:700;margin-bottom:4px;">${op.nombre}</div>
            <div style="font-size:11px;color:#888;margin-bottom:2px;">${t.emoji} ${t.label} Â· ${op.loc || ''}</div>
            <div style="margin-bottom:10px;">
              <span style="font-size:9px;font-weight:700;padding:2px 7px;border-radius:2px;
                background:${NIVEL_COLORS[op.nivel]}20;color:${NIVEL_COLORS[op.nivel]};
                border:1px solid ${NIVEL_COLORS[op.nivel]}50;">
                N${op.nivel} ${NIVEL_LABELS[op.nivel]}
              </span>
            </div>
            <button onclick="window.abrirDetalle('${op.id}')"
              style="width:100%;padding:8px;background:#1a3a6e;border:none;color:#fff;
                     cursor:pointer;font-family:'IBM Plex Sans',sans-serif;font-size:12px;
                     font-weight:600;border-radius:2px;">
              Ver operaciÃ³n â†’
            </button>
          </div>`);
            iw.open(gmap, marker);
          });
          gmMarkers[op.id] = marker;
        }
      });

      if (hasValidCoords && !editPickMode && !picking) {
        if (boundsTimeout) clearTimeout(boundsTimeout);
        boundsTimeout = setTimeout(() => {
          gmap.fitBounds(bounds, { top: 40, bottom: 40, left: 40, right: 380 });
          // right padding for the desktop sidebar so it doesn't hide markers
          if (gmap.getZoom() > 14) gmap.setZoom(14); // prevent excessive zooming on single marker
        }, 100);
      }
    }

    // â”€â”€ PICK LOCATION (nueva operaciÃ³n) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.iniciarPick = () => {
      if (!gmap || !mapReady) return;
      picking = true;
      document.getElementById('overlay-op').classList.remove('open');
      document.getElementById('pick-banner').classList.add('on');
      document.getElementById('pick-banner').textContent = 'ğŸ“ Haz clic en el mapa para fijar la ubicaciÃ³n';
      gmap.getDiv().style.cursor = 'crosshair';
      pickListener = gmap.addListener('click', e => {
        pickedCoords = { lat: e.latLng.lat(), lng: e.latLng.lng() };
        const gc = new google.maps.Geocoder();
        gc.geocode({ location: e.latLng }, (results, status) => {
          if (status === 'OK' && results[0]) {
            pickedAddress = results[0].formatted_address;
            document.getElementById('f-lugar').value = pickedAddress;
          }
          mostrarCoordBox();
          stopPick();
          window.abrirModalOp();
        });
        if (tempGmMarker) tempGmMarker.map = null;
        tempGmMarker = new google.maps.marker.AdvancedMarkerElement({
          position: e.latLng,
          map: gmap,
        });
      });
    };

    function stopPick() {
      picking = false;
      if (pickListener) { google.maps.event.removeListener(pickListener); pickListener = null; }
      document.getElementById('pick-banner').classList.remove('on');
      gmap.getDiv().style.cursor = '';
    }

    function mostrarCoordBox() {
      const box = document.getElementById('coord-box');
      box.textContent = pickedCoords ? `ğŸ“ ${pickedCoords.lat.toFixed(5)}, ${pickedCoords.lng.toFixed(5)}` : '';
      box.classList.toggle('show', !!pickedCoords);
    }

    // â”€â”€ PICK LOCATION (editar operaciÃ³n) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.iniciarEditPick = () => {
      if (!gmap || !mapReady) return;
      editPickMode = true;
      document.getElementById('overlay-edit-op').classList.remove('open');
      document.getElementById('pick-banner').classList.add('on');
      document.getElementById('pick-banner').textContent = 'ğŸ“ Haz clic en el mapa para actualizar la ubicaciÃ³n';
      gmap.getDiv().style.cursor = 'crosshair';
      editPickListener = gmap.addListener('click', e => {
        editPickedCoords = { lat: e.latLng.lat(), lng: e.latLng.lng() };
        const gc = new google.maps.Geocoder();
        gc.geocode({ location: e.latLng }, (results, status) => {
          if (status === 'OK' && results[0]) {
            editPickedAddress = results[0].formatted_address;
            document.getElementById('fe-lugar').value = editPickedAddress;
          }
          mostrarEditCoordBox();
          stopEditPick();
          document.getElementById('overlay-edit-op').classList.add('open');
        });
        if (editTempGmMarker) editTempGmMarker.map = null;
        editTempGmMarker = new google.maps.marker.AdvancedMarkerElement({
          position: e.latLng,
          map: gmap,
        });
      });
    };

    function stopEditPick() {
      editPickMode = false;
      if (editPickListener) { google.maps.event.removeListener(editPickListener); editPickListener = null; }
      document.getElementById('pick-banner').classList.remove('on');
      gmap.getDiv().style.cursor = '';
    }

    function mostrarEditCoordBox() {
      const box = document.getElementById('edit-coord-box');
      box.textContent = editPickedCoords ? `ğŸ“ ${editPickedCoords.lat.toFixed(5)}, ${editPickedCoords.lng.toFixed(5)}` : '';
      box.classList.toggle('show', !!editPickedCoords);
    }

    // â”€â”€ CONTADORES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function actualizarContadores() {
      let visible = Object.values(ops);
      if (selectedProvincia !== 'AndalucÃ­a') {
        visible = visible.filter(o => o.provincia === selectedProvincia);
      }
      [1, 2, 3, 4].forEach(n => {
        const el = document.getElementById('cnt' + n);
        if (el) el.textContent = visible.filter(o => o.nivel == n).length;
      });
    }

    // â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderSidebar() {
      const list = document.getElementById('ops-list');
      const empty = document.getElementById('empty-msg');
      list.querySelectorAll('.op-card').forEach(c => c.remove());

      let visible = Object.values(ops);
      if (filtro !== 'all') visible = visible.filter(o => String(o.nivel) === filtro);

      // Filtrado por provincia
      if (selectedProvincia !== 'AndalucÃ­a') {
        visible = visible.filter(o => o.provincia === selectedProvincia);
      }

      visible.sort((a, b) => {
        const ta = a.actualizadoEn?.toMillis ? a.actualizadoEn.toMillis() : 0;
        const tb = b.actualizadoEn?.toMillis ? b.actualizadoEn.toMillis() : 0;
        return tb - ta;
      });

      if (!visible.length) { empty.classList.add('show'); return; }
      empty.classList.remove('show');

      visible.forEach(op => {
        const t = TIPOS[op.tipo] || TIPOS.otro;
        const card = document.createElement('div');
        let classes = 'op-card';
        if (selOpId === op.id) classes += ' sel';
        if (op._isNew) classes += ' is-new';
        card.className = classes;
        card.dataset.nivel = op.nivel;

        let badgeHtml = '';
        if (op._isNew) {
          badgeHtml = `<div class="card-badge new-badge" title="Nueva operaciÃ³n"></div>`;
        } else if (op._hasUpdate) {
          badgeHtml = `<div class="card-badge update-badge" title="Nuevos mensajes"></div>`;
        }

        card.innerHTML = `
      <div class="card-top" style="position:relative;">
        <div>
          <div class="card-scope" style="font-size:9px; font-weight:700; color:var(--accent); text-transform:uppercase; margin-bottom:2px; opacity:0.8;">
            ${op.provincia === 'AndalucÃ­a' ? 'Oficina AutonÃ³mica de AndalucÃ­a' : `Oficina Provincial de ${op.provincia}`}
          </div>
          <div class="card-id">${op.id.substring(0, 8).toUpperCase()}</div>
          <div class="card-name" style="padding-right:16px;">${op.nombre}</div>
        </div>
        ${badgeHtml}
        <span class="card-type-tag" style="color:${t.color};border-color:${t.color}30;background:${t.color}12">${t.emoji} ${TIPOS[op.tipo] ? t.label : op.tipo}</span>
      </div>
      <div class="card-meta">
        <span class="card-loc">ğŸ“ ${op.loc || 'Sin ubicaciÃ³n'}</span>
        <div style="display:flex; gap:4px; align-items:center;">
          ${op.estado === 'finalizada' ? '<span style="font-size:9px;font-weight:700;padding:2px 6px;border-radius:2px;background:var(--bg-3);color:var(--text-3);border:1px solid var(--border-mid);">FINALIZADA</span>' : ''}
          <span class="nivel-pill pill-${op.nivel}">N${op.nivel} ${NIVEL_LABELS[op.nivel]}</span>
        </div>
      </div>`;
        card.addEventListener('click', () => {
          if (selOpId === op.id && document.getElementById('detail-panel').classList.contains('open')) {
            window.cerrarDetalle();
          } else {
            window.abrirDetalle(op.id);
          }
        });
        list.appendChild(card);
      });
    }

    window.setFiltro = (f, btn) => {
      filtro = f;
      document.querySelectorAll('.ftab').forEach(b => b.classList.remove('on', 'on-n1', 'on-n2', 'on-n3', 'on-n4'));
      btn.classList.add(f === 'all' ? 'on' : `on-n${f}`);
      renderSidebar();
    };

    // â”€â”€ DETALLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.abrirDetalle = (id) => {
      selOpId = id;
      const op = ops[id];
      if (!op) return;

      // Limpiar badges por visualizaciÃ³n
      if (op._isNew || op._hasUpdate) {
        op._isNew = false;
        op._hasUpdate = false;
        // Re-renderizamos en mapa y lista para quitar la notificaciÃ³n visual
        if (gmMarkers[id]) {
          const t = TIPOS[op.tipo] || TIPOS.otro;
          gmMarkers[id].content = nivelIcon(op.nivel, t.emoji, false, false, op.recursosSummary);
        }
      }

      document.getElementById('detail-panel').classList.add('open');
      if (gmap && mapReady) setTimeout(() => google.maps.event.trigger(gmap, 'resize'), 100);
      renderDetalle(op);
      renderSidebar();
      if (op.coords && gmap) {
        gmap.panTo({ lat: op.coords.lat, lng: op.coords.lng });
        gmap.setZoom(13);
      }
      suscribirAcciones(id);
      suscribirRecursos(id);
    };

    window.cerrarDetalle = () => {
      document.getElementById('detail-panel').classList.remove('open');
      if (gmap && mapReady) setTimeout(() => google.maps.event.trigger(gmap, 'resize'), 100);
      selOpId = null;
      if (unsubAcciones) { unsubAcciones(); unsubAcciones = null; }
      if (unsubRecursos) { unsubRecursos(); unsubRecursos = null; }
      renderSidebar();
    };

    function suscribirAcciones(opId) {
      if (unsubAcciones) unsubAcciones();
      const q = query(collection(db, 'operaciones', opId, 'acciones'), orderBy('timestamp', 'desc'));
      unsubAcciones = onSnapshot(q, snap => {
        const acciones = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        currentAcciones = {};
        acciones.forEach(a => currentAcciones[a.id] = a);
        renderTimeline(acciones, ops[opId]);
      });
    }

    function suscribirRecursos(opId) {
      if (unsubRecursos) unsubRecursos();
      const q = query(collection(db, 'operaciones', opId, 'recursos'), orderBy('asignadoEn', 'desc'));
      unsubRecursos = onSnapshot(q, snap => {
        const recursos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderRecursosOp(recursos, ops[opId]);
      });
    }

    let opcionesRecursosCache = { vehiculos: [] };

    window.cargarOpcionesRecursos = async () => {
      const cat = document.getElementById('r-cat').value;
      const sel = document.getElementById('r-item');
      sel.innerHTML = '<option value="">Selecciona recurso...</option>';
      if (!cat || !selOpId) return;

      const currentOp = ops[selOpId];
      if (!currentOp) return;

      if (cat === 'vehiculos') {
        const snap = await getDocs(collection(db, 'vehiculos'));
        opcionesRecursosCache.vehiculos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        // Filtrar vehÃ­culos por el Ã¡mbito de la operaciÃ³n
        const filtered = opcionesRecursosCache.vehiculos.filter(v => {
          const prov = v.provincia || 'MÃ¡laga';
          return prov === currentOp.provincia;
        });
        filtered.forEach(v => {
          sel.innerHTML += `<option value="${v.id}">${v.indicativo} - ${v.tipo} (${v.matricula})</option>`;
        });
      }
    };

    window.asignarRecurso = async () => {
      if (!selOpId) return;
      const cat = document.getElementById('r-cat').value;
      const itemId = document.getElementById('r-item').value;
      if (!cat || !itemId) return;

      const btn = document.getElementById('btn-add-recurso');
      btn.disabled = true; btn.textContent = '...';

      try {
        let recursoDesc = '';
        if (cat === 'vehiculos') {
          const v = opcionesRecursosCache.vehiculos.find(x => x.id === itemId);
          if (v) recursoDesc = `ğŸš— ${v.indicativo} - ${v.tipo} (${v.matricula})`;
        }

        if (recursoDesc) {
          await setDoc(doc(db, 'operaciones', selOpId, 'recursos', itemId), {
            id: itemId,
            categoria: cat,
            recursoId: itemId,
            descripcion: recursoDesc,
            asignadoEn: serverTimestamp(),
            asignadoPor: currentUser.uid
          });

          const autorNombre = currentUserDoc.nombre || currentUser.email;
          await addDoc(collection(db, 'operaciones', selOpId, 'acciones'), {
            texto: `Se ha asignado el recurso: ${recursoDesc}`,
            prioridad: 'Baja',
            autor: autorNombre,
            uid: currentUser.uid,
            timestamp: serverTimestamp()
          });

          try {
            const opRef = doc(db, 'operaciones', selOpId);
            const opSnap = await getDoc(opRef);
            const rSum = opSnap.data().recursosSummary || {};

            const keyMap = {
              'CamiÃ³n': 'camiones',
              'Ambulancia': 'ambulancias',
              'VehÃ­culo Todo terreno': 'offroad',
              'Todo Terreno': 'offroad',
              'VehÃ­culo transporte personal': 'van',
              'VehÃ­culo de transporte mixto': 'van',
              'Furgoneta': 'van'
            };
            const v = opcionesRecursosCache.vehiculos.find(x => x.id === itemId);
            const key = keyMap[v.tipo] || 'otros';
            rSum[key] = (rSum[key] || 0) + 1;

            await updateDoc(opRef, {
              recursosSummary: rSum,
              actualizadoEn: serverTimestamp()
            });
          } catch (e) { console.error("Error updating recursosSummary:", e); }
        }
        document.getElementById('r-cat').value = '';
        document.getElementById('r-item').innerHTML = '<option value="">Selecciona recurso...</option>';
      } catch (e) { alert('Error asignando recurso: ' + e.message); }
      btn.disabled = false; btn.textContent = 'AÃ±adir';
    };

    window.desasignarRecurso = async (id, desc) => {
      if (!selOpId) return;
      if (!confirm('Â¿Retirar este recurso de la operaciÃ³n?')) return;
      try {
        await deleteDoc(doc(db, 'operaciones', selOpId, 'recursos', id));
        const autorNombre = currentUserDoc.nombre || currentUser.email;
        await addDoc(collection(db, 'operaciones', selOpId, 'acciones'), {
          texto: `Se ha retirado el recurso: ${desc}`,
          prioridad: 'Baja',
          autor: autorNombre,
          uid: currentUser.uid,
          timestamp: serverTimestamp()
        });
        try {
          const opRef = doc(db, 'operaciones', selOpId);
          const opSnap = await getDoc(opRef);
          const rSum = opSnap.data().recursosSummary || {};

          // Inferir tipo de la descripciÃ³n (esto es un poco frÃ¡gil pero funciona con el desc generado)
          let key = 'otros';
          if (desc.includes('ğŸš—')) { // Asumimos que los vehiculos empiezan con emoji
            if (desc.includes('CamiÃ³n')) key = 'camiones';
            else if (desc.includes('Ambulancia')) key = 'ambulancias';
            else if (desc.includes('Todo terreno') || desc.includes('Todo Terreno')) key = 'offroad';
            else if (desc.includes('VehÃ­culo transporte personal') || desc.includes('VehÃ­culo de transporte mixto') || desc.includes('Furgoneta')) key = 'van';
          }

          if (rSum[key] > 0) rSum[key]--;

          await updateDoc(opRef, {
            recursosSummary: rSum,
            actualizadoEn: serverTimestamp()
          });
        } catch (e) { console.error("Error updating recursosSummary:", e); }
      } catch (e) { alert('Error: ' + e.message); }
    };

    function renderRecursosOp(recursos, op) {
      const list = document.getElementById('dp-recursos-list');
      const form = document.getElementById('dp-recursos-form');
      const isFinalizada = op?.estado === 'finalizada';
      const canModify = !isFinalizada && (currentRole === 'admin' || currentRole === 'super_admin' || currentRole === 'usuario' || currentRole === 'manager');

      if (form) form.style.display = canModify ? 'block' : 'none';
      if (!list) return;

      const summary = document.getElementById('dp-recursos-summary');
      if (summary) summary.textContent = `Recursos asignados (${recursos.length})`;

      if (!recursos.length) {
        list.innerHTML = '<div style="font-size:11px;color:var(--text-4);">No hay recursos asignados.</div>';
        return;
      }

      list.innerHTML = recursos.map(r => {
        const desc = r.descripcion || '';
        let iconUrl = '';
        if (desc.includes('CamiÃ³n')) iconUrl = 'assets/icons/truck.png';
        else if (desc.includes('Ambulancia')) iconUrl = 'assets/icons/ambulance.png';
        else if (desc.includes('Todo terreno') || desc.includes('Todo Terreno')) iconUrl = 'assets/icons/offroad.png';
        else if (desc.includes('VehÃ­culo transporte personal') || desc.includes('VehÃ­culo de transporte mixto') || desc.includes('Furgoneta')) iconUrl = 'assets/icons/van.png';

        const iconHtml = iconUrl ? `<img src="${iconUrl}" style="width:16px; height:16px; margin-right:6px; vertical-align:middle;">` : '';
        const btnDelete = canModify ? `<button onclick="desasignarRecurso('${r.id}', '${r.descripcion}')" style="background:none;border:none;color:var(--crit-1);cursor:pointer;font-size:14px;line-height:1;" title="Retirar">âœ•</button>` : '';
        return `
        <div style="display:flex; justify-content:space-between; align-items:center; background:var(--bg-2); padding:5px 10px; border:1px solid var(--border-mid); border-radius:2px; font-size:11px;">
          <div style="display:flex; align-items:center;">
            ${iconHtml}
            <span style="font-weight:600;">${desc}</span>
          </div>
          ${btnDelete}
        </div>`;
      }).join('');
    }

    function renderDetalle(op) {
      const t = TIPOS[op.tipo] || TIPOS.otro;
      const isAdmin = currentRole === 'admin' || currentRole === 'super_admin' || currentRole === 'manager';
      const isSA = currentRole === 'super_admin';

      document.getElementById('dp-id').textContent = op.id.substring(0, 8).toUpperCase();
      const scopeTitle = document.getElementById('dp-scope-title');
      if (scopeTitle) {
        scopeTitle.textContent = op.provincia === 'AndalucÃ­a' ? 'Oficina AutonÃ³mica de AndalucÃ­a' : `Oficina Provincial de ${op.provincia}`;
      }
      document.getElementById('dp-name').textContent = op.nombre;
      document.getElementById('dp-loc').innerHTML = op.loc ? `ğŸ“ ${op.loc} ` : (op.coords ? `ğŸ“ ${op.coords.lat.toFixed(4)}, ${op.coords.lng.toFixed(4)} ` : '');
      document.getElementById('dp-type-tag').innerHTML =
        `<span class="card-type-tag" style="color:${t.color};border-color:${t.color}30;background:${t.color}12">${t.emoji} ${TIPOS[op.tipo] ? t.label : op.tipo}</span>`;

      document.querySelectorAll('.nsel-opt').forEach(b => {
        b.classList.toggle('on', parseInt(b.dataset.n) === op.nivel);
        b.disabled = false;
      });

      const ir = document.getElementById('dp-info-row');
      const ts = op.creadoEn?.toDate
        ? op.creadoEn.toDate().toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' })
        : 'â€”';
      ir.innerHTML = '';
      if (op.dir) ir.innerHTML += `<div class="dp-info-item"><strong>${op.dir}</strong>Jefe de Operaciones</div>`;
      if (op.org) ir.innerHTML += `<div class="dp-info-item"><strong>${op.org}</strong>Solicitado por</div>`;
      if (op.creadoPorNombre) ir.innerHTML += `<div class="dp-info-item"><strong>${op.creadoPorNombre}</strong>Creado por</div>`;
      ir.innerHTML += `<div class="dp-info-item"><strong>${ts}</strong>Inicio</div>`;

      // Campo autor readonly
      document.getElementById('a-autor').value = currentUserDoc.nombre || currentUser.email;
      document.getElementById('a-autor').readOnly = true;

      // LÃ³gica de finalizaciÃ³n e informes
      const isFinalizada = op.estado === 'finalizada';

      document.getElementById('dp-addaction-wrapper').style.display = isFinalizada ? 'none' : 'block';
      document.getElementById('dp-edit-btn').style.display = (isAdmin && !isFinalizada) ? 'inline-flex' : 'none';
      document.getElementById('dp-fin-btn').style.display = (isAdmin && !isFinalizada) ? 'inline-flex' : 'none';
      document.getElementById('dp-ai-btn').style.display = isFinalizada ? 'inline-flex' : 'none';

      document.getElementById('dp-admin-btns').style.display = isSA ? 'flex' : 'none';
      document.getElementById('dp-reabrir-btn').style.display = (isSA && isFinalizada) ? 'inline-flex' : 'none';

      // Deshabilitar selector de nivel si estÃ¡ finalizada
      document.querySelectorAll('.nsel-opt').forEach(b => {
        b.disabled = isFinalizada;
      });
    }

    function renderTimeline(acciones, op) {
      const tl = document.getElementById('dp-timeline');
      const t = op ? (TIPOS[op.tipo] || TIPOS.otro) : TIPOS.otro;
      const nivel = op ? op.nivel : 1;
      if (!acciones.length) {
        tl.innerHTML = '<div class="tl-empty">// Sin novedades registradas //</div>';
        return;
      }
      tl.innerHTML = acciones.map(a => {
        const ts = a.timestamp?.toDate
          ? a.timestamp.toDate().toLocaleString('es-ES', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })
          : 'â€”';

        const isAdmin = currentRole === 'admin' || currentRole === 'super_admin' || currentRole === 'manager';
        const isFinalizada = op?.estado === 'finalizada';
        const editBtn = (isAdmin && !isFinalizada)
          ? `<button class="btn-cancel-m" style="padding: 2px 8px; font-size: 11px; margin-left: auto;" onclick="abrirModalEditAccion('${a.id}')">âœï¸ Editar</button>`
          : '';

        return `<div class="tl-entry">
      <div class="tl-node tl-node-${nivel}">${t.emoji}</div>
      <div class="tl-body">
        <div class="tl-meta" style="display:flex; align-items:center;">
          <span class="tl-ts">${ts}</span>
          <span class="tl-prio prio-${a.prioridad}">${a.prioridad}</span>
          ${editBtn}
        </div>
        <div class="tl-text">${a.texto}</div>
        <div class="tl-author">â€” ${a.autor || 'â€”'}</div>
      </div>
    </div > `;
      }).join('');
    }

    // â”€â”€ CAMBIAR NIVEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.cambiarNivel = async n => {
      if (!selOpId) return;
      const op = ops[selOpId];
      if (!op) return;

      if (parseInt(op.nivel) === n) return;
      const comment = prompt(`Vas a cambiar la prioridad a N${n} ${NIVEL_LABELS[n]}. Por favor, indica el motivo:`);
      if (comment === null) return;
      const finalComment = comment.trim() || "Sin comentario adicional";

      try {
        await updateDoc(doc(db, 'operaciones', selOpId), { nivel: n, actualizadoEn: serverTimestamp() });

        // Registrar en el log como una novedad
        const autorNombre = currentUserDoc.nombre || currentUser.email;
        await addDoc(collection(db, 'operaciones', selOpId, 'acciones'), {
          texto: `Cambio de prioridad: N${op.nivel} ${NIVEL_LABELS[op.nivel] || op.nivel} â” N${n} ${NIVEL_LABELS[n]}. Motivo: ${finalComment}`,
          prioridad: 'Baja',
          autor: autorNombre,
          uid: currentUser.uid,
          timestamp: serverTimestamp()
        });

        if (gmMarkers[selOpId]) {
          const t = TIPOS[op.tipo] || TIPOS.otro;
          gmMarkers[selOpId].content = nivelIcon(n, t.emoji, false, false, op.recursosSummary);
        }
        mostrarToast('Prioridad actualizada y registrada.');
      } catch (e) {
        alert('Error al cambiar nivel: ' + e.message);
      }
    };

    // â”€â”€ EDITAR ACCIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.abrirModalEditAccion = (id) => {
      if (!selOpId || !currentAcciones[id]) return;
      editAccionId = id;
      const accion = currentAcciones[id];
      document.getElementById('ea-texto').value = accion.texto || '';

      if (accion.timestamp?.toDate) {
        const d = accion.timestamp.toDate();
        const yy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        const hh = String(d.getHours()).padStart(2, '0');
        const mn = String(d.getMinutes()).padStart(2, '0');
        document.getElementById('ea-fecha').value = `${yy} -${mm} -${dd}T${hh}:${mn} `;
      } else {
        document.getElementById('ea-fecha').value = '';
      }

      document.getElementById('overlay-edit-accion').classList.add('open');
      setTimeout(() => document.getElementById('ea-texto').focus(), 100);
    };

    window.cerrarModalEditAccion = () => {
      document.getElementById('overlay-edit-accion').classList.remove('open');
      editAccionId = null;
    };

    window.guardarEditAccion = async () => {
      if (!selOpId || !editAccionId) return;

      const btn = document.getElementById('btn-guardar-edit-accion');
      btn.disabled = true; btn.textContent = 'Guardandoâ€¦';

      try {
        const texto = document.getElementById('ea-texto').value.trim();
        const valFecha = document.getElementById('ea-fecha').value;
        const ts = valFecha ? new Date(valFecha) : new Date();

        await updateDoc(doc(db, 'operaciones', selOpId, 'acciones', editAccionId), {
          texto,
          timestamp: ts
        });

        cerrarModalEditAccion();
      } catch (e) {
        alert('Error: ' + e.message);
      }
      btn.disabled = false; btn.textContent = 'Guardar novedad â†’';
    };

    window.eliminarAccion = async () => {
      if (!selOpId || !editAccionId) return;
      if (!confirm('Â¿Seguro que deseas eliminar esta novedad? Esta acciÃ³n no se puede deshacer.')) return;

      const btn = document.getElementById('btn-guardar-edit-accion');
      btn.disabled = true; btn.textContent = 'Eliminandoâ€¦';

      try {
        await deleteDoc(doc(db, 'operaciones', selOpId, 'acciones', editAccionId));
        cerrarModalEditAccion();
        mostrarToast('Novedad eliminada.');
      } catch (e) {
        alert('Error al eliminar: ' + e.message);
      }
      btn.disabled = false; btn.textContent = 'Guardar novedad â†’';
    };

    // â”€â”€ AÃ‘ADIR ACCIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.addAccion = async () => {
      if (!selOpId) return;
      const texto = document.getElementById('a-texto').value.trim();
      if (!texto) { document.getElementById('a-texto').focus(); return; }
      const btn = document.getElementById('btn-reg-accion');
      btn.disabled = true;
      try {
        const autorNombre = currentUserDoc.nombre || currentUser.email;
        await addDoc(collection(db, 'operaciones', selOpId, 'acciones'), {
          texto,
          prioridad: document.getElementById('a-prio').value,
          autor: autorNombre,
          uid: currentUser.uid,
          timestamp: serverTimestamp()
        });

        try {
          await updateDoc(doc(db, 'operaciones', selOpId), { actualizadoEn: serverTimestamp() });
        } catch (updateErr) {
          console.warn("Usuario sin permisos para actualizar la operaciÃ³n principal, pero novedad aÃ±adida.");
        }

        document.getElementById('a-texto').value = '';
      } catch (e) { alert('Error: ' + e.message); }
      btn.disabled = false;
    };

    // â”€â”€ BORRAR OPERACIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.borrarOp = async () => {
      if (!selOpId) return;
      if (!confirm('Â¿Borrar esta operaciÃ³n? No se puede deshacer.')) return;
      if (gmMarkers[selOpId]) { gmMarkers[selOpId].setMap(null); delete gmMarkers[selOpId]; }
      await deleteDoc(doc(db, 'operaciones', selOpId));
      cerrarDetalle();
    };

    // â”€â”€ FINALIZAR / REABRIR OPERACIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.finalizarOp = async () => {
      if (!selOpId) return;
      if (!confirm('Â¿Finalizar esta operaciÃ³n? Ya no se podrÃ¡n aÃ±adir novedades ni editar, y se habilitarÃ¡ el informe IA.')) return;
      try {
        const autorNombre = currentUserDoc.nombre || currentUser.email;
        await addDoc(collection(db, 'operaciones', selOpId, 'acciones'), {
          texto: 'OperaciÃ³n finalizada por el administrador.',
          prioridad: 'Baja',
          autor: autorNombre,
          uid: currentUser.uid,
          timestamp: serverTimestamp()
        });
        await updateDoc(doc(db, 'operaciones', selOpId), { estado: 'finalizada', actualizadoEn: serverTimestamp() });
        mostrarToast('OperaciÃ³n finalizada.');
      } catch (e) { alert('Error: ' + e.message); }
    };

    window.reabrirOp = async () => {
      if (!selOpId) return;
      if (!confirm('Â¿Reabrir esta operaciÃ³n? VolverÃ¡ a estar activa y escribible.')) return;
      try {
        const autorNombre = currentUserDoc.nombre || currentUser.email;
        await addDoc(collection(db, 'operaciones', selOpId, 'acciones'), {
          texto: 'OperaciÃ³n reabierta por super_admin.',
          prioridad: 'Media',
          autor: autorNombre,
          uid: currentUser.uid,
          timestamp: serverTimestamp()
        });
        await updateDoc(doc(db, 'operaciones', selOpId), { estado: 'activa', actualizadoEn: serverTimestamp() });
        mostrarToast('OperaciÃ³n reabierta.');
      } catch (e) { alert('Error: ' + e.message); }
    };

    // â”€â”€ INFORME IA (GEMINI) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.abrirModalInformeIA = async () => {
      if (!selOpId) return;
      const op = ops[selOpId];
      if (!op) return;

      const btn = document.getElementById('dp-ai-btn');
      btn.disabled = true; btn.textContent = 'Generando informe...';

      try {
        // 1. Recopilamos datos bÃ¡sicos
        const t = TIPOS[op.tipo] || TIPOS.otro;
        let dataContext = `Nombre operaciÃ³n: ${op.nombre} \n`;
        dataContext += `Tipo: ${t.label} \nUbicaciÃ³n: ${op.loc || 'N/A'} \n`;
        dataContext += `Jefe de Operaciones: ${op.dir || 'N/A'} \nSolicitado por: ${op.org || 'N/A'} \n\n`;
        dataContext += `================ HILO CRONOLÃ“GICO DE ACCIONES ================\n`;

        // 2. Traer todas las acciones/novedades ordenadas
        const snap = await getDocs(query(collection(db, 'operaciones', selOpId, 'acciones'), orderBy('timestamp', 'asc')));
        if (snap.empty) {
          dataContext += "(Sin acciones registradas)\n";
        } else {
          snap.forEach(doc => {
            const a = doc.data();
            const dateStr = a.timestamp?.toDate ? a.timestamp.toDate().toLocaleString('es-ES') : 'Fecha desconocida';
            dataContext += `[${dateStr}]- Prioridad: ${a.prioridad} - Autor: ${a.autor} \n`;
            dataContext += `Novedad: ${a.texto} \n`;
            dataContext += `----------------------------------------------------------\n`;
          });
        }

        // 3. Prompt estricto para Gemini
        const prompt = `
Eres un analista experto en gestiÃ³n de emergencias y catÃ¡strofes de la plataforma SIGECA.
El usuario ha solicitado generar un informe final ejecutivo y bien estructurado que resuma esta intervenciÃ³n finalizada.

          INSTRUCCIONES:
        1. Lee todos los datos base y el hilo cronolÃ³gico de acciones.
2. Genera un resumen ejecutivo en espaÃ±ol, profesional, claro y neutro. 
3. Estructura el informe usando etiquetas HTML simples compatibles(<h1>, <h2>, <p>, <ul>, <li>, <strong>) para poder renderizarlo en la web directamente. No envuelvas el resultado en \`\`\`html.
          4. El informe debe contener estas secciones principales:
          - Resumen Ejecutivo (situaciÃ³n general y desenlace)
          - Recursos y OrganizaciÃ³n (organismos y directores involucrados)
          - CronologÃ­a Destacada (los hitos mÃ¡s relevantes resumidos)
          - ConclusiÃ³n Final (estado actual, sin inventar datos que no estÃ©n)
          Si faltan datos, indÃ­calo de forma elegante.

          DATOS DE LA INTERVENCIÃ“N:
          ${dataContext}
          `;

        // 4. Llamada a la API de Gemini
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${geminiApiKey}`;

        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ role: "user", parts: [{ text: prompt }] }],
            generationConfig: {
              temperature: 0.2,
              topK: 40,
              topP: 0.95,
              maxOutputTokens: 8192,
            }
          })
        });

        if (!response.ok) {
          const errData = await response.json();
          throw new Error(errData.error?.message || 'Error en la peticiÃ³n a Gemini');
        }

        const data = await response.json();
        let textReport = data.candidates[0].content.parts[0].text;

        // Limpiamos posible formateo markdown
        textReport = textReport.replace(/^```html\n?/, '').replace(/\n?```$/, '');

        // 5. Mostrar en Modal
        document.getElementById('ai-report-content').innerHTML = textReport;
        document.getElementById('overlay-ai-report').classList.add('open');

      } catch (e) {
        alert('Error al generar el informe IA: ' + e.message);
      }

      btn.disabled = false; btn.textContent = 'âœ¨ Emitir informe (IA)';
    };

    window.cerrarModalInformeIA = () => {
      document.getElementById('overlay-ai-report').classList.remove('open');
    };

    // â”€â”€ HELPERS SELECTORES SOLICITUD Y TIPO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.handleTipoChange = (prefix) => {
      const select = document.getElementById(`${prefix}-tipo`);
      const input = document.getElementById(`${prefix}-tipo-otro`);
      if (select && input) {
        input.style.display = select.value === 'otro' ? 'block' : 'none';
        if (select.value !== 'otro') input.value = '';
      }
    };

    window.handleSolicitadoChange = (prefix) => {
      const orgSelect = document.getElementById(`${prefix}-org`);
      const subContainer = document.getElementById(`${prefix}-org-sub`);
      const subInput = document.getElementById(`${prefix}-org-sub-input`);
      const subSelect = document.getElementById(`${prefix}-org-sub-select`);

      if (subContainer) {
        subContainer.style.display = 'block';
        subInput.style.display = 'none';
        subSelect.style.display = 'none';
        subInput.value = '';

        switch (orgSelect.value) {
          case 'Ayuntamiento':
            subInput.placeholder = "Indica quÃ© ayuntamiento...";
            subInput.style.display = 'block';
            break;
          case 'Cruz Roja':
            subInput.placeholder = "Indica quiÃ©n dentro de Cruz Roja...";
            subInput.style.display = 'block';
            break;
          case 'Otro':
            subInput.placeholder = "Indica el organismo o persona...";
            subInput.style.display = 'block';
            break;
          case 'Jefe de Operaciones':
            subSelect.style.display = 'block';
            break;
          default:
            subContainer.style.display = 'none';
            break;
        }
      }
    }

    window.parseSolicitadoData = (prefix) => {
      const mainVal = document.getElementById(`${prefix}-org`).value;
      if (mainVal === '112' || mainVal === '061' || !mainVal) return mainVal;

      if (mainVal === 'Jefe de Operaciones') {
        return `Jefe de Operaciones - ${document.getElementById(`${prefix}-org-sub-select`).value}`;
      } else if (mainVal === 'Otro') {
        const sub = document.getElementById(`${prefix}-org-sub-input`).value.trim();
        return sub ? `Otro - ${sub}` : mainVal;
      } else {
        const sub = document.getElementById(`${prefix}-org-sub-input`).value.trim();
        return sub ? `${mainVal} - ${sub}` : mainVal;
      }
    }

    window.parseTipoData = (prefix) => {
      const mainVal = document.getElementById(`${prefix}-tipo`).value;
      if (mainVal === 'otro') {
        const subVal = document.getElementById(`${prefix}-tipo-otro`).value.trim();
        return subVal ? subVal : 'otro';
      }
      return mainVal;
    }

    // â”€â”€ MODAL NUEVA OPERACIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.abrirModalOp = () => {
      ensureAutocomplete();
      document.getElementById('overlay-op').classList.add('open');
      setTimeout(() => document.getElementById('f-nombre').focus(), 100);
      mostrarCoordBox();
      handleSolicitadoChange('f');

      // LÃ³gica de provincia segÃºn usuario
      const provRow = document.getElementById('f-provincia-row');
      const provSel = document.getElementById('f-provincia');
      if (currentUserDoc.provincia && currentUserDoc.provincia !== 'AndalucÃ­a') {
        provRow.style.display = 'none';
        provSel.value = currentUserDoc.provincia;
      } else {
        provRow.style.display = 'block';
        provSel.value = selectedProvincia; // Por defecto la que tiene filtrada en el header
      }
    };

    window.cerrarModalOp = () => {
      document.getElementById('overlay-op').classList.remove('open');
      pickedCoords = null;
      pickedAddress = '';
      if (tempGmMarker) { tempGmMarker.setMap(null); tempGmMarker = null; }
      ['f-nombre', 'f-desc', 'f-loc', 'f-org-sub-input', 'f-lugar', 'f-tipo-otro'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      document.getElementById('f-tipo').value = 'inundacion';
      handleTipoChange('f');
      document.getElementById('f-nivel').value = '3';
      document.getElementById('f-dir').value = 'Julio Pulido Morilla';
      document.getElementById('f-org').value = '112';
      document.getElementById('coord-box').classList.remove('show');
    };

    window.crearOp = async () => {
      const nombre = document.getElementById('f-nombre').value.trim();
      if (!nombre) { document.getElementById('f-nombre').focus(); return; }
      const btn = document.getElementById('btn-crear-op');
      btn.disabled = true; btn.textContent = 'Creandoâ€¦';
      try {
        const nivel = parseInt(document.getElementById('f-nivel').value);
        const desc = document.getElementById('f-desc').value.trim();
        const locVal = document.getElementById('f-lugar').value.trim() || document.getElementById('f-loc').value.trim();
        const autorNombre = currentUserDoc.nombre || currentUser.email;
        const provincia = document.getElementById('f-provincia').value;

        const orgFinal = parseSolicitadoData('f');
        const tipoFinal = parseTipoData('f');

        const ref = await addDoc(collection(db, 'operaciones'), {
          nombre,
          tipo: tipoFinal,
          nivel,
          loc: locVal,
          provincia,
          dir: document.getElementById('f-dir').value,
          org: orgFinal,
          coords: pickedCoords || null,
          creadoPor: currentUser.uid,
          creadoPorNombre: autorNombre,
          creadoEn: serverTimestamp(),
          actualizadoEn: serverTimestamp(),
          estado: 'activa'
        });
        if (desc) {
          await addDoc(collection(db, 'operaciones', ref.id, 'acciones'), {
            texto: desc,
            prioridad: nivel <= 2 ? 'CrÃ­tica' : nivel === 3 ? 'Alta' : 'Media',
            autor: autorNombre,
            uid: currentUser.uid,
            timestamp: serverTimestamp()
          });
        }
        cerrarModalOp();
        window.abrirDetalle(ref.id);
      } catch (e) { alert('Error: ' + e.message); }
      btn.disabled = false; btn.textContent = 'Crear operaciÃ³n â†’';
    };

    // â”€â”€ MODAL EDITAR OPERACIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.abrirModalEditOp = () => {
      if (!selOpId) return;
      ensureAutocompleteEdit();
      const op = ops[selOpId];
      if (!op) return;

      // Poblar campos con datos actuales
      document.getElementById('fe-nombre').value = op.nombre || '';
      document.getElementById('fe-provincia').value = op.provincia || 'AndalucÃ­a';

      const selectTipo = document.getElementById('fe-tipo');
      const opsTipo = Array.from(selectTipo.options).map(o => o.value);
      if (opsTipo.includes(op.tipo)) {
        selectTipo.value = op.tipo;
        document.getElementById('fe-tipo-otro').value = '';
      } else {
        selectTipo.value = 'otro';
        document.getElementById('fe-tipo-otro').value = op.tipo || '';
      }
      handleTipoChange('fe');

      document.getElementById('fe-lugar').value = op.loc || '';

      if (op.creadoEn?.toDate) {
        const d = op.creadoEn.toDate();
        const yy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        const hh = String(d.getHours()).padStart(2, '0');
        const mn = String(d.getMinutes()).padStart(2, '0');
        document.getElementById('fe-fecha').value = `${yy}-${mm}-${dd}T${hh}:${mn}`;
      } else {
        document.getElementById('fe-fecha').value = '';
      }

      // Jefe de operaciones
      const optionsDir = Array.from(document.getElementById('fe-dir').options).map(o => o.value);
      if (optionsDir.includes(op.dir)) {
        document.getElementById('fe-dir').value = op.dir;
      } else {
        document.getElementById('fe-dir').value = 'Julio Pulido Morilla'; // fallback si existÃ­a un texto libre
      }

      // Solicitado por
      const orgSelect = document.getElementById('fe-org');
      const orgSubInput = document.getElementById('fe-org-sub-input');
      const orgSubSelect = document.getElementById('fe-org-sub-select');

      orgSubInput.value = '';
      orgSubSelect.value = 'Julio Pulido Morilla';

      if (!op.org) {
        orgSelect.value = '112';
      } else if (op.org.startsWith('Jefe de Operaciones - ')) {
        orgSelect.value = 'Jefe de Operaciones';
        orgSubSelect.value = op.org.replace('Jefe de Operaciones - ', '');
      } else if (op.org.startsWith('Ayuntamiento - ')) {
        orgSelect.value = 'Ayuntamiento';
        orgSubInput.value = op.org.replace('Ayuntamiento - ', '');
      } else if (op.org.startsWith('Cruz Roja - ')) {
        orgSelect.value = 'Cruz Roja';
        orgSubInput.value = op.org.replace('Cruz Roja - ', '');
      } else {
        // Si era texto libre anterior o coincide con opciones base
        const optionsOrg = Array.from(orgSelect.options).map(o => o.value);
        if (optionsOrg.includes(op.org)) {
          orgSelect.value = op.org;
        } else {
          orgSelect.value = '112'; // fallback base
        }
      }
      handleSolicitadoChange('fe');

      // Restaurar coords actuales como punto de partida
      editPickedCoords = op.coords || null;
      editPickedAddress = op.loc || '';
      mostrarEditCoordBox();

      document.getElementById('overlay-edit-op').classList.add('open');
      setTimeout(() => document.getElementById('fe-nombre').focus(), 100);

      // LÃ³gica de provincia en ediciÃ³n
      const provRow = document.getElementById('fe-provincia-row');
      if (currentUserDoc.provincia && currentUserDoc.provincia !== 'AndalucÃ­a') {
        provRow.style.display = 'none';
      } else {
        provRow.style.display = 'block';
      }
    };

    window.cerrarModalEditOp = () => {
      document.getElementById('overlay-edit-op').classList.remove('open');
      editPickedCoords = null;
      editPickedAddress = '';
      if (editTempGmMarker) { editTempGmMarker.setMap(null); editTempGmMarker = null; }
      document.getElementById('edit-coord-box').classList.remove('show');
    };

    window.guardarEditOp = async () => {
      if (!selOpId) return;
      const nombre = document.getElementById('fe-nombre').value.trim();
      if (!nombre) { document.getElementById('fe-nombre').focus(); return; }
      const btn = document.getElementById('btn-guardar-edit-op');
      btn.disabled = true; btn.textContent = 'Guardandoâ€¦';
      try {
        const locVal = document.getElementById('fe-lugar').value.trim();
        const orgFinal = parseSolicitadoData('fe');

        const valFecha = document.getElementById('fe-fecha').value;
        const tsCreado = valFecha ? new Date(valFecha) : new Date();
        const tipoFinal = parseTipoData('fe');

        const updates = {
          nombre,
          tipo: tipoFinal,
          loc: locVal,
          dir: document.getElementById('fe-dir').value,
          org: orgFinal,
          provincia: document.getElementById('fe-provincia').value,
          creadoEn: tsCreado,
          actualizadoEn: serverTimestamp()
        };
        // Solo actualizar coords si el usuario eligiÃ³ una nueva ubicaciÃ³n
        if (editPickedCoords) updates.coords = editPickedCoords;

        await updateDoc(doc(db, 'operaciones', selOpId), updates);

        // Actualizar marcador del mapa si cambiaron coordenadas
        if (editPickedCoords && gmMarkers[selOpId]) {
          const tipo = TIPOS[updates.tipo] || TIPOS.otro;
          gmMarkers[selOpId].position = editPickedCoords;
          gmMarkers[selOpId].content = nivelIcon(ops[selOpId].nivel, tipo.emoji, false, false, ops[selOpId].recursosSummary);
        }

        mostrarToast('OperaciÃ³n actualizada.');
        cerrarModalEditOp();
      } catch (e) { alert('Error: ' + e.message); }
      btn.disabled = false; btn.textContent = 'Guardar cambios â†’';
    };

    // â”€â”€ SECTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.showSection = sec => {
      document.querySelectorAll('.nav-item').forEach(b => b.classList.toggle('on', b.dataset.sec === sec));
      document.getElementById('section-operaciones').style.display = sec === 'operaciones' ? 'flex' : 'none';
      document.getElementById('section-usuarios').style.display = sec === 'usuarios' ? 'flex' : 'none';
      if (document.getElementById('section-tablas')) {
        document.getElementById('section-tablas').style.display = sec === 'tablas' ? 'flex' : 'none';
      }

      if (sec === 'usuarios') suscribirUsuarios();
      if (sec === 'tablas' && typeof window.showTablaMaestra === 'function') {
        window.showTablaMaestra('vehiculos');
      }
      if (sec === 'operaciones' && gmap) setTimeout(() => google.maps.event.trigger(gmap, 'resize'), 100);
    };

    let unsubUsuarios = null;
    function suscribirUsuarios() {
      if (unsubUsuarios) unsubUsuarios();
      unsubUsuarios = onSnapshot(collection(db, 'users'), snap => {
        const tbody = document.getElementById('users-tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        const now = Date.now();
        const twoHours = 2 * 60 * 60 * 1000;

        const adminProv = currentUserDoc.provincia || 'AndalucÃ­a';

        snap.forEach(d => {
          const u = d.data();

          // Filtrado por Ã¡mbito del administrador
          if (adminProv !== 'AndalucÃ­a' && u.provincia !== adminProv) return;

          // Filtrado por jerarquÃ­a de roles
          if (currentRole === 'manager') {
            // Un Administrador sÃ³lo puede ver Responsables y Usuarios
            if (u.role !== 'admin' && u.role !== 'usuario') return;
          }

          const lastAct = u.ultimaActividad?.toMillis ? u.ultimaActividad.toMillis() : 0;
          const isRecentlyActive = (now - lastAct) < twoHours;
          const isOnline = u.enLinea === true && isRecentlyActive;

          const tr = document.createElement('tr');
          tr.innerHTML = `
          <td>
            <div style="display:flex; align-items:center; gap:8px;">
              <div style="width:10px; height:10px; border-radius:50%; background:${isOnline ? '#2ecc71' : '#e74c3c'}; border:1px solid rgba(0,0,0,0.1);" title="${isOnline ? 'En lÃ­nea' : 'Desconectado'}"></div>
              ${u.nombre || 'â€”'}
            </div>
          </td>
          <td style="font-family:'IBM Plex Mono',monospace;font-size:12px;">${u.email}</td>
          <td>
            <div style="display:flex; flex-direction:column; gap:2px;">
              <span class="rol-badge rol-${u.role}">${ROL_LABELS[u.role] || u.role}</span>
              <span style="font-size:10px; color:var(--text-3); font-weight:600;">${u.provincia || 'â€”'}</span>
            </div>
          </td>
          <td><span class="activo-badge ${u.activo !== false ? 'activo' : 'inactivo'}">${u.activo !== false ? 'Activo' : 'Inactivo'}</span></td>
          <td>
            <button class="tbl-btn" onclick="editarUsuario('${d.id}')">Editar</button>
            <button class="tbl-btn" onclick="abrirLogUsuario('${d.id}', '${u.nombre || u.email}')">Log</button>
            ${d.id !== currentUser.uid
              ? `<button class="tbl-btn danger" onclick="borrarUsuario('${d.id}')">Desactivar</button>`
              : '<span style="font-size:11px;color:var(--text-4)">(tÃº)</span>'}
          </td>`;
          tbody.appendChild(tr);
        });
      });
    }

    function cargarOpcionesRoles(selId) {
      const sel = document.getElementById(selId);
      sel.innerHTML = '';

      const rolesParaAdmin = [
        { val: 'usuario', lab: ROL_LABELS.usuario },
        { val: 'admin', lab: ROL_LABELS.admin }
      ];
      const rolesCompletos = [
        { val: 'usuario', lab: ROL_LABELS.usuario },
        { val: 'admin', lab: ROL_LABELS.admin },
        { val: 'manager', lab: ROL_LABELS.manager },
        { val: 'super_admin', lab: ROL_LABELS.super_admin }
      ];

      const lista = currentRole === 'super_admin' ? rolesCompletos : rolesParaAdmin;
      lista.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.val;
        opt.textContent = r.lab;
        sel.appendChild(opt);
      });
    }

    window.abrirModalUsuario = () => {
      editingUserId = null;
      document.getElementById('modal-user-title').textContent = 'Nuevo usuario';
      ['u-nombre', 'u-email', 'u-pass'].forEach(id => document.getElementById(id).value = '');

      cargarOpcionesRoles('u-role');
      document.getElementById('u-role').value = 'usuario';

      const provSel = document.getElementById('u-provincia');
      const adminProv = currentUserDoc.provincia || 'AndalucÃ­a';

      if (adminProv !== 'AndalucÃ­a') {
        provSel.value = adminProv;
        provSel.disabled = true;
      } else {
        provSel.value = 'AndalucÃ­a';
        provSel.disabled = false;
      }

      document.getElementById('u-activo').value = 'true';
      document.getElementById('u-pass-row').style.display = 'flex';
      document.getElementById('overlay-user').classList.add('open');
      document.getElementById('u-nombre').focus();
    };

    let unsubUserLog = null;
    window.abrirLogUsuario = (uid, nombre) => {
      document.getElementById('log-user-name').textContent = nombre;
      const tbody = document.getElementById('log-tbody');
      tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;padding:20px;">Cargando historial...</td></tr>';

      const q = query(collection(db, 'users', uid, 'sessions'), orderBy('timestamp', 'desc'));
      if (unsubUserLog) unsubUserLog();

      unsubUserLog = onSnapshot(q, snap => {
        tbody.innerHTML = '';
        if (snap.empty) {
          tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;padding:20px;color:var(--text-4);">No hay registros de sesiÃ³n.</td></tr>';
          return;
        }
        snap.forEach(doc => {
          const s = doc.data();
          const ts = s.timestamp?.toDate ? s.timestamp.toDate().toLocaleString('es-ES') : 'â€”';
          const tipo = s.tipo === 'entrada' ? 'ğŸŸ¢ Entrada (Login)' : 'ğŸ”´ Salida (Logout)';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="font-family:'IBM Plex Mono',monospace;">${ts}</td>
            <td style="font-weight:600;">${tipo}</td>
          `;
          tbody.appendChild(tr);
        });
      });
      document.getElementById('overlay-user-log').classList.add('open');
    };

    window.cerrarLogUsuario = () => {
      document.getElementById('overlay-user-log').classList.remove('open');
      if (unsubUserLog) { unsubUserLog(); unsubUserLog = null; }
    };

    window.editarUsuario = async uid => {
      const snap = await getDoc(doc(db, 'users', uid));
      if (!snap.exists()) return;
      const u = snap.data();
      editingUserId = uid;
      document.getElementById('modal-user-title').textContent = 'Editar usuario';
      document.getElementById('u-nombre').value = u.nombre || '';
      document.getElementById('u-email').value = u.email || '';

      cargarOpcionesRoles('u-role');
      document.getElementById('u-role').value = u.role || 'usuario';

      const provSel = document.getElementById('u-provincia');
      const adminProv = currentUserDoc.provincia || 'AndalucÃ­a';
      provSel.value = u.provincia || 'AndalucÃ­a';

      if (adminProv !== 'AndalucÃ­a') {
        provSel.disabled = true;
      } else {
        provSel.disabled = false;
      }

      document.getElementById('u-activo').value = u.activo === false ? 'false' : 'true';
      document.getElementById('u-pass-row').style.display = 'none';
      document.getElementById('overlay-user').classList.add('open');
    };

    window.cerrarModalUsuario = () => {
      document.getElementById('overlay-user').classList.remove('open');
      editingUserId = null;
    };

    window.guardarUsuario = async () => {
      const nombre = document.getElementById('u-nombre').value.trim();
      const email = document.getElementById('u-email').value.trim();
      const pass = document.getElementById('u-pass').value;
      const role = document.getElementById('u-role').value;
      const provincia = document.getElementById('u-provincia').value;
      const activo = document.getElementById('u-activo').value === 'true';
      if (!nombre || !email) { alert('Nombre y email son obligatorios.'); return; }
      const btn = document.getElementById('btn-guardar-user');
      btn.disabled = true; btn.textContent = 'Guardandoâ€¦';
      try {
        if (editingUserId) {
          await updateDoc(doc(db, 'users', editingUserId), { nombre, role, provincia, activo });
          mostrarToast('Usuario actualizado.');
        } else {
          if (!pass || pass.length < 6) { alert('La contraseÃ±a debe tener al menos 6 caracteres.'); btn.disabled = false; btn.textContent = 'Guardar'; return; }
          const res = await fetch(
            `https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=__FIREBASE_API_KEY__`,
            {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, password: pass, returnSecureToken: true })
            }
          );
          const data = await res.json();
          if (data.error) throw new Error(data.error.message);
          await setDoc(doc(db, 'users', data.localId), {
            nombre, email, role, provincia, activo,
            creadoPor: currentUser.uid,
            creadoEn: serverTimestamp()
          });
          mostrarToast('Usuario creado.');
        }
        cerrarModalUsuario();
      } catch (e) { alert('Error: ' + e.message); }
      btn.disabled = false; btn.textContent = 'Guardar';
    };

    window.borrarUsuario = async uid => {
      if (!confirm('Â¿Desactivar este usuario?')) return;
      await updateDoc(doc(db, 'users', uid), { activo: false });
      mostrarToast('Usuario desactivado.');
    };

    // â”€â”€ TABLAS MAESTRAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.showTablaMaestra = (tabla) => {
      document.querySelectorAll('#tablas-subnav .ftab').forEach(b => b.classList.remove('on'));
      const activeBtn = document.getElementById(`subnav-${tabla}`);
      if (activeBtn) activeBtn.classList.add('on');

      const contVeh = document.getElementById('tabla-vehiculos-container');
      if (contVeh) contVeh.style.display = tabla === 'vehiculos' ? 'flex' : 'none';

      if (tabla === 'vehiculos') cargarVehiculos();
    };

    window.changeProvincia = (val) => {
      selectedProvincia = val;
      renderSidebar();
      renderMapa();
      actualizarContadores();
      if (typeof cargarVehiculos === 'function') cargarVehiculos();
    };

    let editingVehiculoId = null;

    async function cargarVehiculos() {
      const snap = await getDocs(collection(db, 'vehiculos'));
      const tbody = document.getElementById('vehiculos-tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      const allVehs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      // Filtrado por Ã¡mbito (con fallback a MÃ¡laga)
      const visible = allVehs.filter(v => {
        const prov = v.provincia || 'MÃ¡laga';
        return selectedProvincia === 'AndalucÃ­a' || prov === selectedProvincia;
      });

      visible.forEach(v => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${v.indicativo || 'â€”'}</strong></td>
          <td style="font-family:'IBM Plex Mono',monospace;font-size:12px;">${v.matricula || 'â€”'}</td>
          <td>${v.tipo || 'â€”'}</td>
          <td style="font-size:11px; color:var(--text-3);">${v.provincia || 'MÃ¡laga'}</td>
          <td>
            <button class="tbl-btn" onclick="editarVehiculo('${v.id}')">Editar</button>
            <button class="tbl-btn danger" onclick="borrarVehiculo('${v.id}')">Eliminar</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    window.abrirModalVehiculo = () => {
      editingVehiculoId = null;
      document.getElementById('modal-vehiculo-title').textContent = 'Nuevo vehÃ­culo';
      ['v-indicativo', 'v-matricula'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      document.getElementById('v-tipo').value = 'CamiÃ³n';

      const provRow = document.getElementById('v-prov-row');
      const provSel = document.getElementById('v-provincia');
      if (currentUserDoc.provincia && currentUserDoc.provincia !== 'AndalucÃ­a') {
        provRow.style.display = 'none';
        provSel.value = currentUserDoc.provincia;
      } else {
        provRow.style.display = 'block';
        provSel.value = selectedProvincia === 'AndalucÃ­a' ? 'AndalucÃ­a' : selectedProvincia;
      }

      document.getElementById('overlay-vehiculo').classList.add('open');
      setTimeout(() => document.getElementById('v-indicativo').focus(), 100);
    };

    window.editarVehiculo = async id => {
      const snap = await getDoc(doc(db, 'vehiculos', id));
      if (!snap.exists()) return;
      const v = snap.data();
      editingVehiculoId = id;
      document.getElementById('modal-vehiculo-title').textContent = 'Editar vehÃ­culo';
      document.getElementById('v-indicativo').value = v.indicativo || '';
      document.getElementById('v-matricula').value = v.matricula || '';
      document.getElementById('v-tipo').value = v.tipo || 'CamiÃ³n';

      const provRow = document.getElementById('v-prov-row');
      const provSel = document.getElementById('v-provincia');
      provSel.value = v.provincia || 'MÃ¡laga';
      if (currentUserDoc.provincia && currentUserDoc.provincia !== 'AndalucÃ­a') {
        provRow.style.display = 'none';
      } else {
        provRow.style.display = 'block';
      }

      document.getElementById('overlay-vehiculo').classList.add('open');
      setTimeout(() => document.getElementById('v-indicativo').focus(), 100);
    };

    window.cerrarModalVehiculo = () => {
      document.getElementById('overlay-vehiculo').classList.remove('open');
      editingVehiculoId = null;
    };

    window.guardarVehiculo = async () => {
      const indicativo = document.getElementById('v-indicativo').value.trim();
      const matricula = document.getElementById('v-matricula').value.trim();
      const tipo = document.getElementById('v-tipo').value;
      if (!indicativo || !matricula) { alert('Indicativo y matrÃ­cula son obligatorios.'); return; }

      const btn = document.getElementById('btn-guardar-vehiculo');
      btn.disabled = true; btn.textContent = 'Guardandoâ€¦';
      try {
        const provincia = document.getElementById('v-provincia').value;
        if (editingVehiculoId) {
          await updateDoc(doc(db, 'vehiculos', editingVehiculoId), {
            indicativo, matricula, tipo, provincia, actualizadoEn: serverTimestamp()
          });
          mostrarToast('VehÃ­culo actualizado.');
        } else {
          await addDoc(collection(db, 'vehiculos'), {
            indicativo, matricula, tipo, provincia,
            creadoPor: currentUser.uid,
            creadoEn: serverTimestamp(),
            actualizadoEn: serverTimestamp()
          });
          mostrarToast('VehÃ­culo creado.');
        }
        cerrarModalVehiculo();
        cargarVehiculos();
      } catch (e) { alert('Error: ' + e.message); }
      btn.disabled = false; btn.textContent = 'Guardar';
    };

    window.borrarVehiculo = async id => {
      if (!confirm('Â¿Eliminar este vehÃ­culo de forma permanente?')) return;
      try {
        await deleteDoc(doc(db, 'vehiculos', id));
        mostrarToast('VehÃ­culo eliminado.');
        cargarVehiculos();
      } catch (e) { alert('Error al eliminar: ' + e.message); }
    };

    // â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function mostrarToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    function mostrarLogin() {
      document.getElementById('screen-login').style.display = 'flex';
      document.getElementById('screen-app').style.display = 'none';
    }
    function mostrarApp() {
      document.getElementById('screen-login').style.display = 'none';
      document.getElementById('screen-app').style.display = 'flex';
    }
    function mostrarLoginErr(msg) {
      const el = document.getElementById('err-login');
      el.textContent = msg; el.style.display = 'block';
    }

    // â”€â”€ TECLADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        window.cerrarModalOp();
        window.cerrarModalEditOp();
        window.cerrarDetalle();
        window.cerrarModalUsuario();
        if (window.cerrarModalVehiculo) window.cerrarModalVehiculo();
        if (picking) stopPick();
        if (editPickMode) stopEditPick();
      }
    });
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('l-pass')?.addEventListener('keydown', e => {
        if (e.key === 'Enter') window.doLogin();
      });
    });
  </script>

  <!-- Google Maps se carga dinÃ¡micamente desde el script superior -->

  <style>
    :root {
      --bg: #f4f2ee;
      --bg-1: #fff;
      --bg-2: #f9f8f5;
      --bg-3: #eeece7;
      --bg-4: #e5e2da;
      --text-1: #1a1814;
      --text-2: #5c5848;
      --text-3: #9c9486;
      --text-4: #c8c0b2;
      --border: rgba(0, 0, 0, 0.08);
      --border-mid: rgba(0, 0, 0, 0.14);
      --border-dark: rgba(0, 0, 0, 0.22);
      --crit-1: #1a7a4a;
      --crit-1-bg: #f0faf4;
      --crit-1-border: #a8d8bc;
      --crit-2: #c08c00;
      --crit-2-bg: #fefbee;
      --crit-2-border: #eadb94;
      --crit-3: #d35400;
      --crit-3-bg: #fef5ee;
      --crit-3-border: #f0c8a0;
      --crit-4: #c0392b;
      --crit-4-bg: #fdf1f0;
      --crit-4-border: #e8b4b0;
      --accent: #1a3a6e;
      --accent-lt: #eaf0fb;
      --shadow-sm: 0 1px 4px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.10);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.14);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'IBM Plex Sans', sans-serif;
      background: var(--bg);
      color: var(--text-1);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      font-size: 14px;
    }

    /* LOGIN */
    #screen-login {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: var(--bg);
    }

    .login-card {
      background: var(--bg-1);
      border: 1px solid var(--border-dark);
      border-radius: 4px;
      padding: 40px;
      width: 380px;
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .login-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .login-icon {
      width: 40px;
      height: 40px;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 20px;
      border-radius: 2px;
    }

    .login-title {
      font-family: 'Fraunces', serif;
      font-size: 22px;
      font-weight: 700;
      color: var(--accent);
    }

    .login-sub {
      font-size: 9px;
      font-weight: 600;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text-3);
    }

    .login-field {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .login-lbl {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-3);
    }

    .login-input {
      background: var(--bg-2);
      border: 1px solid var(--border-mid);
      color: var(--text-1);
      padding: 9px 12px;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 14px;
      outline: none;
      border-radius: 2px;
      transition: border-color 0.12s;
    }

    .login-input:focus {
      border-color: var(--accent);
    }

    .btn-login {
      padding: 11px;
      background: var(--accent);
      border: none;
      color: #fff;
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 14px;
      font-weight: 600;
      border-radius: 2px;
      transition: background 0.12s;
    }

    .btn-login:hover {
      background: #253d6e;
    }

    .btn-login:disabled {
      background: var(--text-4);
      cursor: not-allowed;
    }

    .login-err {
      font-size: 12px;
      color: var(--crit-1);
      background: var(--crit-1-bg);
      border: 1px solid var(--crit-1-border);
      padding: 8px 12px;
      border-radius: 2px;
      display: none;
    }

    /* APP */
    #screen-app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* HEADER */
    header {
      height: 54px;
      background: var(--bg-1);
      border-bottom: 1px solid var(--border-mid);
      display: flex;
      align-items: center;
      padding: 0 18px;
      gap: 14px;
      flex-shrink: 0;
      box-shadow: var(--shadow-sm);
      z-index: 200;
    }

    .logo-mark {
      display: flex;
      align-items: center;
      gap: 9px;
      flex-shrink: 0;
    }

    .logo-icon {
      width: 30px;
      height: 30px;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 15px;
      border-radius: 2px;
    }

    .logo-text {
      font-family: 'Fraunces', serif;
      font-size: 17px;
      font-weight: 700;
      color: var(--accent);
    }

    .logo-sub {
      font-size: 8px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-3);
    }

    .hdr-div {
      width: 1px;
      height: 26px;
      background: var(--border-mid);
      flex-shrink: 0;
    }

    .nivel-indicators {
      display: flex;
      gap: 5px;
    }

    .nivel-chip {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 3px 9px;
      border-radius: 2px;
      border: 1px solid;
    }

    .nivel-chip-val {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 14px;
      font-weight: 500;
    }

    .nivel-chip-lbl {
      font-size: 8px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .chip-n1 {
      background: var(--crit-1-bg);
      border-color: var(--crit-1-border);
      color: var(--crit-1);
    }

    .chip-n2 {
      background: var(--crit-2-bg);
      border-color: var(--crit-2-border);
      color: var(--crit-2);
    }

    .chip-n3 {
      background: var(--crit-3-bg);
      border-color: var(--crit-3-border);
      color: var(--crit-3);
    }

    .chip-n4 {
      background: var(--crit-4-bg);
      border-color: var(--crit-4-border);
      color: var(--crit-4);
    }

    .hdr-right {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: auto;
      flex-shrink: 0;
    }

    .hdr-user-info {
      text-align: right;
    }

    .hdr-user-name {
      font-size: 13px;
      font-weight: 600;
    }

    .hdr-user-role {
      font-size: 10px;
      color: var(--text-3);
    }

    .live-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #27ae60;
      box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.25);
      animation: livepulse 2.5s infinite;
    }

    @keyframes livepulse {

      0%,
      100% {
        box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.25)
      }

      50% {
        box-shadow: 0 0 0 5px rgba(39, 174, 96, 0.1)
      }
    }

    .clock {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 12px;
      color: var(--text-2);
    }

    .btn-nueva {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--accent);
      color: #fff;
      border: none;
      cursor: pointer;
      padding: 7px 14px;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 12px;
      font-weight: 600;
      border-radius: 2px;
      white-space: nowrap;
      transition: background 0.12s;
    }

    .btn-nueva:hover {
      background: #253d6e;
    }

    .btn-logout {
      padding: 6px 12px;
      background: transparent;
      border: 1px solid var(--border-mid);
      color: var(--text-3);
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 11px;
      border-radius: 2px;
      transition: all 0.12s;
    }

    .btn-logout:hover {
      border-color: var(--border-dark);
      color: var(--text-1);
    }

    /* NAV */
    .app-nav {
      display: flex;
      border-bottom: 1px solid var(--border-mid);
      background: var(--bg-1);
      flex-shrink: 0;
      padding: 0 18px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-3);
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.12s;
      margin-bottom: -1px;
    }

    .nav-item:hover {
      color: var(--text-1);
    }

    .nav-item.on {
      color: var(--accent);
      border-bottom-color: var(--accent);
      font-weight: 600;
    }

    /* SECTIONS */
    #section-operaciones {
      flex: 1;
      overflow: hidden;
      display: flex;
    }

    #section-usuarios,
    #section-tablas {
      flex: 1;
      overflow: hidden;
      display: none;
      flex-direction: column;
      padding: 24px;
      gap: 16px;
      background: var(--bg);
    }

    /* SIDEBAR */
    .panel-left {
      width: 320px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      background: var(--bg-1);
      border-right: 1px solid var(--border-mid);
    }

    .panel-left-head {
      padding: 12px 14px 10px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .section-label {
      font-size: 9px;
      font-weight: 600;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text-3);
      margin-bottom: 8px;
    }

    .filter-tabs {
      display: flex;
      border: 1px solid var(--border-mid);
      border-radius: 2px;
      overflow: hidden;
    }

    .ftab {
      flex: 1;
      padding: 5px 4px;
      background: var(--bg-2);
      border: none;
      border-right: 1px solid var(--border);
      color: var(--text-3);
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 11px;
      font-weight: 600;
      transition: all 0.12s;
    }

    .ftab:last-child {
      border-right: none;
    }

    .ftab.on {
      background: var(--bg-1);
      color: var(--text-1);
    }

    .ftab.on-n1 {
      background: var(--crit-1-bg);
      color: var(--crit-1);
    }

    .ftab.on-n2 {
      background: var(--crit-2-bg);
      color: var(--crit-2);
    }

    .ftab.on-n3 {
      background: var(--crit-3-bg);
      color: var(--crit-3);
    }

    .ftab.on-n4 {
      background: var(--crit-4-bg);
      color: var(--crit-4);
    }

    .ops-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .ops-list::-webkit-scrollbar {
      width: 3px;
    }

    .ops-list::-webkit-scrollbar-thumb {
      background: var(--bg-4);
    }

    .empty-msg {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      gap: 8px;
      color: var(--text-4);
      text-align: center;
      font-size: 12px;
    }

    .empty-msg.show {
      display: flex;
    }

    .op-card {
      background: var(--bg-1);
      border: 1px solid var(--border-mid);
      border-left: 4px solid transparent;
      padding: 10px 12px;
      cursor: pointer;
      transition: all 0.12s;
      border-radius: 0 2px 2px 0;
      box-shadow: var(--shadow-sm);
    }

    .op-card:hover {
      box-shadow: var(--shadow-md);
    }

    .op-card.sel {
      background: var(--accent-lt);
    }

    .op-card[data-nivel="1"] {
      border-left-color: var(--crit-1);
    }

    .op-card[data-nivel="2"] {
      border-left-color: var(--crit-2);
    }

    .op-card[data-nivel="3"] {
      border-left-color: var(--crit-3);
    }

    .op-card[data-nivel="4"] {
      border-left-color: var(--crit-4);
      background: var(--crit-4-bg);
    }

    .card-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 5px;
    }

    .card-id {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 9px;
      color: var(--text-3);
      margin-bottom: 2px;
    }

    .card-name {
      font-size: 13px;
      font-weight: 600;
      line-height: 1.2;
    }

    .card-type-tag {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 10px;
      white-space: nowrap;
      flex-shrink: 0;
      border: 1px solid;
    }

    .card-badge {
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid var(--bg-1);
    }

    .new-badge {
      top: -8px;
      right: -8px;
      background: #e74c3c;
      box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.4);
      animation: pulseAlert 1.5s infinite;
    }

    .update-badge {
      top: -8px;
      left: -8px;
      background: #2980b9;
    }

    .op-card.is-new {
      background: #fffafa;
      border-color: #e8b4b0;
    }

    @keyframes pulseAlert {
      0% {
        box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
      }

      70% {
        box-shadow: 0 0 0 6px rgba(231, 76, 60, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
      }
    }

    .card-meta {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-3);
    }

    .nivel-pill {
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: 2px;
      border: 1px solid;
    }

    .pill-1 {
      background: var(--crit-1-bg);
      color: var(--crit-1);
      border-color: var(--crit-1-border);
    }

    .pill-2 {
      background: var(--crit-2-bg);
      color: var(--crit-2);
      border-color: var(--crit-2-border);
    }

    .pill-3 {
      background: var(--crit-3-bg);
      color: var(--crit-3);
      border-color: var(--crit-3-border);
    }

    .pill-4 {
      background: var(--crit-4-bg);
      color: var(--crit-4);
      border-color: var(--crit-4-border);
    }

    /* MAP */
    .map-zone {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .pick-banner {
      display: none;
      position: absolute;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      padding: 9px 20px;
      z-index: 600;
      border-radius: 2px;
      box-shadow: var(--shadow-lg);
      pointer-events: none;
      animation: blinkS 1.4s infinite;
    }

    @keyframes blinkS {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0.7
      }
    }

    .pick-banner.on {
      display: block;
    }

    /* DETAIL PANEL */
    .detail-panel {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 370px;
      background: var(--bg-1);
      border-right: 1px solid var(--border-dark);
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      z-index: 500;
      transform: translateX(-100%);
      transition: transform 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .detail-panel.open {
      transform: translateX(0);
    }

    .dp-header {
      padding: 10px 16px 6px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .dp-scope-title {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 4px;
      opacity: 0.8;
    }

    .dp-top-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .dp-id {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 9px;
      color: var(--text-3);
      margin-bottom: 2px;
    }

    .dp-name {
      font-family: 'Fraunces', serif;
      font-size: 18px;
      font-weight: 700;
      line-height: 1.1;
    }

    .btn-close-dp {
      background: var(--bg-3);
      border: 1px solid var(--border-mid);
      color: var(--text-3);
      cursor: pointer;
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      flex-shrink: 0;
      border-radius: 2px;
    }

    .btn-close-dp:hover {
      background: var(--bg-4);
      color: var(--text-1);
    }

    .dp-chips {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .dp-loc {
      font-size: 12px;
      color: var(--text-2);
      font-weight: 500;
    }

    .nivel-selector {
      display: flex;
      border: 1px solid var(--border-mid);
      border-radius: 2px;
      overflow: hidden;
    }

    .nsel-opt {
      padding: 4px 8px;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      cursor: pointer;
      background: var(--bg-2);
      border: none;
      border-right: 1px solid var(--border);
      color: var(--text-3);
      font-family: 'IBM Plex Sans', sans-serif;
    }

    .nsel-opt:last-child {
      border-right: none;
    }

    .nsel-opt:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }

    .nsel-opt[data-n="1"].on {
      background: var(--crit-1-bg);
      color: var(--crit-1);
    }

    .nsel-opt[data-n="2"].on {
      background: var(--crit-2-bg);
      color: var(--crit-2);
    }

    .nsel-opt[data-n="3"].on {
      background: var(--crit-3-bg);
      color: var(--crit-3);
    }

    .nsel-opt[data-n="4"].on {
      background: var(--crit-4-bg);
      color: var(--crit-4);
    }

    .dp-info-row {
      padding: 4px 16px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .dp-info-item {
      font-size: 10px;
      color: var(--text-3);
    }

    .dp-info-item strong {
      display: block;
      font-size: 11px;
      color: var(--text-2);
      font-weight: 500;
    }

    .dp-recursos {
      padding: 6px 16px 8px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      background: var(--bg-1);
    }

    .dp-timeline {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px;
    }

    .dp-timeline::-webkit-scrollbar {
      width: 3px;
    }

    .dp-timeline::-webkit-scrollbar-thumb {
      background: var(--bg-4);
    }

    .tl-empty {
      text-align: center;
      padding: 24px 0;
      color: var(--text-4);
      font-size: 11px;
      font-family: 'IBM Plex Mono', monospace;
    }

    .tl-entry {
      display: flex;
      gap: 10px;
      position: relative;
      padding-bottom: 14px;
      animation: entryIn 0.2s ease;
    }

    @keyframes entryIn {
      from {
        opacity: 0;
        transform: translateY(5px)
      }

      to {
        opacity: 1
      }
    }

    .tl-entry:not(:last-child)::before {
      content: '';
      position: absolute;
      left: 11px;
      top: 22px;
      bottom: 0;
      width: 1px;
      background: var(--border-mid);
    }

    .tl-node {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      flex-shrink: 0;
      border: 2px solid;
      background: var(--bg-1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      z-index: 1;
      position: relative;
    }

    .tl-node-1 {
      border-color: var(--crit-1);
      background: var(--crit-1-bg);
    }

    .tl-node-2 {
      border-color: var(--crit-2);
      background: var(--crit-2-bg);
    }

    .tl-node-3 {
      border-color: var(--crit-3);
      background: var(--crit-3-bg);
    }

    .tl-node-4 {
      border-color: var(--crit-4);
      background: var(--crit-4-bg);
    }

    .tl-body {
      flex: 1;
    }

    .tl-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 3px;
    }

    .tl-ts {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 9px;
      color: var(--text-4);
    }

    .tl-prio {
      font-size: 9px;
      font-weight: 700;
      padding: 1px 5px;
      border-radius: 10px;
    }

    .prio-CrÃ­tica {
      background: var(--crit-1-bg);
      color: var(--crit-1);
    }

    .prio-Alta {
      background: var(--crit-2-bg);
      color: var(--crit-2);
    }

    .prio-Media {
      background: var(--crit-3-bg);
      color: var(--crit-3);
    }

    .prio-Baja {
      background: var(--crit-4-bg);
      color: var(--crit-4);
    }

    .tl-text {
      font-size: 12px;
      line-height: 1.5;
    }

    .tl-author {
      font-size: 11px;
      color: var(--text-3);
      margin-top: 2px;
      font-style: italic;
    }

    .dp-addaction {
      padding: 10px 16px 14px;
      border-top: 1px solid var(--border-mid);
      flex-shrink: 0;
      background: var(--bg-2);
    }

    .dp-admin-btns {
      display: none;
      gap: 6px;
      padding: 8px 16px;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }

    .btn-danger {
      padding: 6px 12px;
      background: var(--crit-1-bg);
      border: 1px solid var(--crit-1-border);
      color: var(--crit-1);
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 11px;
      font-weight: 600;
      border-radius: 2px;
    }

    .btn-danger:hover {
      background: var(--crit-1);
      color: #fff;
    }

    .btn-edit-op {
      display: none;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      background: var(--accent-lt);
      border: 1px solid #c0cfe8;
      color: var(--accent);
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 11px;
      font-weight: 600;
      border-radius: 2px;
      transition: background 0.12s;
    }

    .btn-edit-op:hover {
      background: #d0dcf2;
    }

    .btn-ai {
      display: none;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      background: linear-gradient(135deg, #8e2de2, #4a00e0);
      border: none;
      color: #fff;
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 11px;
      font-weight: 600;
      border-radius: 2px;
      transition: opacity 0.12s;
    }

    .btn-ai:hover {
      opacity: 0.9;
    }

    .btn-ai:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* AI REPORT MODAL */
    .ai-report-body {
      padding: 20px;
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-1);
      max-height: 60vh;
      overflow-y: auto;
    }

    .ai-report-body h1 {
      font-family: 'Fraunces', serif;
      font-size: 20px;
      color: var(--accent);
      margin-bottom: 12px;
    }

    .ai-report-body h2 {
      font-size: 15px;
      color: var(--text-2);
      margin-top: 20px;
      margin-bottom: 8px;
      border-bottom: 1px solid var(--border-mid);
      padding-bottom: 4px;
    }

    .ai-report-body ul {
      margin-left: 20px;
      margin-bottom: 12px;
    }

    .ai-report-body p {
      margin-bottom: 12px;
    }

    /* FORM */
    .f-input {
      background: var(--bg-1);
      border: 1px solid var(--border-mid);
      color: var(--text-1);
      padding: 7px 10px;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 12px;
      outline: none;
      border-radius: 2px;
      transition: border-color 0.12s;
      width: 100%;
    }

    .f-input:focus {
      border-color: var(--accent);
    }

    .f-input::placeholder {
      color: var(--text-4);
    }

    .f-input[readonly] {
      background: var(--bg-3);
      color: var(--text-3);
      cursor: default;
      border-color: var(--border);
    }

    .f-select {
      background: var(--bg-1);
      border: 1px solid var(--border-mid);
      color: var(--text-2);
      padding: 7px 8px;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 12px;
      outline: none;
      cursor: pointer;
      border-radius: 2px;
      flex-shrink: 0;
    }

    .form-row {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }

    .btn-reg {
      width: 100%;
      padding: 8px;
      background: var(--accent);
      border: none;
      color: #fff;
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 12px;
      font-weight: 600;
      border-radius: 2px;
      transition: background 0.12s;
      margin-top: 4px;
    }

    .btn-reg:hover {
      background: #253d6e;
    }

    .btn-reg:disabled {
      background: var(--text-4);
      cursor: not-allowed;
    }

    .coord-box {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 11px;
      color: #1a7a4a;
      background: var(--crit-4-bg);
      border: 1px solid var(--crit-4-border);
      padding: 5px 10px;
      border-radius: 2px;
      display: none;
      margin-top: 4px;
    }

    .coord-box.show {
      display: block;
    }

    .btn-mapa {
      padding: 7px 11px;
      background: var(--accent-lt);
      border: 1px solid #c0cfe8;
      color: var(--accent);
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 12px;
      font-weight: 600;
      border-radius: 2px;
      white-space: nowrap;
      flex-shrink: 0;
      transition: background 0.12s;
    }

    .btn-mapa:hover {
      background: #d0dcf2;
    }

    /* Places autocomplete */
    .pac-container {
      z-index: 2000 !important;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 13px;
      border-radius: 2px;
      border: 1px solid var(--border-dark);
      box-shadow: var(--shadow-md);
    }

    .pac-item {
      padding: 6px 10px;
      cursor: pointer;
    }

    .pac-item:hover {
      background: var(--bg-2);
    }

    .pac-item-query {
      font-size: 13px;
    }

    /* MODAL */
    .overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(30, 25, 15, 0.45);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .overlay.open {
      display: flex;
      animation: fadeO 0.15s ease;
    }

    @keyframes fadeO {
      from {
        opacity: 0
      }

      to {
        opacity: 1
      }
    }

    .modal {
      background: var(--bg-1);
      border: 1px solid var(--border-dark);
      border-radius: 3px;
      width: 500px;
      max-width: 96vw;
      box-shadow: var(--shadow-lg);
      animation: modalIn 0.18s ease;
      max-height: 92vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: translateY(-14px)
      }

      to {
        opacity: 1;
        transform: none
      }
    }

    .modal-head {
      padding: 18px 20px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .modal-title {
      font-family: 'Fraunces', serif;
      font-size: 18px;
      font-weight: 700;
    }

    .modal-body {
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow-y: auto;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field-lbl {
      font-size: 9px;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-3);
    }

    .field-row {
      display: flex;
      gap: 10px;
    }

    .modal-foot {
      padding: 12px 20px 16px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }

    .btn-cancel-m {
      padding: 8px 16px;
      background: var(--bg-2);
      border: 1px solid var(--border-mid);
      color: var(--text-2);
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 12px;
      font-weight: 500;
      border-radius: 2px;
    }

    .btn-create-m {
      padding: 8px 20px;
      background: var(--accent);
      border: none;
      color: #fff;
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 12px;
      font-weight: 600;
      border-radius: 2px;
      transition: background 0.12s;
    }

    .btn-create-m:hover {
      background: #253d6e;
    }

    .btn-create-m:disabled {
      background: var(--text-4);
      cursor: not-allowed;
    }

    /* TABLA USUARIOS */
    .users-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .users-table-wrap {
      flex: 1;
      overflow: auto;
      background: var(--bg-1);
      border: 1px solid var(--border-mid);
      border-radius: 3px;
      box-shadow: var(--shadow-sm);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead tr {
      background: var(--bg-2);
      border-bottom: 2px solid var(--border-mid);
    }

    th {
      padding: 10px 14px;
      text-align: left;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-3);
    }

    td {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      vertical-align: middle;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover td {
      background: var(--bg-2);
    }

    .rol-badge {
      font-size: 10px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .rol-super_admin {
      background: #e8f0fb;
      color: var(--accent);
      border: 1px solid #c0cfe8;
    }

    .rol-admin {
      background: var(--crit-3-bg);
      color: var(--crit-3);
      border: 1px solid var(--crit-3-border);
    }

    .rol-usuario {
      background: var(--bg-3);
      color: var(--text-2);
      border: 1px solid var(--border-mid);
    }

    .activo-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 7px;
      border-radius: 10px;
    }

    .activo {
      background: var(--crit-4-bg);
      color: var(--crit-4);
      border: 1px solid var(--crit-4-border);
    }

    .inactivo {
      background: var(--crit-1-bg);
      color: var(--crit-1);
      border: 1px solid var(--crit-1-border);
    }

    .tbl-btn {
      padding: 4px 10px;
      background: var(--bg-2);
      border: 1px solid var(--border-mid);
      color: var(--text-2);
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 11px;
      font-weight: 500;
      border-radius: 2px;
      margin-right: 4px;
    }

    .tbl-btn:hover {
      background: var(--bg-3);
    }

    .tbl-btn.danger {
      color: var(--crit-1);
      border-color: var(--crit-1-border);
    }

    .tbl-btn.danger:hover {
      background: var(--crit-1);
      color: #fff;
    }

    /* TOAST */
    #toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(10px);
      background: var(--accent);
      color: #fff;
      padding: 10px 22px;
      border-radius: 2px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: var(--shadow-lg);
      opacity: 0;
      transition: all 0.25s;
      pointer-events: none;
      z-index: 2000;
    }

    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* CUSTOM ADVANCED MARKERS */
    .custom-marker {
      position: relative;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
      cursor: pointer;
      user-select: none;
    }

    .marker-main {
      position: relative;
      width: 70px;
      height: 36px;
      background: #fff;
      border: 2.5px solid var(--nivel-color);
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .marker-main::after {
      content: '';
      position: absolute;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 12px solid var(--nivel-color);
    }

    .marker-cross {
      position: absolute;
      left: 10px;
      width: 16px;
      height: 16px;
      background: #cc0000;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 900;
      font-size: 14px;
      border-radius: 2px;
    }

    .marker-emoji {
      font-size: 20px;
      margin-left: 16px;
    }

    .marker-badges {
      position: absolute;
      top: 44px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 6px;
      pointer-events: none;
    }

    .badge-item {
      position: relative;
      width: 28px;
      height: 28px;
      background: #fff;
      border: 1.5px solid #555;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .badge-img {
      width: 24px;
      height: 24px;
      object-fit: contain;
    }

    .badge-count {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #e74c3c;
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      width: 17px;
      height: 17px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #fff;
    }

    .marker-new-glow {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 18px;
      box-shadow: 0 0 15px #e74c3c;
      animation: markerGlow 1.5s infinite;
      pointer-events: none;
    }

    @keyframes markerGlow {
      0% {
        box-shadow: 0 0 0px #e74c3c;
        opacity: 0.8;
      }

      100% {
        box-shadow: 0 0 20px #e74c3c;
        opacity: 0;
      }
    }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div id="screen-login">
    <div class="login-card">
      <div class="login-logo">
        <div class="login-icon">âš </div>
        <div>
          <div class="login-title">SIGECA</div>
          <div class="login-sub">Sistema de GestiÃ³n de CatÃ¡strofes</div>
        </div>
      </div>
      <div class="login-field">
        <div class="login-lbl">Email</div>
        <input class="login-input" id="l-email" type="email" placeholder="usuario@organismo.es" autocomplete="username">
      </div>
      <div class="login-field">
        <div class="login-lbl">ContraseÃ±a</div>
        <input class="login-input" id="l-pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
      </div>
      <div class="login-err" id="err-login"></div>
      <button class="btn-login" id="btn-login" onclick="doLogin()">Acceder</button>
    </div>
  </div>

  <!-- APP -->
  <div id="screen-app" style="display:none">
    <header>
      <div class="logo-mark">
        <div class="logo-icon">âš </div>
        <div>
          <div class="logo-text">SIGECA</div>
          <div class="logo-sub">GestiÃ³n de CatÃ¡strofes</div>
        </div>
      </div>
      <div class="hdr-div"></div>
      <div class="nivel-indicators">
        <div class="nivel-chip chip-n1"><span class="nivel-chip-val" id="cnt1">0</span><span
            class="nivel-chip-lbl">N1</span></div>
        <div class="nivel-chip chip-n2"><span class="nivel-chip-val" id="cnt2">0</span><span
            class="nivel-chip-lbl">N2</span></div>
        <div class="nivel-chip chip-n3"><span class="nivel-chip-val" id="cnt3">0</span><span
            class="nivel-chip-lbl">N3</span></div>
        <div class="nivel-chip chip-n4"><span class="nivel-chip-val" id="cnt4">0</span><span
            class="nivel-chip-lbl">N4</span></div>
      </div>
      <div class="hdr-right">
        <div class="live-dot"></div>
        <div class="clock" id="clock">--:--:--</div>
        <div class="hdr-user-info">
          <div class="hdr-user-name" id="hdr-user"></div>
          <div class="hdr-user-role" id="hdr-role"></div>
        </div>
        <div class="hdr-div"></div>
        <div style="display:flex; flex-direction:column; align-items:flex-end;">
          <div id="hdr-office-title"
            style="font-family:'Fraunces',serif; font-size:14px; font-weight:700; color:var(--accent);"></div>
          <div id="hdr-prov-selector-wrap" style="display:none; align-items:center; gap:6px; margin-top:2px;">
            <span style="font-size:10px; color:var(--text-3); font-weight:600; text-transform:uppercase;">Ver:</span>
            <select id="hdr-prov-selector" class="f-select" style="padding:2px 4px; font-size:11px;"
              onchange="changeProvincia(this.value)">
              <option value="AndalucÃ­a">Oficina AutonÃ³mica de AndalucÃ­a</option>
            </select>
          </div>
        </div>
        <button id="btn-nueva-op" class="btn-nueva" onclick="abrirModalOp()">+ Nueva operaciÃ³n</button>
        <button class="btn-logout" onclick="doLogout()">Salir</button>
      </div>
    </header>

    <nav class="app-nav">
      <button class="nav-item on" data-sec="operaciones" onclick="showSection('operaciones')">ğŸ—º Operaciones</button>
      <button class="nav-item" id="nav-usuarios" data-sec="usuarios" onclick="showSection('usuarios')"
        style="display:none">ğŸ‘¥ Usuarios</button>
      <button class="nav-item" id="nav-tablas" data-sec="tablas" onclick="showSection('tablas')" style="display:none">ğŸ—‚
        Tablas maestras</button>
    </nav>

    <!-- OPERACIONES -->
    <div id="section-operaciones">
      <div class="panel-left">
        <div class="panel-left-head">
          <div class="section-label">Operaciones registradas</div>
          <div class="filter-tabs">
            <button class="ftab on" onclick="setFiltro('all',this)">Todas</button>
            <button class="ftab" onclick="setFiltro('1',this)">N1</button>
            <button class="ftab" onclick="setFiltro('2',this)">N2</button>
            <button class="ftab" onclick="setFiltro('3',this)">N3</button>
            <button class="ftab" onclick="setFiltro('4',this)">N4</button>
          </div>
        </div>
        <div class="ops-list" id="ops-list">
          <div class="empty-msg show" id="empty-msg">
            <div style="font-size:28px;opacity:0.4">ğŸ“‹</div>
            <span>Sin operaciones registradas.</span>
          </div>
        </div>
        <div
          style="padding: 8px 16px; font-size: 11px; color: var(--text-4); border-top: 1px solid var(--border); text-align: left; font-family: monospace;">
          VersiÃ³n V.2.12.0
        </div>
      </div>
      </footer>
      <div class="map-zone">
        <div class="pick-banner" id="pick-banner">ğŸ“ Haz clic en el mapa para fijar la ubicaciÃ³n</div>
        <div id="map"></div>

        <!-- PANEL DETALLE -->
        <div class="detail-panel" id="detail-panel">
          <div class="dp-header">
            <div class="dp-scope-title" id="dp-scope-title"></div>
            <div class="dp-top-row">
              <div>
                <div class="dp-id" id="dp-id"></div>
                <div class="dp-name" id="dp-name"></div>
              </div>
              <button class="btn-close-dp" onclick="cerrarDetalle()">âœ•</button>
            </div>
            <div class="dp-chips">
              <div id="dp-type-tag"></div>
              <div class="dp-loc" id="dp-loc"></div>
            </div>
          </div>
          <div
            style="padding:8px 16px;border-bottom:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:space-between;gap:8px;">
            <span
              style="font-size:10px;color:var(--text-3);font-weight:600;text-transform:uppercase;letter-spacing:0.08em;">Nivel:</span>
            <div class="nivel-selector">
              <button class="nsel-opt" data-n="1" onclick="cambiarNivel(1)">N1 Baja</button>
              <button class="nsel-opt" data-n="2" onclick="cambiarNivel(2)">N2 Media</button>
              <button class="nsel-opt" data-n="3" onclick="cambiarNivel(3)">N3 Alta</button>
              <button class="nsel-opt" data-n="4" onclick="cambiarNivel(4)">N4 CrÃ­tica</button>
            </div>
          </div>
          <div class="dp-info-row" id="dp-info-row"></div>

          <!-- RECURSOS ASIGNADOS -->
          <details class="dp-recursos" id="dp-recursos-wrapper">
            <summary class="section-label" id="dp-recursos-summary"
              style="cursor:pointer; outline:none; font-size:10px; margin-bottom:6px;">
              Recursos asignados (0)</summary>
            <div id="dp-recursos-list" style="display:flex; flex-direction:column; gap:4px; margin-bottom:8px;"></div>

            <div id="dp-recursos-form"
              style="background:var(--bg-2); padding:6px; border:1px solid var(--border); border-radius:2px;">
              <div style="display:flex; gap:6px; align-items:center;">
                <select class="f-input f-select" id="r-cat" style="flex:1; padding:4px; font-size:11px;"
                  onchange="cargarOpcionesRecursos()">
                  <option value="">CategorÃ­a...</option>
                  <option value="vehiculos">VehÃ­culos</option>
                </select>
                <select class="f-input f-select" id="r-item" style="flex:2; padding:4px; font-size:11px;">
                  <option value="">Recurso...</option>
                </select>
                <button class="btn-create-m" id="btn-add-recurso" onclick="asignarRecurso()"
                  style="padding:5px 8px; font-size: 11px; white-space:nowrap;">AÃ±adir</button>
              </div>
            </div>
          </details>

          <div class="dp-timeline" id="dp-timeline"></div>
          <div class="dp-addaction" id="dp-addaction-wrapper">
            <div style="display:flex; gap:6px; margin-bottom:6px;">
              <select class="f-select" id="a-prio" style="padding:4px; font-size:11px; width:95px;">
                <option value="CrÃ­tica">ğŸ”´ CrÃ­tica</option>
                <option value="Alta">ğŸŸ  Alta</option>
                <option value="Media" selected>ğŸŸ¡ Media</option>
                <option value="Baja">ğŸŸ¢ Baja</option>
              </select>
              <!-- Campo autor: readonly, siempre muestra el usuario conectado -->
              <input class="f-input" id="a-autor" placeholder="Usuario" style="flex:1; padding:4px; font-size:11px;"
                readonly>
            </div>
            <textarea class="f-input" id="a-texto" placeholder="Describe la novedad, acciÃ³n o decisiÃ³nâ€¦"
              style="resize:vertical;min-height:45px;margin-bottom:4px;"></textarea>
            <button class="btn-reg" id="btn-reg-accion" onclick="addAccion()">Registrar novedad</button>
          </div>
          <!-- Botones admin -->
          <div
            style="padding:8px 16px;border-top:1px solid var(--border);flex-shrink:0;display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
            <button id="dp-edit-btn" class="btn-edit-op" onclick="abrirModalEditOp()">âœï¸ Editar</button>
            <button id="dp-fin-btn" class="btn-edit-op" onclick="finalizarOp()">Finalizar operaciÃ³n</button>
            <button id="dp-ai-btn" class="btn-ai" onclick="abrirModalInformeIA()">âœ¨ Emitir informe (IA)</button>
            <div class="dp-admin-btns" id="dp-admin-btns" style="padding:0;border:none;display:none;">
              <button id="dp-reabrir-btn" class="btn-edit-op" onclick="reabrirOp()" style="display:none;">Abrir</button>
              <button class="btn-danger" onclick="borrarOp()">ğŸ—‘ Borrar</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- USUARIOS -->
    <div id="section-usuarios">
      <div class="users-toolbar">
        <div>
          <div style="font-family:'Fraunces',serif;font-size:20px;font-weight:700;">GestiÃ³n de usuarios</div>
          <div style="font-size:12px;color:var(--text-3);margin-top:2px;">Solo el Super Admin puede crear, editar y
            desactivar usuarios.</div>
        </div>
        <button class="btn-nueva" onclick="abrirModalUsuario()">+ Nuevo usuario</button>
      </div>
      <div class="users-table-wrap">
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Email</th>
              <th>Rol</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="users-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- TABLAS MAESTRAS -->
    <div id="section-tablas">
      <div class="users-toolbar"
        style="margin-bottom: 8px; flex-direction: column; align-items: flex-start; gap: 16px;">
        <div>
          <div style="font-family:'Fraunces',serif;font-size:20px;font-weight:700;">Tablas maestras</div>
          <div style="font-size:12px;color:var(--text-3);margin-top:2px;">GestiÃ³n de catÃ¡logos y dispositivos
            estructurales.</div>
        </div>
        <div class="filter-tabs" id="tablas-subnav" style="width: 100%; max-width: 400px; display: flex;">
          <button class="ftab on" id="subnav-vehiculos" onclick="showTablaMaestra('vehiculos')"
            style="flex:1;">VehÃ­culos</button>
          <!-- Se pueden aÃ±adir mÃ¡s pestaÃ±as aquÃ­ en el futuro -->
        </div>
      </div>

      <!-- Contenedor VehÃ­culos -->
      <div id="tabla-vehiculos-container" style="display:flex; flex-direction:column; flex:1; gap:16px;">
        <div style="display:flex; justify-content:flex-end;">
          <button class="btn-nueva" onclick="abrirModalVehiculo()">+ Nuevo vehÃ­culo</button>
        </div>
        <div class="users-table-wrap">
          <table>
            <thead>
              <tr>
                <th>Indicativo</th>
                <th>MatrÃ­cula</th>
                <th>Tipo de vehÃ­culo</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="vehiculos-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- MODAL NUEVA OPERACIÃ“N -->
  <div class="overlay" id="overlay-op">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title">Nueva operaciÃ³n</div>
        <button class="btn-close-dp" onclick="cerrarModalOp()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <div class="field-lbl">Nombre de la operaciÃ³n *</div>
          <input class="f-input" id="f-nombre" placeholder="Ej: Inundaciones Cuenca del Ebro">
        </div>
        <div class="field-row">
          <div class="field" style="flex:1;">
            <div class="field-lbl">Tipo de catÃ¡strofe</div>
            <select class="f-input f-select" id="f-tipo" style="width:100%" onchange="handleTipoChange('f')">
              <option value="inundacion">ğŸŒŠ InundaciÃ³n / DANA</option>
              <option value="incendio">ğŸ”¥ Incendio forestal</option>
              <option value="seismo">ğŸŒ SeÃ­smo / Terremoto</option>
              <option value="temporal">ğŸŒª Temporal / Viento</option>
              <option value="accidente">ğŸš› Accidente grave</option>
              <option value="quimico">â˜£ï¸ Incidente quÃ­mico</option>
              <option value="sanitaria">ğŸ¦  Emergencia sanitaria</option>
              <option value="logistica">ğŸ“¦ OperaciÃ³n LogÃ­stica</option>
              <option value="otro">ğŸ“‹ Otro</option>
            </select>
            <input class="f-input" id="f-tipo-otro" placeholder="Especificar..."
              style="display:none; margin-top:8px; width:100%;">
          </div>
          <div class="field" style="flex:1;">
            <div class="field-lbl">Nivel de activaciÃ³n</div>
            <select class="f-input f-select" id="f-nivel" style="width:100%">
              <option value="1">N1 â€” Emergencia Mayor</option>
              <option value="2">N2 â€” Emergencia</option>
              <option value="3" selected>N3 â€” Alerta</option>
              <option value="4">N4 â€” Seguimiento</option>
            </select>
          </div>
        </div>
        <div class="field">
          <div class="field-lbl">DescripciÃ³n inicial</div>
          <textarea class="f-input" id="f-desc" placeholder="SituaciÃ³n inicial, recursos movilizadosâ€¦"
            style="resize:vertical;min-height:68px;"></textarea>
        </div>
        <div class="field-row">
          <div class="field" style="flex:1;">
            <div class="field-lbl">Jefe de Operaciones</div>
            <select class="f-input f-select" id="f-dir" style="width:100%">
              <option value="Julio Pulido Morilla">Julio Pulido Morilla</option>
              <option value="Samuel Linares Cantero">Samuel Linares Cantero</option>
            </select>
          </div>
          <div class="field" style="flex:1;">
            <div class="field-lbl">Solicitado por:</div>
            <select class="f-input f-select" id="f-org" style="width:100%" onchange="handleSolicitadoChange('f')">
              <option value="112">112</option>
              <option value="061">061</option>
              <option value="Ayuntamiento">Ayuntamiento</option>
              <option value="Cruz Roja">Cruz Roja</option>
              <option value="Otro">Otro</option>
              <option value="Jefe de Operaciones">Jefe de Operaciones</option>
            </select>
            <div id="f-org-sub" style="display:none; margin-top:8px;">
              <input class="f-input" id="f-org-sub-input" style="display:none;">
              <select class="f-input f-select" id="f-org-sub-select" style="display:none; width:100%">
                <option value="Julio Pulido Morilla">Julio Pulido Morilla</option>
                <option value="Samuel Linares Cantero">Samuel Linares Cantero</option>
              </select>
            </div>
          </div>
        </div>
        <div class="field">
          <div class="field-lbl">ğŸ“ UbicaciÃ³n â€” busca una direcciÃ³n o haz clic en el mapa</div>
          <div style="display:flex;gap:6px;">
            <input class="f-input" id="f-lugar" placeholder="Escribe una direcciÃ³n, municipio o lugarâ€¦"
              autocomplete="off" onkeydown="if(event.key==='Enter') event.preventDefault();">
            <button type="button" class="btn-mapa" onclick="iniciarPick()">ğŸ—º En mapa</button>
          </div>
          <div class="coord-box" id="coord-box"></div>
          <input type="hidden" id="f-loc">
        </div>
        <div class="field" id="f-provincia-row">
          <div class="field-lbl">Provincia *</div>
          <select class="f-input f-select" id="f-provincia" style="width:100%">
            <option value="AndalucÃ­a">Oficina AutonÃ³mica de AndalucÃ­a</option>
            <option value="AlmerÃ­a">Oficina Provincial de AlmerÃ­a</option>
            <option value="CÃ¡diz">Oficina Provincial de CÃ¡diz</option>
            <option value="CÃ³rdoba">Oficina Provincial de CÃ³rdoba</option>
            <option value="Granada">Oficina Provincial de Granada</option>
            <option value="Huelva">Oficina Provincial de Huelva</option>
            <option value="JaÃ©n">Oficina Provincial de JaÃ©n</option>
            <option value="MÃ¡laga">Oficina Provincial de MÃ¡laga</option>
            <option value="Sevilla">Oficina Provincial de Sevilla</option>
          </select>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn-cancel-m" onclick="cerrarModalOp()">Cancelar</button>
        <button class="btn-create-m" id="btn-crear-op" onclick="crearOp()">Crear operaciÃ³n â†’</button>
      </div>
    </div>
  </div>

  <!-- MODAL EDITAR OPERACIÃ“N -->
  <div class="overlay" id="overlay-edit-op">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title">Editar operaciÃ³n</div>
        <button class="btn-close-dp" onclick="cerrarModalEditOp()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <div class="field-lbl">Nombre de la operaciÃ³n *</div>
          <input class="f-input" id="fe-nombre" placeholder="Ej: Inundaciones Cuenca del Ebro">
        </div>
        <div class="field-row">
          <div class="field" style="flex:1;">
            <div class="field-lbl">Fecha y hora de inicio</div>
            <input type="datetime-local" class="f-input" id="fe-fecha" style="width:100%">
          </div>
          <div class="field" style="flex:1;">
            <div class="field-lbl">Tipo de catÃ¡strofe</div>
            <select class="f-input f-select" id="fe-tipo" style="width:100%" onchange="handleTipoChange('fe')">
              <option value="inundacion">ğŸŒŠ InundaciÃ³n / DANA</option>
              <option value="incendio">ğŸ”¥ Incendio forestal</option>
              <option value="seismo">ğŸŒ SeÃ­smo / Terremoto</option>
              <option value="temporal">ğŸŒª Temporal / Viento</option>
              <option value="accidente">ğŸš› Accidente grave</option>
              <option value="quimico">â˜£ï¸ Incidente quÃ­mico</option>
              <option value="sanitaria">ğŸ¦  Emergencia sanitaria</option>
              <option value="logistica">ğŸ“¦ OperaciÃ³n LogÃ­stica</option>
              <option value="otro">ğŸ“‹ Otro</option>
            </select>
            <input class="f-input" id="fe-tipo-otro" placeholder="Especificar..."
              style="display:none; margin-top:8px; width:100%;">
          </div>
        </div>
        <div class="field-row">
          <div class="field" style="flex:1;">
            <div class="field-lbl">Jefe de Operaciones</div>
            <select class="f-input f-select" id="fe-dir" style="width:100%">
              <option value="Julio Pulido Morilla">Julio Pulido Morilla</option>
              <option value="Samuel Linares Cantero">Samuel Linares Cantero</option>
            </select>
          </div>
          <div class="field" style="flex:1;">
            <div class="field-lbl">Solicitado por:</div>
            <select class="f-input f-select" id="fe-org" style="width:100%" onchange="handleSolicitadoChange('fe')">
              <option value="112">112</option>
              <option value="061">061</option>
              <option value="Ayuntamiento">Ayuntamiento</option>
              <option value="Cruz Roja">Cruz Roja</option>
              <option value="Otro">Otro</option>
              <option value="Jefe de Operaciones">Jefe de Operaciones</option>
            </select>
            <div id="fe-org-sub" style="display:none; margin-top:8px;">
              <input class="f-input" id="fe-org-sub-input" style="display:none;">
              <select class="f-input f-select" id="fe-org-sub-select" style="display:none; width:100%">
                <option value="Julio Pulido Morilla">Julio Pulido Morilla</option>
                <option value="Samuel Linares Cantero">Samuel Linares Cantero</option>
              </select>
            </div>
          </div>
        </div>
        <div class="field">
          <div class="field-lbl">ğŸ“ UbicaciÃ³n â€” busca una direcciÃ³n o haz clic en el mapa</div>
          <div style="display:flex;gap:6px;">
            <input class="f-input" id="fe-lugar" placeholder="Escribe una direcciÃ³n, municipio o lugarâ€¦"
              autocomplete="off" onkeydown="if(event.key==='Enter') event.preventDefault();">
            <button type="button" class="btn-mapa" onclick="iniciarEditPick()">ğŸ—º En mapa</button>
          </div>
          <div class="coord-box" id="edit-coord-box"></div>
        </div>
        <div class="field" id="fe-provincia-row">
          <div class="field-lbl">Provincia *</div>
          <select class="f-input f-select" id="fe-provincia" style="width:100%">
            <option value="AndalucÃ­a">Oficina AutonÃ³mica de AndalucÃ­a</option>
            <option value="AlmerÃ­a">Oficina Provincial de AlmerÃ­a</option>
            <option value="CÃ¡diz">Oficina Provincial de CÃ¡diz</option>
            <option value="CÃ³rdoba">Oficina Provincial de CÃ³rdoba</option>
            <option value="Granada">Oficina Provincial de Granada</option>
            <option value="Huelva">Oficina Provincial de Huelva</option>
            <option value="JaÃ©n">Oficina Provincial de JaÃ©n</option>
            <option value="MÃ¡laga">Oficina Provincial de MÃ¡laga</option>
            <option value="Sevilla">Oficina Provincial de Sevilla</option>
          </select>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn-cancel-m" onclick="cerrarModalEditOp()">Cancelar</button>
        <button class="btn-create-m" id="btn-guardar-edit-op" onclick="guardarEditOp()">Guardar cambios â†’</button>
      </div>
    </div>
  </div>

  <!-- MODAL EDITAR ACCIÃ“N -->
  <div class="overlay" id="overlay-edit-accion">
    <div class="modal" style="width:480px;max-width:90vw;">
      <div class="modal-head">
        <div class="modal-title">Editar Novedad</div>
        <button class="btn-close-dp" onclick="cerrarModalEditAccion()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <div class="field-lbl">Fecha y Hora</div>
          <input type="datetime-local" class="f-input" id="ea-fecha">
        </div>
        <div class="field">
          <div class="field-lbl">Texto de la novedad</div>
          <textarea class="f-input" id="ea-texto" style="resize:vertical;min-height:80px;"></textarea>
        </div>
      </div>
      <div class="modal-foot" style="justify-content: space-between;">
        <button class="btn-cancel-m" style="color:var(--crit-1);border-color:var(--crit-1);background:var(--crit-1-bg);"
          onclick="eliminarAccion()">ğŸ—‘ï¸ Eliminar</button>
        <div style="display:flex;gap:8px;">
          <button class="btn-cancel-m" onclick="cerrarModalEditAccion()">Cancelar</button>
          <button class="btn-create-m" id="btn-guardar-edit-accion" onclick="guardarEditAccion()">Guardar novedad
            â†’</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL USUARIO -->
  <div class="overlay" id="overlay-user">
    <div class="modal" style="width:420px;">
      <div class="modal-head">
        <div class="modal-title" id="modal-user-title">Nuevo usuario</div>
        <button class="btn-close-dp" onclick="cerrarModalUsuario()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <div class="field-lbl">Nombre completo *</div>
          <input class="f-input" id="u-nombre" placeholder="Nombre y apellidos">
        </div>
        <div class="field">
          <div class="field-lbl">Email *</div>
          <input class="f-input" id="u-email" type="email" placeholder="usuario@organismo.es">
        </div>
        <div class="field" id="u-pass-row">
          <div class="field-lbl">ContraseÃ±a inicial *</div>
          <input class="f-input" id="u-pass" type="password" placeholder="MÃ­nimo 6 caracteres">
        </div>
        <div class="field-row">
          <div class="field" style="flex:1;">
            <div class="field-lbl">Rol</div>
            <select class="f-input f-select" id="u-role" style="width:100%">
              <!-- Las opciones se cargan dinÃ¡micamente segÃºn permiso -->
            </select>
          </div>
          <div class="field" style="flex:1;">
            <div class="field-lbl">Perfil / Provincia</div>
            <select class="f-input f-select" id="u-provincia" style="width:100%">
              <option value="AndalucÃ­a">Oficina AutonÃ³mica de AndalucÃ­a</option>
              <option value="AlmerÃ­a">Oficina Provincial de AlmerÃ­a</option>
              <option value="CÃ¡diz">Oficina Provincial de CÃ¡diz</option>
              <option value="CÃ³rdoba">Oficina Provincial de CÃ³rdoba</option>
              <option value="Granada">Oficina Provincial de Granada</option>
              <option value="Huelva">Oficina Provincial de Huelva</option>
              <option value="JaÃ©n">Oficina Provincial de JaÃ©n</option>
              <option value="MÃ¡laga">Oficina Provincial de MÃ¡laga</option>
              <option value="Sevilla">Oficina Provincial de Sevilla</option>
            </select>
          </div>
        </div>
        <div class="field">
          <div class="field-lbl">Estado</div>
          <select class="f-input f-select" id="u-activo" style="width:100%">
            <option value="true">Activo</option>
            <option value="false">Inactivo</option>
          </select>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn-cancel-m" onclick="cerrarModalUsuario()">Cancelar</button>
        <button class="btn-create-m" id="btn-guardar-user" onclick="guardarUsuario()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- MODAL VEHÃCULO -->
  <div class="overlay" id="overlay-vehiculo">
    <div class="modal" style="width:420px;">
      <div class="modal-head">
        <div class="modal-title" id="modal-vehiculo-title">Nuevo vehÃ­culo</div>
        <button class="btn-close-dp" onclick="cerrarModalVehiculo()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <div class="field-lbl">Indicativo *</div>
          <input class="f-input" id="v-indicativo" placeholder="Ej: A-10">
        </div>
        <div class="field">
          <div class="field-lbl">MatrÃ­cula *</div>
          <input class="f-input" id="v-matricula" placeholder="Ej: 1234 ABC">
        </div>
        <div class="field">
          <div class="field-lbl">Tipo de vehÃ­culo *</div>
          <select class="f-input f-select" id="v-tipo" style="width:100%">
            <option value="CamiÃ³n">CamiÃ³n</option>
            <option value="VehÃ­culo transporte personal">VehÃ­culo transporte personal</option>
            <option value="VehÃ­culo de transporte mixto">VehÃ­culo de transporte mixto</option>
            <option value="Ambulancia">Ambulancia</option>
            <option value="VehÃ­culo Todo terreno">VehÃ­culo Todo terreno</option>
          </select>
        </div>
        <div class="field" id="v-prov-row">
          <div class="field-lbl">Oficina / Provincia *</div>
          <select class="f-input f-select" id="v-provincia" style="width:100%">
            <option value="AndalucÃ­a">Oficina AutonÃ³mica de AndalucÃ­a</option>
            <option value="AlmerÃ­a">Oficina Provincial de AlmerÃ­a</option>
            <option value="CÃ¡diz">Oficina Provincial de CÃ¡diz</option>
            <option value="CÃ³rdoba">Oficina Provincial de CÃ³rdoba</option>
            <option value="Granada">Oficina Provincial de Granada</option>
            <option value="Huelva">Oficina Provincial de Huelva</option>
            <option value="JaÃ©n">Oficina Provincial de JaÃ©n</option>
            <option value="MÃ¡laga">Oficina Provincial de MÃ¡laga</option>
            <option value="Sevilla">Oficina Provincial de Sevilla</option>
          </select>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn-cancel-m" onclick="cerrarModalVehiculo()">Cancelar</button>
        <button class="btn-create-m" id="btn-guardar-vehiculo" onclick="guardarVehiculo()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- MODAL INFORME IA -->
  <div class="overlay" id="overlay-ai-report">
    <div class="modal" style="width:700px; max-width:98vw;">
      <div class="modal-head">
        <div class="modal-title">âœ¨ Informe Generado por Inteligencia Artificial</div>
        <button class="btn-close-dp" onclick="cerrarModalInformeIA()">âœ•</button>
      </div>
      <div class="modal-body ai-report-body" id="ai-report-content">
        <!-- El texto generado se incrustarÃ¡ aquÃ­ -->
      </div>
      <div class="modal-foot">
        <button class="btn-cancel-m" onclick="cerrarModalInformeIA()">Cerrar panel</button>
      </div>
    </div>
  </div>

  <!-- MODAL LOG DE SESIONES -->
  <div class="overlay" id="overlay-user-log">
    <div class="modal" style="width:500px; max-width:95vw;">
      <div class="modal-head">
        <div class="modal-title">Historial de sesiones: <span id="log-user-name"></span></div>
        <button class="btn-close-dp" onclick="cerrarLogUsuario()">âœ•</button>
      </div>
      <div class="modal-body" style="max-height:60vh; overflow-y:auto; padding:0;">
        <table style="width:100%; border-collapse:collapse;">
          <thead style="position:sticky; top:0; background:var(--bg-1); z-index:1; box-shadow:0 1px 0 var(--border);">
            <tr>
              <th style="text-align:left; padding:12px; font-size:11px; text-transform:uppercase; color:var(--text-3);">
                Fecha y Hora</th>
              <th style="text-align:left; padding:12px; font-size:11px; text-transform:uppercase; color:var(--text-3);">
                Evento</th>
            </tr>
          </thead>
          <tbody id="log-tbody">
            <!-- Los logs se cargan aquÃ­ -->
          </tbody>
        </table>
      </div>
      <div class="modal-foot">
        <button class="btn-cancel-m" onclick="cerrarLogUsuario()">Cerrar historial</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    setInterval(() => {
      const el = document.getElementById('clock');
      if (el) el.textContent = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }, 1000);
  </script>
</body>

</html>