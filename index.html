<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="EmerCRE">
  <link rel="apple-touch-icon" href="assets/logo_emercre.png">
  <title>EmerCRE â€” Sistema de GestiÃ³n de CatÃ¡strofes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600&family=IBM+Plex+Mono:wght@400;500&family=Fraunces:opsz,wght@9..144,300;9..144,700;9..144,900&display=swap"
    rel="stylesheet">

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, confirmPasswordReset, updatePassword, EmailAuthProvider, reauthenticateWithCredential }
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc,
      onSnapshot, query, where, orderBy, limit, limitToLast, serverTimestamp, getDoc, getDocs, arrayUnion, or, and
    }
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { initializeAppCheck, ReCaptchaV3Provider }
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app-check.js";
    import { getMessaging, getToken, onMessage }
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging.js";

    // â”€â”€ CONFIGURACIÃ“N IA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let geminiApiKey = '__GEMINI_API_KEY__'; // Clave por defecto proporcionada por el usuario

    // â”€â”€ FIREBASE CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const firebaseConfig = {
      apiKey: "__FIREBASE_API_KEY__",
      authDomain: "emercre.firebaseapp.com",
      projectId: "emercre",
      storageBucket: "emercre.firebasestorage.app",
      messagingSenderId: "277256770434",
      appId: "1:277256770434:web:225aa9c7ff6b862d72b59b"
    };
    const fbApp = initializeApp(firebaseConfig);
    const auth = getAuth(fbApp);
    const db = getFirestore(fbApp);
    let messaging = null;

    async function initMessaging() {
      try {
        const { isSupported } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging.js");
        const supported = await isSupported();
        if (supported) {
          messaging = getMessaging(fbApp);
          console.log("Firebase Messaging initialized.");
        } else {
          console.warn("Firebase Messaging is NOT supported in this browser/context.");
        }
      } catch (e) {
        console.error("Error checking messaging support:", e);
      }
    }
    initMessaging();

    // â”€â”€ FIREBASE APP CHECK (V.4.9.0) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    try {
      // self.FIREBASE_APPCHECK_DEBUG_TOKEN = true; // Desactivado para producciÃ³n (V.4.9.2)
      initializeAppCheck(fbApp, {
        provider: new ReCaptchaV3Provider('6LemNXUsAAAAACVSGSPQ2ow0qbaV0a7QvZo5tV0h'),
        isTokenAutoRefreshEnabled: true
      });
    } catch (e) {
      console.warn("App Check failed to initialize (probable dev environment):", e);
    }

    // â”€â”€ ESTADO GLOBAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let currentUser = null;
    let currentRole = null;
    let currentUserDoc = null;
    let selOpId = null;
    let filtro = 'all';
    let mostrarCerradas = false;
    let searchQuery = '';
    let userSearchQuery = '';
    let tablasSearchQuery = '';
    let picking = false;
    let pickedCoords = null;
    let pickedAddress = '';
    let gmap = null;
    let mapReady = false;
    let gmMarkers = {};
    let autocomplete = null;
    let autocompleteEdit = null;
    let pickListener = null;
    let tempGmMarker = null;
    let unsubOps = null;
    let unsubAcciones = null;
    let unsubRecursos = null;
    let unsubJefes = null;
    let unsubGuardia = null;
    let unsubGlobalJefes = null;
    let allJefesGuardiaCacheMap = {}; // "Provincia" -> "Nombre del Jefe"
    let trafficLayer = null;
    let directionsService = null;
    let directionsRenderer = null;
    let autocompleteOrigin = null;
    let autocompleteDest = null;
    let unsubChatGlobal = null;
    let unsubChatDetail = null;
    let currentChatId = 'general'; // 'general' o userId
    let unreadMessages = {}; // id -> count
    let jefeGuardiaActual = null;
    let ops = {};
    let editingUserId = null;

    // Helper visibilidad (V.3.4.1)
    function isOpVisible(op) {
      if (!op) return false;
      const isOculta = op.oculta === true;
      if (isOculta) return mostrarCerradas;
      return true;
    }

    // â”€â”€ ESTRUCTURA AUTONÃ“MICA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const PROVINCIAS = ['AlmerÃ­a', 'CÃ¡diz', 'CÃ³rdoba', 'Granada', 'JaÃ©n', 'Huelva', 'MÃ¡laga', 'Sevilla'];
    let selectedProvincia = 'AndalucÃ­a'; // 'AndalucÃ­a' o una provincia concreta
    // Edit op state
    let editPickedCoords = null;
    let editPickedAddress = '';
    let editPickListener = null;
    let editTempGmMarker = null;
    let editPickMode = false;
    // Edit action state
    let currentAcciones = {};
    let editAccionId = null;

    // â”€â”€ NOTIFICACIONES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let lastSeenOps = {}; // Para saber quÃ© ops hemos visto (tracking nuevo op)
    let opsTimestamps = {}; // Para saber Ãºltimo timestamp y compararlo con nuestro "visto"
    let alertSound = new Audio('assets/alert.mp3');

    // â”€â”€ TIPO / NIVEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const TIPOS = {
      inundacion: { label: 'InundaciÃ³n', emoji: 'ðŸŒŠ', color: '#2980b9' },
      incendio: { label: 'Incendio forestal', emoji: 'ðŸ”¥', color: '#c0392b' },
      seismo: { label: 'SeÃ­smo', emoji: 'ðŸŒ', color: '#8e44ad' },
      temporal: { label: 'Temporal', emoji: 'ðŸŒª', color: '#16a085' },
      accidente: { label: 'Accidente', emoji: 'ðŸš›', color: '#d35400' },
      quimico: { label: 'Inc. QuÃ­mico', emoji: 'â˜£ï¸', color: '#c0392b' },
      sanitaria: { label: 'Emerg. Sanitaria', emoji: 'ðŸ¦ ', color: '#e74c3c' },
      logistica: { label: 'Op. LogÃ­stica', emoji: 'ðŸ“¦', color: '#8e44ad' },
      otro: { label: 'Otro', emoji: 'ðŸ“‹', color: '#7f8c8d' }
    };
    const NIVEL_LABELS = { 1: 'Baja', 2: 'Media', 3: 'Alta', 4: 'CrÃ­tica' };
    const NIVEL_COLORS = { 1: '#1a7a4a', 2: '#c08c00', 3: '#d35400', 4: '#c0392b' };
    const ROL_LABELS = {
      super_admin: 'Super Admin',
      manager: 'Administrador',
      admin: 'Responsable',
      usuario: 'Usuario'
    };

    // â”€â”€ GOOGLE MAPS INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.initGoogleMap = function () {
      gmap = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 40.4, lng: -3.7 },
        zoom: 6,
        mapId: 'bc56b7cd6850d53c', // Map ID para Advanced Markers
        mapTypeId: 'roadmap',
        mapTypeControl: true,
        mapTypeControlOptions: {
          style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
          position: google.maps.ControlPosition.TOP_RIGHT,
          mapTypeIds: ['roadmap', 'satellite', 'hybrid', 'terrain']
        },
        streetViewControl: false,
        fullscreenControl: false,
        zoomControlOptions: { position: google.maps.ControlPosition.RIGHT_BOTTOM }
      });

      trafficLayer = new google.maps.TrafficLayer();
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map: gmap,
        suppressMarkers: false,
        polylineOptions: { strokeColor: '#1a3a6e', strokeOpacity: 0.7, strokeWeight: 5 }
      });

      google.maps.event.addListenerOnce(gmap, 'tilesloaded', function () {
        mapReady = true;
        if (Object.keys(ops).length) renderMapa();
      });

      gmap.addListener('click', () => {
        document.querySelectorAll('.custom-marker.expanded').forEach(el => el.classList.remove('expanded'));
        if (!picking && !editPickMode) window.cerrarDetalle();
      });

      // Force refresh when map container becomes visible
      new ResizeObserver(() => {
        if (gmap && mapReady && document.getElementById('map').offsetWidth > 0) {
          google.maps.event.trigger(gmap, 'resize');
          if (Object.keys(ops).length) renderMapa();
        }
      }).observe(document.getElementById('map'));
    };

    window.ensureAutocomplete = function () {
      if (!autocomplete) {
        const input = document.getElementById('f-lugar');
        autocomplete = new google.maps.places.Autocomplete(input, {
          fields: ['geometry', 'formatted_address', 'name'],
          componentRestrictions: { country: 'es' }
        });
        autocomplete.addListener('place_changed', () => {
          const place = autocomplete.getPlace();
          if (!place.geometry) return;
          pickedCoords = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() };
          pickedAddress = place.formatted_address || place.name || '';
          mostrarCoordBox();
          if (mapReady && gmap) {
            gmap.panTo(place.geometry.location);
            gmap.setZoom(15);
            if (tempGmMarker) tempGmMarker.map = null;
            tempGmMarker = new google.maps.marker.AdvancedMarkerElement({
              position: place.geometry.location,
              map: gmap,
              title: place.name
            });
          }
        });
      }
    };

    window.ensureAutocompleteEdit = function () {
      if (!autocompleteEdit) {
        const inputEdit = document.getElementById('fe-lugar');
        autocompleteEdit = new google.maps.places.Autocomplete(inputEdit, {
          fields: ['geometry', 'formatted_address', 'name'],
          componentRestrictions: { country: 'es' }
        });
        autocompleteEdit.addListener('place_changed', () => {
          const place = autocompleteEdit.getPlace();
          if (!place.geometry) return;
          editPickedCoords = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() };
          editPickedAddress = place.formatted_address || place.name || '';
          mostrarEditCoordBox();
          if (mapReady && gmap) {
            gmap.panTo(place.geometry.location);
            gmap.setZoom(15);
            if (editTempGmMarker) editTempGmMarker.map = null;
            editTempGmMarker = new google.maps.marker.AdvancedMarkerElement({
              position: place.geometry.location,
              map: gmap,
              title: place.name
            });
          }
        });
      }
    };

    window.toggleTraffic = () => {
      const isOn = !!trafficLayer.getMap();
      trafficLayer.setMap(isOn ? null : gmap);
      document.getElementById('btn-toggle-traffic').classList.toggle('active', !isOn);
      mostrarToast(!isOn ? 'Capa de trÃ¡fico activada' : 'Capa de trÃ¡fico desactivada');
    };

    window.toggleDirections = () => {
      const panel = document.getElementById('map-routing-panel');
      panel.classList.toggle('open');
      if (panel.classList.contains('open')) {
        ensureAutocompleteRouting();
      }
    };

    window.ensureAutocompleteRouting = () => {
      if (!autocompleteOrigin) {
        autocompleteOrigin = new google.maps.places.Autocomplete(document.getElementById('route-origin'), {
          fields: ['geometry', 'formatted_address', 'name'],
          componentRestrictions: { country: 'es' }
        });
      }
      if (!autocompleteDest) {
        autocompleteDest = new google.maps.places.Autocomplete(document.getElementById('route-dest'), {
          fields: ['geometry', 'formatted_address', 'name'],
          componentRestrictions: { country: 'es' }
        });
      }
    };

    window.calculateRoute = () => {
      const origin = document.getElementById('route-origin').value;
      const dest = document.getElementById('route-dest').value;
      if (!origin || !dest) return;

      const btn = document.getElementById('btn-calc-route');
      const info = document.getElementById('route-info');
      btn.disabled = true; btn.textContent = '...';
      if (info) info.style.display = 'none';

      directionsService.route({
        origin: origin,
        destination: dest,
        travelMode: google.maps.TravelMode.DRIVING
      }, (result, status) => {
        btn.disabled = false; btn.textContent = 'Calcular';
        if (status === 'OK') {
          directionsRenderer.setDirections(result);
          if (info && result.routes[0] && result.routes[0].legs[0]) {
            const leg = result.routes[0].legs[0];
            info.innerHTML = `
              <div style="font-weight:700; color:var(--accent); font-size:12px; margin-bottom:2px;">${leg.distance.text}</div>
              <div style="font-size:11px; color:var(--text-3);">DuraciÃ³n est.: <b>${leg.duration.text}</b></div>
            `;
            info.style.display = 'block';
          }
        } else {
          alert('No se pudo calcular la ruta: ' + status);
        }
      });
    };

    window.clearRoute = () => {
      directionsRenderer.setDirections({ routes: [] });
      document.getElementById('route-origin').value = '';
      document.getElementById('route-dest').value = '';
      const info = document.getElementById('route-info');
      if (info) { info.innerHTML = ''; info.style.display = 'none'; }
    };

    // â”€â”€ CHAT LOGIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let unreadMessagesGeneral = 0;
    let unreadMessagesPrivados = {}; // uid -> count
    let lastMessageAt = {};
    let unsubUserPresence = null;
    let unsubChatGeneralGlobal = null;
    let unsubChatPrivateGlobal = null;

    window.suscribirNotificacionesChat = () => {
      if (unsubChatGeneralGlobal) unsubChatGeneralGlobal();
      if (unsubChatPrivateGlobal) unsubChatPrivateGlobal();

      const updateGlobalState = () => {
        renderChatNavBadge();
        renderChatList();
      };

      // 1. Escuchar mensajes GENERAL (Sin limit ni orderBy para asegurar recibir los Ãºltimos sin Ã­ndices)
      const qGen = query(collection(db, 'chat_mensajes'), where('destinatarioId', '==', 'general'));
      unsubChatGeneralGlobal = onSnapshot(qGen, snap => {
        unreadMessagesGeneral = 0;
        let latestTs = 0;
        snap.forEach(doc => {
          const m = doc.data();
          const ts = m.timestamp?.toMillis ? m.timestamp.toMillis() : (Date.now());
          latestTs = Math.max(latestTs, ts);
          if (m.remitenteId !== currentUser.uid) {
            if (!m.leidoPor || !m.leidoPor.includes(currentUser.uid)) unreadMessagesGeneral++;
          }
        });
        if (latestTs > 0) lastMessageAt['general'] = latestTs;
        updateGlobalState();
      }, err => console.error("General Listener Error:", err));

      // 2. Escuchar mensajes PRIVADOS (Sin limit ni orderBy)
      const qPriv = query(
        collection(db, 'chat_mensajes'),
        or(where('destinatarioId', '==', currentUser.uid), where('remitenteId', '==', currentUser.uid))
      );
      unsubChatPrivateGlobal = onSnapshot(qPriv, snap => {
        unreadMessagesPrivados = {};
        snap.forEach(doc => {
          const m = doc.data();
          const ts = m.timestamp?.toMillis ? m.timestamp.toMillis() : (Date.now());
          const otherId = m.remitenteId === currentUser.uid ? m.destinatarioId : m.remitenteId;
          if (otherId !== 'general') {
            lastMessageAt[otherId] = Math.max(lastMessageAt[otherId] || 0, ts);
            if (m.destinatarioId === currentUser.uid && !m.leido) {
              unreadMessagesPrivados[otherId] = (unreadMessagesPrivados[otherId] || 0) + 1;
            }
          }
        });
        updateGlobalState();
      }, err => console.error("Private Listener Error:", err));
    };

    function renderChatNavBadge() {
      let totalPrivado = Object.values(unreadMessagesPrivados).reduce((a, b) => a + b, 0);
      const dot = '<span class="nav-badge"></span>';
      document.getElementById('nav-chat-badge').innerHTML = totalPrivado > 0 ? dot : '';
      const mdot = document.getElementById('mnav-chat-badge');
      if (mdot) mdot.innerHTML = totalPrivado > 0 ? dot : '';
    }

    function getInitials(name) {
      if (!name) return "?";
      const parts = name.split(" ");
      if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
      return name[0].toUpperCase();
    }

    function renderChatList() {
      const list = document.getElementById('chat-list');
      if (!list) return;

      // 1. Filtrar usuarios por Ã¡mbito (provincia)
      const filteredUsers = allUsersCache.filter(u => {
        if (u.uid === currentUser.uid) return false;
        const myProv = currentUserDoc.provincia;
        const userProv = u.provincia;
        if (myProv && myProv !== 'AndalucÃ­a') {
          return userProv === myProv || userProv === 'AndalucÃ­a';
        }
        return true;
      });

      // 2. Preparar items de contactos privados
      let allPrivateItems = filteredUsers.map(u => {
        const isOnline = u.enLinea && (Date.now() - (u.ultimaActividad?.toMillis() || 0)) < 300000;
        let roleLabel = ROL_LABELS[u.role] || u.role;
        let isJefeDeGuardia = false;
        let jefeProv = '';

        for (const [prov, nombreJefe] of Object.entries(allJefesGuardiaCacheMap)) {
          if (nombreJefe === u.nombre) {
            isJefeDeGuardia = true;
            jefeProv = prov;
            break;
          }
        }

        return {
          id: u.uid,
          nombre: u.nombre || u.email,
          initials: getInitials(u.nombre || u.email),
          roleLabel: roleLabel,
          isJefeDeGuardia: isJefeDeGuardia,
          jefeProv: jefeProv,
          lastAct: lastMessageAt[u.uid] || 0,
          unread: unreadMessagesPrivados[u.uid] || 0,
          isOnline: isOnline,
          isGeneral: false
        };
      });

      // 3. Dividir y ordenar
      const jefeItems = allPrivateItems.filter(i => i.isJefeDeGuardia).sort((a, b) => b.lastAct - a.lastAct);
      const otherItems = allPrivateItems.filter(i => !i.isJefeDeGuardia).sort((a, b) => b.lastAct - a.lastAct);

      // 4. Crear lista final
      let items = [];
      items.push({
        id: 'general',
        nombre: 'General',
        sub: 'Todos los usuarios',
        lastAct: lastMessageAt['general'] || 0,
        unread: unreadMessagesGeneral,
        isGeneral: true
      });
      items = items.concat(jefeItems);
      items = items.concat(otherItems);

      list.innerHTML = items.map(item => {
        const isActive = currentChatId === item.id;
        const badge = item.unread ? `<span class="chat-badge">${item.unread}</span>` : '';

        if (item.isGeneral) {
          return `
            <div class="chat-item ${isActive ? 'active' : ''}" onclick="selectChat('general')">
              <div class="chat-avatar chat-avatar-general">ðŸ‘¥</div>
              <div class="chat-item-info">
                <div class="name">General</div>
                <div class="status">Todos los usuarios</div>
              </div>
              ${badge}
            </div>
          `;
        } else {
          return `
            <div class="chat-item ${isActive ? 'active' : ''}" onclick="selectChat('${item.id}')">
              <div class="chat-avatar chat-avatar-user">
                ${item.initials}
                <div class="online-dot" style="background:${item.isOnline ? '#2ecc71' : '#bdc3c7'};"></div>
              </div>
              <div class="chat-item-info">
                <div class="name">${item.nombre}</div>
                <div class="status">
                  ${item.isJefeDeGuardia ? `<span style="color: #e74c3c; font-weight: 600;">Jefe de Operaciones (${item.jefeProv})</span>` : item.roleLabel}
                </div>
              </div>
              ${badge}
            </div>
          `;
        }
      }).join('');
    }

    let allUsersCache = [];
    async function cargarUsuariosParaChat() {
      if (unsubUserPresence) unsubUserPresence();
      unsubUserPresence = onSnapshot(collection(db, 'users'), snap => {
        allUsersCache = snap.docs.map(d => ({ uid: d.id, ...d.data() }));
        renderChatList();
      });
    }

    window.selectChat = (id) => {
      currentChatId = id;
      renderChatList();
      const inputArea = document.getElementById('chat-input-area');
      const chatHeader = document.getElementById('chat-header');
      const hdrAvatar = document.getElementById('chat-header-avatar');
      const chatMessages = document.getElementById('chat-messages');

      if (!id) {
        if (chatHeader) chatHeader.style.display = 'none';
        if (inputArea) inputArea.style.display = 'none';
        if (unsubChatDetail) { unsubChatDetail(); unsubChatDetail = null; }
        chatMessages.innerHTML = `
          <div class="chat-placeholder">
            <div class="chat-placeholder-icon">ðŸ’¬</div>
            <h2>EmerCRE Chat</h2>
            <p>Selecciona un contacto o el canal General para comenzar a chatear e intercambiar informaciÃ³n operativa.</p>
          </div>
        `;
        return;
      }

      if (chatHeader) chatHeader.style.display = 'flex';
      if (inputArea) inputArea.style.display = 'flex';

      const item = id === 'general' ? { nombre: 'General' } : allUsersCache.find(u => u.uid === id);
      const name = item ? item.nombre : 'Chat';
      document.getElementById('chat-target-name').textContent = name;
      if (hdrAvatar) {
        hdrAvatar.textContent = id === 'general' ? 'ðŸ‘¥' : getInitials(name);
      }

      suscribirChatDetalle(id);
    };

    function suscribirChatDetalle(chatId) {
      if (!chatId) return; // V.4.5.2
      if (unsubChatDetail) unsubChatDetail();
      const msgsDiv = document.getElementById('chat-messages');
      msgsDiv.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-4);">Cargando mensajes...</div>';

      let q;
      if (chatId === 'general') {
        q = query(collection(db, 'chat_mensajes'), where('destinatarioId', '==', 'general'));
      } else {
        // Chat privado: usamos 'or' para cubrir remitente/destinatario de forma segura con las reglas
        q = query(collection(db, 'chat_mensajes'),
          or(
            and(where('remitenteId', '==', currentUser.uid), where('destinatarioId', '==', chatId)),
            and(where('remitenteId', '==', chatId), where('destinatarioId', '==', currentUser.uid))
          )
        );
      }

      unsubChatDetail = onSnapshot(q, async snap => {
        msgsDiv.innerHTML = '';
        let batchToMark = [];

        // Ordenar en cliente para evitar necesidad de Ã­ndices compuestos en Firebase
        const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        docs.sort((a, b) => (a.timestamp?.toMillis ? a.timestamp.toMillis() : 0) - (b.timestamp?.toMillis ? b.timestamp.toMillis() : 0));

        docs.forEach(m => {
          if (chatId !== 'general') {
            const isRelated = (m.remitenteId === currentUser.uid && m.destinatarioId === chatId) ||
              (m.remitenteId === chatId && m.destinatarioId === currentUser.uid);
            if (!isRelated) return;
          }

          const isMe = m.remitenteId === currentUser.uid;
          const ts = m.timestamp?.toDate ? m.timestamp.toDate().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : '...';

          const bubble = document.createElement('div');
          bubble.className = `msg-bubble ${isMe ? 'msg-sent' : 'msg-received'}`;
          bubble.innerHTML = `
            ${!isMe && chatId === 'general' ? `<div style="font-size:11px; margin-bottom:4px; color:#128c7e; font-weight:700;">${m.remitenteNombre || 'Usuario'}</div>` : ''}
            <div>${m.texto}</div>
            <div class="msg-meta">
              <span></span>
              <span>${ts}</span>
            </div>
          `;
          msgsDiv.appendChild(bubble);

          // Mark as read if not me
          if (!isMe) {
            if (chatId === 'general') {
              if (!m.leidoPor || !m.leidoPor.includes(currentUser.uid)) {
                batchToMark.push(updateDoc(doc(db, 'chat_mensajes', m.id), {
                  leidoPor: arrayUnion(currentUser.uid)
                }));
              }
            } else if (!m.leido) {
              batchToMark.push(updateDoc(doc(db, 'chat_mensajes', m.id), { leido: true }));
            }
          }
        });
        if (snap.empty) {
          msgsDiv.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-4);">No hay mensajes todavÃ­a. ðŸ‘‹</div>';
        }
        msgsDiv.scrollTop = msgsDiv.scrollHeight;
        if (batchToMark.length > 0) await Promise.all(batchToMark);
      }, err => {
        console.error("Chat error:", err);
        msgsDiv.innerHTML = `<div style="text-align:center; padding:20px; color:var(--crit-1);">Error: ${err.message}</div>`;
      });
    }

    window.enviarMensaje = async () => {
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      if (!text) return;

      input.value = '';
      input.style.height = ''; // V.5.6.0: Reset height after sending
      try {
        await addDoc(collection(db, 'chat_mensajes'), {
          remitenteId: currentUser.uid,
          remitenteNombre: currentUserDoc.nombre || currentUser.email,
          destinatarioId: currentChatId,
          texto: text,
          timestamp: serverTimestamp(),
          leido: false,
          leidoPor: []
        });
      } catch (e) {
        alert('Error al enviar: ' + e.message);
      }
    };

    // â”€â”€ ACTIVIDAD (HEARTBEAT) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let lastHeartbeat = 0;
    function actualizarActividad() {
      if (!currentUser) return;
      const now = Date.now();
      // Throttle: Max una actualizaciÃ³n cada 5 minutos (300.000 ms)
      if (now - lastHeartbeat < 300000) return;
      lastHeartbeat = now;
      updateDoc(doc(db, 'users', currentUser.uid), {
        ultimaActividad: serverTimestamp(),
        enLinea: true
      }).catch(() => { });
    }
    window.addEventListener('click', actualizarActividad);
    window.addEventListener('keypress', actualizarActividad);

    // â”€â”€ NOTIFICACIONES PUSH (V.5.7.1 Debug) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.setupNotifications = async (isManual = false) => {
      if (!messaging) {
        if (isManual) mostrarToast("âš ï¸ El navegador no soporta notificaciones o no estÃ¡ en HTTPS.");
        return;
      }
      try {
        if (isManual) mostrarToast("Intentando activar notificaciones...");

        // 1. Registrar Service Worker
        const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
        console.log("SW registrado:", registration);

        // 2. Solicitar permiso
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
          if (isManual) mostrarToast("âš ï¸ Permiso denegado. ActÃ­valo en los ajustes del navegador.");
          return;
        }

        // 3. Obtener token
        const vapidKey = "BDwGvRdHh3oO7jdRD8B1vyl6ZAUcvh0P7Fsjhdwzd1XG2_YE0iaOdu_emr9XFdDz2ReN1nlDu1_ipGYjryHH5LQ";
        const token = await getToken(messaging, {
          serviceWorkerRegistration: registration,
          vapidKey: vapidKey
        });

        if (token) {
          await updateDoc(doc(db, 'users', currentUser.uid), { fcmToken: token });
          if (isManual) mostrarToast("âœ… Â¡Notificaciones activadas correctamente!");
        } else {
          if (isManual) mostrarToast("âŒ No se pudo obtener el Token de notificaciÃ³n.");
        }
      } catch (e) {
        console.error("Error FCM:", e);
        if (isManual) mostrarToast(`âŒ Error: ${e.message}`);
      }
    }

    window.diagNotificaciones = () => {
      const status = {
        sw: 'serviceWorker' in navigator,
        notif: 'Notification' in window,
        perm: Notification.permission,
        msgSupported: !!messaging,
        isHTTPS: location.protocol === 'https:',
        isPWA: window.matchMedia('(display-mode: standalone)').matches
      };
      alert(Object.entries(status).map(([k, v]) => `${k}: ${v}`).join('\n'));
    };    // FunciÃ³n para disparar la notificaciÃ³n (V.5.7.0)
    window.broadcastNuevaOperacion = async (op) => {
      console.log("Broadcasting nueva operaciÃ³n:", op.nombre);

      // 1. Guardar en una colecciÃ³n de "pendientes" por si el usuario pone una Cloud Function o Relay
      try {
        await addDoc(collection(db, 'fcm_notificaciones'), {
          titulo: 'Nueva OperaciÃ³n',
          body: `${op.creadoPorNombre} ha creado: ${op.nombre}`,
          provincia: op.provincia,
          data: { opId: op.id },
          timestamp: serverTimestamp()
        });
      } catch (e) {
        console.warn("No se pudo guardar la peticiÃ³n de push:", e);
      }
    }

    // Listener para mensajes en primer plano (Foreground)
    if (messaging) {
      onMessage(messaging, (payload) => {
        console.log("Mensaje en primer plano recibido:", payload);
        // Mostrar aviso manual si estamos en la app
        mostrarToast(`ðŸ”” ${payload.notification.title}: ${payload.notification.body}`);
      });
    }

    // â”€â”€ AUTH STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    onAuthStateChanged(auth, async user => {
      if (user) {
        let snap;
        try {
          snap = await getDoc(doc(db, 'users', user.uid));
        } catch (e) { console.error("Error fetching user doc:", e); }

        if (!snap || !snap.exists() || snap.data().activo === false) {
          await signOut(auth);
          mostrarLoginErr('Usuario no autorizado o desactivado.');
          return;
        }
        currentUser = user;
        currentUserDoc = snap.data();
        currentRole = currentUserDoc.role;

        // Limpiar estado de botÃ³n login por si estaba en "Accediendo..."
        const btnLogin = document.getElementById('btn-login');
        if (btnLogin) { btnLogin.disabled = false; btnLogin.textContent = 'Login'; }

        // Inicializar provincia seleccionada segÃºn perfil
        if (currentUserDoc.provincia && currentUserDoc.provincia !== 'AndalucÃ­a') {
          selectedProvincia = currentUserDoc.provincia;
        } else {
          selectedProvincia = 'AndalucÃ­a';
        }

        // Registrar entrada y marcar online (No bloqueante)
        try {
          updateDoc(doc(db, 'users', user.uid), {
            enLinea: true,
            ultimaActividad: serverTimestamp()
          });
          addDoc(collection(db, 'users', user.uid, 'sessions'), {
            tipo: 'entrada',
            timestamp: serverTimestamp()
          });
        } catch (e) { console.warn("Presencia no registrada (posible falta de reglas):", e); }

        mostrarApp();
        initApp();
        setupNotifications(); // V.5.7.0
      } else {
        currentUser = null; currentRole = null;
        mostrarLogin();
        detenerListeners();
        if (unsubUserPresence) unsubUserPresence();
        if (unsubChatGeneralGlobal) unsubChatGeneralGlobal();
        if (unsubChatPrivateGlobal) unsubChatPrivateGlobal();
      }
    });

    // Cargar Google Maps dinÃ¡micamente para asegurar que los callbacks estÃ©n listos
    function cargarGoogleMaps() {
      const script = document.createElement('script');
      const apiKey = "__GOOGLE_MAPS_API_KEY__";
      script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places,marker&callback=initGoogleMap&language=es`;
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    }
    cargarGoogleMaps();

    // â”€â”€ LOGIN / LOGOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.doLogin = async () => {
      const email = document.getElementById('l-email').value.trim();
      const pass = document.getElementById('l-pass').value;
      if (!email || !pass) return;
      const btn = document.getElementById('btn-login');
      btn.disabled = true; btn.textContent = 'Accediendoâ€¦';
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (e) {
        console.error("Login error:", e);
        mostrarLoginErr('Email o contraseÃ±a incorrectos.');
        btn.disabled = false; btn.textContent = 'Login';
      }
    };

    // â”€â”€ GESTIÃ“N DE CONTRASEÃ‘AS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.abrirModalForgot = () => {
      document.getElementById('overlay-forgot').classList.add('open');
      document.getElementById('f-email-reset').value = document.getElementById('l-email').value;
    };
    window.cerrarModalForgot = () => {
      document.getElementById('overlay-forgot').classList.remove('open');
    };
    window.requestResetEmail = async () => {
      const email = document.getElementById('f-email-reset').value.trim();
      if (!email) return;
      const btn = document.getElementById('btn-send-reset');
      btn.disabled = true; btn.textContent = 'Enviando...';
      try {
        await sendPasswordResetEmail(auth, email);
        alert('Se ha enviado un correo para restablecer tu contraseÃ±a. Revisa tu bandeja de entrada.');
        cerrarModalForgot();
      } catch (e) {
        console.error("Error sending reset email:", e);
        alert('Error al enviar el correo: ' + e.message);
      } finally {
        btn.disabled = false; btn.textContent = 'Enviar enlace de recuperaciÃ³n';
      }
    };

    window.abrirModalChangePass = () => {
      document.getElementById('overlay-change-pass').classList.add('open');
    };
    window.cerrarModalChangePass = () => {
      document.getElementById('overlay-change-pass').classList.remove('open');
      document.getElementById('curr-pass').value = '';
      document.getElementById('new-pass').value = '';
      document.getElementById('new-pass-conf').value = '';
    };
    window.confirmChangePassword = async () => {
      const p0 = document.getElementById('curr-pass').value;
      const p1 = document.getElementById('new-pass').value;
      const p2 = document.getElementById('new-pass-conf').value;
      if (!p0) return alert('Debes introducir tu contraseÃ±a actual.');
      if (!p1 || p1.length < 6) return alert('La nueva contraseÃ±a debe tener al menos 6 caracteres.');
      if (p1 !== p2) return alert('Las nuevas contraseÃ±as no coinciden.');

      const btn = document.getElementById('btn-confirm-change');
      btn.disabled = true; btn.textContent = 'Verificando...';
      try {
        // Re-autenticaciÃ³n obligatoria para mayor seguridad
        const credential = EmailAuthProvider.credential(auth.currentUser.email, p0);
        await reauthenticateWithCredential(auth.currentUser, credential);

        btn.textContent = 'Cambiando...';
        await updatePassword(auth.currentUser, p1);
        alert('ContraseÃ±a actualizada correctamente.');
        cerrarModalChangePass();
      } catch (e) {
        console.error("Error changing password:", e);
        if (e.code === 'auth/wrong-password') {
          alert('La contraseÃ±a actual es incorrecta.');
        } else {
          alert('Error al cambiar contraseÃ±a: ' + e.message);
        }
      } finally {
        btn.disabled = false; btn.textContent = 'Cambiar contraseÃ±a';
      }
    };

    // Reset flow (from email link)
    window.confirmReset = async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const oobCode = urlParams.get('oobCode');
      const p1 = document.getElementById('r-pass1').value;
      const p2 = document.getElementById('r-pass2').value;
      if (!p1 || p1.length < 6) return alert('La contraseÃ±a debe tener al menos 6 caracteres.');
      if (p1 !== p2) return alert('Las contraseÃ±as no coinciden.');

      const btn = document.getElementById('btn-reset-now');
      btn.disabled = true; btn.textContent = 'Restableciendo...';
      try {
        await confirmPasswordReset(auth, oobCode, p1);
        alert('Tu contraseÃ±a ha sido restablecida. Ya puedes iniciar sesiÃ³n.');
        window.location.href = window.location.pathname; // Reload without params
      } catch (e) {
        console.error("Error resetting password:", e);
        alert('Error al restablecer contraseÃ±a: ' + e.message);
        btn.disabled = false; btn.textContent = 'Restablecer contraseÃ±a';
      }
    };

    // Chequeo de parÃ¡metros de reset en URL al inicio
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('mode') === 'resetPassword' && urlParams.get('oobCode')) {
      setTimeout(() => {
        document.getElementById('screen-login').style.display = 'none';
        document.getElementById('overlay-reset').classList.add('open');
      }, 500);
    }

    window.doLogout = async () => {
      if (currentUser) {
        try {
          await addDoc(collection(db, 'users', currentUser.uid, 'sessions'), {
            tipo: 'salida',
            timestamp: serverTimestamp()
          });
          await updateDoc(doc(db, 'users', currentUser.uid), { enLinea: false });
        } catch (e) { console.error("Error logout presence:", e); }
      }
      signOut(auth);
    };

    // â”€â”€ INIT APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function initApp() {
      document.getElementById('hdr-user').textContent = currentUserDoc.nombre || currentUser.email;
      document.getElementById('hdr-role').textContent = ROL_LABELS[currentRole] || currentRole;

      // Actualizar tÃ­tulo de oficina y selector de provincia
      const officeTitle = document.getElementById('hdr-office-title');
      const provSelectorWrap = document.getElementById('hdr-prov-selector-wrap');
      const provSelector = document.getElementById('hdr-prov-selector');

      if (currentUserDoc.provincia && currentUserDoc.provincia !== 'AndalucÃ­a') {
        officeTitle.textContent = `Oficina Provincial de ${currentUserDoc.provincia}`;
        provSelectorWrap.style.display = 'none';
        selectedProvincia = currentUserDoc.provincia;
      } else {
        officeTitle.textContent = 'Oficina AutonÃ³mica de AndalucÃ­a';
        provSelectorWrap.style.display = 'flex';
        // Poblar selector si estÃ¡ vacÃ­o
        if (provSelector.options.length <= 1) {
          PROVINCIAS.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p;
            opt.textContent = `Oficina Provincial de ${p}`;
            provSelector.appendChild(opt);
          });
        }
        provSelector.options[0].textContent = "Oficina AutonÃ³mica de AndalucÃ­a";
        provSelector.value = selectedProvincia;
      }

      const isAdmin = currentRole === 'admin' || currentRole === 'super_admin' || currentRole === 'autonomica' || currentRole === 'provincial' || currentRole === 'manager';
      document.getElementById('btn-nueva-op').style.display = isAdmin ? 'flex' : 'none';

      const canManageGuardia = currentRole === 'super_admin' || currentRole === 'manager' || currentRole === 'admin' || currentRole === 'autonomica' || currentRole === 'provincial';
      document.getElementById('hdr-jefe-guardia-val').style.display = canManageGuardia ? 'none' : 'block';
      document.getElementById('hdr-jefe-guardia-sel').style.display = canManageGuardia ? 'block' : 'none';

      const canManageUsers = currentRole === 'super_admin' || currentRole === 'manager';
      document.getElementById('nav-usuarios').style.display = canManageUsers ? 'flex' : 'none';
      document.getElementById('mnav-usuarios').style.display = canManageUsers ? 'block' : 'none';
      if (document.getElementById('nav-tablas')) {
        document.getElementById('nav-tablas').style.display = canManageUsers ? 'flex' : 'none';
        document.getElementById('mnav-tablas').style.display = canManageUsers ? 'block' : 'none';
      }

      const isPrivileged = currentRole === 'super_admin' || currentRole === 'manager' || currentRole === 'admin';
      const sideToggle = document.getElementById('sidebar-toggle-cerradas');
      if (sideToggle) sideToggle.style.display = isPrivileged ? 'flex' : 'none';

      suscribirOps();
      suscribirJefesSelect();
      suscribirGuardia();
      suscribirTodosLosJefes();
      cargarUsuariosParaChat();
      suscribirNotificacionesChat();
      showSection('operaciones');
      if (gmap && mapReady) setTimeout(() => google.maps.event.trigger(gmap, 'resize'), 100);

      // â”€â”€ MOBILE DRAWER POPULATION (V.5.5.4) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const dn = document.getElementById('drawer-user-name');
      const dr = document.getElementById('drawer-user-role');
      if (dn) dn.textContent = currentUserDoc.nombre || currentUser.email;
      if (dr) dr.textContent = ROL_LABELS[currentRole] || currentRole;

      // Oficina
      const dOficina = document.getElementById('drawer-oficina-title');
      const dProvWrap = document.getElementById('drawer-prov-selector-wrap');
      const dProvSel = document.getElementById('drawer-prov-selector');
      if (currentUserDoc.provincia && currentUserDoc.provincia !== 'AndalucÃ­a') {
        if (dOficina) dOficina.textContent = `Oficina Provincial de ${currentUserDoc.provincia}`;
        if (dProvWrap) dProvWrap.style.display = 'none';
      } else {
        if (dOficina) dOficina.textContent = 'Oficina AutonÃ³mica de AndalucÃ­a';
        if (dProvWrap) dProvWrap.style.display = 'block';
        if (dProvSel && dProvSel.options.length <= 1) {
          PROVINCIAS.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p;
            opt.textContent = `Oficina Provincial de ${p}`;
            dProvSel.appendChild(opt);
          });
        }
        if (dProvSel) dProvSel.value = selectedProvincia;
      }

      // Jefe de Guardia drawer
      const dJefeVal = document.getElementById('drawer-jefe-guardia-val');
      const dJefeSel = document.getElementById('drawer-jefe-guardia-sel');
      if (canManageGuardia) {
        if (dJefeVal) dJefeVal.style.display = 'none';
        if (dJefeSel) dJefeSel.style.display = 'block';
      } else {
        if (dJefeVal) dJefeVal.style.display = 'block';
        if (dJefeSel) dJefeSel.style.display = 'none';
      }

      // Floating nueva op button on mobile
      const mobileNuevaBtn = document.getElementById('btn-mobile-nueva-op');
      if (mobileNuevaBtn) {
        mobileNuevaBtn.style.display = isAdmin ? 'flex' : 'none';
      }
    }

    function detenerListeners() {
      if (unsubOps) { unsubOps(); unsubOps = null; }
      if (unsubAcciones) { unsubAcciones(); unsubAcciones = null; }
      if (unsubRecursos) { unsubRecursos(); unsubRecursos = null; }
      if (unsubJefes) { unsubJefes(); unsubJefes = null; }
      if (unsubGuardia) { unsubGuardia(); unsubGuardia = null; }
      if (unsubGlobalJefes) { unsubGlobalJefes(); unsubGlobalJefes = null; }
      // Clean chat listeners (V.4.5.1)
      if (unsubChatGeneralGlobal) { unsubChatGeneralGlobal(); unsubChatGeneralGlobal = null; }
      if (unsubChatPrivateGlobal) { unsubChatPrivateGlobal(); unsubChatPrivateGlobal = null; }
      if (unsubUserPresence) { unsubUserPresence(); unsubUserPresence = null; }
      if (unsubChatDetail) { unsubChatDetail(); unsubChatDetail = null; }
      ops = {};
    }

    // â”€â”€ SUSCRIPCIÃ“N OPERACIONES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function suscribirOps() {
      if (unsubOps) unsubOps();
      const q = query(collection(db, 'operaciones'), orderBy('creadoEn', 'desc'));
      let initialLoad = true;

      unsubOps = onSnapshot(q, snap => {
        let hasNewOp = false;

        snap.docChanges().forEach(ch => {
          const d = ch.doc.data();
          const dId = ch.doc.id;

          if (ch.type === 'removed') {
            delete ops[dId];
          } else {
            const oldOp = ops[dId];
            ops[dId] = { id: dId, ...d };

            if (oldOp) {
              ops[dId]._isNew = oldOp._isNew;
              ops[dId]._hasUpdate = oldOp._hasUpdate;
            }

            // Detectar nueva operacion:
            if (ch.type === 'added') {
              // Si es la carga inicial, asumimos que no es nueva "en tiempo real"
              // a no ser que tÃº mismo la hayas creado muy recientemente
              if (!initialLoad && d.creadoPor !== currentUser.uid) {
                // Solo pitar si es de mi Ã¡mbito o soy autonÃ³mico (V.4.7.0)
                const myProv = currentUserDoc.provincia;
                const opProv = d.provincia;
                if (myProv === 'AndalucÃ­a' || myProv === opProv) {
                  hasNewOp = true;
                }
                ops[dId]._isNew = true;
              }
            }

            if (ch.type === 'modified' && dId !== selOpId) {
              const tsOld = oldOp && oldOp.actualizadoEn?.toMillis ? oldOp.actualizadoEn.toMillis() : 0;
              const tsNew = d.actualizadoEn?.toMillis ? d.actualizadoEn.toMillis() : 0;
              if (tsOld > 0 && tsNew > tsOld) {
                ops[dId]._hasUpdate = true;
              }
            }
          }
        });

        if (hasNewOp && !initialLoad) {
          alertSound.play().catch(e => console.log('Ignored auto-play:', e));
        }

        initialLoad = false;

        renderSidebar();
        renderMapa();
        actualizarContadores();
        if (selOpId && ops[selOpId]) renderDetalle(ops[selOpId]);
      }, err => {
        console.error("Ops listener error:", err);
      });
    }

    // â”€â”€ MAPA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function nivelIcon(op, t) {
      const color = NIVEL_COLORS[op.nivel] || '#888';
      const container = document.createElement('div');
      container.className = 'custom-marker';
      container.style.setProperty('--nivel-color', color);

      // Calculate orbital positions for badges
      let totalBadges = 0;
      if (op.recursosSummary && op.recursosSummary['erbes'] > 0) totalBadges++;
      if (op.recursosSummary && op.recursosSummary['eries'] > 0) totalBadges++;

      const types = [
        { key: 'camiones', icon: 'assets/icons/truck.png' },
        { key: 'ambulancias', icon: 'assets/icons/ambulance.png' },
        { key: 'offroad', icon: 'assets/icons/offroad.png' },
        { key: 'van', icon: 'assets/icons/van.png' }
      ];

      const presentVehicleTypes = types.filter(t => op.recursosSummary && (op.recursosSummary[t.key] || 0) > 0);
      totalBadges += presentVehicleTypes.length;

      let currentBadgeIdx = 0;
      let html = '';

      // ERBE (Top radial focus)
      if (op.recursosSummary && op.recursosSummary['erbes'] > 0) {
        const count = op.recursosSummary['erbes'];
        const isCrit = op.nivel == 4;
        html += `<div class="marker-radial-item erbe-focus ${isCrit ? 'has-crit' : ''}" style="--idx: ${currentBadgeIdx}; --total: ${totalBadges};">
                  <div class="badge-item-erbe">
                    <img src="assets/icons/erbe.svg" class="badge-erbes-img">
                    ${count > 1 ? `<div class="badge-count">${count}</div>` : ''}
                  </div>
                </div>`;
        currentBadgeIdx++;
      }

      // ERIE (Top radial focus)
      if (op.recursosSummary && op.recursosSummary['eries'] > 0) {
        const count = op.recursosSummary['eries'];
        const isCrit = op.nivel == 4;
        html += `<div class="marker-radial-item erie-focus ${isCrit ? 'has-crit' : ''}" style="--idx: ${currentBadgeIdx}; --total: ${totalBadges};">
                  <div class="badge-item-erbe">
                    <img src="assets/icons/erie.svg" class="badge-erbes-img">
                    ${count > 1 ? `<div class="badge-count">${count}</div>` : ''}
                  </div>
                </div>`;
        currentBadgeIdx++;
      }

      html += `
        <div class="marker-main">
          ${op._isNew ? '<div class="marker-new-glow"></div>' : ''}
          ${op.nivel == 4 ? '<div class="marker-crit-badge">!</div>' : ''}
          <div class="marker-cross">+</div>
          <div class="marker-emoji">${t.emoji}</div>
        </div>
      `;

      // Vehicles (Bottom radial focus)
      if (presentVehicleTypes.length > 0) {
        let badgesHtml = '<div class="marker-vehicles-container">';
        presentVehicleTypes.forEach(type => {
          const count = op.recursosSummary[type.key];
          badgesHtml += `
            <div class="marker-radial-item vehicle-focus" style="--idx: ${currentBadgeIdx}; --total: ${totalBadges};">
              <div class="badge-item">
                <img src="${type.icon}" class="badge-img badge-${type.key}">
                ${count > 1 ? `<div class="badge-count">${count}</div>` : ''}
              </div>
            </div>`;
          currentBadgeIdx++;
        });
        badgesHtml += '</div>';
        html += badgesHtml;
      }

      // Add expandable card
      html += `
        <div class="marker-expand-card" onclick="event.stopPropagation()">
          <div style="font-family:'Fraunces',serif;font-size:15px;font-weight:700;margin-bottom:4px;color:#111;">${op.nombre}</div>
          <div style="font-size:11px;color:#888;margin-bottom:2px;">${t.emoji} ${t.label} Â· ${op.loc || ''}</div>
          <div style="margin-bottom:10px;">
            <span style="font-size:9px;font-weight:700;padding:2px 7px;border-radius:2px;
              background:${NIVEL_COLORS[op.nivel]}20;color:${NIVEL_COLORS[op.nivel]};
              border:1px solid ${NIVEL_COLORS[op.nivel]}50;">
              ${NIVEL_LABELS[op.nivel]}
            </span>
          </div>
          <button onclick="window.abrirDetalle('${op.id}')"
            style="width:100%;padding:8px;background:#1a3a6e;border:none;color:#fff;
                   cursor:pointer;font-family:'IBM Plex Sans',sans-serif;font-size:12px;
                   font-weight:600;border-radius:2px;transition:background 0.2s;">
            Acceder a intervenciÃ³n â†’
          </button>
        </div>
      `;

      container.innerHTML = html;
      return container;
    }

    let boundsTimeout = null;
    function renderMapa() {
      if (!gmap || !mapReady) return;

      // Build search filter helper (V.5.4.0)
      const q = searchQuery.trim().toLowerCase();
      function isOpSearchVisible(op) {
        if (!isOpVisible(op)) return false;
        if (selectedProvincia !== 'AndalucÃ­a' && op.provincia !== selectedProvincia) return false;
        // Ocultas filter
        if (op.oculta === true && !mostrarCerradas) return false;
        // Search filter
        if (q) {
          const fields = [
            op.nombre || '', op.loc || '', op.tipo || '', op.id || '',
            op.provincia || '', op.dir || '', op.org || '', op.estado || '',
            `N${op.nivel}`, NIVEL_LABELS[op.nivel] || ''
          ].join(' ').toLowerCase();
          if (!fields.includes(q)) return false;
        }
        return true;
      }

      // Limpiar marcadores que ya no son visibles
      Object.keys(gmMarkers).forEach(id => {
        if (!ops[id] || !isOpSearchVisible(ops[id])) {
          gmMarkers[id].setMap(null);
          delete gmMarkers[id];
        }
      });

      const bounds = new google.maps.LatLngBounds();
      let hasValidCoords = false;

      Object.values(ops).forEach(op => {
        if (!isOpSearchVisible(op)) return;
        if (!op.coords) return;
        const t = TIPOS[op.tipo] || TIPOS.otro;
        const pos = { lat: op.coords.lat, lng: op.coords.lng };

        bounds.extend(pos);
        hasValidCoords = true;

        const iconContent = nivelIcon(op, t);
        if (gmMarkers[op.id]) {
          gmMarkers[op.id].position = pos;
          gmMarkers[op.id].content = iconContent;
        } else {
          const marker = new google.maps.marker.AdvancedMarkerElement({
            position: pos,
            map: gmap,
            content: iconContent,
            title: op.nombre
          });
          marker.addListener('click', () => {
            document.querySelectorAll('.custom-marker.expanded').forEach(el => {
              if (el !== marker.content) el.classList.remove('expanded');
            });
            marker.content.classList.toggle('expanded');
          });
          gmMarkers[op.id] = marker;
        }
      });

      if (hasValidCoords && !editPickMode && !picking && !selOpId) {
        if (boundsTimeout) clearTimeout(boundsTimeout);
        boundsTimeout = setTimeout(() => {
          const isMobile = window.innerWidth < 900;
          gmap.fitBounds(bounds, isMobile ? { top: 30, bottom: 30, left: 30, right: 30 } : { top: 40, bottom: 40, left: 340, right: 40 });
          if (gmap.getZoom() > 14) gmap.setZoom(14);
        }, 100);
      }
    }

    // â”€â”€ PICK LOCATION (nueva operaciÃ³n) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.iniciarPick = () => {
      if (!gmap || !mapReady) return;
      picking = true;
      document.getElementById('overlay-op').classList.remove('open');
      document.getElementById('pick-banner').classList.add('on');
      document.getElementById('pick-banner').textContent = 'ðŸ“ Haz clic en el mapa para fijar la ubicaciÃ³n';
      gmap.getDiv().style.cursor = 'crosshair';
      pickListener = gmap.addListener('click', e => {
        pickedCoords = { lat: e.latLng.lat(), lng: e.latLng.lng() };
        const gc = new google.maps.Geocoder();
        gc.geocode({ location: e.latLng }, (results, status) => {
          if (status === 'OK' && results[0]) {
            pickedAddress = results[0].formatted_address;
            document.getElementById('f-lugar').value = pickedAddress;
          }
          mostrarCoordBox();
          stopPick();
          window.abrirModalOp();
        });
        if (tempGmMarker) tempGmMarker.map = null;
        tempGmMarker = new google.maps.marker.AdvancedMarkerElement({
          position: e.latLng,
          map: gmap,
        });
      });
    };

    function stopPick() {
      picking = false;
      if (pickListener) { google.maps.event.removeListener(pickListener); pickListener = null; }
      document.getElementById('pick-banner').classList.remove('on');
      gmap.getDiv().style.cursor = '';
    }

    function mostrarCoordBox() {
      const box = document.getElementById('coord-box');
      box.textContent = pickedCoords ? `ðŸ“ ${pickedCoords.lat.toFixed(5)}, ${pickedCoords.lng.toFixed(5)}` : '';
      box.classList.toggle('show', !!pickedCoords);
    }

    // â”€â”€ PICK LOCATION (editar operaciÃ³n) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.iniciarEditPick = () => {
      if (!gmap || !mapReady) return;
      editPickMode = true;
      document.getElementById('overlay-edit-op').classList.remove('open');
      document.getElementById('pick-banner').classList.add('on');
      document.getElementById('pick-banner').textContent = 'ðŸ“ Haz clic en el mapa para actualizar la ubicaciÃ³n';
      gmap.getDiv().style.cursor = 'crosshair';
      editPickListener = gmap.addListener('click', e => {
        editPickedCoords = { lat: e.latLng.lat(), lng: e.latLng.lng() };
        const gc = new google.maps.Geocoder();
        gc.geocode({ location: e.latLng }, (results, status) => {
          if (status === 'OK' && results[0]) {
            editPickedAddress = results[0].formatted_address;
            document.getElementById('fe-lugar').value = editPickedAddress;
          }
          mostrarEditCoordBox();
          stopEditPick();
          document.getElementById('overlay-edit-op').classList.add('open');
        });
        if (editTempGmMarker) editTempGmMarker.map = null;
        editTempGmMarker = new google.maps.marker.AdvancedMarkerElement({
          position: e.latLng,
          map: gmap,
        });
      });
    };

    function stopEditPick() {
      editPickMode = false;
      if (editPickListener) { google.maps.event.removeListener(editPickListener); editPickListener = null; }
      document.getElementById('pick-banner').classList.remove('on');
      gmap.getDiv().style.cursor = '';
    }

    function mostrarEditCoordBox() {
      const box = document.getElementById('edit-coord-box');
      box.textContent = editPickedCoords ? `ðŸ“ ${editPickedCoords.lat.toFixed(5)}, ${editPickedCoords.lng.toFixed(5)}` : '';
      box.classList.toggle('show', !!editPickedCoords);
    }

    // â”€â”€ CONTADORES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function actualizarContadores() {
      let visible = Object.values(ops);
      if (selectedProvincia !== 'AndalucÃ­a') {
        visible = visible.filter(o => o.provincia === selectedProvincia);
      }
      [1, 2, 3, 4].forEach(n => {
        const el = document.getElementById('cnt' + n);
        if (el) el.textContent = visible.filter(o => o.nivel == n).length;
      });
    }

    // â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderSidebar() {
      const list = document.getElementById('ops-list');
      const empty = document.getElementById('empty-msg');
      list.querySelectorAll('.op-card').forEach(c => c.remove());

      let visible = Object.values(ops).filter(isOpVisible);

      // Filtrado por provincia
      if (selectedProvincia !== 'AndalucÃ­a') {
        visible = visible.filter(o => o.provincia === selectedProvincia);
      }

      // LÃ³gica de filtrado de intervenciones ocultas (V.3.4.0)
      visible = visible.filter(op => {
        const isOculta = op.oculta === true;
        if (isOculta) return mostrarCerradas;
        return true;
      });

      // BÃºsqueda de texto (V.5.4.0)
      if (searchQuery.trim()) {
        const q = searchQuery.trim().toLowerCase();
        visible = visible.filter(op => {
          const fields = [
            op.nombre || '',
            op.loc || '',
            op.tipo || '',
            op.id || '',
            op.provincia || '',
            op.dir || '',
            op.org || '',
            op.estado || '',
            `N${op.nivel}`,
            NIVEL_LABELS[op.nivel] || ''
          ].join(' ').toLowerCase();
          return fields.includes(q);
        });
      }

      visible.sort((a, b) => {
        if (a.nivel == 4 && b.nivel != 4) return -1;
        if (a.nivel != 4 && b.nivel == 4) return 1;
        const ta = a.actualizadoEn?.toMillis ? a.actualizadoEn.toMillis() : 0;
        const tb = b.actualizadoEn?.toMillis ? b.actualizadoEn.toMillis() : 0;
        return tb - ta;
      });

      if (!visible.length) { empty.classList.add('show'); return; }
      empty.classList.remove('show');

      visible.forEach(op => {
        const t = TIPOS[op.tipo] || TIPOS.otro;
        const card = document.createElement('div');
        let classes = 'op-card';
        if (selOpId === op.id) classes += ' sel';
        if (op._isNew) classes += ' is-new';
        card.className = classes;
        card.dataset.nivel = op.nivel;

        let badgeHtml = '';
        if (op._isNew) {
          badgeHtml = `<div class="card-badge new-badge" title="Nueva operaciÃ³n"></div>`;
        } else if (op._hasUpdate) {
          badgeHtml = `<div class="card-badge update-badge" title="Nuevos mensajes"></div>`;
        }

        card.innerHTML = `
      <div class="card-top" style="position:relative;">
        <div>
          <div class="card-scope" style="font-size:9px; font-weight:700; color:var(--accent); text-transform:uppercase; margin-bottom:2px; opacity:0.8;">
            ${op.provincia === 'AndalucÃ­a' ? 'Oficina AutonÃ³mica de AndalucÃ­a' : `Oficina Provincial de ${op.provincia}`}
          </div>
          <div class="card-id">${op.id.substring(0, 8).toUpperCase()}</div>
          <div class="card-name" style="padding-right:16px;">${op.nombre}</div>
        </div>
        ${badgeHtml}
        <span class="card-type-tag" style="color:${t.color};border-color:${t.color}30;background:${t.color}12">${t.emoji} ${TIPOS[op.tipo] ? t.label : op.tipo}</span>
      </div>
      <div class="card-meta">
        <span class="card-loc">ðŸ“ ${op.loc || 'Sin ubicaciÃ³n'}</span>
        <div style="display:flex; gap:4px; align-items:center;">
          ${op.estado === 'finalizada' ? '<span style="font-size:9px;font-weight:700;padding:2px 6px;border-radius:2px;background:var(--bg-3);color:var(--text-3);border:1px solid var(--border-mid);">FINALIZADA</span>' : ''}
          <span class="nivel-pill pill-${op.nivel}">${NIVEL_LABELS[op.nivel]}</span>
        </div>
      </div>`;
        card.addEventListener('click', () => {
          if (selOpId === op.id && document.getElementById('detail-panel').classList.contains('open')) {
            window.cerrarDetalle();
          } else {
            window.abrirDetalle(op.id);
          }
        });
        list.appendChild(card);
      });
    }

    window.setFiltro = (f, btn) => {
      filtro = f;
      document.querySelectorAll('.ftab').forEach(b => b.classList.remove('on', 'on-n1', 'on-n2', 'on-n3', 'on-n4'));
      btn.classList.add(f === 'all' ? 'on' : `on-n${f}`);
      renderSidebar();
    };

    window.handleSearch = (value) => {
      searchQuery = value;
      document.getElementById('ops-search-clear').style.display = value ? 'flex' : 'none';
      renderSidebar();
      renderMapa();
    };

    window.clearSearch = () => {
      const input = document.getElementById('ops-search');
      if (input) input.value = '';
      searchQuery = '';
      document.getElementById('ops-search-clear').style.display = 'none';
      renderSidebar();
      renderMapa();
    };

    // â”€â”€ DETALLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.abrirDetalle = (id) => {
      selOpId = id;
      const op = ops[id];
      if (!op) return;

      // Limpiar badges por visualizaciÃ³n
      if (op._isNew || op._hasUpdate) {
        op._isNew = false;
        op._hasUpdate = false;
        // Re-renderizamos en mapa y lista para quitar la notificaciÃ³n visual
        if (gmMarkers[id]) {
          const t = TIPOS[op.tipo] || TIPOS.otro;
          gmMarkers[id].content = nivelIcon(op.nivel, t.emoji, false, false, op.recursosSummary);
        }
      }

      document.getElementById('detail-panel').classList.add('open');
      if (gmap && mapReady) setTimeout(() => google.maps.event.trigger(gmap, 'resize'), 100);
      renderDetalle(op);
      renderSidebar();
      if (op.coords && gmap) {
        // Centrar suavemente en el Ã¡rea visible (derecha de los paneles)
        const currentZoom = gmap.getZoom();
        const targetZoom = (currentZoom < 10 || currentZoom > 16) ? 13 : currentZoom;

        // Offset simple: si el panel de detalle + sidebar son ~700px, 
        // queremos descentrar el centro real un poco a la izquierda para que el marcador 
        // quede centrado en el hueco del mapa.
        const projection = gmap.getProjection();
        if (projection && window.innerWidth > 900) {
          const pos = new google.maps.LatLng(op.coords.lat, op.coords.lng);
          // 350px de offset (mitad del espacio ocupado por paneles)
          const offset = 350 / Math.pow(2, targetZoom);
          // Esto es una simplificaciÃ³n, panTo con padding en fitBounds es mÃ¡s preciso pero salta mÃ¡s.
          // Para evitar saltos, usamos panTo directo si el usuario lo prefiere.
          // Pero el usuario dice que "desplaza el mapa hacia la derecha". 
          // Si es absolute, el mapa ocupa todo. AsÃ­ que el marcador debe quedar 
          // a la derecha del panel.

          gmap.setZoom(targetZoom);
          gmap.panTo(pos);
          // Aplicamos un pequeÃ±o retraso para el offset visual si fuera necesario, 
          // pero panTo estÃ¡ndar es mÃ¡s "estable".
        } else {
          gmap.setZoom(targetZoom);
          gmap.panTo({ lat: op.coords.lat, lng: op.coords.lng });
        }
      }
      suscribirAcciones(id);
      suscribirRecursos(id);
    };

    window.cerrarDetalle = () => {
      document.getElementById('detail-panel').classList.remove('open');
      if (gmap && mapReady) setTimeout(() => google.maps.event.trigger(gmap, 'resize'), 100);
      selOpId = null;
      if (unsubAcciones) { unsubAcciones(); unsubAcciones = null; }
      if (unsubRecursos) { unsubRecursos(); unsubRecursos = null; }
      renderSidebar();
      renderMapa(); // Re-center map to show all
    };

    function suscribirAcciones(opId) {
      if (unsubAcciones) unsubAcciones();
      const q = query(collection(db, 'operaciones', opId, 'acciones'), orderBy('timestamp', 'desc'));
      unsubAcciones = onSnapshot(q, snap => {
        const acciones = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        currentAcciones = {};
        acciones.forEach(a => currentAcciones[a.id] = a);
        renderTimeline(acciones, ops[opId]);
      });
    }

    let currentAssignedIds = [];
    function suscribirRecursos(opId) {
      if (unsubRecursos) unsubRecursos();
      const q = query(collection(db, 'operaciones', opId, 'recursos'), orderBy('asignadoEn', 'desc'));
      unsubRecursos = onSnapshot(q, snap => {
        const recursos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        currentAssignedIds = recursos.map(r => r.recursoId);
        renderRecursosOp(recursos, ops[opId]);
      });
    }

    let opcionesRecursosCache = { vehiculos: [], erbes: [], eries: [] };

    window.cargarOpcionesRecursos = async () => {
      const cat = document.getElementById('r-cat').value;
      const sel = document.getElementById('r-item');
      sel.innerHTML = '<option value="">Selecciona recurso...</option>';
      if (!cat || !selOpId) return;

      const currentOp = ops[selOpId];
      if (!currentOp) return;

      if (cat === 'vehiculos') {
        const snap = await getDocs(collection(db, 'vehiculos'));
        opcionesRecursosCache.vehiculos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        // Filtrar vehÃ­culos por el Ã¡mbito de la operaciÃ³n
        let filtered = opcionesRecursosCache.vehiculos.filter(v => {
          const prov = v.provincia || 'MÃ¡laga';
          return prov === currentOp.provincia;
        });

        // FILTRO: No mostrar los que ya estÃ¡n asignados
        filtered = filtered.filter(v => !currentAssignedIds.includes(v.id));

        filtered.forEach(v => {
          sel.innerHTML += `<option value="${v.id}">${v.indicativo} - ${v.tipo} (${v.matricula})</option>`;
        });
      } else if (cat === 'erbes') {
        const snap = await getDocs(collection(db, 'erbes'));
        opcionesRecursosCache.erbes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        let filtered = opcionesRecursosCache.erbes.filter(e => {
          const prov = e.provincia || 'MÃ¡laga';
          return prov === currentOp.provincia;
        });

        filtered = filtered.filter(e => !currentAssignedIds.includes(e.id));

        filtered.forEach(e => {
          sel.innerHTML += `<option value="${e.id}">ERBE ${e.localidad} (${e.provincia})</option>`;
        });
      } else if (cat === 'eries') {
        const snap = await getDocs(collection(db, 'eries'));
        opcionesRecursosCache.eries = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        let filtered = opcionesRecursosCache.eries.filter(e => {
          const prov = e.provincia || 'MÃ¡laga';
          return prov === currentOp.provincia;
        });

        filtered = filtered.filter(e => !currentAssignedIds.includes(e.id));

        filtered.forEach(e => {
          sel.innerHTML += `<option value="${e.id}">ERIE ${e.especialidad} (${e.provincia})</option>`;
        });
      }
    };

    window.asignarRecurso = async () => {
      if (!selOpId) return;
      const cat = document.getElementById('r-cat').value;
      const itemId = document.getElementById('r-item').value;
      if (!cat || !itemId) return;

      const btn = document.getElementById('btn-add-recurso');
      btn.disabled = true; btn.textContent = '...';

      try {
        let recursoDesc = '';
        if (cat === 'vehiculos') {
          const v = opcionesRecursosCache.vehiculos.find(x => x.id === itemId);
          if (v) recursoDesc = `ðŸš— ${v.indicativo} - ${v.tipo} (${v.matricula})`;
        } else if (cat === 'erbes') {
          const e = opcionesRecursosCache.erbes.find(x => x.id === itemId);
          if (e) recursoDesc = `ðŸ¥ ERBE ${e.localidad}`;
        } else if (cat === 'eries') {
          const e = opcionesRecursosCache.eries.find(x => x.id === itemId);
          if (e) recursoDesc = `ðŸ¥ ERIE ${e.especialidad}`;
        }

        if (recursoDesc) {
          await setDoc(doc(db, 'operaciones', selOpId, 'recursos', itemId), {
            id: itemId,
            categoria: cat,
            recursoId: itemId,
            descripcion: recursoDesc,
            asignadoEn: serverTimestamp(),
            asignadoPor: currentUser.uid
          });

          const autorNombre = currentUserDoc.nombre || currentUser.email;
          await addDoc(collection(db, 'operaciones', selOpId, 'acciones'), {
            texto: `Se ha asignado el recurso: ${recursoDesc}`,
            prioridad: 'Baja',
            autor: autorNombre,
            uid: currentUser.uid,
            timestamp: serverTimestamp()
          });

          try {
            const opRef = doc(db, 'operaciones', selOpId);
            const opSnap = await getDoc(opRef);
            const rSum = opSnap.data().recursosSummary || {};

            let key = 'otros';
            if (cat === 'vehiculos') {
              const keyMap = {
                'CamiÃ³n': 'camiones',
                'Ambulancia': 'ambulancias',
                'VehÃ­culo Todo terreno': 'offroad',
                'Todo Terreno': 'offroad',
                'VehÃ­culo transporte personal': 'van',
                'VehÃ­culo de transporte mixto': 'van',
                'Furgoneta': 'van'
              };
              const v = opcionesRecursosCache.vehiculos.find(x => x.id === itemId);
              key = keyMap[v.tipo] || 'otros';
            } else if (cat === 'erbes') {
              key = 'erbes';
            } else if (cat === 'eries') {
              key = 'eries';
            }
            rSum[key] = (rSum[key] || 0) + 1;

            await updateDoc(opRef, {
              recursosSummary: rSum,
              actualizadoEn: serverTimestamp()
            });
          } catch (e) { console.error("Error updating recursosSummary:", e); }
        }
        document.getElementById('r-cat').value = '';
        document.getElementById('r-item').innerHTML = '<option value="">Selecciona recurso...</option>';
      } catch (e) { alert('Error asignando recurso: ' + e.message); }
      btn.disabled = false; btn.textContent = 'AÃ±adir';
    };

    window.desasignarRecurso = async (id, desc) => {
      if (!selOpId) return;
      if (!confirm('Â¿Retirar este recurso de la operaciÃ³n?')) return;
      try {
        await deleteDoc(doc(db, 'operaciones', selOpId, 'recursos', id));
        const autorNombre = currentUserDoc.nombre || currentUser.email;
        await addDoc(collection(db, 'operaciones', selOpId, 'acciones'), {
          texto: `Se ha retirado el recurso: ${desc}`,
          prioridad: 'Baja',
          autor: autorNombre,
          uid: currentUser.uid,
          timestamp: serverTimestamp()
        });
        try {
          const opRef = doc(db, 'operaciones', selOpId);
          const opSnap = await getDoc(opRef);
          const rSum = opSnap.data().recursosSummary || {};

          // Inferir tipo de la descripciÃ³n (esto es un poco frÃ¡gil pero funciona con el desc generado)
          let key = 'otros';
          if (desc.includes('ðŸš—')) { // Asumimos que los vehiculos empiezan con emoji
            if (desc.includes('CamiÃ³n')) key = 'camiones';
            else if (desc.includes('Ambulancia')) key = 'ambulancias';
            else if (desc.includes('Todo terreno') || desc.includes('Todo Terreno')) key = 'offroad';
            else if (desc.includes('VehÃ­culo transporte personal') || desc.includes('VehÃ­culo de transporte mixto') || desc.includes('Furgoneta')) key = 'van';
          } else if (desc.includes('ðŸ¥ ERBE')) {
            key = 'erbes';
          } else if (desc.includes('ðŸ¥ ERIE')) {
            key = 'eries';
          }

          if (rSum[key] > 0) rSum[key]--;

          await updateDoc(opRef, {
            recursosSummary: rSum,
            actualizadoEn: serverTimestamp()
          });
        } catch (e) { console.error("Error updating recursosSummary:", e); }
      } catch (e) { alert('Error: ' + e.message); }
    };

    function renderRecursosOp(recursos, op) {
      const list = document.getElementById('dp-recursos-list');
      const form = document.getElementById('dp-recursos-form');
      const isFinalizada = op?.estado === 'finalizada';
      const canModify = !isFinalizada && (currentRole === 'admin' || currentRole === 'super_admin' || currentRole === 'usuario' || currentRole === 'manager');

      if (form) form.style.display = canModify ? 'block' : 'none';
      if (!list) return;

      const summary = document.getElementById('dp-recursos-summary');
      if (summary) summary.textContent = `Asignar Recursos (${recursos.length})`;

      if (!recursos.length) {
        list.innerHTML = '<div style="font-size:11px;color:var(--text-4);">No hay recursos asignados.</div>';
        return;
      }

      list.innerHTML = recursos.map(r => {
        const desc = r.descripcion || '';
        let iconUrl = '';
        if (desc.includes('CamiÃ³n')) iconUrl = 'assets/icons/truck.png';
        else if (desc.includes('Ambulancia')) iconUrl = 'assets/icons/ambulance.png';
        else if (desc.includes('Todo terreno') || desc.includes('Todo Terreno')) iconUrl = 'assets/icons/offroad.png';
        else if (desc.includes('VehÃ­culo transporte personal') || desc.includes('VehÃ­culo de transporte mixto') || desc.includes('Furgoneta')) iconUrl = 'assets/icons/van.png';
        else if (desc.includes('ðŸ¥ ERBE')) iconUrl = 'assets/icons/erbe.svg';

        const iconHtml = iconUrl ? `<img src="${iconUrl}" style="width:16px; height:16px; margin-right:6px; vertical-align:middle;">` : '';
        const btnDelete = canModify ? `<button onclick="desasignarRecurso('${r.id}', '${r.descripcion}')" style="background:none;border:none;color:var(--crit-1);cursor:pointer;font-size:14px;line-height:1;" title="Retirar">âœ•</button>` : '';
        return `
        <div style="display:flex; justify-content:space-between; align-items:center; background:var(--bg-2); padding:5px 10px; border:1px solid var(--border-mid); border-radius:2px; font-size:11px;">
          <div style="display:flex; align-items:center;">
            ${iconHtml}
            <span style="font-weight:600;">${desc}</span>
          </div>
          ${btnDelete}
        </div>`;
      }).join('');
    }

    function renderDetalle(op) {
      const t = TIPOS[op.tipo] || TIPOS.otro;
      const isAdmin = currentRole === 'admin' || currentRole === 'super_admin' || currentRole === 'manager';
      const isSA = currentRole === 'super_admin';

      document.getElementById('dp-id').textContent = op.id.substring(0, 8).toUpperCase();
      const scopeTitle = document.getElementById('dp-scope-title');
      if (scopeTitle) {
        scopeTitle.textContent = op.provincia === 'AndalucÃ­a' ? 'Oficina AutonÃ³mica de AndalucÃ­a' : `Oficina Provincial de ${op.provincia}`;
      }
      document.getElementById('dp-name').textContent = op.nombre;
      document.getElementById('dp-loc').innerHTML = op.loc ? `ðŸ“ ${op.loc} ` : (op.coords ? `ðŸ“ ${op.coords.lat.toFixed(4)}, ${op.coords.lng.toFixed(4)} ` : '');
      document.getElementById('dp-type-tag').innerHTML =
        `<span class="card-type-tag" style="color:${t.color};border-color:${t.color}30;background:${t.color}12">${t.emoji} ${TIPOS[op.tipo] ? t.label : op.tipo}</span>`;

      document.querySelectorAll('.nsel-opt').forEach(b => {
        b.classList.toggle('on', parseInt(b.dataset.n) === op.nivel);
        b.disabled = false;
      });

      const ir = document.getElementById('dp-info-row');
      const ts = op.creadoEn?.toDate
        ? op.creadoEn.toDate().toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' })
        : 'â€”';
      ir.innerHTML = '';
      if (op.dir) ir.innerHTML += `<div class="dp-info-item"><strong>${op.dir}</strong>Jefe de Operaciones</div>`;
      if (op.org) ir.innerHTML += `<div class="dp-info-item"><strong>${op.org}</strong>Solicitado por</div>`;
      if (op.creadoPorNombre) ir.innerHTML += `<div class="dp-info-item"><strong>${op.creadoPorNombre}</strong>Creado por</div>`;
      ir.innerHTML += `<div class="dp-info-item"><strong>${ts}</strong>Inicio</div>`;

      // Campo autor readonly
      document.getElementById('a-autor').value = currentUserDoc.nombre || currentUser.email;
      document.getElementById('a-autor').readOnly = true;

      // LÃ³gica de finalizaciÃ³n e informes
      const isFinalizada = op.estado === 'finalizada';

      document.getElementById('dp-addaction-wrapper').style.display = isFinalizada ? 'none' : 'block';
      document.getElementById('dp-edit-btn').style.display = (isAdmin && !isFinalizada) ? 'inline-flex' : 'none';
      document.getElementById('dp-fin-btn').style.display = (isAdmin && !isFinalizada) ? 'inline-flex' : 'none';
      document.getElementById('dp-ai-btn').style.display = isFinalizada ? 'inline-flex' : 'none';

      document.getElementById('dp-admin-btns').style.display = isSA ? 'flex' : 'none';
      document.getElementById('dp-reabrir-btn').style.display = (isSA && isFinalizada) ? 'inline-flex' : 'none';

      // Deshabilitar selector de nivel si estÃ¡ finalizada
      document.querySelectorAll('.nsel-opt').forEach(b => {
        b.disabled = isFinalizada;
      });

      // LÃ³gica de Ocultar (V.3.4.0)
      const hideWrapper = document.getElementById('dp-hide-wrapper');
      if (hideWrapper) {
        if (isFinalizada && (currentRole === 'admin' || currentRole === 'super_admin' || currentRole === 'manager')) {
          hideWrapper.style.display = 'flex';
          document.getElementById('dp-hide-switch').checked = !!op.oculta;
        } else {
          hideWrapper.style.display = 'none';
        }
      }
    }

    window.toggleOcultarActual = async (checked) => {
      if (!selOpId) return;
      try {
        await updateDoc(doc(db, 'operaciones', selOpId), { oculta: checked, actualizadoEn: serverTimestamp() });
        mostrarToast(checked ? 'IntervenciÃ³n ocultada' : 'IntervenciÃ³n visible');
      } catch (e) { alert('Error: ' + e.message); }
    };

    window.toggleGlobalCerradas = (checked) => {
      mostrarCerradas = checked;
      renderSidebar();
      renderMapa();
    };

    function renderTimeline(acciones, op) {
      const tl = document.getElementById('dp-timeline');
      const t = op ? (TIPOS[op.tipo] || TIPOS.otro) : TIPOS.otro;
      const nivel = op ? op.nivel : 1;
      if (!acciones.length) {
        tl.innerHTML = '<div class="tl-empty">// Sin novedades registradas //</div>';
        return;
      }
      tl.innerHTML = acciones.map(a => {
        const ts = a.timestamp?.toDate
          ? a.timestamp.toDate().toLocaleString('es-ES', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })
          : 'â€”';

        const isAdmin = currentRole === 'admin' || currentRole === 'super_admin' || currentRole === 'manager';
        const isFinalizada = op?.estado === 'finalizada';
        const editBtn = (isAdmin && !isFinalizada)
          ? `<button class="btn-cancel-m" style="padding: 2px 8px; font-size: 11px; margin-left: auto;" onclick="abrirModalEditAccion('${a.id}')">âœï¸ Editar</button>`
          : '';

        return `<div class="tl-entry">
      <div class="tl-node tl-node-${nivel}">${t.emoji}</div>
      <div class="tl-body">
        <div class="tl-meta" style="display:flex; align-items:center;">
          <span class="tl-ts">${ts}</span>
          <span class="tl-prio prio-${a.prioridad}">${a.prioridad}</span>
          ${editBtn}
        </div>
        <div class="tl-text">${a.texto}</div>
        <div class="tl-author">â€” ${a.autor || 'â€”'}</div>
      </div>
    </div > `;
      }).join('');
    }

    // â”€â”€ CAMBIAR NIVEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.cambiarNivel = async n => {
      if (!selOpId) return;
      const op = ops[selOpId];
      if (!op) return;

      if (parseInt(op.nivel) === n) return;
      const comment = prompt(`Vas a cambiar la prioridad a N${n} ${NIVEL_LABELS[n]}. Por favor, indica el motivo:`);
      if (comment === null) return;
      const finalComment = comment.trim() || "Sin comentario adicional";

      try {
        await updateDoc(doc(db, 'operaciones', selOpId), { nivel: n, actualizadoEn: serverTimestamp() });

        // Registrar en el log como una novedad
        const autorNombre = currentUserDoc.nombre || currentUser.email;
        await addDoc(collection(db, 'operaciones', selOpId, 'acciones'), {
          texto: `Cambio de prioridad: N${op.nivel} ${NIVEL_LABELS[op.nivel] || op.nivel} âž” N${n} ${NIVEL_LABELS[n]}. Motivo: ${finalComment}`,
          prioridad: 'Baja',
          autor: autorNombre,
          uid: currentUser.uid,
          timestamp: serverTimestamp()
        });

        if (gmMarkers[selOpId]) {
          const t = TIPOS[op.tipo] || TIPOS.otro;
          gmMarkers[selOpId].content = nivelIcon(n, t.emoji, false, false, op.recursosSummary);
        }
        mostrarToast('Prioridad actualizada y registrada.');
      } catch (e) {
        alert('Error al cambiar nivel: ' + e.message);
      }
    };

    // â”€â”€ EDITAR ACCIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.abrirModalEditAccion = (id) => {
      if (!selOpId || !currentAcciones[id]) return;
      editAccionId = id;
      const accion = currentAcciones[id];
      document.getElementById('ea-texto').value = accion.texto || '';

      if (accion.timestamp?.toDate) {
        const d = accion.timestamp.toDate();
        const yy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        const hh = String(d.getHours()).padStart(2, '0');
        const mn = String(d.getMinutes()).padStart(2, '0');
        document.getElementById('ea-fecha').value = `${yy}-${mm}-${dd}T${hh}:${mn}`;
      } else {
        document.getElementById('ea-fecha').value = '';
      }

      document.getElementById('overlay-edit-accion').classList.add('open');
      setTimeout(() => document.getElementById('ea-texto').focus(), 100);
    };

    window.cerrarModalEditAccion = () => {
      document.getElementById('overlay-edit-accion').classList.remove('open');
      editAccionId = null;
    };

    window.guardarEditAccion = async () => {
      if (!selOpId || !editAccionId) return;

      const btn = document.getElementById('btn-guardar-edit-accion');
      btn.disabled = true; btn.textContent = 'Guardandoâ€¦';

      try {
        const texto = document.getElementById('ea-texto').value.trim();
        const valFecha = document.getElementById('ea-fecha').value;
        const ts = valFecha ? new Date(valFecha) : new Date();

        await updateDoc(doc(db, 'operaciones', selOpId, 'acciones', editAccionId), {
          texto,
          timestamp: ts
        });

        cerrarModalEditAccion();
      } catch (e) {
        alert('Error: ' + e.message);
      }
      btn.disabled = false; btn.textContent = 'Guardar novedad â†’';
    };

    window.eliminarAccion = async () => {
      if (!selOpId || !editAccionId) return;
      if (!confirm('Â¿Seguro que deseas eliminar esta novedad? Esta acciÃ³n no se puede deshacer.')) return;

      const btn = document.getElementById('btn-guardar-edit-accion');
      btn.disabled = true; btn.textContent = 'Eliminandoâ€¦';

      try {
        await deleteDoc(doc(db, 'operaciones', selOpId, 'acciones', editAccionId));
        cerrarModalEditAccion();
        mostrarToast('Novedad eliminada.');
      } catch (e) {
        alert('Error al eliminar: ' + e.message);
      }
      btn.disabled = false; btn.textContent = 'Guardar novedad â†’';
    };

    // â”€â”€ AÃ‘ADIR ACCIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.addAccion = async () => {
      if (!selOpId) return;
      const texto = document.getElementById('a-texto').value.trim();
      if (!texto) { document.getElementById('a-texto').focus(); return; }
      const btn = document.getElementById('btn-reg-accion');
      btn.disabled = true;
      try {
        const autorNombre = currentUserDoc.nombre || currentUser.email;
        await addDoc(collection(db, 'operaciones', selOpId, 'acciones'), {
          texto,
          prioridad: document.getElementById('a-prio').value,
          autor: autorNombre,
          uid: currentUser.uid,
          timestamp: serverTimestamp()
        });

        try {
          await updateDoc(doc(db, 'operaciones', selOpId), { actualizadoEn: serverTimestamp() });
        } catch (updateErr) {
          console.warn("Usuario sin permisos para actualizar la operaciÃ³n principal, pero novedad aÃ±adida.");
        }

        document.getElementById('a-texto').value = '';
      } catch (e) { alert('Error: ' + e.message); }
      btn.disabled = false;
    };

    // â”€â”€ BORRAR OPERACIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.borrarOp = async () => {
      if (!selOpId) return;
      if (!confirm('Â¿Borrar esta operaciÃ³n? No se puede deshacer.')) return;
      if (gmMarkers[selOpId]) { gmMarkers[selOpId].setMap(null); delete gmMarkers[selOpId]; }
      await deleteDoc(doc(db, 'operaciones', selOpId));
      cerrarDetalle();
    };

    // â”€â”€ FINALIZAR / REABRIR OPERACIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.finalizarOp = async () => {
      if (!selOpId) return;
      if (!confirm('Â¿Finalizar esta operaciÃ³n? Ya no se podrÃ¡n aÃ±adir novedades ni editar, y se habilitarÃ¡ el informe IA.')) return;
      try {
        const autorNombre = currentUserDoc.nombre || currentUser.email;
        await addDoc(collection(db, 'operaciones', selOpId, 'acciones'), {
          texto: 'OperaciÃ³n finalizada por el administrador.',
          prioridad: 'Baja',
          autor: autorNombre,
          uid: currentUser.uid,
          timestamp: serverTimestamp()
        });
        await updateDoc(doc(db, 'operaciones', selOpId), { estado: 'finalizada', actualizadoEn: serverTimestamp() });
        mostrarToast('OperaciÃ³n finalizada.');
      } catch (e) { alert('Error: ' + e.message); }
    };

    window.reabrirOp = async () => {
      if (!selOpId) return;
      if (!confirm('Â¿Reabrir esta operaciÃ³n? VolverÃ¡ a estar activa y escribible.')) return;
      try {
        const autorNombre = currentUserDoc.nombre || currentUser.email;
        await addDoc(collection(db, 'operaciones', selOpId, 'acciones'), {
          texto: 'OperaciÃ³n reabierta por super_admin.',
          prioridad: 'Media',
          autor: autorNombre,
          uid: currentUser.uid,
          timestamp: serverTimestamp()
        });
        await updateDoc(doc(db, 'operaciones', selOpId), { estado: 'activa', actualizadoEn: serverTimestamp() });
        mostrarToast('OperaciÃ³n reabierta.');
      } catch (e) { alert('Error: ' + e.message); }
    };

    // â”€â”€ INFORME IA (GEMINI) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.abrirModalInformeIA = async () => {
      if (!selOpId) return;
      const op = ops[selOpId];
      if (!op) return;

      const btn = document.getElementById('dp-ai-btn');
      btn.disabled = true; btn.textContent = 'Generando informe...';

      try {
        // 1. Recopilamos datos bÃ¡sicos
        const t = TIPOS[op.tipo] || TIPOS.otro;
        let dataContext = `Nombre operaciÃ³n: ${op.nombre} \n`;
        dataContext += `Tipo: ${t.label} \nUbicaciÃ³n: ${op.loc || 'N/A'} \n`;
        dataContext += `Jefe de Operaciones: ${op.dir || 'N/A'} \nSolicitado por: ${op.org || 'N/A'} \n\n`;
        dataContext += `================ HILO CRONOLÃ“GICO DE ACCIONES ================\n`;

        // 2. Traer todas las acciones/novedades ordenadas
        const snap = await getDocs(query(collection(db, 'operaciones', selOpId, 'acciones'), orderBy('timestamp', 'asc')));
        if (snap.empty) {
          dataContext += "(Sin acciones registradas)\n";
        } else {
          snap.forEach(doc => {
            const a = doc.data();
            const dateStr = a.timestamp?.toDate ? a.timestamp.toDate().toLocaleString('es-ES') : 'Fecha desconocida';
            dataContext += `[${dateStr}]- Prioridad: ${a.prioridad} - Autor: ${a.autor} \n`;
            dataContext += `Novedad: ${a.texto} \n`;
            dataContext += `----------------------------------------------------------\n`;
          });
        }

        // 3. Prompt estricto para Gemini
        const prompt = `
Eres un analista experto en gestiÃ³n de emergencias y catÃ¡strofes de la plataforma EmerCRE.
El usuario ha solicitado generar un informe final ejecutivo y bien estructurado que resuma esta intervenciÃ³n finalizada.

          INSTRUCCIONES:
        1. Lee todos los datos base y el hilo cronolÃ³gico de acciones.
2. Genera un resumen ejecutivo en espaÃ±ol, profesional, claro y neutro. 
3. Estructura el informe usando etiquetas HTML simples compatibles(<h1>, <h2>, <p>, <ul>, <li>, <strong>) para poder renderizarlo en la web directamente. No envuelvas el resultado en \`\`\`html.
          4. El informe debe contener estas secciones principales:
          - Resumen Ejecutivo (situaciÃ³n general y desenlace)
          - Recursos y OrganizaciÃ³n (organismos y directores involucrados)
          - CronologÃ­a Destacada (los hitos mÃ¡s relevantes resumidos)
          - ConclusiÃ³n Final (estado actual, sin inventar datos que no estÃ©n)
          Si faltan datos, indÃ­calo de forma elegante.

          DATOS DE LA INTERVENCIÃ“N:
          ${dataContext}
          `;

        // 4. Llamada a la API de Gemini
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${geminiApiKey}`;

        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ role: "user", parts: [{ text: prompt }] }],
            generationConfig: {
              temperature: 0.2,
              topK: 40,
              topP: 0.95,
              maxOutputTokens: 8192,
            }
          })
        });

        if (!response.ok) {
          const errData = await response.json();
          throw new Error(errData.error?.message || 'Error en la peticiÃ³n a Gemini');
        }

        const data = await response.json();
        let textReport = data.candidates[0].content.parts[0].text;

        // Limpiamos posible formateo markdown
        textReport = textReport.replace(/^```html\n?/, '').replace(/\n?```$/, '');

        // 5. Mostrar en Modal
        document.getElementById('ai-report-content').innerHTML = textReport;
        document.getElementById('overlay-ai-report').classList.add('open');

      } catch (e) {
        alert('Error al generar el informe IA: ' + e.message);
      }

      btn.disabled = false; btn.textContent = 'âœ¨ Emitir informe (IA)';
    };

    window.cerrarModalInformeIA = () => {
      document.getElementById('overlay-ai-report').classList.remove('open');
    };

    // â”€â”€ HELPERS SELECTORES SOLICITUD Y TIPO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.handleTipoChange = (prefix) => {
      const select = document.getElementById(`${prefix}-tipo`);
      const input = document.getElementById(`${prefix}-tipo-otro`);
      if (select && input) {
        input.style.display = select.value === 'otro' ? 'block' : 'none';
        if (select.value !== 'otro') input.value = '';
      }
    };

    window.handleSolicitadoChange = (prefix) => {
      const orgSelect = document.getElementById(`${prefix}-org`);
      const subContainer = document.getElementById(`${prefix}-org-sub`);
      const subInput = document.getElementById(`${prefix}-org-sub-input`);
      const subSelect = document.getElementById(`${prefix}-org-sub-select`);

      if (subContainer) {
        subContainer.style.display = 'block';
        subInput.style.display = 'none';
        subSelect.style.display = 'none';
        subInput.value = '';

        switch (orgSelect.value) {
          case 'Ayuntamiento':
            subInput.placeholder = "Indica quÃ© ayuntamiento...";
            subInput.style.display = 'block';
            break;
          case 'Cruz Roja':
            subInput.placeholder = "Indica quiÃ©n dentro de Cruz Roja...";
            subInput.style.display = 'block';
            break;
          case 'Otro':
            subInput.placeholder = "Indica el organismo o persona...";
            subInput.style.display = 'block';
            break;
          case 'Jefe de Operaciones':
            subSelect.style.display = 'block';
            // Auto-seleccionar el jefe que ya estÃ¡ puesto en el campo de direcciÃ³n (V.4.6.2)
            const jefeActual = document.getElementById(`${prefix}-dir`).value;
            if (jefeActual) subSelect.value = jefeActual;
            break;
          default:
            subContainer.style.display = 'none';
            break;
        }
      }
    }

    window.parseSolicitadoData = (prefix) => {
      const mainVal = document.getElementById(`${prefix}-org`).value;
      if (mainVal === '112' || mainVal === '061' || !mainVal) return mainVal;

      if (mainVal === 'Jefe de Operaciones') {
        return `Jefe de Operaciones - ${document.getElementById(`${prefix}-org-sub-select`).value}`;
      } else if (mainVal === 'Otro') {
        const sub = document.getElementById(`${prefix}-org-sub-input`).value.trim();
        return sub ? `Otro - ${sub}` : mainVal;
      } else {
        const sub = document.getElementById(`${prefix}-org-sub-input`).value.trim();
        return sub ? `${mainVal} - ${sub}` : mainVal;
      }
    }

    window.parseTipoData = (prefix) => {
      const mainVal = document.getElementById(`${prefix}-tipo`).value;
      if (mainVal === 'otro') {
        const subVal = document.getElementById(`${prefix}-tipo-otro`).value.trim();
        return subVal ? subVal : 'otro';
      }
      return mainVal;
    }

    // â”€â”€ MODAL NUEVA OPERACIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.abrirModalOp = () => {
      ensureAutocomplete();
      document.getElementById('overlay-op').classList.add('open');
      setTimeout(() => document.getElementById('f-nombre').focus(), 100);
      mostrarCoordBox();
      handleSolicitadoChange('f');

      // LÃ³gica de provincia segÃºn usuario
      const provRow = document.getElementById('f-provincia-row');
      const provSel = document.getElementById('f-provincia');
      if (currentUserDoc.provincia && currentUserDoc.provincia !== 'AndalucÃ­a') {
        provRow.style.display = 'none';
        provSel.value = currentUserDoc.provincia;
      } else {
        provRow.style.display = 'block';
        provSel.value = selectedProvincia; // Por defecto la que tiene filtrada en el header
      }

      // Default jefe de guardia (segÃºn provincia del modal)
      actualizarJefePorProvincia(provSel.value, 'f');
    };

    window.cerrarModalOp = () => {
      document.getElementById('overlay-op').classList.remove('open');
      pickedCoords = null;
      pickedAddress = '';
      if (tempGmMarker) { tempGmMarker.setMap(null); tempGmMarker = null; }
      ['f-nombre', 'f-desc', 'f-loc', 'f-org-sub-input', 'f-lugar', 'f-tipo-otro'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      document.getElementById('f-tipo').value = 'inundacion';
      handleTipoChange('f');
      document.getElementById('f-nivel').value = '3';
      document.getElementById('f-dir').value = 'Julio Pulido Morilla';
      document.getElementById('f-org').value = '';
      document.getElementById('coord-box').classList.remove('show');
    };

    window.crearOp = async () => {
      const nombre = document.getElementById('f-nombre').value.trim();
      if (!nombre) { document.getElementById('f-nombre').focus(); return; }

      const org = document.getElementById('f-org').value;
      if (!org) {
        alert('El campo "Solicitado por" es obligatorio.');
        document.getElementById('f-org').focus();
        return;
      }
      const btn = document.getElementById('btn-crear-op');
      btn.disabled = true; btn.textContent = 'Creandoâ€¦';
      try {
        const nivel = parseInt(document.getElementById('f-nivel').value);
        const desc = document.getElementById('f-desc').value.trim();
        const locVal = document.getElementById('f-lugar').value.trim() || document.getElementById('f-loc').value.trim();
        const autorNombre = currentUserDoc.nombre || currentUser.email;
        const provincia = document.getElementById('f-provincia').value;

        const orgFinal = parseSolicitadoData('f');
        const tipoFinal = parseTipoData('f');

        const ref = await addDoc(collection(db, 'operaciones'), {
          nombre,
          tipo: tipoFinal,
          nivel,
          loc: locVal,
          provincia,
          dir: document.getElementById('f-dir').value,
          org: orgFinal,
          coords: pickedCoords || null,
          creadoPor: currentUser.uid,
          creadoPorNombre: autorNombre,
          creadoEn: serverTimestamp(),
          actualizadoEn: serverTimestamp(),
          estado: 'activa'
        });
        if (desc) {
          await addDoc(collection(db, 'operaciones', ref.id, 'acciones'), {
            texto: desc,
            prioridad: nivel <= 2 ? 'CrÃ­tica' : nivel === 3 ? 'Alta' : 'Media',
            autor: autorNombre,
            uid: currentUser.uid,
            timestamp: serverTimestamp()
          });
        }
        broadcastNuevaOperacion({ id: ref.id, nombre, provincia, creadoPorNombre: autorNombre }); // V.5.7.0
        cerrarModalOp();
        window.abrirDetalle(ref.id);
      } catch (e) { alert('Error: ' + e.message); }
      btn.disabled = false; btn.textContent = 'Crear operaciÃ³n â†’';
    };

    // â”€â”€ MODAL EDITAR OPERACIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.abrirModalEditOp = () => {
      if (!selOpId) return;
      ensureAutocompleteEdit();
      const op = ops[selOpId];
      if (!op) return;

      // Poblar campos con datos actuales
      document.getElementById('fe-nombre').value = op.nombre || '';
      document.getElementById('fe-provincia').value = op.provincia || 'AndalucÃ­a';

      const selectTipo = document.getElementById('fe-tipo');
      const opsTipo = Array.from(selectTipo.options).map(o => o.value);
      if (opsTipo.includes(op.tipo)) {
        selectTipo.value = op.tipo;
        document.getElementById('fe-tipo-otro').value = '';
      } else {
        selectTipo.value = 'otro';
        document.getElementById('fe-tipo-otro').value = op.tipo || '';
      }
      handleTipoChange('fe');

      document.getElementById('fe-lugar').value = op.loc || '';

      if (op.creadoEn?.toDate) {
        const d = op.creadoEn.toDate();
        const yy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        const hh = String(d.getHours()).padStart(2, '0');
        const mn = String(d.getMinutes()).padStart(2, '0');
        document.getElementById('fe-fecha').value = `${yy}-${mm}-${dd}T${hh}:${mn}`;
      } else {
        document.getElementById('fe-fecha').value = '';
      }

      // Jefe de operaciones
      const optionsDir = Array.from(document.getElementById('fe-dir').options).map(o => o.value);
      if (optionsDir.includes(op.dir)) {
        document.getElementById('fe-dir').value = op.dir;
      } else {
        document.getElementById('fe-dir').value = 'Julio Pulido Morilla'; // fallback si existÃ­a un texto libre
      }

      // Solicitado por
      const orgSelect = document.getElementById('fe-org');
      const orgSubInput = document.getElementById('fe-org-sub-input');
      const orgSubSelect = document.getElementById('fe-org-sub-select');

      orgSubInput.value = '';
      orgSubSelect.value = 'Julio Pulido Morilla';

      if (!op.org) {
        orgSelect.value = '112';
      } else if (op.org.startsWith('Jefe de Operaciones - ')) {
        orgSelect.value = 'Jefe de Operaciones';
        orgSubSelect.value = op.org.replace('Jefe de Operaciones - ', '');
      } else if (op.org.startsWith('Ayuntamiento - ')) {
        orgSelect.value = 'Ayuntamiento';
        orgSubInput.value = op.org.replace('Ayuntamiento - ', '');
      } else if (op.org.startsWith('Cruz Roja - ')) {
        orgSelect.value = 'Cruz Roja';
        orgSubInput.value = op.org.replace('Cruz Roja - ', '');
      } else {
        // Si era texto libre anterior o coincide con opciones base
        const optionsOrg = Array.from(orgSelect.options).map(o => o.value);
        if (optionsOrg.includes(op.org)) {
          orgSelect.value = op.org;
        } else {
          orgSelect.value = '112'; // fallback base
        }
      }
      handleSolicitadoChange('fe');

      // Restaurar coords actuales como punto de partida
      editPickedCoords = op.coords || null;
      editPickedAddress = op.loc || '';
      mostrarEditCoordBox();

      document.getElementById('overlay-edit-op').classList.add('open');
      setTimeout(() => document.getElementById('fe-nombre').focus(), 100);

      // LÃ³gica de provincia en ediciÃ³n
      const provRow = document.getElementById('fe-provincia-row');
      if (currentUserDoc.provincia && currentUserDoc.provincia !== 'AndalucÃ­a') {
        provRow.style.display = 'none';
      } else {
        provRow.style.display = 'block';
      }
    };

    window.cerrarModalEditOp = () => {
      document.getElementById('overlay-edit-op').classList.remove('open');
      editPickedCoords = null;
      editPickedAddress = '';
      if (editTempGmMarker) { editTempGmMarker.setMap(null); editTempGmMarker = null; }
      document.getElementById('edit-coord-box').classList.remove('show');
    };

    window.guardarEditOp = async () => {
      if (!selOpId) return;
      const nombre = document.getElementById('fe-nombre').value.trim();
      if (!nombre) { document.getElementById('fe-nombre').focus(); return; }
      const btn = document.getElementById('btn-guardar-edit-op');
      btn.disabled = true; btn.textContent = 'Guardandoâ€¦';
      try {
        const locVal = document.getElementById('fe-lugar').value.trim();
        const orgFinal = parseSolicitadoData('fe');

        const valFecha = document.getElementById('fe-fecha').value;
        const tsCreado = valFecha ? new Date(valFecha) : new Date();
        const tipoFinal = parseTipoData('fe');

        const updates = {
          nombre,
          tipo: tipoFinal,
          loc: locVal,
          dir: document.getElementById('fe-dir').value,
          org: orgFinal,
          provincia: document.getElementById('fe-provincia').value,
          creadoEn: tsCreado,
          actualizadoEn: serverTimestamp()
        };
        // Solo actualizar coords si el usuario eligiÃ³ una nueva ubicaciÃ³n
        if (editPickedCoords) updates.coords = editPickedCoords;

        await updateDoc(doc(db, 'operaciones', selOpId), updates);

        // Actualizar marcador del mapa si cambiaron coordenadas
        if (editPickedCoords && gmMarkers[selOpId]) {
          const tipo = TIPOS[updates.tipo] || TIPOS.otro;
          gmMarkers[selOpId].position = editPickedCoords;
          gmMarkers[selOpId].content = nivelIcon(ops[selOpId].nivel, tipo.emoji, false, false, ops[selOpId].recursosSummary);
        }

        mostrarToast('OperaciÃ³n actualizada.');
        cerrarModalEditOp();
      } catch (e) { alert('Error: ' + e.message); }
      btn.disabled = false; btn.textContent = 'Guardar cambios â†’';
    };

    // â”€â”€ SECTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.showSection = sec => {
      document.querySelectorAll('.nav-item').forEach(b => b.classList.toggle('on', b.dataset.sec === sec));
      document.getElementById('section-operaciones').style.display = sec === 'operaciones' ? 'flex' : 'none';
      document.getElementById('section-usuarios').style.display = sec === 'usuarios' ? 'flex' : 'none';
      if (document.getElementById('section-tablas')) {
        document.getElementById('section-tablas').style.display = sec === 'tablas' ? 'flex' : 'none';
      }

      if (sec === 'chat') {
        document.getElementById('section-chat-view').style.display = 'flex';
        document.getElementById('section-chat').style.display = 'flex';
        cargarUsuariosParaChat();
        // Al entrar, no auto-seleccionamos si no hay nada (V.4.5.2)
        if (currentChatId) selectChat(currentChatId);
        else selectChat(null);
      } else {
        document.getElementById('section-chat-view').style.display = 'none';
        document.getElementById('section-chat').style.display = 'none';
        // Detener listener de detalle al salir del chat para permitir notificaciones (V.4.5.1)
        if (unsubChatDetail) { unsubChatDetail(); unsubChatDetail = null; }
        // Deseleccionar chat al salir para que al volver no se marque como leÃ­do auto (V.4.5.2)
        currentChatId = null;
      }

      if (sec === 'usuarios') suscribirUsuarios();
      if (sec === 'tablas' && typeof window.showTablaMaestra === 'function') {
        window.showTablaMaestra('vehiculos');
      }
      if (sec === 'operaciones' && gmap) setTimeout(() => google.maps.event.trigger(gmap, 'resize'), 100);

      // Toggle mobile FAB: only show on operaciones (V.5.5.8)
      const fab = document.getElementById('btn-mobile-nueva-op');
      if (fab) {
        const isAdmin = currentRole === 'admin' || currentRole === 'super_admin' || currentRole === 'autonomica' || currentRole === 'provincial' || currentRole === 'manager';
        fab.style.display = (sec === 'operaciones' && isAdmin && window.innerWidth < 900) ? 'flex' : 'none';
      }
    };

    let unsubUsuarios = null;
    let cachedUsersSnap = null;

    function suscribirUsuarios() {
      if (unsubUsuarios) unsubUsuarios();
      unsubUsuarios = onSnapshot(collection(db, 'users'), snap => {
        cachedUsersSnap = snap;
        renderUsersTable();
      });
    }

    function renderUsersTable() {
      if (!cachedUsersSnap) return;
      const tbody = document.getElementById('users-tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      const now = Date.now();
      const twoHours = 2 * 60 * 60 * 1000;
      const adminProv = currentUserDoc.provincia || 'AndalucÃ­a';
      const q = userSearchQuery.trim().toLowerCase();

      cachedUsersSnap.forEach(d => {
        const u = d.data();
        if (adminProv !== 'AndalucÃ­a' && u.provincia !== adminProv) return;
        if (currentRole === 'manager') {
          if (u.role !== 'admin' && u.role !== 'usuario') return;
        }

        // Search filter
        if (q) {
          const fields = [u.nombre || '', u.email || '', u.provincia || '', ROL_LABELS[u.role] || u.role || ''].join(' ').toLowerCase();
          if (!fields.includes(q)) return;
        }

        const lastAct = u.ultimaActividad?.toMillis ? u.ultimaActividad.toMillis() : 0;
        const isRecentlyActive = (now - lastAct) < twoHours;
        const isOnline = u.enLinea === true && isRecentlyActive;

        const initials = (u.nombre || 'U').split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
        const hue = (u.nombre || '').split('').reduce((a, c) => a + c.charCodeAt(0), 0) % 360;
        const avatarBg = `hsl(${hue}, 45%, 55%)`;

        const svgEdit = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`;
        const svgLog = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>`;
        const svgTrash = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`;
        const svgToggle = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>`;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <div style="display:flex; align-items:center; gap:10px;">
              <div class="user-avatar" style="background:${avatarBg};">${initials}</div>
              <div>
                <div style="font-weight:600;">${u.nombre || 'â€”'}</div>
                <div style="font-size:11px; color:#6c757d;">${isOnline ? 'ðŸŸ¢ En lÃ­nea' : 'ðŸ”´ Desconectado'}</div>
              </div>
            </div>
          </td>
          <td style="font-family:'IBM Plex Mono',monospace;font-size:12px; color:#6c757d;">${u.email}</td>
          <td>
            <div style="display:flex; flex-direction:column; gap:2px;">
              <span class="rol-badge rol-${u.role}">${ROL_LABELS[u.role] || u.role}</span>
              <span style="font-size:10px; color:var(--text-3); font-weight:600;">${u.provincia || 'â€”'}</span>
            </div>
          </td>
          <td><span class="activo-badge ${u.activo !== false ? 'activo' : 'inactivo'}">${u.activo !== false ? 'Activo' : 'Inactivo'}</span></td>
          <td>
            <button class="tbl-btn" onclick="editarUsuario('${d.id}')" title="Editar">${svgEdit}</button>
            <button class="tbl-btn" onclick="abrirLogUsuario('${d.id}', '${u.nombre || u.email}')" title="Ver log">${svgLog}</button>
            ${d.id !== currentUser.uid
            ? (currentRole === 'super_admin'
              ? `<button class="tbl-btn danger" onclick="borrarUsuario('${d.id}')" title="Eliminar de la DB">${svgTrash}</button>
                   <button class="tbl-btn" onclick="desactivarUsuario('${d.id}')" title="Desactivar">${svgToggle}</button>`
              : `<button class="tbl-btn danger" onclick="desactivarUsuario('${d.id}')" title="Desactivar">${svgToggle}</button>`)
            : '<span style="font-size:11px;color:var(--text-4)">(tÃº)</span>'}
          </td>`;
        tbody.appendChild(tr);
      });
    }

    window.handleUserSearch = (value) => {
      userSearchQuery = value;
      document.getElementById('user-search-clear').style.display = value ? 'flex' : 'none';
      renderUsersTable();
    };

    window.clearUserSearch = () => {
      const input = document.getElementById('user-search');
      if (input) input.value = '';
      userSearchQuery = '';
      document.getElementById('user-search-clear').style.display = 'none';
      renderUsersTable();
    };

    function cargarOpcionesRoles(selId) {
      const sel = document.getElementById(selId);
      sel.innerHTML = '';

      const rolesParaAdmin = [
        { val: 'usuario', lab: ROL_LABELS.usuario },
        { val: 'admin', lab: ROL_LABELS.admin }
      ];
      const rolesCompletos = [
        { val: 'usuario', lab: ROL_LABELS.usuario },
        { val: 'admin', lab: ROL_LABELS.admin },
        { val: 'manager', lab: ROL_LABELS.manager },
        { val: 'super_admin', lab: ROL_LABELS.super_admin }
      ];

      const lista = currentRole === 'super_admin' ? rolesCompletos : rolesParaAdmin;
      lista.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.val;
        opt.textContent = r.lab;
        sel.appendChild(opt);
      });
    }

    window.abrirModalUsuario = () => {
      editingUserId = null;
      document.getElementById('modal-user-title').textContent = 'Nuevo usuario';
      ['u-nombre', 'u-email', 'u-pass'].forEach(id => document.getElementById(id).value = '');

      cargarOpcionesRoles('u-role');
      document.getElementById('u-role').value = 'usuario';

      const provSel = document.getElementById('u-provincia');
      const adminProv = currentUserDoc.provincia || 'AndalucÃ­a';

      if (adminProv !== 'AndalucÃ­a') {
        provSel.value = adminProv;
        provSel.disabled = true;
      } else {
        provSel.value = 'AndalucÃ­a';
        provSel.disabled = false;
      }

      document.getElementById('u-activo').value = 'true';
      document.getElementById('u-pass-row').style.display = 'flex';
      document.getElementById('overlay-user').classList.add('open');
      document.getElementById('u-nombre').focus();
    };

    let unsubUserLog = null;
    window.abrirLogUsuario = (uid, nombre) => {
      document.getElementById('log-user-name').textContent = nombre;
      const tbody = document.getElementById('log-tbody');
      tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;padding:20px;">Cargando historial...</td></tr>';

      const q = query(collection(db, 'users', uid, 'sessions'), orderBy('timestamp', 'desc'));
      if (unsubUserLog) unsubUserLog();

      unsubUserLog = onSnapshot(q, snap => {
        tbody.innerHTML = '';
        if (snap.empty) {
          tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;padding:20px;color:var(--text-4);">No hay registros de sesiÃ³n.</td></tr>';
          return;
        }
        snap.forEach(doc => {
          const s = doc.data();
          const ts = s.timestamp?.toDate ? s.timestamp.toDate().toLocaleString('es-ES') : 'â€”';
          const tipo = s.tipo === 'entrada' ? 'ðŸŸ¢ Entrada (Login)' : 'ðŸ”´ Salida (Logout)';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="font-family:'IBM Plex Mono',monospace;">${ts}</td>
            <td style="font-weight:600;">${tipo}</td>
          `;
          tbody.appendChild(tr);
        });
      });
      document.getElementById('overlay-user-log').classList.add('open');
    };

    window.cerrarLogUsuario = () => {
      document.getElementById('overlay-user-log').classList.remove('open');
      if (unsubUserLog) { unsubUserLog(); unsubUserLog = null; }
    };

    window.editarUsuario = async uid => {
      const snap = await getDoc(doc(db, 'users', uid));
      if (!snap.exists()) return;
      const u = snap.data();
      editingUserId = uid;
      document.getElementById('modal-user-title').textContent = 'Editar usuario';
      document.getElementById('u-nombre').value = u.nombre || '';
      document.getElementById('u-email').value = u.email || '';

      cargarOpcionesRoles('u-role');
      document.getElementById('u-role').value = u.role || 'usuario';

      const provSel = document.getElementById('u-provincia');
      const adminProv = currentUserDoc.provincia || 'AndalucÃ­a';
      provSel.value = u.provincia || 'AndalucÃ­a';

      if (adminProv !== 'AndalucÃ­a') {
        provSel.disabled = true;
      } else {
        provSel.disabled = false;
      }

      document.getElementById('u-activo').value = u.activo === false ? 'false' : 'true';
      document.getElementById('u-pass-row').style.display = 'none';
      document.getElementById('overlay-user').classList.add('open');
    };

    window.cerrarModalUsuario = () => {
      document.getElementById('overlay-user').classList.remove('open');
      editingUserId = null;
    };

    window.guardarUsuario = async () => {
      const nombre = document.getElementById('u-nombre').value.trim();
      const email = document.getElementById('u-email').value.trim();
      const pass = document.getElementById('u-pass').value;
      const role = document.getElementById('u-role').value;
      const provincia = document.getElementById('u-provincia').value;
      const activo = document.getElementById('u-activo').value === 'true';
      if (!nombre || !email) { alert('Nombre y email son obligatorios.'); return; }
      const btn = document.getElementById('btn-guardar-user');
      btn.disabled = true; btn.textContent = 'Guardandoâ€¦';
      try {
        if (editingUserId) {
          await updateDoc(doc(db, 'users', editingUserId), { nombre, role, provincia, activo });
          mostrarToast('Usuario actualizado.');
        } else {
          if (!pass || pass.length < 6) { alert('La contraseÃ±a debe tener al menos 6 caracteres.'); btn.disabled = false; btn.textContent = 'Guardar'; return; }
          const res = await fetch(
            `https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=__FIREBASE_API_KEY__`,
            {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, password: pass, returnSecureToken: true })
            }
          );
          const data = await res.json();
          if (data.error) throw new Error(data.error.message);
          await setDoc(doc(db, 'users', data.localId), {
            nombre, email, role, provincia, activo,
            creadoPor: currentUser.uid,
            creadoEn: serverTimestamp()
          });
          mostrarToast('Usuario creado.');
        }
        cerrarModalUsuario();
      } catch (e) { alert('Error: ' + e.message); }
      btn.disabled = false; btn.textContent = 'Guardar';
    };

    window.desactivarUsuario = async uid => {
      if (!confirm('Â¿Desactivar este usuario? El acceso quedarÃ¡ revocado.')) return;
      await updateDoc(doc(db, 'users', uid), { activo: false });
      mostrarToast('Usuario desactivado.');
    };

    window.borrarUsuario = async uid => {
      if (!confirm('Â¿ELIMINAR PERMANENTEMENTE este usuario? Esta acciÃ³n es irreversible.')) return;
      try {
        await deleteDoc(doc(db, 'users', uid));
        mostrarToast('Usuario eliminado permanentemente.');
      } catch (e) {
        alert('Error: No se pudo eliminar el documento de usuario. ' + e.message);
      }
    };

    // â”€â”€ TABLAS MAESTRAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.showTablaMaestra = (tabla) => {
      document.querySelectorAll('#tablas-subnav .tablas-pill').forEach(b => b.classList.remove('active'));
      const activeBtn = document.getElementById(`subnav-${tabla}`);
      if (activeBtn) activeBtn.classList.add('active');

      // Reset search when switching tabs
      tablasSearchQuery = '';
      const tSearch = document.getElementById('tablas-search');
      if (tSearch) tSearch.value = '';
      const tClear = document.getElementById('tablas-search-clear');
      if (tClear) tClear.style.display = 'none';

      const contVeh = document.getElementById('tabla-vehiculos-container');
      if (contVeh) contVeh.style.display = tabla === 'vehiculos' ? 'flex' : 'none';

      const contErbes = document.getElementById('tabla-erbes-container');
      if (contErbes) contErbes.style.display = tabla === 'erbes' ? 'flex' : 'none';

      const contEries = document.getElementById('tabla-eries-container');
      if (contEries) contEries.style.display = tabla === 'eries' ? 'flex' : 'none';

      const contJefes = document.getElementById('tabla-jefes-container');
      if (contJefes) contJefes.style.display = tabla === 'jefes' ? 'flex' : 'none';

      if (tabla === 'vehiculos') cargarVehiculos();
      if (tabla === 'erbes') cargarErbes();
      if (tabla === 'eries') cargarEries();
      if (tabla === 'jefes') cargarJefes();
    };

    window.handleTablasSearch = (value) => {
      tablasSearchQuery = value;
      document.getElementById('tablas-search-clear').style.display = value ? 'flex' : 'none';
      // Re-render the active tab
      const activeTab = document.querySelector('#tablas-subnav .tablas-pill.active');
      if (activeTab) {
        const id = activeTab.id.replace('subnav-', '');
        if (id === 'vehiculos') cargarVehiculos();
        else if (id === 'erbes') cargarErbes();
        else if (id === 'eries') cargarEries();
        else if (id === 'jefes') cargarJefes();
      }
    };

    window.clearTablasSearch = () => {
      const input = document.getElementById('tablas-search');
      if (input) input.value = '';
      tablasSearchQuery = '';
      document.getElementById('tablas-search-clear').style.display = 'none';
      const activeTab = document.querySelector('#tablas-subnav .tablas-pill.active');
      if (activeTab) {
        const id = activeTab.id.replace('subnav-', '');
        if (id === 'vehiculos') cargarVehiculos();
        else if (id === 'erbes') cargarErbes();
        else if (id === 'eries') cargarEries();
        else if (id === 'jefes') cargarJefes();
      }
    };

    window.changeProvincia = (val) => {
      selectedProvincia = val;
      renderSidebar();
      renderMapa();
      actualizarContadores();
      suscribirGuardia();
      suscribirJefesSelect(); // Refrescar listas de jefes filtradas
      if (typeof cargarVehiculos === 'function') cargarVehiculos();
      if (typeof cargarErbes === 'function') cargarErbes();
      if (typeof cargarEries === 'function') cargarEries();

      // Sync drawer selectors (V.5.5.4)
      const dProvSel = document.getElementById('drawer-prov-selector');
      if (dProvSel) dProvSel.value = val;
      const hProvSel = document.getElementById('hdr-prov-selector');
      if (hProvSel) hProvSel.value = val;
      const dOficina = document.getElementById('drawer-oficina-title');
      if (dOficina) {
        dOficina.textContent = val === 'AndalucÃ­a'
          ? 'Oficina AutonÃ³mica de AndalucÃ­a'
          : `Oficina Provincial de ${val}`;
      }
    };

    let editingVehiculoId = null;

    async function cargarVehiculos() {
      const snap = await getDocs(collection(db, 'vehiculos'));
      const tbody = document.getElementById('vehiculos-tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      const allVehs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      // Filtrado por Ã¡mbito (con fallback a MÃ¡laga)
      let visible = allVehs.filter(v => {
        const prov = v.provincia || 'MÃ¡laga';
        return selectedProvincia === 'AndalucÃ­a' || prov === selectedProvincia;
      });

      // Search filter
      if (tablasSearchQuery.trim()) {
        const q = tablasSearchQuery.trim().toLowerCase();
        visible = visible.filter(v => {
          const fields = [v.indicativo || '', v.matricula || '', v.tipo || '', v.provincia || ''].join(' ').toLowerCase();
          return fields.includes(q);
        });
      }

      visible.forEach(v => {
        const svgEdit = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`;
        const svgTrash = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${v.indicativo}</strong></td>
          <td style="font-family:'IBM Plex Mono',monospace; font-size:12px;">${v.matricula}</td>
          <td>${v.tipo || '-'}</td>
          <td style="font-size:11px; color:#6c757d;">${v.provincia || 'MÃ¡laga'}</td>
          <td>
            <button class="tbl-btn" onclick="editarVehiculo('${v.id}')" title="Editar">${svgEdit}</button>
            <button class="tbl-btn danger" onclick="borrarVehiculo('${v.id}')" title="Eliminar">${svgTrash}</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    window.abrirModalVehiculo = () => {
      editingVehiculoId = null;
      document.getElementById('modal-vehiculo-title').textContent = 'Nuevo vehÃ­culo';
      ['v-indicativo', 'v-matricula'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      document.getElementById('v-tipo').value = 'CamiÃ³n';

      const provRow = document.getElementById('v-prov-row');
      const provSel = document.getElementById('v-provincia');
      if (currentUserDoc.provincia && currentUserDoc.provincia !== 'AndalucÃ­a') {
        provRow.style.display = 'none';
        provSel.value = currentUserDoc.provincia;
      } else {
        provRow.style.display = 'block';
        provSel.value = selectedProvincia === 'AndalucÃ­a' ? 'AndalucÃ­a' : selectedProvincia;
      }

      document.getElementById('overlay-vehiculo').classList.add('open');
      setTimeout(() => document.getElementById('v-indicativo').focus(), 100);
    };

    window.editarVehiculo = async id => {
      const snap = await getDoc(doc(db, 'vehiculos', id));
      if (!snap.exists()) return;
      const v = snap.data();
      editingVehiculoId = id;
      document.getElementById('modal-vehiculo-title').textContent = 'Editar vehÃ­culo';
      document.getElementById('v-indicativo').value = v.indicativo || '';
      document.getElementById('v-matricula').value = v.matricula || '';
      document.getElementById('v-tipo').value = v.tipo || 'CamiÃ³n';

      const provRow = document.getElementById('v-prov-row');
      const provSel = document.getElementById('v-provincia');
      provSel.value = v.provincia || 'MÃ¡laga';
      if (currentUserDoc.provincia && currentUserDoc.provincia !== 'AndalucÃ­a') {
        provRow.style.display = 'none';
      } else {
        provRow.style.display = 'block';
      }

      document.getElementById('overlay-vehiculo').classList.add('open');
      setTimeout(() => document.getElementById('v-indicativo').focus(), 100);
    };

    window.cerrarModalVehiculo = () => {
      document.getElementById('overlay-vehiculo').classList.remove('open');
      editingVehiculoId = null;
    };

    window.guardarVehiculo = async () => {
      let indicativo = document.getElementById('v-indicativo').value.trim();
      let matricula = document.getElementById('v-matricula').value.trim();
      const tipo = document.getElementById('v-tipo').value;
      if (!indicativo || !matricula) { alert('Indicativo y matrÃ­cula son obligatorios.'); return; }

      // Validaciones de formato (los super_admin pueden saltarse esta regla)
      if (currentUserDoc.role !== 'super_admin') {
        const indicativoRegex = /^[A-Za-z]{1,2}-\d{2}\.\d{2}$/;
        const matriculaRegex = /^\d{4}[A-Za-z]{3}$/;

        if (!indicativoRegex.test(indicativo)) {
          alert('Formato de Indicativo incorrecto.\nDebe ser: A-NN.NN o AA-NN.NN\n(Donde A es letra y N es nÃºmero).\n\nEjemplo vÃ¡lido: A-10.22 o AB-10.22');
          return;
        }
        if (!matriculaRegex.test(matricula)) {
          alert('Formato de MatrÃ­cula incorrecto.\nDebe ser: 4 nÃºmeros seguidos de 3 letras (sin espacios).\n\nEjemplo vÃ¡lido: 1234ABC');
          return;
        }
      }

      // Estandarizar a mayÃºsculas
      indicativo = indicativo.toUpperCase();
      matricula = matricula.toUpperCase();

      const btn = document.getElementById('btn-guardar-vehiculo');
      btn.disabled = true; btn.textContent = 'Guardandoâ€¦';
      try {
        const provincia = document.getElementById('v-provincia').value;
        if (editingVehiculoId) {
          await updateDoc(doc(db, 'vehiculos', editingVehiculoId), {
            indicativo, matricula, tipo, provincia, actualizadoEn: serverTimestamp()
          });
          mostrarToast('VehÃ­culo actualizado.');
        } else {
          await addDoc(collection(db, 'vehiculos'), {
            indicativo, matricula, tipo, provincia,
            creadoPor: currentUser.uid,
            creadoEn: serverTimestamp(),
            actualizadoEn: serverTimestamp()
          });
          mostrarToast('VehÃ­culo creado.');
        }
        cerrarModalVehiculo();
        cargarVehiculos();
      } catch (e) { alert('Error: ' + e.message); }
      btn.disabled = false; btn.textContent = 'Guardar';
    };

    window.borrarVehiculo = async id => {
      if (!confirm('Â¿Eliminar este vehÃ­culo de forma permanente?')) return;
      try {
        await deleteDoc(doc(db, 'vehiculos', id));
        mostrarToast('VehÃ­culo eliminado.');
        cargarVehiculos();
      } catch (e) { alert('Error al eliminar: ' + e.message); }
    };

    // â”€â”€ GESTIÃ“N ERBES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let editingErbeId = null;

    async function cargarErbes() {
      const snap = await getDocs(collection(db, 'erbes'));
      const tbody = document.getElementById('erbes-tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      const allErbes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      let visible = allErbes.filter(e => {
        const prov = e.provincia || 'MÃ¡laga';
        return selectedProvincia === 'AndalucÃ­a' || prov === selectedProvincia;
      });

      if (tablasSearchQuery.trim()) {
        const q = tablasSearchQuery.trim().toLowerCase();
        visible = visible.filter(e => {
          const fields = [e.localidad || '', e.provincia || ''].join(' ').toLowerCase();
          return fields.includes(q);
        });
      }
      visible.forEach(e => {
        const svgEdit = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`;
        const svgTrash = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>ERBE ${e.localidad || '-'}</strong></td>
          <td style="font-size:11px; color:#6c757d;">${e.provincia || 'MÃ¡laga'}</td>
          <td>
            <button class="tbl-btn" onclick="editarErbe('${e.id}')" title="Editar">${svgEdit}</button>
            <button class="tbl-btn danger" onclick="borrarErbe('${e.id}')" title="Eliminar">${svgTrash}</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    window.abrirModalErbe = () => {
      editingErbeId = null;
      document.getElementById('modal-erbe-title').textContent = 'Nuevo ERBE';
      const elLoc = document.getElementById('e-localidad');
      if (elLoc) elLoc.value = '';

      const provRow = document.getElementById('e-prov-row');
      const provSel = document.getElementById('e-provincia');
      if (currentUserDoc.provincia && currentUserDoc.provincia !== 'AndalucÃ­a') {
        provRow.style.display = 'none';
        provSel.value = currentUserDoc.provincia;
      } else {
        provRow.style.display = 'block';
        provSel.value = selectedProvincia === 'AndalucÃ­a' ? 'AndalucÃ­a' : selectedProvincia;
      }

      document.getElementById('overlay-erbe').classList.add('open');
      setTimeout(() => document.getElementById('e-localidad').focus(), 100);
    };

    window.editarErbe = async id => {
      const snap = await getDoc(doc(db, 'erbes', id));
      if (!snap.exists()) return;
      const e = snap.data();
      editingErbeId = id;
      document.getElementById('modal-erbe-title').textContent = 'Editar ERBE';
      document.getElementById('e-localidad').value = e.localidad || '';

      const provRow = document.getElementById('e-prov-row');
      const provSel = document.getElementById('e-provincia');
      provSel.value = e.provincia || 'MÃ¡laga';
      if (currentUserDoc.provincia && currentUserDoc.provincia !== 'AndalucÃ­a') {
        provRow.style.display = 'none';
      } else {
        provRow.style.display = 'block';
      }

      document.getElementById('overlay-erbe').classList.add('open');
      setTimeout(() => document.getElementById('e-localidad').focus(), 100);
    };

    window.cerrarModalErbe = () => {
      document.getElementById('overlay-erbe').classList.remove('open');
      editingErbeId = null;
    };

    window.guardarErbe = async () => {
      const localidad = document.getElementById('e-localidad').value.trim();
      if (!localidad) { alert('La localidad es obligatoria.'); return; }

      const btn = document.getElementById('btn-guardar-erbe');
      btn.disabled = true; btn.textContent = 'Guardandoâ€¦';
      try {
        const provincia = document.getElementById('e-provincia').value;
        if (editingErbeId) {
          await updateDoc(doc(db, 'erbes', editingErbeId), {
            localidad, provincia, actualizadoEn: serverTimestamp()
          });
          mostrarToast('ERBE actualizado.');
        } else {
          await addDoc(collection(db, 'erbes'), {
            localidad, provincia,
            creadoPor: currentUser.uid,
            creadoEn: serverTimestamp(),
            actualizadoEn: serverTimestamp()
          });
          mostrarToast('ERBE creado.');
        }
        cerrarModalErbe();
        cargarErbes();
      } catch (e) { alert('Error: ' + e.message); }
      btn.disabled = false; btn.textContent = 'Guardar';
    };

    window.borrarErbe = async id => {
      if (!confirm('Â¿Eliminar este ERBE de forma permanente?')) return;
      try {
        await deleteDoc(doc(db, 'erbes', id));
        mostrarToast('ERBE eliminado.');
        cargarErbes();
      } catch (e) { alert('Error al eliminar: ' + e.message); }
    };

    // â”€â”€ GESTIÃ“N ERIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let editingErieId = null;

    async function cargarEries() {
      const snap = await getDocs(collection(db, 'eries'));
      const tbody = document.getElementById('eries-tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      const allEries = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      let visible = allEries.filter(e => {
        const prov = e.provincia || 'MÃ¡laga';
        return selectedProvincia === 'AndalucÃ­a' || prov === selectedProvincia;
      });

      if (tablasSearchQuery.trim()) {
        const q = tablasSearchQuery.trim().toLowerCase();
        visible = visible.filter(e => {
          const fields = [e.especialidad || '', e.provincia || ''].join(' ').toLowerCase();
          return fields.includes(q);
        });
      }
      visible.forEach(e => {
        const svgEdit = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`;
        const svgTrash = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>ERIE ${e.especialidad || '-'}</strong></td>
          <td style="font-size:11px; color:#6c757d;">${e.provincia || 'MÃ¡laga'}</td>
          <td>
            <button class="tbl-btn" onclick="editarErie('${e.id}')" title="Editar">${svgEdit}</button>
            <button class="tbl-btn danger" onclick="borrarErie('${e.id}')" title="Eliminar">${svgTrash}</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    window.abrirModalErie = () => {
      editingErieId = null;
      document.getElementById('modal-erie-title').textContent = 'Nuevo ERIE';
      const elEsp = document.getElementById('erie-especialidad');
      if (elEsp) elEsp.value = 'Asistencia Sanitaria';

      const provRow = document.getElementById('erie-prov-row');
      const provSel = document.getElementById('erie-provincia');
      if (currentUserDoc.provincia && currentUserDoc.provincia !== 'AndalucÃ­a') {
        provRow.style.display = 'none';
        provSel.value = currentUserDoc.provincia;
      } else {
        provRow.style.display = 'block';
        provSel.value = selectedProvincia === 'AndalucÃ­a' ? 'AndalucÃ­a' : selectedProvincia;
      }

      document.getElementById('overlay-erie').classList.add('open');
      setTimeout(() => document.getElementById('erie-especialidad').focus(), 100);
    };

    window.editarErie = async id => {
      const snap = await getDoc(doc(db, 'eries', id));
      if (!snap.exists()) return;
      const e = snap.data();
      editingErieId = id;
      document.getElementById('modal-erie-title').textContent = 'Editar ERIE';
      document.getElementById('erie-especialidad').value = e.especialidad || 'Asistencia Sanitaria';

      const provRow = document.getElementById('erie-prov-row');
      const provSel = document.getElementById('erie-provincia');
      provSel.value = e.provincia || 'MÃ¡laga';
      if (currentUserDoc.provincia && currentUserDoc.provincia !== 'AndalucÃ­a') {
        provRow.style.display = 'none';
      } else {
        provRow.style.display = 'block';
      }

      document.getElementById('overlay-erie').classList.add('open');
    };

    window.cerrarModalErie = () => {
      document.getElementById('overlay-erie').classList.remove('open');
    };

    window.guardarErie = async () => {
      const especialidad = document.getElementById('erie-especialidad').value;
      const provincia = document.getElementById('erie-provincia').value;

      const btn = document.getElementById('btn-guardar-erie');
      btn.disabled = true; btn.textContent = 'Guardando...';

      try {
        if (editingErieId) {
          await updateDoc(doc(db, 'eries', editingErieId), { especialidad, provincia });
          mostrarToast('ERIE actualizado.');
        } else {
          await addDoc(collection(db, 'eries'), { especialidad, provincia });
          mostrarToast('ERIE creado.');
        }
        cerrarModalErie();
        cargarEries();
      } catch (e) { alert('Error: ' + e.message); }
      btn.disabled = false; btn.textContent = 'Guardar';
    };

    window.borrarErie = async id => {
      if (!confirm('Â¿Eliminar este ERIE de forma permanente?')) return;
      try {
        await deleteDoc(doc(db, 'eries', id));
        mostrarToast('ERIE eliminado.');
        cargarEries();
      } catch (e) { alert('Error al eliminar: ' + e.message); }
    };

    // â”€â”€ GESTIÃ“N JEFES DE OPERACIONES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let editingJefeId = null;

    async function cargarJefes() {
      const snap = await getDocs(collection(db, 'jefes_operaciones'));
      const tbody = document.getElementById('jefes-tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      const allJefes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      let visible = allJefes.filter(j => {
        const prov = j.provincia || 'AndalucÃ­a';
        return selectedProvincia === 'AndalucÃ­a' || prov === selectedProvincia;
      });

      if (tablasSearchQuery.trim()) {
        const q = tablasSearchQuery.trim().toLowerCase();
        visible = visible.filter(j => {
          const fields = [j.nombre || '', j.provincia || ''].join(' ').toLowerCase();
          return fields.includes(q);
        });
      }
      visible.forEach(j => {
        const svgTrash = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${j.nombre || '-'}</strong></td>
          <td style="font-size:11px; color:#6c757d;">${j.provincia || 'AndalucÃ­a'}</td>
          <td>
            <button class="tbl-btn danger" onclick="borrarJefe('${j.id}')" title="Eliminar">${svgTrash}</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    window.abrirModalJefe = async () => {
      editingJefeId = null;
      document.getElementById('modal-jefe-title').textContent = 'Nuevo Jefe de Operaciones';

      const selUser = document.getElementById('j-user');
      selUser.innerHTML = '<option value="">Cargando usuarios...</option>';

      const provRow = document.getElementById('j-prov-row');
      const provSel = document.getElementById('j-provincia');
      if (currentUserDoc.provincia && currentUserDoc.provincia !== 'AndalucÃ­a') {
        provRow.style.display = 'none';
        provSel.value = currentUserDoc.provincia;
      } else {
        provRow.style.display = 'block';
        provSel.value = selectedProvincia === 'AndalucÃ­a' ? 'AndalucÃ­a' : selectedProvincia;
      }

      // Cargar lista de usuarios del Ã¡mbito
      const snap = await getDocs(collection(db, 'users'));
      selUser.innerHTML = '<option value="">Seleccionar usuario...</option>';
      snap.forEach(d => {
        const u = d.data();
        if (provSel.value !== 'AndalucÃ­a' && u.provincia !== provSel.value) return;
        const opt = document.createElement('option');
        opt.value = d.id;
        opt.dataset.nombre = u.nombre || u.email;
        opt.textContent = u.nombre || u.email;
        selUser.appendChild(opt);
      });

      document.getElementById('overlay-jefe').classList.add('open');
    };

    window.guardarJefe = async () => {
      const userId = document.getElementById('j-user').value;
      if (!userId) { alert('Debes seleccionar un usuario.'); return; }
      const selUser = document.getElementById('j-user');
      const nombre = selUser.options[selUser.selectedIndex].dataset.nombre;

      const btn = document.getElementById('btn-guardar-jefe');
      btn.disabled = true; btn.textContent = 'Guardandoâ€¦';
      try {
        const provincia = document.getElementById('j-provincia').value;
        await addDoc(collection(db, 'jefes_operaciones'), {
          uid: userId,
          nombre,
          provincia,
          creadoPor: currentUser.uid,
          creadoEn: serverTimestamp(),
          actualizadoEn: serverTimestamp()
        });
        mostrarToast('Jefe de Operaciones aÃ±adido.');
        cerrarModalJefe();
        cargarJefes();
      } catch (e) { alert('Error: ' + e.message); }
      btn.disabled = false; btn.textContent = 'AÃ±adir Jefe';
    };

    window.cerrarModalJefe = () => {
      document.getElementById('overlay-jefe').classList.remove('open');
      editingJefeId = null;
    };

    window.borrarJefe = async id => {
      if (!confirm('Â¿Eliminar este Jefe de Operaciones?')) return;
      try {
        await deleteDoc(doc(db, 'jefes_operaciones', id));
        mostrarToast('Jefe de Operaciones eliminado.');
        cargarJefes();
      } catch (e) { alert('Error al eliminar: ' + e.message); }
    };

    // Mantener sincronizados los select de Jefes de Operaciones en los formularios
    let todosLosJefesGlobal = []; // Para poder repoblar selects sin reconectar

    // Mantener sincronizados los select de Jefes de Operaciones en los formularios y cabecera
    function suscribirJefesSelect() {
      if (unsubJefes) unsubJefes();
      unsubJefes = onSnapshot(collection(db, 'jefes_operaciones'), snap => {
        todosLosJefesGlobal = snap.docs.map(d => d.data());
        refrescarTodosLosSelectsJefes();
      });
    }

    function refrescarTodosLosSelectsJefes() {
      const selects = ['f-dir', 'fe-dir', 'f-org-sub-select', 'fe-org-sub-select', 'hdr-jefe-guardia-sel', 'drawer-jefe-guardia-sel'];
      selects.forEach(sid => {
        const sel = document.getElementById(sid);
        if (!sel) return;

        let provAFiltro = selectedProvincia;
        // Si es un modal, puede que la provincia seleccionada en el modal sea distinta a la del header
        if (sid.startsWith('f-') && document.getElementById('f-provincia')) {
          provAFiltro = document.getElementById('f-provincia').value;
        } else if (sid.startsWith('fe-') && document.getElementById('fe-provincia')) {
          provAFiltro = document.getElementById('fe-provincia').value;
        }

        rellenarUnSelectJefe(sid, provAFiltro);
      });
    }

    function rellenarUnSelectJefe(sid, provFiltro) {
      const sel = document.getElementById(sid);
      if (!sel) return;
      const currentVal = sel.value;
      sel.innerHTML = '';

      if (sid === 'hdr-jefe-guardia-sel' || sid === 'drawer-jefe-guardia-sel') {
        const optNone = document.createElement('option');
        optNone.value = "";
        optNone.textContent = "Seleccionar...";
        sel.appendChild(optNone);
      }

      // Copia y Ordenar
      const jefes = [...todosLosJefesGlobal].sort((a, b) => (a.nombre || '').localeCompare(b.nombre || ''));

      jefes.forEach(j => {
        const jProv = j.provincia || 'AndalucÃ­a';
        if (provFiltro !== 'AndalucÃ­a' && jProv !== provFiltro) return;

        const opt = document.createElement('option');
        opt.value = j.nombre;
        opt.textContent = j.nombre;
        sel.appendChild(opt);
      });

      // Mantener selecciÃ³n si existÃ­a
      if (currentVal && Array.from(sel.options).some(o => o.value === currentVal)) {
        sel.value = currentVal;
      } else if ((sid === 'hdr-jefe-guardia-sel' || sid === 'drawer-jefe-guardia-sel') && jefeGuardiaActual) {
        sel.value = jefeGuardiaActual;
      }
    }

    window.actualizarJefePorProvincia = async (prov, prefix) => {
      // 1. Refrescar los select de este prefijo para la nueva provincia
      const selectIds = [`${prefix}-dir`, `${prefix}-org-sub-select`].filter(id => document.getElementById(id));
      selectIds.forEach(sid => rellenarUnSelectJefe(sid, prov));

      // 2. Buscar quiÃ©n estÃ¡ de guardia en esa provincia
      try {
        const docRef = doc(db, 'config_guardia', prov);
        const d = await getDoc(docRef);
        if (d.exists()) {
          const jefeNombre = d.data().jefeNombre;
          if (jefeNombre) {
            document.getElementById(`${prefix}-dir`).value = jefeNombre;
            const orgSelect = document.getElementById(`${prefix}-org`);
            if (orgSelect) {
              // Si ya estÃ¡ seleccionado 'Jefe de Operaciones', sincronizamos el sub-selector (V.4.6.3)
              if (orgSelect.value === 'Jefe de Operaciones') {
                const subSelect = document.getElementById(`${prefix}-org-sub-select`);
                if (subSelect) subSelect.value = jefeNombre;
              }
            }
          }
        }
      } catch (e) { console.error("Error al actualizar jefe por provincia:", e); }
    };

    function suscribirGuardia() {
      if (unsubGuardia) unsubGuardia();
      // Usamos el Ã¡mbito actual (AndalucÃ­a o la provincia)
      const scope = selectedProvincia;
      unsubGuardia = onSnapshot(doc(db, 'config_guardia', scope), d => {
        if (d.exists()) {
          jefeGuardiaActual = d.data().jefeNombre;
          const valEl = document.getElementById('hdr-jefe-guardia-val');
          if (valEl) valEl.textContent = jefeGuardiaActual || 'Sin asignar';
          const sel = document.getElementById('hdr-jefe-guardia-sel');
          if (sel) sel.value = jefeGuardiaActual || '';
          // Drawer sync (V.5.5.4)
          const dVal = document.getElementById('drawer-jefe-guardia-val');
          if (dVal) dVal.textContent = jefeGuardiaActual || 'Sin asignar';
          const dSel = document.getElementById('drawer-jefe-guardia-sel');
          if (dSel) dSel.value = jefeGuardiaActual || '';
        } else {
          jefeGuardiaActual = null;
          const valEl = document.getElementById('hdr-jefe-guardia-val');
          if (valEl) valEl.textContent = 'Sin asignar';
          const sel = document.getElementById('hdr-jefe-guardia-sel');
          if (sel) sel.value = '';
          // Drawer sync (V.5.5.4)
          const dVal = document.getElementById('drawer-jefe-guardia-val');
          if (dVal) dVal.textContent = 'Sin asignar';
          const dSel = document.getElementById('drawer-jefe-guardia-sel');
          if (dSel) dSel.value = '';
        }
      });
    }

    function suscribirTodosLosJefes() {
      if (unsubGlobalJefes) unsubGlobalJefes();
      unsubGlobalJefes = onSnapshot(collection(db, 'config_guardia'), snap => {
        allJefesGuardiaCacheMap = {};
        snap.forEach(d => {
          if (d.data().jefeNombre) {
            allJefesGuardiaCacheMap[d.id] = d.data().jefeNombre;
          }
        });
        // Refrescar chat si estÃ¡ visible
        renderChatList();
      });
    }

    window.cambiarJefeGuardia = async (nombre) => {
      // Solo cambiar si hay un nombre vÃ¡lido (evitar reset accidental con "Seleccionar...")
      if (!nombre) {
        // Restaurar el valor anterior si se selecciona el placeholder por error
        const sel = document.getElementById('hdr-jefe-guardia-sel');
        if (sel) sel.value = jefeGuardiaActual || '';
        return;
      }
      try {
        await setDoc(doc(db, 'config_guardia', selectedProvincia), {
          jefeNombre: nombre,
          actualizadoPor: currentUser.uid,
          actualizadoEn: serverTimestamp()
        });
        mostrarToast('Jefe de Guardia actualizado.');
      } catch (e) { alert('Error al cambiar Jefe de Guardia: ' + e.message); }
    };

    // â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function mostrarToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    function mostrarLogin() {
      document.getElementById('screen-login').style.display = 'flex';
      document.getElementById('screen-app').style.display = 'none';
      const btn = document.getElementById('btn-login');
      if (btn) { btn.disabled = false; btn.textContent = 'Login'; }
    }
    function mostrarApp() {
      document.getElementById('screen-login').style.display = 'none';
      document.getElementById('screen-app').style.display = 'flex';
    }
    function mostrarLoginErr(msg) {
      const el = document.getElementById('err-login');
      el.textContent = msg; el.style.display = 'block';
    }

    // â”€â”€ TECLADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        window.cerrarModalOp();
        window.cerrarModalEditOp();
        window.cerrarDetalle();
        window.cerrarModalUsuario();
        if (window.cerrarModalVehiculo) window.cerrarModalVehiculo();
        if (picking) stopPick();
        if (editPickMode) stopEditPick();
      }
    });
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('l-pass')?.addEventListener('keydown', e => {
        if (e.key === 'Enter') window.doLogin();
      });
    });

    // --- LOGICA MOBILE V.3.0.0 ---
    window.toggleMobileMenu = () => {
      document.getElementById('mobile-menu-overlay').classList.toggle('open');
    };

    window.mobileShowSection = (sec) => {
      toggleMobileMenu();
      showSection(sec);
      // Actualizar visual en el drawer
      document.querySelectorAll('.drawer-item').forEach(b => b.classList.toggle('on', b.dataset.sec === sec));

      // Resetear estado del mapa al cambiar de secciÃ³n
      const mapZone = document.querySelector('.map-zone');
      const toggleBtn = document.getElementById('btn-mobile-map-toggle');

      if (sec !== 'operaciones') {
        if (mapZone) mapZone.classList.remove('mobile-on');
        if (toggleBtn) {
          toggleBtn.style.display = 'none';
          toggleBtn.textContent = 'Ver Mapa ðŸ—º'; // Reset text
        }
      } else {
        // En PC, btn-mobile-map-toggle ya tiene display none por CSS
        if (toggleBtn && window.innerWidth <= 900) toggleBtn.style.display = 'block';
      }
    };

    window.toggleMobileMap = () => {
      const mapZone = document.querySelector('.map-zone');
      const btn = document.getElementById('btn-mobile-map-toggle');
      const isOn = mapZone.classList.toggle('mobile-on');
      btn.textContent = isOn ? 'Ver Lista ðŸ“‹' : 'Ver Mapa ðŸ—º';
      if (isOn && gmap) {
        setTimeout(() => google.maps.event.trigger(gmap, 'resize'), 100);
      }
    };

    // Sobreescribir el renderDetalle y cerrarDetalle para manejar el botÃ³n de mapa en mobile
    const originalAbrirDetalle = window.abrirDetalle;
    window.abrirDetalle = (id) => {
      originalAbrirDetalle(id);
      if (window.innerWidth <= 900) {
        document.getElementById('btn-mobile-map-toggle').style.display = 'none';
      }
    };

    const originalCerrarDetalle = window.cerrarDetalle;
    window.cerrarDetalle = () => {
      originalCerrarDetalle();
      if (window.innerWidth <= 900 && filtro === 'all') { // O ajusta segÃºn lÃ³gica
        document.getElementById('btn-mobile-map-toggle').style.display = 'block';
      } else if (window.innerWidth <= 900) {
        // Asegurar que si estamos en operaciones se vea el botÃ³n
        const activeSec = document.querySelector('.nav-item.on')?.dataset.sec || 'operaciones';
        if (activeSec === 'operaciones') document.getElementById('btn-mobile-map-toggle').style.display = 'block';
      }
    };
  </script>

  <!-- Google Maps se carga dinÃ¡micamente desde el script superior -->

  <style>
    :root {
      --bg: #f4f2ee;
      --bg-1: #fff;
      --bg-2: #f9f8f5;
      --bg-3: #eeece7;
      --bg-4: #e5e2da;
      --text-1: #1a1814;
      --text-2: #5c5848;
      --text-3: #9c9486;
      --text-4: #c8c0b2;
      --border: rgba(0, 0, 0, 0.08);
      --border-mid: rgba(0, 0, 0, 0.14);
      --border-dark: rgba(0, 0, 0, 0.22);
      --crit-1: #1a7a4a;
      --crit-1-bg: #f0faf4;
      --crit-1-border: #a8d8bc;
      --crit-2: #c08c00;
      --crit-2-bg: #fefbee;
      --crit-2-border: #eadb94;
      --crit-3: #d35400;
      --crit-3-bg: #fef5ee;
      --crit-3-border: #f0c8a0;
      --crit-4: #c0392b;
      --crit-4-bg: #fdf1f0;
      --crit-4-border: #e8b4b0;
      --accent: #1a3a6e;
      --accent-lt: #eaf0fb;
      --shadow-sm: 0 1px 4px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.10);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.14);
    }

    /* Hide rogue font loading spans that cause overflow */
    span[style*="font-size: 300px"],
    span[style*="font-size:300px"] {
      display: none !important;
      opacity: 0 !important;
      pointer-events: none !important;
      width: 0 !important;
      height: 0 !important;
      position: absolute !important;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'IBM Plex Sans', sans-serif;
      background: var(--bg);
      color: var(--text-1);
      height: 100vh;
      overflow: hidden !important;
      display: flex;
      flex-direction: column;
      font-size: 14px;
      width: 100vw !important;
      position: relative;
    }

    html {
      overflow: hidden !important;
      width: 100vw !important;
    }

    /* LOGIN */
    #screen-login {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #0f172a;
      position: relative;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px 0;
      width: 100%;
    }

    .login-hero {
      position: relative;
      padding: 40px 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1;
      flex-shrink: 0;
    }

    .hero-content {
      display: flex;
      align-items: center;
      gap: 24px;
      color: #fff;
    }

    .hero-logo-img {
      width: 100px;
      height: 100px;
      object-fit: contain;
    }

    .hero-text-group {
      display: flex;
      flex-direction: column;
    }

    .hero-title {
      font-family: 'Fraunces', serif;
      font-size: 64px;
      font-weight: 900;
      line-height: 1;
      margin-bottom: 4px;
    }

    .hero-sub {
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      opacity: 0.8;
    }

    .login-card {
      background: #ffffff;
      border: none;
      border-radius: 4px;
      width: 720px;
      max-width: 90vw;
      box-shadow: 0 40px 100px rgba(0, 0, 0, 0.4);
      display: flex;
      overflow: hidden;
      z-index: 2;
      margin-top: 20px;
      margin-bottom: 40px;
      animation: modalIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .login-visual {
      flex: 1.1;
      background: #f8fafc;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 50px;
    }

    .login-visual img {
      width: 280px;
      height: 280px;
      object-fit: contain;
    }

    .login-form-side {
      flex: 1;
      padding: 50px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 20px;
      background: #ffffff;
    }

    .form-logo-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .form-logo-img {
      width: 50px;
      height: 50px;
      object-fit: contain;
    }

    .form-title {
      font-family: 'Fraunces', serif;
      font-size: 28px;
      font-weight: 900;
      color: #1e293b;
      line-height: 1;
    }

    .form-sub {
      font-size: 9px;
      font-weight: 800;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #94a3b8;
    }

    .login-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .login-lbl {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #94a3b8;
    }

    .login-input {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      color: #1e293b;
      padding: 12px 14px;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 14px;
      outline: none;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .login-input:focus {
      border-color: #0f172a;
      box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.05);
    }

    .btn-login {
      padding: 14px;
      background: #2563eb;
      border: none;
      color: #fff;
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 14px;
      font-weight: 700;
      border-radius: 4px;
      transition: all 0.2s;
      margin-top: 8px;
    }

    .btn-login:hover {
      background: #1d4ed8;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }

    .login-err {
      font-size: 12px;
      color: #ef4444;
      background: #fff1f2;
      border: 1px solid #fecdd3;
      padding: 10px;
      border-radius: 4px;
      display: none;
      text-align: center;
    }

    @media (max-width: 800px) {
      .login-hero {
        display: none;
      }

      .login-card {
        flex-direction: column;
        width: 100%;
        max-width: 380px;
        margin: 20px;
        margin-top: 0;
      }

      .login-visual {
        padding: 30px;
      }

      .login-visual img {
        width: 160px;
        height: 160px;
      }

      .login-form-side {
        padding: 40px 30px;
      }
    }

    /* APP */
    #screen-app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: var(--bg);
      overflow-x: hidden;
      width: 100%;
    }

    /* HEADER */
    header {
      height: 54px;
      background: var(--bg-1);
      border-bottom: 1px solid var(--border-mid);
      display: flex;
      align-items: center;
      padding: 0 18px;
      gap: 14px;
      flex-shrink: 0;
      box-shadow: var(--shadow-sm);
      z-index: 200;
    }

    .logo-mark {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    .logo-text {
      font-family: 'Fraunces', serif;
      font-size: 19px;
      font-weight: 800;
      color: var(--accent);
      line-height: 1;
    }

    .logo-sub {
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-3);
    }

    .hdr-div {
      width: 1px;
      height: 26px;
      background: var(--border-mid);
      flex-shrink: 0;
    }

    .nivel-indicators {
      display: flex;
      gap: 5px;
    }

    .nivel-chip {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 3px 9px;
      border-radius: 2px;
      border: 1px solid;
    }

    .nivel-chip-val {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 14px;
      font-weight: 500;
    }

    .nivel-chip-lbl {
      font-size: 8px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .chip-n1 {
      background: var(--crit-1-bg);
      border-color: var(--crit-1-border);
      color: var(--crit-1);
    }

    .chip-n2 {
      background: var(--crit-2-bg);
      border-color: var(--crit-2-border);
      color: var(--crit-2);
    }

    .chip-n3 {
      background: var(--crit-3-bg);
      border-color: var(--crit-3-border);
      color: var(--crit-3);
    }

    .chip-n4 {
      background: var(--crit-4-bg);
      border-color: var(--crit-4-border);
      color: var(--crit-4);
    }

    .hdr-right {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: auto;
      flex-shrink: 0;
    }

    .hdr-user-info {
      text-align: right;
    }

    .hdr-user-name {
      font-size: 13px;
      font-weight: 600;
    }

    .hdr-user-role {
      font-size: 10px;
      color: var(--text-3);
    }

    .live-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #27ae60;
      box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.25);
      animation: livepulse 2.5s infinite;
    }

    @keyframes livepulse {

      0%,
      100% {
        box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.25)
      }

      50% {
        box-shadow: 0 0 0 5px rgba(39, 174, 96, 0.1)
      }
    }

    .clock {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 12px;
      color: var(--text-2);
    }

    .btn-nueva {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--accent);
      color: #fff;
      border: none;
      cursor: pointer;
      padding: 7px 14px;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 12px;
      font-weight: 600;
      border-radius: 2px;
      white-space: nowrap;
      transition: background 0.12s;
    }

    .btn-nueva:hover {
      background: #253d6e;
    }

    .btn-logout {
      padding: 6px 12px;
      background: transparent;
      border: 1px solid var(--border-mid);
      color: var(--text-3);
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 11px;
      border-radius: 2px;
      transition: all 0.12s;
    }

    .btn-logout:hover {
      border-color: var(--border-dark);
      color: var(--text-1);
    }

    /* NAV */
    .app-nav {
      display: flex;
      border-bottom: 1px solid var(--border-mid);
      background: var(--bg-1);
      flex-shrink: 0;
      padding: 0 18px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-3);
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.12s;
      margin-bottom: -1px;
    }

    .nav-item:hover {
      color: var(--text-1);
    }

    .nav-item.on {
      color: var(--accent);
      border-bottom-color: var(--accent);
      font-weight: 600;
    }

    /* SECTIONS */
    #section-operaciones {
      flex: 1;
      overflow: hidden;
      display: flex;
      position: relative;
    }

    #section-tablas {
      flex: 1;
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      /* Prevent horizontal overflow */
      display: none;
      flex-direction: column;
      padding: 24px;
      gap: 16px;
      background: var(--bg);
      max-width: 100vw;
    }

    /* Switch Toggle */
    .switch {
      position: relative;
      display: inline-block;
      width: 32px;
      height: 18px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--bg-3);
      transition: .4s;
      border-radius: 18px;
      border: 1px solid var(--border-mid);
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 12px;
      width: 12px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: var(--accent);
      border-color: var(--accent);
    }

    input:checked+.slider:before {
      transform: translateX(14px);
    }

    /* MAP CONTROLS */
    .map-controls-floating {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .map-btn-float {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-mid);
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-2);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: all 0.2s;
    }

    .map-btn-float:hover {
      background: #fff;
      color: var(--accent);
    }

    .map-btn-float.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .map-routing-panel {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border-mid);
      border-radius: 6px;
      padding: 12px;
      width: 240px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      display: none;
      flex-direction: column;
      gap: 8px;
    }

    .map-routing-panel.open {
      display: flex;
    }

    /* â•â•â•â•â•â•â• CHAT UI â€” WhatsApp-Style (V.5.6.0) â•â•â•â•â•â•â• */
    #section-chat {
      display: none;
      height: calc(100vh - 120px);
      overflow: hidden;
      border-radius: 0;
    }

    .chat-sidebar {
      width: 320px;
      background: var(--bg-1);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      border-right: 1px solid var(--border-mid);
    }

    .chat-sidebar-head {
      padding: 14px 16px;
      background: linear-gradient(135deg, #075e54 0%, #128c7e 100%);
      color: #fff;
      font-weight: 700;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    .chat-sidebar-head span {
      font-size: 20px;
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .chat-list::-webkit-scrollbar {
      width: 4px;
    }

    .chat-list::-webkit-scrollbar-thumb {
      background: var(--bg-4);
      border-radius: 4px;
    }

    .chat-item {
      padding: 12px 14px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
      border-bottom: 1px solid var(--border-light);
      position: relative;
    }

    .chat-item:hover {
      background: rgba(0, 0, 0, 0.04);
    }

    .chat-item.active {
      background: linear-gradient(90deg, rgba(18, 140, 126, 0.12), rgba(18, 140, 126, 0.04));
      border-left: 3px solid #128c7e;
    }

    .chat-avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 17px;
      font-weight: 700;
      flex-shrink: 0;
      position: relative;
    }

    .chat-avatar-general {
      background: linear-gradient(135deg, #128c7e, #25d366);
      color: white;
    }

    .chat-avatar-user {
      background: var(--bg-3);
      color: var(--text-2);
    }

    .chat-avatar .online-dot {
      position: absolute;
      bottom: 1px;
      right: 1px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 2px solid var(--bg-1);
    }

    .chat-item-info {
      flex: 1;
      min-width: 0;
    }

    .chat-item .name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-1);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-item .status {
      font-size: 11px;
      color: var(--text-3);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 2px;
    }

    .chat-badge {
      background: #25d366;
      color: white;
      font-size: 10px;
      font-weight: 700;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .nav-badge {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #25d366;
      border-radius: 50%;
      margin-left: 4px;
      box-shadow: 0 0 8px rgba(37, 211, 102, 0.5);
    }

    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
      background: #e5ddd5;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cdefs%3E%3Cpattern id='p' width='40' height='40' patternUnits='userSpaceOnUse'%3E%3Ccircle cx='20' cy='20' r='1.2' fill='%23ccc' opacity='0.3'/%3E%3C/pattern%3E%3C/defs%3E%3Crect fill='url(%23p)' width='200' height='200'/%3E%3C/svg%3E");
    }

    .chat-header {
      padding: 12px 20px;
      background: linear-gradient(135deg, #075e54 0%, #128c7e 100%);
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
    }

    .chat-header-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
    }

    .chat-header h3 {
      font-size: 16px;
      margin: 0;
      color: #fff;
      font-weight: 600;
    }

    .chat-messages {
      flex: 1;
      padding: 16px 60px 16px 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .chat-messages::-webkit-scrollbar {
      width: 5px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }

    .msg-bubble {
      max-width: 65%;
      padding: 8px 12px 6px;
      border-radius: 8px;
      font-size: 13.5px;
      line-height: 1.45;
      position: relative;
      word-break: break-word;
      box-shadow: 0 1px 1px rgba(0, 0, 0, 0.08);
    }

    .msg-sent {
      align-self: flex-end;
      background: #dcf8c6;
      color: #303030;
      border-top-right-radius: 0;
    }

    .msg-received {
      align-self: flex-start;
      background: #fff;
      color: #303030;
      border-top-left-radius: 0;
    }

    .msg-meta {
      font-size: 10px;
      margin-top: 3px;
      color: rgba(0, 0, 0, 0.45);
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .msg-meta b {
      color: #128c7e;
    }

    .chat-input-area {
      padding: 10px 16px;
      background: #f0f0f0;
      border-top: 1px solid #ddd;
      display: flex;
      align-items: flex-end;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      border: none;
      border-radius: 20px;
      padding: 10px 16px;
      font-size: 14px;
      font-family: inherit;
      resize: none;
      max-height: 100px;
      overflow-y: auto;
      background: #fff;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
      outline: none;
    }

    .chat-input:focus {
      box-shadow: 0 1px 4px rgba(18, 140, 126, 0.2);
    }

    .btn-chat-send {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #128c7e, #25d366);
      color: white;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: transform 0.15s, box-shadow 0.15s;
      box-shadow: 0 2px 6px rgba(18, 140, 126, 0.3);
    }

    .btn-chat-send:hover {
      transform: scale(1.05);
      box-shadow: 0 3px 10px rgba(18, 140, 126, 0.4);
    }

    .btn-chat-send:active {
      transform: scale(0.95);
    }

    .chat-placeholder {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px;
      background: #f8f9fa;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cdefs%3E%3Cpattern id='p' width='40' height='40' patternUnits='userSpaceOnUse'%3E%3Ccircle cx='20' cy='20' r='1.2' fill='%23ccc' opacity='0.15'/%3E%3C/pattern%3E%3C/defs%3E%3Crect fill='url(%23p)' width='200' height='200'/%3E%3C/svg%3E");
    }

    .chat-placeholder-icon {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: linear-gradient(135deg, #128c7e22, #25d36622);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      margin-bottom: 20px;
      animation: placeholderPulse 2.5s ease-in-out infinite;
    }

    @keyframes placeholderPulse {

      0%,
      100% {
        transform: scale(1);
        opacity: 0.8;
      }

      50% {
        transform: scale(1.06);
        opacity: 1;
      }
    }

    .chat-placeholder h2 {
      font-family: 'Fraunces', serif;
      font-size: 22px;
      font-weight: 700;
      color: var(--text-1);
      margin: 0 0 8px;
    }

    .chat-placeholder p {
      font-size: 14px;
      color: var(--text-3);
      max-width: 320px;
      line-height: 1.5;
      margin: 0;
    }

    /* SIDEBAR */
    .panel-left {
      width: 320px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      background: var(--bg-1);
      border-right: 1px solid var(--border-mid);
      overflow: hidden;
    }

    .panel-left-head {
      padding: 12px 14px 10px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    /* â•â•â•â•â•â•â•â•â•â•â• SEARCH BOX â•â•â•â•â•â•â•â•â•â•â• */
    .search-box {
      position: relative;
      display: flex;
      align-items: center;
    }

    .search-icon {
      position: absolute;
      left: 10px;
      width: 16px;
      height: 16px;
      color: #9ca3af;
      pointer-events: none;
    }

    .search-input {
      width: 100%;
      padding: 10px 32px 10px 34px;
      border: 1px solid #e9ecef;
      border-radius: 10px;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 13px;
      background: #fff;
      color: var(--text-1);
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .search-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(183, 28, 28, 0.08);
    }

    .search-input::placeholder {
      color: #9ca3af;
      font-weight: 400;
    }

    .search-clear {
      position: absolute;
      right: 8px;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: none;
      background: #e9ecef;
      color: #6c757d;
      font-size: 14px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      transition: background 0.15s ease;
      padding: 0;
      line-height: 1;
    }

    .search-clear:hover {
      background: #dee2e6;
    }

    .section-label {
      font-size: 9px;
      font-weight: 600;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text-3);
      margin-bottom: 8px;
    }

    .filter-tabs {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      /* Ensure tabs wrap on small screens */
    }

    .ftab {
      flex: 1;
      padding: 5px 4px;
      background: var(--bg-2);
      border: none;
      border-right: 1px solid var(--border);
      color: var(--text-3);
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 11px;
      font-weight: 600;
      transition: all 0.12s;
    }

    .ftab:last-child {
      border-right: none;
    }

    .ftab.on {
      background: var(--bg-1);
      color: var(--text-1);
    }

    .ftab.on-n1 {
      background: var(--crit-1-bg);
      color: var(--crit-1);
    }

    .ftab.on-n2 {
      background: var(--crit-2-bg);
      color: var(--crit-2);
    }

    .ftab.on-n3 {
      background: var(--crit-3-bg);
      color: var(--crit-3);
    }

    .ftab.on-n4 {
      background: var(--crit-4-bg);
      color: var(--crit-4);
    }

    .ops-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .ops-list::-webkit-scrollbar {
      width: 3px;
    }

    .ops-list::-webkit-scrollbar-thumb {
      background: var(--bg-4);
    }

    .empty-msg {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      gap: 8px;
      color: var(--text-4);
      text-align: center;
      font-size: 12px;
    }

    .empty-msg.show {
      display: flex;
    }

    .op-card {
      background: var(--bg-1);
      border: 1px solid var(--border-mid);
      border-left: 4px solid transparent;
      padding: 10px 12px;
      cursor: pointer;
      transition: all 0.12s;
      border-radius: 0 2px 2px 0;
      box-shadow: var(--shadow-sm);
    }

    .op-card:hover {
      box-shadow: var(--shadow-md);
    }

    .op-card.sel {
      background: var(--accent-lt);
    }

    .op-card[data-nivel="1"] {
      border-left-color: var(--crit-1);
    }

    .op-card[data-nivel="2"] {
      border-left-color: var(--crit-2);
    }

    .op-card[data-nivel="3"] {
      border-left-color: var(--crit-3);
    }

    .op-card[data-nivel="4"] {
      border-left-color: var(--crit-4);
      background: var(--crit-4-bg);
    }

    .card-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 5px;
    }

    .card-id {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 9px;
      color: var(--text-3);
      margin-bottom: 2px;
    }

    .card-name {
      font-size: 13px;
      font-weight: 600;
      line-height: 1.2;
    }

    .card-type-tag {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 10px;
      white-space: nowrap;
      flex-shrink: 0;
      border: 1px solid;
    }

    .card-badge {
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid var(--bg-1);
    }

    .new-badge {
      top: -8px;
      right: -8px;
      background: #e74c3c;
      box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.4);
      animation: pulseAlert 1.5s infinite;
    }

    .update-badge {
      top: -8px;
      left: -8px;
      background: #2980b9;
    }

    .op-card.is-new {
      background: #fffafa;
      border-color: #e8b4b0;
    }

    @keyframes pulseAlert {
      0% {
        box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
      }

      70% {
        box-shadow: 0 0 0 6px rgba(231, 76, 60, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
      }
    }

    .card-meta {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-3);
    }

    .nivel-pill {
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: 2px;
      border: 1px solid;
    }

    .pill-1 {
      background: var(--crit-1-bg);
      color: var(--crit-1);
      border-color: var(--crit-1-border);
    }

    .pill-2 {
      background: var(--crit-2-bg);
      color: var(--crit-2);
      border-color: var(--crit-2-border);
    }

    .pill-3 {
      background: var(--crit-3-bg);
      color: var(--crit-3);
      border-color: var(--crit-3-border);
    }

    .pill-4 {
      background: var(--crit-4-bg);
      color: var(--crit-4);
      border-color: var(--crit-4-border);
    }

    /* MAP */
    .map-zone {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .pick-banner {
      display: none;
      position: absolute;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      padding: 9px 20px;
      z-index: 600;
      border-radius: 2px;
      box-shadow: var(--shadow-lg);
      pointer-events: none;
      animation: blinkS 1.4s infinite;
    }

    @keyframes blinkS {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0.7
      }
    }

    .pick-banner.on {
      display: block;
    }

    /* DETAIL PANEL */
    .detail-panel {
      width: 0;
      opacity: 0;
      overflow: hidden;
      background: var(--bg-1);
      border-right: none;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      position: absolute;
      top: 0;
      left: 320px;
      bottom: 0;
      z-index: 1000;
      box-shadow: 4px 0 10px rgba(0, 0, 0, 0.05);
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s;
    }

    .detail-panel.open {
      width: 380px;
      opacity: 1;
      border-right: 1px solid var(--border-mid);
    }

    .dp-header {
      padding: 10px 16px 6px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .dp-scope-title {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 4px;
      opacity: 0.8;
    }

    .dp-top-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .dp-id {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 9px;
      color: var(--text-3);
      margin-bottom: 2px;
    }

    .dp-name {
      font-family: 'Fraunces', serif;
      font-size: 18px;
      font-weight: 700;
      line-height: 1.1;
    }

    .btn-close-dp {
      background: var(--bg-3);
      border: 1px solid var(--border-mid);
      color: var(--text-3);
      cursor: pointer;
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      flex-shrink: 0;
      border-radius: 2px;
    }

    .btn-close-dp:hover {
      background: var(--bg-4);
      color: var(--text-1);
    }

    .dp-chips {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .dp-loc {
      font-size: 12px;
      color: var(--text-2);
      font-weight: 500;
    }

    .users-table-wrap {
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, 0.04);
      border-radius: 12px;
      overflow-x: auto;
      max-width: 100%;
      -webkit-overflow-scrolling: touch;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
      /* Amentado para mejor contraste */
    }

    .nivel-selector {
      display: flex;
      border: 1px solid var(--border-mid);
      border-radius: 2px;
      overflow: hidden;
    }

    .nsel-opt {
      padding: 4px 8px;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      cursor: pointer;
      background: var(--bg-2);
      border: none;
      border-right: 1px solid var(--border);
      color: var(--text-3);
      font-family: 'IBM Plex Sans', sans-serif;
    }

    .nsel-opt:last-child {
      border-right: none;
    }

    .nsel-opt:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }

    .nsel-opt[data-n="1"].on {
      background: var(--crit-1-bg);
      color: var(--crit-1);
    }

    .nsel-opt[data-n="2"].on {
      background: var(--crit-2-bg);
      color: var(--crit-2);
    }

    .nsel-opt[data-n="3"].on {
      background: var(--crit-3-bg);
      color: var(--crit-3);
    }

    .nsel-opt[data-n="4"].on {
      background: var(--crit-4-bg);
      color: var(--crit-4);
    }

    .dp-info-row {
      padding: 4px 16px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .dp-info-item {
      font-size: 10px;
      color: var(--text-3);
    }

    .dp-info-item strong {
      display: block;
      font-size: 11px;
      color: var(--text-2);
      font-weight: 500;
    }

    .dp-recursos {
      padding: 6px 16px 8px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      background: var(--accent-lt);
      /* Resaltado de color */
    }

    .dp-timeline {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px;
    }

    .dp-timeline::-webkit-scrollbar {
      width: 3px;
    }

    .dp-timeline::-webkit-scrollbar-thumb {
      background: var(--bg-4);
    }

    .tl-empty {
      text-align: center;
      padding: 24px 0;
      color: var(--text-4);
      font-size: 11px;
      font-family: 'IBM Plex Mono', monospace;
    }

    .tl-entry {
      display: flex;
      gap: 10px;
      position: relative;
      padding-bottom: 14px;
      animation: entryIn 0.2s ease;
    }

    @keyframes entryIn {
      from {
        opacity: 0;
        transform: translateY(5px)
      }

      to {
        opacity: 1
      }
    }

    .tl-entry:not(:last-child)::before {
      content: '';
      position: absolute;
      left: 11px;
      top: 22px;
      bottom: 0;
      width: 1px;
      background: var(--border-mid);
    }

    .tl-node {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      flex-shrink: 0;
      border: 2px solid;
      background: var(--bg-1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      z-index: 1;
      position: relative;
    }

    .tl-node-1 {
      border-color: var(--crit-1);
      background: var(--crit-1-bg);
    }

    .tl-node-2 {
      border-color: var(--crit-2);
      background: var(--crit-2-bg);
    }

    .tl-node-3 {
      border-color: var(--crit-3);
      background: var(--crit-3-bg);
    }

    .tl-node-4 {
      border-color: var(--crit-4);
      background: var(--crit-4-bg);
    }

    .tl-body {
      flex: 1;
    }

    .tl-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 3px;
    }

    .tl-ts {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 9px;
      color: var(--text-4);
    }

    .tl-prio {
      font-size: 9px;
      font-weight: 700;
      padding: 1px 5px;
      border-radius: 10px;
    }

    .prio-CrÃ­tica {
      background: var(--crit-1-bg);
      color: var(--crit-1);
    }

    .prio-Alta {
      background: var(--crit-2-bg);
      color: var(--crit-2);
    }

    .prio-Media {
      background: var(--crit-3-bg);
      color: var(--crit-3);
    }

    .prio-Baja {
      background: var(--crit-4-bg);
      color: var(--crit-4);
    }

    .tl-text {
      font-size: 12px;
      line-height: 1.5;
    }

    .tl-author {
      font-size: 11px;
      color: var(--text-3);
      margin-top: 2px;
      font-style: italic;
    }

    .dp-addaction {
      padding: 10px 16px 14px;
      border-top: 1px solid var(--border-mid);
      flex-shrink: 0;
      background: var(--bg-2);
    }

    .dp-admin-btns {
      display: none;
      gap: 6px;
      padding: 8px 16px;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }

    .btn-danger {
      padding: 6px 12px;
      background: var(--crit-1-bg);
      border: 1px solid var(--crit-1-border);
      color: var(--crit-1);
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 11px;
      font-weight: 600;
      border-radius: 2px;
    }

    .btn-danger:hover {
      background: var(--crit-1);
      color: #fff;
    }

    .btn-edit-op {
      display: none;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      background: var(--accent-lt);
      border: 1px solid #c0cfe8;
      color: var(--accent);
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 11px;
      font-weight: 600;
      border-radius: 2px;
      transition: background 0.12s;
    }

    .btn-edit-op:hover {
      background: #d0dcf2;
    }

    .btn-ai {
      display: none;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      background: linear-gradient(135deg, #8e2de2, #4a00e0);
      border: none;
      color: #fff;
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 11px;
      font-weight: 600;
      border-radius: 2px;
      transition: opacity 0.12s;
    }

    .btn-ai:hover {
      opacity: 0.9;
    }

    .btn-ai:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* AI REPORT MODAL */
    .ai-report-body {
      padding: 20px;
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-1);
      max-height: 60vh;
      overflow-y: auto;
    }

    .ai-report-body h1 {
      font-family: 'Fraunces', serif;
      font-size: 20px;
      color: var(--accent);
      margin-bottom: 12px;
    }

    .ai-report-body h2 {
      font-size: 15px;
      color: var(--text-2);
      margin-top: 20px;
      margin-bottom: 8px;
      border-bottom: 1px solid var(--border-mid);
      padding-bottom: 4px;
    }

    .ai-report-body ul {
      margin-left: 20px;
      margin-bottom: 12px;
    }

    .ai-report-body p {
      margin-bottom: 12px;
    }

    /* FORM */
    .f-input {
      background: var(--bg-1);
      border: 1px solid var(--border-mid);
      color: var(--text-1);
      padding: 7px 10px;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 12px;
      outline: none;
      border-radius: 2px;
      transition: border-color 0.12s;
      width: 100%;
    }

    .f-input:focus {
      border-color: var(--accent);
    }

    .f-input::placeholder {
      color: var(--text-4);
    }

    .f-input[readonly] {
      background: var(--bg-3);
      color: var(--text-3);
      cursor: default;
      border-color: var(--border);
    }

    .f-select {
      background: var(--bg-1);
      border: 1px solid var(--border-mid);
      color: var(--text-2);
      padding: 7px 8px;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 12px;
      outline: none;
      cursor: pointer;
      border-radius: 2px;
      flex-shrink: 0;
    }

    .form-row {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }

    .btn-reg {
      width: 100%;
      padding: 8px;
      background: var(--accent);
      border: none;
      color: #fff;
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 12px;
      font-weight: 600;
      border-radius: 2px;
      transition: background 0.12s;
      margin-top: 4px;
    }

    .btn-reg:hover {
      background: #253d6e;
    }

    .btn-reg:disabled {
      background: var(--text-4);
      cursor: not-allowed;
    }

    .coord-box {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 11px;
      color: #1a7a4a;
      background: var(--crit-4-bg);
      border: 1px solid var(--crit-4-border);
      padding: 5px 10px;
      border-radius: 2px;
      display: none;
      margin-top: 4px;
    }

    .coord-box.show {
      display: block;
    }

    .btn-mapa {
      padding: 7px 11px;
      background: var(--accent-lt);
      border: 1px solid #c0cfe8;
      color: var(--accent);
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 12px;
      font-weight: 600;
      border-radius: 2px;
      white-space: nowrap;
      flex-shrink: 0;
      transition: background 0.12s;
    }

    .btn-mapa:hover {
      background: #d0dcf2;
    }

    /* Places autocomplete */
    .pac-container {
      z-index: 2000 !important;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 13px;
      border-radius: 2px;
      border: 1px solid var(--border-dark);
      box-shadow: var(--shadow-md);
    }

    .pac-item {
      padding: 6px 10px;
      cursor: pointer;
    }

    .pac-item:hover {
      background: var(--bg-2);
    }

    .pac-item-query {
      font-size: 13px;
    }

    /* MODAL */
    .overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(30, 25, 15, 0.45);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .overlay.open {
      display: flex;
      animation: fadeO 0.15s ease;
    }

    @keyframes fadeO {
      from {
        opacity: 0
      }

      to {
        opacity: 1
      }
    }

    .modal {
      background: var(--bg-1);
      border: 1px solid var(--border-dark);
      border-radius: 3px;
      width: 500px;
      max-width: 96vw;
      box-shadow: var(--shadow-lg);
      animation: modalIn 0.18s ease;
      max-height: 92vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: translateY(-14px)
      }

      to {
        opacity: 1;
        transform: none
      }
    }

    .modal-head {
      padding: 18px 20px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .modal-title {
      font-family: 'Fraunces', serif;
      font-size: 18px;
      font-weight: 700;
    }

    .modal-body {
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow-y: auto;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field-lbl {
      font-size: 9px;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-3);
    }

    .field-row {
      display: flex;
      gap: 10px;
    }

    .modal-foot {
      padding: 12px 20px 16px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }

    .btn-cancel-m {
      padding: 8px 16px;
      background: var(--bg-2);
      border: 1px solid var(--border-mid);
      color: var(--text-2);
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 12px;
      font-weight: 500;
      border-radius: 2px;
    }

    .btn-cancel-m:hover {
      background: var(--bg-3);
    }

    .btn-create-m {
      padding: 8px 20px;
      background: var(--accent);
      border: none;
      color: #fff;
      cursor: pointer;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 12px;
      font-weight: 600;
      border-radius: 2px;
      transition: background 0.12s;
    }

    .btn-create-m:hover {
      background: #253d6e;
    }

    .btn-create-m:disabled {
      background: var(--text-4);
      cursor: not-allowed;
    }

    /* â•â•â•â•â•â•â•â•â•â•â• SECCIONES CARD â•â•â•â•â•â•â•â•â•â•â• */
    #section-usuarios,
    #section-tablas {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 8px 24px rgba(0, 0, 0, 0.06);
      padding: 28px 32px;
      margin: 16px;
    }

    .users-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .section-title {
      font-family: 'Fraunces', serif;
      font-size: 22px;
      font-weight: 700;
      color: var(--text-1);
    }

    .section-subtitle {
      font-size: 13px;
      color: var(--text-3);
      margin-top: 4px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â• TABLA CONTENEDOR â•â•â•â•â•â•â•â•â•â•â• */
    .users-table-wrap {
      flex: 1;
      overflow: auto;
      border: 1px solid #e9ecef;
      border-radius: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border-spacing: 0;
    }

    thead tr {
      background: #f8f9fa;
      border-bottom: 2px solid #e9ecef;
    }

    th {
      padding: 12px 16px;
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    td {
      padding: 14px 16px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
      vertical-align: middle;
      color: var(--text-1);
    }

    tr {
      transition: background 0.15s ease;
    }

    tbody tr:nth-child(even) {
      background: #fafbfc;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover {
      background: rgba(183, 28, 28, 0.03);
    }

    /* â•â•â•â•â•â•â•â•â•â•â• AVATAR â•â•â•â•â•â•â•â•â•â•â• */
    .user-avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
    }

    /* â•â•â•â•â•â•â•â•â•â•â• BADGES â•â•â•â•â•â•â•â•â•â•â• */
    .rol-badge {
      font-size: 10px;
      font-weight: 700;
      padding: 3px 10px;
      border-radius: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      display: inline-block;
      border: 1px solid var(--border-mid);
    }

    .activo-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 12px;
    }

    .activo {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .inactivo {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* â•â•â•â•â•â•â•â•â•â•â• BOTONES ACCIÃ“N â•â•â•â•â•â•â•â•â•â•â• */
    .tbl-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid #e9ecef;
      background: #fff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 4px;
      transition: all 0.15s ease;
      color: #6c757d;
      padding: 0;
    }

    .tbl-btn svg {
      width: 15px;
      height: 15px;
    }

    .tbl-btn:hover {
      background: #f8f9fa;
      border-color: #dee2e6;
      color: var(--text-1);
    }

    .tbl-btn.danger {
      color: #dc3545;
      border-color: #f5c6cb;
    }

    .tbl-btn.danger:hover {
      background: #fff5f5;
      border-color: #f5c6cb;
      color: #c82333;
    }

    .tbl-btn-text {
      padding: 6px 14px;
      height: auto;
      width: auto;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 11px;
      font-weight: 500;
    }

    /* â•â•â•â•â•â•â•â•â•â•â• TABS PILL â•â•â•â•â•â•â•â•â•â•â• */
    .tablas-pills {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .tablas-pill {
      border-radius: 20px;
      padding: 8px 20px;
      background: transparent;
      border: 1px solid #e9ecef;
      color: #6c757d;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tablas-pill:hover {
      background: #f8f9fa;
      border-color: #dee2e6;
    }

    .tablas-pill.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      box-shadow: 0 2px 8px rgba(183, 28, 28, 0.2);
    }

    /* TOAST */
    #toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(10px);
      background: var(--accent);
      color: #fff;
      padding: 10px 22px;
      border-radius: 2px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: var(--shadow-lg);
      opacity: 0;
      transition: all 0.25s;
      pointer-events: none;
      z-index: 2000;
    }

    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* CUSTOM ADVANCED MARKERS */
    .custom-marker {
      position: relative;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
      cursor: pointer;
      user-select: none;
      z-index: 1;
      /* base z-index */
      transition: z-index 0s 0s;
      /* instant base */
    }

    .custom-marker.expanded {
      z-index: 9999 !important;
      /* Force to top when expanded */
    }

    .marker-expand-card {
      position: absolute;
      /* Anchor the bottom of the card safely above the ERBE icon */
      bottom: calc(100% + 115px);
      left: 50%;
      transform: translateX(-50%) scale(0.95);
      transform-origin: bottom center;
      background: white;
      border-radius: 4px;
      padding: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
      width: max-content;
      max-width: 260px;
      min-width: 200px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      pointer-events: none;
      text-align: left;
    }

    .custom-marker.expanded .marker-expand-card {
      opacity: 1;
      visibility: visible;
      /* The transform only translates X, the bottom anchor handles Y */
      transform: translateX(-50%) scale(1);
      pointer-events: auto;
      z-index: 20;
    }

    .marker-expand-card button:hover {
      background: #102a54 !important;
    }

    /* SECTIONS V.4.5.0 */
    #section-usuarios,
    #section-tablas {
      padding: 24px;
      flex-direction: column;
      gap: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .marker-main {
      position: relative;
      width: 70px;
      height: 36px;
      background: #fff;
      border: 2.5px solid var(--nivel-color);
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .marker-crit-badge {
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      width: 22px;
      height: 22px;
      background: #c0392b;
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 14px;
      border: 2px solid #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      z-index: 10;
    }

    .marker-main::after {
      content: '';
      position: absolute;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 12px solid var(--nivel-color);
    }

    .marker-cross {
      position: absolute;
      left: 10px;
      width: 16px;
      height: 16px;
      background: #cc0000;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 900;
      font-size: 14px;
      border-radius: 2px;
    }

    .marker-emoji {
      font-size: 20px;
      margin-left: 16px;
    }

    .marker-vehicles-container {
      position: absolute;
      top: 44px;
      left: 50%;
      display: flex;
      gap: 6px;
      pointer-events: none;
      transform: translateX(-50%);
    }

    .marker-radial-item {
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      will-change: transform;
      transform-origin: center center;
    }

    /* ERBE and ERIE specific positioning (collapsed) */
    .marker-radial-item.erbe-focus,
    .marker-radial-item.erie-focus {
      position: absolute;
      bottom: calc(100% + 4px);
      left: 50%;
      transform: translateX(-50%) scale(1);
      display: flex;
      justify-content: center;
      pointer-events: none;
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* Prevent overlap when both are present and marker is collapsed */
    .custom-marker:not(.expanded):has(.erie-focus) .marker-radial-item.erbe-focus {
      transform: translateX(-105%) scale(1);
    }

    .custom-marker:not(.expanded):has(.erbe-focus) .marker-radial-item.erie-focus {
      transform: translateX(5%) scale(1);
    }

    .marker-radial-item.erbe-focus.has-crit,
    .marker-radial-item.erie-focus.has-crit {
      bottom: calc(100% + 18px);
    }

    /* Vehicles specific positioning (collapsed) */
    .marker-radial-item.vehicle-focus {
      transform: scale(1);
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* === EXPANDED ORBITAL FLOWER STATE === */
    .custom-marker.expanded .marker-radial-item.erbe-focus,
    .custom-marker.expanded .marker-radial-item.erie-focus {
      position: absolute;
      top: 18px;
      left: 35px;
      bottom: auto;
      --angle: calc((360deg / var(--total)) * var(--idx));
      transform: translate(-50%, -50%) rotate(var(--angle)) translateY(-75px) rotate(calc(var(--angle) * -1)) scale(1.5);
    }

    .custom-marker.expanded .marker-radial-item.vehicle-focus {
      position: absolute;
      top: 0;
      left: 0;
      margin: 0;
      --angle: calc((360deg / var(--total)) * var(--idx));
      transform: translate(-50%, -50%) rotate(var(--angle)) translateY(-75px) rotate(calc(var(--angle) * -1)) scale(1.5);
    }

    .custom-marker.expanded .marker-vehicles-container {
      display: block;
      top: 18px;
      left: 35px;
      transform: none;
    }

    .badge-item {
      position: relative;
      width: 28px;
      height: 28px;
      background: #fff;
      border: 1.5px solid #555;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .badge-img {
      width: 24px;
      height: 24px;
      object-fit: contain;
    }

    .badge-item-erbe {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .badge-erbes-img {
      width: 40px;
      height: auto;
      object-fit: contain;
      border-radius: 2px;
    }

    .badge-count {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #e74c3c;
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      width: 17px;
      height: 17px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #fff;
    }

    .marker-new-glow {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 18px;
      box-shadow: 0 0 15px #e74c3c;
      animation: markerGlow 1.5s infinite;
      pointer-events: none;
    }

    @keyframes markerGlow {
      0% {
        box-shadow: 0 0 0px #e74c3c;
        opacity: 0.8;
      }

      100% {
        box-shadow: 0 0 20px #e74c3c;
        opacity: 0;
      }
    }

    /* --- RESPONSIVE / MOBILE V.3.0.0 --- */
    .btn-menu-toggle {
      display: none;
      background: none;
      border: 1px solid var(--border-mid);
      color: var(--text-2);
      font-size: 20px;
      cursor: pointer;
      width: 36px;
      height: 36px;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .mobile-menu-overlay {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      height: 100dvh !important;
      background: rgba(0, 0, 0, 0.5);
      z-index: 5000;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      backdrop-filter: blur(2px);
    }

    .mobile-menu-overlay.open {
      display: block;
      opacity: 1;
    }

    .mobile-menu-drawer {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 280px;
      max-height: 100vh;
      max-height: 100dvh;
      background: var(--bg-1);
      box-shadow: 10px 0 30px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .mobile-menu-overlay.open .mobile-menu-drawer {
      transform: translateX(0);
    }

    .drawer-head {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .btn-close-drawer {
      background: none;
      border: none;
      font-size: 20px;
      color: var(--text-3);
      cursor: pointer;
    }

    .drawer-links {
      flex: 1;
      overflow-y: auto;
      padding: 10px 0;
    }

    .drawer-item {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      padding: 15px 20px;
      background: none;
      border: none;
      border-left: 4px solid transparent;
      color: var(--text-2);
      font-family: inherit;
      font-size: 15px;
      font-weight: 500;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s;
    }

    .drawer-item.on {
      background: var(--accent-lt);
      color: var(--accent);
      border-left-color: var(--accent);
    }

    .drawer-foot {
      padding: 20px;
      border-top: 1px solid var(--border);
    }

    .btn-mobile-map-toggle {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 600;
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 30px;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(26, 58, 110, 0.4);
      cursor: pointer;
      animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes bounceIn {
      from {
        transform: translateX(-50%) scale(0.5);
        opacity: 0;
      }

      to {
        transform: translateX(-50%) scale(1);
        opacity: 1;
      }
    }

    @media (max-width: 900px) {
      .btn-menu-toggle {
        display: flex;
      }

      .app-nav {
        display: none;
      }

      header {
        padding: 0 12px;
        gap: 8px;
        height: 60px;
      }

      .logo-mark .logo-text {
        font-size: 16px;
      }

      .logo-mark .logo-sub {
        font-size: 8px;
      }

      .logo-mark img {
        width: 32px !important;
        height: 32px !important;
      }

      .hdr-div,
      .hdr-user-info,
      .nivel-indicators,
      #hdr-guardia-wrap,
      .clock {
        display: none !important;
      }

      #hdr-office-title {
        font-size: 11px;
        text-align: right;
        max-width: 120px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .hdr-right {
        display: flex !important;
        gap: 6px;
        flex: 1;
        justify-content: flex-end;
        overflow: hidden !important;
      }

      .hdr-right>*:not(#hdr-office-title) {
        display: none !important;
      }

      header .btn-logout,
      header .btn-nueva {
        display: none;
      }

      #section-operaciones {
        flex-direction: column;
      }

      .panel-left {
        width: 100%;
        border-right: none;
      }

      .map-zone {
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 550;
        display: none;
        /* Hidden by default on mobile */
      }

      .map-zone.mobile-on {
        display: block;
      }

      .btn-mobile-map-toggle {
        display: block;
      }

      .detail-panel {
        width: 100% !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        border-left: none;
        z-index: 5500 !important;
        transform: translateY(100%) !important;
        display: flex !important;
        /* Always drawer-like on mobile when toggled */
        transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1) !important;
      }

      .detail-panel.open {
        transform: translateY(0) !important;
      }

      .detail-panel .dp-name {
        font-size: 22px;
      }

      /* Make sure modals are very readable on mobile */
      .modal {
        width: 95vw !important;
        margin: 10px;
      }

      .users-toolbar {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
        margin-bottom: 12px !important;
      }

      .users-toolbar .btn-nueva {
        width: 100%;
        text-align: center;
        padding: 10px !important;
      }

      #section-usuarios,
      #section-tablas {
        padding: 12px !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        -webkit-overflow-scrolling: touch;
        box-sizing: border-box !important;
        max-width: 100vw !important;
        height: calc(100vh - 60px) !important;
        height: calc(100dvh - 60px) !important;
      }

      #section-usuarios .search-box,
      #section-tablas .search-box {
        max-width: 100% !important;
        box-sizing: border-box !important;
      }

      .users-table-wrap {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch;
        max-width: 100% !important;
        border-radius: 6px;
        border: 1px solid var(--border);
      }

      .users-table-wrap table {
        min-width: 420px !important;
      }

      .tablas-pills {
        display: flex !important;
        flex-wrap: wrap !important;
        gap: 6px !important;
      }

      .tablas-pill {
        flex: 1 1 45% !important;
        text-align: center;
        padding: 8px 6px !important;
        font-size: 11px !important;
      }

      .dp-header {
        padding: 15px 16px;
      }

      .btn-close-dp::after {
        content: ' Volver';
        margin-left: 5px;
        font-weight: 600;
      }

      .btn-close-dp {
        width: auto;
        padding: 0 10px;
      }

      /* Width Optimization for 360px */
      .filter-tabs {
        overflow-x: auto;
        white-space: nowrap;
        gap: 6px !important;
        padding-bottom: 4px;
        -webkit-overflow-scrolling: touch;
      }

      .ftab {
        flex-shrink: 0;
        padding: 6px 10px !important;
      }

      .nivel-selector {
        flex-wrap: wrap;
        gap: 4px !important;
      }

      .nsel-opt {
        flex: 1 1 45%;
        font-size: 10px !important;
        padding: 6px 4px !important;
      }

      .dp-info-row {
        display: grid !important;
        grid-template-columns: 1fr 1fr;
        gap: 8px !important;
        padding: 12px 16px !important;
      }

      .dp-info-item {
        flex-direction: column !important;
        align-items: flex-start !important;
      }

      .op-card .card-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }

      .op-card .card-loc {
        max-width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .dp-top-row {
        gap: 8px;
      }

      .dp-name {
        word-break: break-word;
      }

      .modal {
        width: 95vw !important;
        max-width: 95vw !important;
        margin: 10px auto !important;
      }

      .login-card {
        width: 90vw !important;
        max-width: 90vw !important;
      }

      .f-input,
      .login-input {
        max-width: 100% !important;
        box-sizing: border-box !important;
      }

      .filter-tabs {
        flex-wrap: wrap !important;
        gap: 4px !important;
      }

      .ftab {
        font-size: 10px !important;
        padding: 6px 2px !important;
      }

      table {
        width: 100% !important;
        overflow-x: auto;
      }

      /* Suppression of dynamic overflow sources */
      *[style*="BESbswy"],
      [style*="font-size: 300px"],
      [style*="font-size:300px"] {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        width: 0 !important;
        height: 0 !important;
        overflow: hidden !important;
      }

      /* Fix Table and Subnav Widths */
      .users-table-wrap,
      .users-table-wrap table {
        width: 100% !important;
        max-width: 100vw !important;
        table-layout: auto !important;
      }

      .users-table-wrap th,
      .users-table-wrap td {
        font-size: 11px !important;
        padding: 10px 8px !important;
        /* Allow some breathing room on mobile without crushing the CSS redesign */
      }

      #tablas-subnav {
        flex-direction: row !important;
        flex-wrap: wrap !important;
        max-width: 100% !important;
      }

      #tablas-subnav .ftab {
        flex: 1 1 45% !important;
        margin-bottom: 4px;
      }

      /* â•â•â•â•â•â•â• MOBILE FIX V.5.5.0 â€” Global Overflow Protection â•â•â•â•â•â•â• */
      html,
      body {
        overflow: hidden !important;
        max-width: 100vw !important;
        height: 100% !important;
      }

      #screen-app {
        overflow: hidden !important;
        max-width: 100vw !important;
        height: 100vh !important;
        height: 100dvh !important;
      }

      #section-operaciones {
        min-height: 0 !important;
      }

      /* â•â•â•â•â•â•â• Chat Section â€” Stacked Mobile Layout (V.5.6.0) â•â•â•â•â•â•â• */
      #section-chat {
        flex-direction: column !important;
        height: calc(100vh - 60px) !important;
        height: calc(100dvh - 60px) !important;
      }

      .chat-sidebar {
        width: 100% !important;
        max-height: 200px;
        /* Reduced to show more chat area */
        border-right: none !important;
        border-bottom: 1px solid #ddd;
        overflow-y: auto;
      }

      .chat-sidebar-head {
        padding: 10px 14px;
        font-size: 14px;
      }

      .chat-main {
        flex: 1;
        min-height: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .chat-messages {
        padding: 12px 14px !important;
      }

      .chat-header {
        padding: 8px 12px !important;
      }

      .chat-input-area {
        padding: 8px 10px !important;
      }

      .msg-bubble {
        max-width: 88% !important;
        font-size: 13px;
      }

      .chat-placeholder {
        padding: 20px;
      }

      .chat-placeholder-icon {
        width: 60px;
        height: 60px;
        font-size: 32px;
      }

      #section-chat-view {
        overflow: hidden !important;
        max-width: 100vw !important;
      }

      /* â•â•â•â•â•â•â• Sections Card Padding Fix â•â•â•â•â•â•â• */
      #section-usuarios,
      #section-tablas {
        margin: 8px !important;
        border-radius: 10px !important;
        box-sizing: border-box !important;
        max-width: calc(100vw - 16px) !important;
      }

      .section-title {
        font-size: 18px !important;
      }

      .section-subtitle {
        font-size: 11px !important;
      }

      /* â•â•â•â•â•â•â• Table Responsive â€” Horizontal Scroll â•â•â•â•â•â•â• */
      .users-table-wrap {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch;
        max-width: 100% !important;
      }

      table {
        min-width: 480px !important;
      }

      /* â•â•â•â•â•â•â• Tablas Pills Responsive â•â•â•â•â•â•â• */
      .tablas-pills {
        gap: 4px !important;
      }

      .tablas-pill {
        padding: 6px 12px !important;
        font-size: 11px !important;
      }

      /* â•â•â•â•â•â•â• Detail Panel â€” Mobile Transition Fix â•â•â•â•â•â•â• */
      .detail-panel {
        left: 0 !important;
        transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1) !important;
      }

      /* â•â•â•â•â•â•â• Recursos form & Add Action â€” Mobile Fit â•â•â•â•â•â•â• */
      .dp-recursos .form-row,
      .dp-addaction .form-row,
      #dp-recursos-form>div {
        flex-wrap: wrap !important;
      }

      #dp-recursos-form .f-select,
      #dp-recursos-form .f-input {
        min-width: 0 !important;
        font-size: 11px !important;
      }

      /* â•â•â•â•â•â•â• Prevent Google Fonts span from causing overflow â•â•â•â•â•â•â• */
      body>span[style*="position: absolute"],
      body>div[style*="position: absolute"][style*="width: 1px"] {
        display: none !important;
      }

      /* â•â•â•â•â•â•â• V.5.5.1 â€” Detail Panel Mobile Compact â•â•â•â•â•â•â• */

      /* Nivel selector: compact single line */
      .detail-panel>div:nth-child(2) {
        padding: 4px 12px !important;
      }

      .nivel-selector {
        display: flex !important;
        flex-wrap: nowrap !important;
        gap: 0 !important;
      }

      .nsel-opt {
        flex: 1 1 auto !important;
        padding: 3px 6px !important;
        font-size: 8px !important;
        white-space: nowrap;
      }

      /* Info row: much more compact */
      .dp-info-row {
        padding: 6px 12px !important;
        gap: 4px 8px !important;
        grid-template-columns: 1fr 1fr !important;
      }

      .dp-info-item {
        font-size: 8px !important;
      }

      .dp-info-item strong {
        font-size: 9px !important;
      }

      /* Detail panel header: compact */
      .dp-header {
        padding: 8px 12px 6px !important;
      }

      .dp-scope-title {
        font-size: 8px !important;
        margin-bottom: 2px !important;
      }

      .dp-name {
        font-size: 16px !important;
      }

      .dp-id {
        font-size: 8px !important;
      }

      .dp-loc {
        font-size: 10px !important;
      }

      /* Chips row: compact */
      .dp-chips {
        gap: 4px !important;
      }

      /* Recursos section: compact */
      .dp-recursos {
        padding: 4px 12px 6px !important;
      }

      /* Add action area: compact */
      .dp-addaction {
        padding: 6px 12px 8px !important;
      }

      .dp-addaction textarea.f-input {
        min-height: 35px !important;
        font-size: 11px !important;
      }

      /* Admin buttons row: compact */
      .detail-panel>div:last-child {
        padding: 6px 12px !important;
      }

      /* Timeline: more space */
      .dp-timeline {
        padding: 8px 12px !important;
      }

      .tl-text {
        font-size: 11px !important;
      }

      .tl-author {
        font-size: 9px !important;
      }

      .tl-ts {
        font-size: 8px !important;
      }

      /* â•â•â•â•â•â•â• V.5.5.1 â€” Sidebar Scroll Fix â•â•â•â•â•â•â• */
      .panel-left {
        max-height: calc(100vh - 60px) !important;
        overflow: hidden !important;
        display: flex !important;
        flex-direction: column !important;
      }

      .ops-list {
        flex: 1 !important;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch;
        min-height: 0 !important;
      }

      /* â•â•â•â•â•â•â• V.5.5.1 â€” Main View Width Containment â•â•â•â•â•â•â• */
      #section-operaciones {
        overflow-x: hidden !important;
        max-width: 100vw !important;
      }

      .panel-left {
        max-width: 100vw !important;
        box-sizing: border-box !important;
      }

      .panel-left-head {
        flex-shrink: 0 !important;
        padding: 10px 12px 8px !important;
      }

      .search-input {
        font-size: 13px !important;
        box-sizing: border-box !important;
      }

      /* Op cards: snug */
      .op-card {
        padding: 8px 10px !important;
      }
    }

    /* Hide mobile-only elements on desktop */
    @media (min-width: 901px) {
      #btn-mobile-nueva-op {
        display: none !important;
      }
    }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div id="screen-login">
    <div class="login-hero">
      <div class="hero-content">
        <img src="assets/logo_emercre.png" alt="Logo Hero" class="hero-logo-img">
        <div class="hero-text-group">
          <div class="hero-title">EmerCRE</div>
          <div class="hero-sub">GestiÃ³n de Emergencias</div>
        </div>
      </div>
    </div>
    <div class="login-card">
      <div class="login-visual">
        <img src="assets/logo_emercre.png" alt="EmerCRE Large Icon">
      </div>
      <div class="login-form-side">
        <div class="form-logo-box">
          <img src="assets/logo_emercre.png" alt="Form Logo" class="form-logo-img">
          <div class="form-title">EmerCRE</div>
          <div class="form-sub">GestiÃ³n de Emergencias</div>
        </div>
        <div class="login-field">
          <div class="login-lbl">Email</div>
          <input class="login-input" id="l-email" type="email" placeholder="usuario@organismo.es"
            autocomplete="username">
        </div>
        <div class="login-field">
          <div class="login-lbl">ContraseÃ±a</div>
          <input class="login-input" id="l-pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
        </div>
        <div class="login-err" id="err-login"></div>
        <button class="btn-login" id="btn-login" onclick="doLogin()">Login</button>
        <div style="text-align: center; margin-top: 15px;">
          <a href="#" onclick="abrirModalForgot()"
            style="font-size: 12px; color: var(--accent); text-decoration: none; font-weight: 500;">Â¿Has olvidado tu
            contraseÃ±a?</a>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="screen-app" style="display:none">
    <header>
      <button id="btn-menu-toggle" class="btn-menu-toggle" onclick="toggleMobileMenu()">â˜°</button>
      <div class="logo-mark">
        <img src="assets/logo_emercre.png" alt="EmerCRE Logo" style="width: 42px; height: 42px; object-fit: contain;">
        <div>
          <div class="logo-text">EmerCRE</div>
          <div class="logo-sub">GestiÃ³n de Emergencias</div>
        </div>
      </div>
      <div class="hdr-div"></div>
      <div style="display:flex; align-items:center; gap:10px;">
        <div id="clock"
          style="font-family:'IBM Plex Mono',monospace; font-size:22px; font-weight:700; color:var(--accent); letter-spacing:1px;">
          --:--:--</div>
      </div>
      <div class="hdr-right">
        <!-- Jefe de Guardia -->
        <div id="hdr-guardia-wrap"
          style="display:flex; align-items:center; gap:8px; background:rgba(255,255,255,0.05); padding:4px 10px; border-radius:4px; border:1px solid var(--border-mid);">
          <div style="display:flex; flex-direction:column;">
            <span
              style="font-size:9px; color:var(--text-3); font-weight:700; text-transform:uppercase; letter-spacing:0.5px;">Jefe
              de Operaciones de Guardia</span>
            <div id="hdr-guardia-controls">
              <span id="hdr-jefe-guardia-val"
                style="font-size:12px; font-weight:600; color:var(--accent);">Cargando...</span>
              <select id="hdr-jefe-guardia-sel" class="f-select"
                style="display:none; padding:1px 4px; font-size:11px; height:18px;"
                onchange="window.cambiarJefeGuardia(this.value)">
                <!-- Se puebla dinÃ¡micamente -->
              </select>
            </div>
          </div>
        </div>


        <div class="hdr-div"></div>

        <!-- Ãmbito / Oficina -->
        <div style="display:flex; flex-direction:column; align-items:flex-end;">
          <div id="hdr-office-title"
            style="font-family:'Fraunces',serif; font-size:14px; font-weight:700; color:var(--accent);"></div>
          <div id="hdr-prov-selector-wrap" style="display:none; align-items:center; gap:6px; margin-top:2px;">
            <select id="hdr-prov-selector" class="f-select" style="padding:2px 4px; font-size:11px;"
              onchange="changeProvincia(this.value)">
              <option value="AndalucÃ­a">Oficina AutonÃ³mica de AndalucÃ­a</option>
            </select>
          </div>
        </div>

        <div class="hdr-div"></div>

        <!-- Usuario y Perfil -->
        <div style="display:flex; align-items:center; gap:10px;">
          <div class="hdr-user-info">
            <div class="hdr-user-name" id="hdr-user"></div>
            <div class="hdr-user-role" id="hdr-role"></div>
          </div>
          <div class="live-dot"></div>
        </div>

        <div class="hdr-div"></div>

        <!-- Llave cambio pass -->
        <button onclick="abrirModalChangePass()"
          style="background: var(--bg-2); border: 1px solid var(--border-mid); color: var(--text-2); width: 32px; height: 32px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; padding: 0;"
          onmouseover="this.style.background='var(--bg-3)'" onmouseout="this.style.background='var(--bg-2)'"
          title="Cambiar contraseÃ±a">
          <span style="font-size: 16px;">ðŸ”‘</span>
        </button>

        <div class="hdr-div"></div>

        <button id="btn-nueva-op" class="btn-nueva" onclick="abrirModalOp()">+ Nueva operaciÃ³n</button>
        <button class="btn-logout" onclick="doLogout()">Salir</button>
      </div>
    </header>

    <nav class="app-nav">
      <button class="nav-item on" data-sec="operaciones" onclick="showSection('operaciones')">ðŸ—º Operaciones</button>
      <button class="nav-item" data-sec="chat" onclick="showSection('chat')">ðŸ’¬ Chat <span
          id="nav-chat-badge"></span></button>
      <button class="nav-item" id="nav-usuarios" data-sec="usuarios" onclick="showSection('usuarios')"
        style="display:none">ðŸ‘¥ Usuarios</button>
      <button class="nav-item" id="nav-tablas" data-sec="tablas" onclick="showSection('tablas')" style="display:none">ðŸ—‚
        Tablas maestras</button>
    </nav>

    <!-- MOBILE MENU OVERLAY (Global) -->
    <div id="mobile-menu-overlay" class="mobile-menu-overlay" onclick="toggleMobileMenu()">
      <div class="mobile-menu-drawer" onclick="event.stopPropagation()">
        <div class="drawer-head">
          <div class="logo-text">EmerCRE</div>
          <button class="btn-close-drawer" onclick="toggleMobileMenu()">âœ•</button>
        </div>

        <!-- User Profile Section -->
        <div id="drawer-user-section"
          style="padding:16px 20px; border-bottom:1px solid var(--border); background:var(--bg-2); flex-shrink:0;">
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
            <div
              style="width:36px; height:36px; border-radius:50%; background:var(--accent); display:flex; align-items:center; justify-content:center; color:white; font-size:16px; font-weight:700;">
              ðŸ‘¤</div>
            <div>
              <div id="drawer-user-name" style="font-size:14px; font-weight:600; color:var(--text-1);"></div>
              <div id="drawer-user-role"
                style="font-size:10px; color:var(--text-3); text-transform:uppercase; letter-spacing:0.05em;"></div>
            </div>
            <div class="live-dot" style="margin-left:auto;"></div>
          </div>
        </div>

        <!-- Oficina / Provincia -->
        <div id="drawer-oficina-section"
          style="padding:12px 20px; border-bottom:1px solid var(--border); flex-shrink:0;">
          <div
            style="font-size:9px; font-weight:700; color:var(--text-3); text-transform:uppercase; letter-spacing:0.08em; margin-bottom:4px;">
            Oficina</div>
          <div id="drawer-oficina-title" style="font-size:13px; font-weight:600; color:var(--accent);"></div>
          <div id="drawer-prov-selector-wrap" style="display:none; margin-top:6px;">
            <select id="drawer-prov-selector" class="f-select" style="width:100%; padding:6px 8px; font-size:12px;"
              onchange="changeProvincia(this.value)">
              <option value="AndalucÃ­a">Oficina AutonÃ³mica de AndalucÃ­a</option>
            </select>
          </div>
        </div>

        <!-- Jefe de Guardia -->
        <div id="drawer-guardia-section"
          style="padding:12px 20px; border-bottom:1px solid var(--border); flex-shrink:0;">
          <div
            style="font-size:9px; font-weight:700; color:var(--text-3); text-transform:uppercase; letter-spacing:0.08em; margin-bottom:4px;">
            Jefe de Operaciones de Guardia</div>
          <div id="drawer-jefe-guardia-val" style="font-size:13px; font-weight:600; color:var(--accent);">Cargando...
          </div>
          <select id="drawer-jefe-guardia-sel" class="f-select"
            style="display:none; width:100%; padding:6px 8px; font-size:12px; margin-top:4px;"
            onchange="window.cambiarJefeGuardia(this.value)">
          </select>
        </div>

        <!-- Navigation -->
        <div class="drawer-links">
          <button class="drawer-item on" data-sec="operaciones" onclick="mobileShowSection('operaciones')">ðŸ—º
            Operaciones</button>
          <button class="drawer-item" data-sec="chat" onclick="mobileShowSection('chat')">ðŸ’¬ Chat <span
              id="mnav-chat-badge"></span></button>
          <button class="drawer-item" id="mnav-usuarios" data-sec="usuarios" onclick="mobileShowSection('usuarios')"
            style="display:none">ðŸ‘¥ Usuarios</button>
          <button class="drawer-item" id="mnav-tablas" data-sec="tablas" onclick="mobileShowSection('tablas')"
            style="display:none">ðŸ—‚ Tablas maestras</button>
        </div>

        <!-- Footer actions -->
        <div class="drawer-foot" style="display:flex; flex-direction:column; gap:8px; flex-shrink:0;">
          <button onclick="setupNotifications(true); toggleMobileMenu();"
            style="width:100%; padding:10px; background:var(--bg-1); border:1px solid var(--accent); color:var(--text-1); cursor:pointer; font-family:inherit; font-size:13px; font-weight:700; border-radius:4px; display:flex; align-items:center; justify-content:center; gap:8px;">ðŸ””
            Activar Notificaciones</button>
          <button onclick="abrirModalChangePass(); toggleMobileMenu();"
            style="width:100%; padding:10px; background:var(--bg-2); border:1px solid var(--border-mid); color:var(--text-2); cursor:pointer; font-family:inherit; font-size:13px; font-weight:500; border-radius:4px; display:flex; align-items:center; justify-content:center; gap:8px;">ðŸ”‘
            Cambiar contrasena</button>
          <button class="btn-logout" style="width:100%; padding:12px;" onclick="doLogout()">Cerrar Sesion</button>
          <div style="text-align:center; margin-top:4px;">
            <a href="#" onclick="diagNotificaciones(); return false;"
              style="font-size:10px; color:var(--text-4); text-decoration:none;">ðŸ›  DiagnÃ³stico Push</a>
          </div>
        </div>
      </div>
    </div>

    <!-- MOBILE: Floating Nueva Operacion button -->
    <button id="btn-mobile-nueva-op" onclick="abrirModalOp()"
      style="display:none; position:fixed; bottom:76px; right:16px; z-index:600; background:var(--accent); color:#fff; border:none; width:52px; height:52px; border-radius:50%; font-size:24px; font-weight:700; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.3); align-items:center; justify-content:center;">+</button>

    <!-- OPERACIONES -->
    <div id="section-operaciones">
      <div class="panel-left">
        <div class="panel-left-head">
          <div class="search-box">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8" />
              <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
            <input type="text" id="ops-search" class="search-input" placeholder="Buscar operaciones..."
              oninput="handleSearch(this.value)">
            <button id="ops-search-clear" class="search-clear" onclick="clearSearch()"
              style="display:none;">&times;</button>
          </div>
        </div>
        <div id="sidebar-toggle-cerradas"
          style="display:none; align-items:center; gap:8px; padding:4px 16px 8px; border-bottom:1px dashed var(--border-mid);">
          <span style="font-size:10px; color:var(--text-3); font-weight:600;">Mostrar intervenciones cerradas</span>
          <label class="switch">
            <input type="checkbox" onchange="toggleGlobalCerradas(this.checked)">
            <span class="slider"></span>
          </label>
        </div>
        <div class="ops-list" id="ops-list">
          <div class="empty-msg show" id="empty-msg">
            <div style="font-size:28px;opacity:0.4">ðŸ“‹</div>
            <span>Sin operaciones registradas.</span>
          </div>
        </div>
        <div
          style="padding: 8px 16px; font-size: 11px; color: var(--text-4); border-top: 1px solid var(--border); text-align: left; font-family: monospace; flex-shrink: 0;">
          VersiÃ³n V.5.7.2 (Debug Notif)
        </div>
      </div>

      <!-- PANEL DETALLE (Movido aquÃ­ a la izquierda) -->
      <div class="detail-panel" id="detail-panel">
        <div class="dp-header">
          <div class="dp-scope-title" id="dp-scope-title"></div>
          <div class="dp-top-row">
            <div>
              <div class="dp-id" id="dp-id"></div>
              <div class="dp-name" id="dp-name"></div>
            </div>
            <button class="btn-close-dp" onclick="cerrarDetalle()">âœ•</button>
          </div>
          <div class="dp-chips">
            <div id="dp-type-tag"></div>
            <div class="dp-loc" id="dp-loc"></div>
          </div>
        </div>
        <div
          style="padding:8px 16px;border-bottom:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <span
            style="font-size:10px;color:var(--text-3);font-weight:600;text-transform:uppercase;letter-spacing:0.08em;">Nivel:</span>
          <div class="nivel-selector">
            <button class="nsel-opt" data-n="1" onclick="cambiarNivel(1)">Baja</button>
            <button class="nsel-opt" data-n="2" onclick="cambiarNivel(2)">Media</button>
            <button class="nsel-opt" data-n="3" onclick="cambiarNivel(3)">Alta</button>
            <button class="nsel-opt" data-n="4" onclick="cambiarNivel(4)">CrÃ­tica</button>
          </div>
        </div>
        <div class="dp-info-row" id="dp-info-row"></div>

        <!-- ASIGNAR RECURSOS -->
        <details class="dp-recursos" id="dp-recursos-wrapper">
          <summary class="section-label" id="dp-recursos-summary"
            style="cursor:pointer; outline:none; font-size:10px; margin-bottom:6px; color:var(--accent);">
            Asignar Recursos (0)</summary>
          <div id="dp-recursos-list" style="display:flex; flex-direction:column; gap:4px; margin-bottom:8px;"></div>

          <div id="dp-recursos-form"
            style="background:var(--bg-2); padding:6px; border:1px solid var(--border); border-radius:2px;">
            <div style="display:flex; gap:6px; align-items:center;">
              <select class="f-input f-select" id="r-cat" style="flex:1; padding:4px; font-size:11px;"
                onchange="cargarOpcionesRecursos()">
                <option value="">CategorÃ­a...</option>
                <option value="vehiculos">VehÃ­culos</option>
                <option value="erbes">ERBEs</option>
                <option value="eries">ERIEs</option>
              </select>
              <select class="f-input f-select" id="r-item" style="flex:2; padding:4px; font-size:11px;">
                <option value="">Recurso...</option>
              </select>
              <button class="btn-create-m" id="btn-add-recurso" onclick="asignarRecurso()"
                style="padding:5px 8px; font-size: 11px; white-space:nowrap;">AÃ±adir</button>
            </div>
          </div>
        </details>

        <div class="dp-timeline" id="dp-timeline"></div>
        <div class="dp-addaction" id="dp-addaction-wrapper">
          <div style="display:flex; gap:6px; margin-bottom:6px;">
            <select class="f-select" id="a-prio" style="padding:4px; font-size:11px; width:95px;">
              <option value="CrÃ­tica">ðŸ”´ CrÃ­tica</option>
              <option value="Alta">ðŸŸ  Alta</option>
              <option value="Media" selected>ðŸŸ¡ Media</option>
              <option value="Baja">ðŸŸ¢ Baja</option>
            </select>
            <!-- Campo autor: readonly, siempre muestra el usuario conectado -->
            <input class="f-input" id="a-autor" placeholder="Usuario" style="flex:1; padding:4px; font-size:11px;"
              readonly>
          </div>
          <textarea class="f-input" id="a-texto" placeholder="Describe la novedad, acciÃ³n o decisiÃ³nâ€¦"
            style="resize:vertical;min-height:45px;margin-bottom:4px;"></textarea>
          <button class="btn-reg" id="btn-reg-accion" onclick="addAccion()">Registrar novedad</button>
        </div>
        <!-- Botones admin -->
        <div
          style="padding:8px 16px;border-top:1px solid var(--border);flex-shrink:0;display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
          <button id="dp-edit-btn" class="btn-edit-op" onclick="abrirModalEditOp()">âœï¸ Editar</button>
          <button id="dp-fin-btn" class="btn-edit-op" onclick="finalizarOp()">Finalizar operaciÃ³n</button>
          <button id="dp-ai-btn" class="btn-ai" onclick="abrirModalInformeIA()">âœ¨ Emitir informe (IA)</button>
          <div class="dp-admin-btns" id="dp-admin-btns" style="padding:0;border:none;display:none;">
            <button id="dp-reabrir-btn" class="btn-edit-op" onclick="reabrirOp()" style="display:none;">Abrir</button>
            <button class="btn-danger" onclick="borrarOp()">ðŸ—‘ Borrar</button>
          </div>
          <div id="dp-hide-wrapper" style="margin-left:auto; display:none; align-items:center; gap:6px;">
            <span style="font-size:10px; color:var(--text-3); font-weight:600;">Ocultar</span>
            <label class="switch">
              <input type="checkbox" id="dp-hide-switch" onchange="toggleOcultarActual(this.checked)">
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>

      <button id="btn-mobile-map-toggle" class="btn-mobile-map-toggle" onclick="toggleMobileMap()">Ver Mapa ðŸ—º</button>
      <div class="map-zone">
        <div class="map-controls-floating">
          <button id="btn-toggle-traffic" class="map-btn-float" onclick="toggleTraffic()">ðŸš¦ TrÃ¡fico</button>
          <button id="btn-toggle-route" class="map-btn-float" onclick="toggleDirections()">ðŸ›£ï¸ Rutas</button>
          <div id="map-routing-panel" class="map-routing-panel">
            <div
              style="font-size:10px; font-weight:700; color:var(--text-3); text-transform:uppercase; margin-bottom:4px;">
              CÃ¡lculo de Ruta</div>
            <input type="text" id="route-origin" class="f-input" placeholder="Origen..."
              style="padding:6px; font-size:11px;">
            <input type="text" id="route-dest" class="f-input" placeholder="Destino..."
              style="padding:6px; font-size:11px;">
            <div style="display:flex; gap:6px; margin-top:4px;">
              <button class="btn-reg" id="btn-calc-route" style="flex:2; padding:6px; font-size:11px;"
                onclick="calculateRoute()">Calcular</button>
              <button class="btn-cancel-m" style="flex:1; padding:6px; font-size:11px;"
                onclick="clearRoute()">âœ–</button>
            </div>
            <div id="route-info"
              style="margin-top:8px; padding-top:8px; border-top:1px dashed var(--border-mid); display:none;"></div>
          </div>
        </div>
        <div class="pick-banner" id="pick-banner">ðŸ“ Haz clic en el mapa para fijar la ubicaciÃ³n</div>
        <div id="map"></div>
      </div>
    </div>

    <!-- CHAT SECTION -->
    <div id="section-chat-view" style="display:none; flex:1; flex-direction:column;">
      <div id="section-chat">
        <div class="chat-sidebar">
          <div class="chat-sidebar-head">
            <span>ðŸ’¬</span> Contactos
          </div>
          <div class="chat-list" id="chat-list">
            <!-- Cargado dinÃ¡micamente -->
          </div>
        </div>
        <div class="chat-main">
          <div id="chat-header" class="chat-header" style="display:none;">
            <div class="chat-header-avatar" id="chat-header-avatar"></div>
            <h3 id="chat-target-name">General</h3>
          </div>
          <div class="chat-messages" id="chat-messages">
            <!-- Cargado dinÃ¡micamente -->
          </div>
          <div id="chat-input-area" class="chat-input-area" style="display: none;">
            <textarea id="chat-input" class="chat-input" placeholder="Escribe un mensaje..." rows="1"
              oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
              onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); enviarMensaje(); }"></textarea>
            <button class="btn-chat-send" onclick="enviarMensaje()">âž¤</button>
          </div>
        </div>
      </div>
    </div>

    <!-- USUARIOS -->
    <div id="section-usuarios" style="display:none;">
      <div class="users-toolbar">
        <div>
          <div class="section-title">GestiÃ³n de usuarios</div>
          <div class="section-subtitle">Solo el Super Admin puede crear, editar y desactivar usuarios.</div>
        </div>
        <button class="btn-nueva" onclick="abrirModalUsuario()">+ Nuevo usuario</button>
      </div>
      <div class="search-box" style="margin-bottom:16px;">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8" />
          <line x1="21" y1="21" x2="16.65" y2="16.65" />
        </svg>
        <input type="text" id="user-search" class="search-input" placeholder="Buscar usuarios..."
          oninput="handleUserSearch(this.value)">
        <button id="user-search-clear" class="search-clear" onclick="clearUserSearch()"
          style="display:none;">&times;</button>
      </div>
      <div class="users-table-wrap">
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Email</th>
              <th>Rol</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="users-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- TABLAS MAESTRAS -->
    <div id="section-tablas" style="display:none;">
      <div class="users-toolbar" style="flex-direction: column; align-items: flex-start; gap: 16px;">
        <div>
          <div class="section-title">Tablas maestras</div>
          <div class="section-subtitle">GestiÃ³n de catÃ¡logos y dispositivos estructurales.</div>
        </div>
        <div class="tablas-pills" id="tablas-subnav">
          <button class="tablas-pill active" id="subnav-vehiculos"
            onclick="showTablaMaestra('vehiculos')">VehÃ­culos</button>
          <button class="tablas-pill" id="subnav-erbes" onclick="showTablaMaestra('erbes')">ERBEs</button>
          <button class="tablas-pill" id="subnav-eries" onclick="showTablaMaestra('eries')">ERIEs</button>
          <button class="tablas-pill" id="subnav-jefes" onclick="showTablaMaestra('jefes')">Jefes de
            Operaciones</button>
        </div>
      </div>

      <div class="search-box" style="margin-bottom:16px;">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8" />
          <line x1="21" y1="21" x2="16.65" y2="16.65" />
        </svg>
        <input type="text" id="tablas-search" class="search-input" placeholder="Buscar en tablas..."
          oninput="handleTablasSearch(this.value)">
        <button id="tablas-search-clear" class="search-clear" onclick="clearTablasSearch()"
          style="display:none;">&times;</button>
      </div>

      <!-- Contenedor VehÃ­culos -->
      <div id="tabla-vehiculos-container" style="display:flex; flex-direction:column; flex:1; gap:16px;">
        <div style="display:flex; justify-content:flex-end;">
          <button class="btn-nueva" onclick="abrirModalVehiculo()">+ Nuevo vehÃ­culo</button>
        </div>
        <div class="users-table-wrap">
          <table>
            <thead>
              <tr>
                <th>Indicativo</th>
                <th>MatrÃ­cula</th>
                <th>Tipo de vehÃ­culo</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="vehiculos-tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Contenedor ERBEs -->
      <div id="tabla-erbes-container" style="display:none; flex-direction:column; flex:1; gap:16px;">
        <div style="display:flex; justify-content:flex-end;">
          <button class="btn-nueva" onclick="abrirModalErbe()">+ AÃ±adir ERBE</button>
        </div>
        <div class="users-table-wrap">
          <table>
            <thead>
              <tr>
                <th>Localidad</th>
                <th>Provincia</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="erbes-tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Contenedor ERIEs -->
      <div id="tabla-eries-container" style="display:none; flex-direction:column; flex:1; gap:16px;">
        <div style="display:flex; justify-content:flex-end;">
          <button class="btn-nueva" onclick="abrirModalErie()">+ AÃ±adir ERIE</button>
        </div>
        <div class="users-table-wrap">
          <table>
            <thead>
              <tr>
                <th>Especialidad</th>
                <th>Provincia</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="eries-tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Contenedor Jefes de Operaciones -->
      <div id="tabla-jefes-container" style="display:none; flex-direction:column; flex:1; gap:16px;">
        <div style="display:flex; justify-content:flex-end;">
          <button class="btn-nueva" onclick="abrirModalJefe()">+ AÃ±adir Jefe de Operaciones</button>
        </div>
        <div class="users-table-wrap">
          <table>
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Provincia</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="jefes-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- MODAL NUEVA OPERACIÃ“N -->
  <div class="overlay" id="overlay-op">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title">Nueva operaciÃ³n</div>
        <button class="btn-close-dp" onclick="cerrarModalOp()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <div class="field-lbl">Nombre de la operaciÃ³n *</div>
          <input class="f-input" id="f-nombre" placeholder="Ej: Inundaciones Cuenca del Ebro">
        </div>
        <div class="field-row">
          <div class="field" style="flex:1;">
            <div class="field-lbl">Tipo de catÃ¡strofe</div>
            <select class="f-input f-select" id="f-tipo" style="width:100%" onchange="handleTipoChange('f')">
              <option value="inundacion">ðŸŒŠ InundaciÃ³n / DANA</option>
              <option value="incendio">ðŸ”¥ Incendio forestal</option>
              <option value="seismo">ðŸŒ SeÃ­smo / Terremoto</option>
              <option value="temporal">ðŸŒª Temporal / Viento</option>
              <option value="accidente">ðŸš› Accidente grave</option>
              <option value="quimico">â˜£ï¸ Incidente quÃ­mico</option>
              <option value="sanitaria">ðŸ¦  Emergencia sanitaria</option>
              <option value="logistica">ðŸ“¦ OperaciÃ³n LogÃ­stica</option>
              <option value="otro">ðŸ“‹ Otro</option>
            </select>
            <input class="f-input" id="f-tipo-otro" placeholder="Especificar..."
              style="display:none; margin-top:8px; width:100%;">
          </div>
          <div class="field" style="flex:1;">
            <div class="field-lbl">Nivel de activaciÃ³n</div>
            <select class="f-input f-select" id="f-nivel" style="width:100%">
              <option value="1">N1 â€” Emergencia Mayor</option>
              <option value="2">N2 â€” Emergencia</option>
              <option value="3" selected>N3 â€” Alerta</option>
              <option value="4">N4 â€” Seguimiento</option>
            </select>
          </div>
        </div>
        <div class="field">
          <div class="field-lbl">DescripciÃ³n inicial</div>
          <textarea class="f-input" id="f-desc" placeholder="SituaciÃ³n inicial, recursos movilizadosâ€¦"
            style="resize:vertical;min-height:68px;"></textarea>
        </div>
        <div class="field-row">
          <div class="field" style="flex:1;">
            <div class="field-lbl">Jefe de Operaciones</div>
            <select class="f-input f-select" id="f-dir" style="width:100%">
              <!-- Se puebla dinÃ¡micamente -->
            </select>
          </div>
          <div class="field" style="flex:1;">
            <div class="field-lbl">Solicitado por:</div>
            <select class="f-input f-select" id="f-org" style="width:100%" onchange="handleSolicitadoChange('f')">
              <option value="">-- Seleccionar --</option>
              <option value="112">112</option>
              <option value="061">061</option>
              <option value="Ayuntamiento">Ayuntamiento</option>
              <option value="Cruz Roja">Cruz Roja</option>
              <option value="Otro">Otro</option>
              <option value="Jefe de Operaciones">Jefe de Operaciones</option>
            </select>
            <div id="f-org-sub" style="display:none; margin-top:8px;">
              <input class="f-input" id="f-org-sub-input" style="display:none;">
              <select class="f-input f-select" id="f-org-sub-select" style="display:none; width:100%">
                <!-- Se puebla dinÃ¡micamente -->
              </select>
            </div>
          </div>
        </div>
        <div class="field">
          <div class="field-lbl">ðŸ“ UbicaciÃ³n â€” busca una direcciÃ³n o haz clic en el mapa</div>
          <div style="display:flex;gap:6px;">
            <input class="f-input" id="f-lugar" placeholder="Escribe una direcciÃ³n, municipio o lugarâ€¦"
              autocomplete="off" onkeydown="if(event.key==='Enter') event.preventDefault();">
            <button type="button" class="btn-mapa" onclick="iniciarPick()">ðŸ—º En mapa</button>
          </div>
          <div class="coord-box" id="coord-box"></div>
          <input type="hidden" id="f-loc">
        </div>
        <div class="field" id="f-provincia-row">
          <div class="field-lbl">Provincia *</div>
          <select class="f-input f-select" id="f-provincia" onchange="actualizarJefePorProvincia(this.value, 'f')"
            style="width:100%">
            <option value="AndalucÃ­a">Oficina AutonÃ³mica de AndalucÃ­a</option>
            <option value="AlmerÃ­a">Oficina Provincial de AlmerÃ­a</option>
            <option value="CÃ¡diz">Oficina Provincial de CÃ¡diz</option>
            <option value="CÃ³rdoba">Oficina Provincial de CÃ³rdoba</option>
            <option value="Granada">Oficina Provincial de Granada</option>
            <option value="Huelva">Oficina Provincial de Huelva</option>
            <option value="JaÃ©n">Oficina Provincial de JaÃ©n</option>
            <option value="MÃ¡laga">Oficina Provincial de MÃ¡laga</option>
            <option value="Sevilla">Oficina Provincial de Sevilla</option>
          </select>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn-cancel-m" onclick="cerrarModalOp()">Cancelar</button>
        <button class="btn-create-m" id="btn-crear-op" onclick="crearOp()">Crear operaciÃ³n â†’</button>
      </div>
    </div>
  </div>

  <!-- MODAL EDITAR OPERACIÃ“N -->
  <div class="overlay" id="overlay-edit-op">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title">Editar operaciÃ³n</div>
        <button class="btn-close-dp" onclick="cerrarModalEditOp()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <div class="field-lbl">Nombre de la operaciÃ³n *</div>
          <input class="f-input" id="fe-nombre" placeholder="Ej: Inundaciones Cuenca del Ebro">
        </div>
        <div class="field-row">
          <div class="field" style="flex:1;">
            <div class="field-lbl">Fecha y hora de inicio</div>
            <input type="datetime-local" class="f-input" id="fe-fecha" style="width:100%">
          </div>
          <div class="field" style="flex:1;">
            <div class="field-lbl">Tipo de catÃ¡strofe</div>
            <select class="f-input f-select" id="fe-tipo" style="width:100%" onchange="handleTipoChange('fe')">
              <option value="inundacion">ðŸŒŠ InundaciÃ³n / DANA</option>
              <option value="incendio">ðŸ”¥ Incendio forestal</option>
              <option value="seismo">ðŸŒ SeÃ­smo / Terremoto</option>
              <option value="temporal">ðŸŒª Temporal / Viento</option>
              <option value="accidente">ðŸš› Accidente grave</option>
              <option value="quimico">â˜£ï¸ Incidente quÃ­mico</option>
              <option value="sanitaria">ðŸ¦  Emergencia sanitaria</option>
              <option value="logistica">ðŸ“¦ OperaciÃ³n LogÃ­stica</option>
              <option value="otro">ðŸ“‹ Otro</option>
            </select>
            <input class="f-input" id="fe-tipo-otro" placeholder="Especificar..."
              style="display:none; margin-top:8px; width:100%;">
          </div>
        </div>
        <div class="field-row">
          <div class="field" style="flex:1;">
            <div class="field-lbl">Jefe de Operaciones</div>
            <select class="f-input f-select" id="fe-dir" style="width:100%">
              <option value="Julio Pulido Morilla">Julio Pulido Morilla</option>
              <option value="Samuel Linares Cantero">Samuel Linares Cantero</option>
            </select>
          </div>
          <div class="field" style="flex:1;">
            <div class="field-lbl">Solicitado por:</div>
            <select class="f-input f-select" id="fe-org" style="width:100%" onchange="handleSolicitadoChange('fe')">
              <option value="112">112</option>
              <option value="061">061</option>
              <option value="Ayuntamiento">Ayuntamiento</option>
              <option value="Cruz Roja">Cruz Roja</option>
              <option value="Otro">Otro</option>
              <option value="Jefe de Operaciones">Jefe de Operaciones</option>
            </select>
            <div id="fe-org-sub" style="display:none; margin-top:8px;">
              <input class="f-input" id="fe-org-sub-input" style="display:none;">
              <select class="f-input f-select" id="fe-org-sub-select" style="display:none; width:100%">
                <!-- Se puebla dinÃ¡micamente -->
              </select>
            </div>
          </div>
        </div>
        <div class="field">
          <div class="field-lbl">ðŸ“ UbicaciÃ³n â€” busca una direcciÃ³n o haz clic en el mapa</div>
          <div style="display:flex;gap:6px;">
            <input class="f-input" id="fe-lugar" placeholder="Escribe una direcciÃ³n, municipio o lugarâ€¦"
              autocomplete="off" onkeydown="if(event.key==='Enter') event.preventDefault();">
            <button type="button" class="btn-mapa" onclick="iniciarEditPick()">ðŸ—º En mapa</button>
          </div>
          <div class="coord-box" id="edit-coord-box"></div>
        </div>
        <div class="field" id="fe-provincia-row">
          <div class="field-lbl">Provincia *</div>
          <select class="f-input f-select" id="fe-provincia" style="width:100%">
            <option value="AndalucÃ­a">Oficina AutonÃ³mica de AndalucÃ­a</option>
            <option value="AlmerÃ­a">Oficina Provincial de AlmerÃ­a</option>
            <option value="CÃ¡diz">Oficina Provincial de CÃ¡diz</option>
            <option value="CÃ³rdoba">Oficina Provincial de CÃ³rdoba</option>
            <option value="Granada">Oficina Provincial de Granada</option>
            <option value="Huelva">Oficina Provincial de Huelva</option>
            <option value="JaÃ©n">Oficina Provincial de JaÃ©n</option>
            <option value="MÃ¡laga">Oficina Provincial de MÃ¡laga</option>
            <option value="Sevilla">Oficina Provincial de Sevilla</option>
          </select>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn-cancel-m" onclick="cerrarModalEditOp()">Cancelar</button>
        <button class="btn-create-m" id="btn-guardar-edit-op" onclick="guardarEditOp()">Guardar cambios â†’</button>
      </div>
    </div>
  </div>

  <!-- MODAL EDITAR ACCIÃ“N -->
  <div class="overlay" id="overlay-edit-accion">
    <div class="modal" style="width:480px;max-width:90vw;">
      <div class="modal-head">
        <div class="modal-title">Editar Novedad</div>
        <button class="btn-close-dp" onclick="cerrarModalEditAccion()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <div class="field-lbl">Fecha y Hora</div>
          <input type="datetime-local" class="f-input" id="ea-fecha">
        </div>
        <div class="field">
          <div class="field-lbl">Texto de la novedad</div>
          <textarea class="f-input" id="ea-texto" style="resize:vertical;min-height:80px;"></textarea>
        </div>
      </div>
      <div class="modal-foot" style="justify-content: space-between;">
        <button class="btn-cancel-m" style="color:var(--crit-1);border-color:var(--crit-1);background:var(--crit-1-bg);"
          onclick="eliminarAccion()">ðŸ—‘ï¸ Eliminar</button>
        <div style="display:flex;gap:8px;">
          <button class="btn-cancel-m" onclick="cerrarModalEditAccion()">Cancelar</button>
          <button class="btn-create-m" id="btn-guardar-edit-accion" onclick="guardarEditAccion()">Guardar novedad
            â†’</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL USUARIO -->
  <div class="overlay" id="overlay-user">
    <div class="modal" style="width:420px;">
      <div class="modal-head">
        <div class="modal-title" id="modal-user-title">Nuevo usuario</div>
        <button class="btn-close-dp" onclick="cerrarModalUsuario()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <div class="field-lbl">Nombre completo *</div>
          <input class="f-input" id="u-nombre" placeholder="Nombre y apellidos">
        </div>
        <div class="field">
          <div class="field-lbl">Email *</div>
          <input class="f-input" id="u-email" type="email" placeholder="usuario@organismo.es">
        </div>
        <div class="field" id="u-pass-row">
          <div class="field-lbl">ContraseÃ±a inicial *</div>
          <input class="f-input" id="u-pass" type="password" placeholder="MÃ­nimo 6 caracteres">
        </div>
        <div class="field-row">
          <div class="field" style="flex:1;">
            <div class="field-lbl">Rol</div>
            <select class="f-input f-select" id="u-role" style="width:100%">
              <!-- Las opciones se cargan dinÃ¡micamente segÃºn permiso -->
            </select>
          </div>
          <div class="field" style="flex:1;">
            <div class="field-lbl">Perfil / Provincia</div>
            <select class="f-input f-select" id="u-provincia" style="width:100%">
              <option value="AndalucÃ­a">Oficina AutonÃ³mica de AndalucÃ­a</option>
              <option value="AlmerÃ­a">Oficina Provincial de AlmerÃ­a</option>
              <option value="CÃ¡diz">Oficina Provincial de CÃ¡diz</option>
              <option value="CÃ³rdoba">Oficina Provincial de CÃ³rdoba</option>
              <option value="Granada">Oficina Provincial de Granada</option>
              <option value="Huelva">Oficina Provincial de Huelva</option>
              <option value="JaÃ©n">Oficina Provincial de JaÃ©n</option>
              <option value="MÃ¡laga">Oficina Provincial de MÃ¡laga</option>
              <option value="Sevilla">Oficina Provincial de Sevilla</option>
            </select>
          </div>
        </div>
        <div class="field">
          <div class="field-lbl">Estado</div>
          <select class="f-input f-select" id="u-activo" style="width:100%">
            <option value="true">Activo</option>
            <option value="false">Inactivo</option>
          </select>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn-cancel-m" onclick="cerrarModalUsuario()">Cancelar</button>
        <button class="btn-create-m" id="btn-guardar-user" onclick="guardarUsuario()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- MODAL VEHÃCULO -->
  <!-- Modal Jefe de Operaciones -->
  <div class="overlay" id="overlay-jefe">
    <div class="modal" style="width:420px;">
      <div class="modal-head">
        <div class="modal-title" id="modal-jefe-title">AÃ±adir Jefe de Operaciones</div>
        <button class="btn-close-dp" onclick="cerrarModalJefe()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <div class="field-lbl">Usuario</div>
          <select class="f-input f-select" id="j-user" style="width:100%">
            <!-- Se puebla dinÃ¡micamente -->
          </select>
          <div style="font-size:11px; color:var(--text-3); margin-top:8px; line-height: 1.4;">
            Selecciona un usuario registrado para designarlo como Jefe de Operaciones en el Ã¡mbito seleccionado.
          </div>
          <div style="font-size:10px; color:var(--text-4); margin-top:20px; text-align:center;">
            VersiÃ³n V.5.4.0
          </div>
        </div>
        <div class="field" id="j-prov-row">
          <div class="field-lbl">Provincia / Ãmbito</div>
          <select class="f-input f-select" id="j-provincia" style="width:100%">
            <option value="AndalucÃ­a">Oficina AutonÃ³mica de AndalucÃ­a</option>
            <option value="AlmerÃ­a">Oficina Provincial de AlmerÃ­a</option>
            <option value="CÃ¡diz">Oficina Provincial de CÃ¡diz</option>
            <option value="CÃ³rdoba">Oficina Provincial de CÃ³rdoba</option>
            <option value="Granada">Oficina Provincial de Granada</option>
            <option value="JaÃ©n">Oficina Provincial de JaÃ©n</option>
            <option value="Huelva">Oficina Provincial de Huelva</option>
            <option value="MÃ¡laga">Oficina Provincial de MÃ¡laga</option>
            <option value="Sevilla">Oficina Provincial de Sevilla</option>
          </select>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn-cancel-m" onclick="cerrarModalJefe()">Cancelar</button>
        <button class="btn-create-m" id="btn-guardar-jefe" onclick="guardarJefe()">Guardar cambios</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay-vehiculo">
    <div class="modal" style="width:420px;">
      <div class="modal-head">
        <div class="modal-title" id="modal-vehiculo-title">Nuevo vehÃ­culo</div>
        <button class="btn-close-dp" onclick="cerrarModalVehiculo()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <div class="field-lbl">Indicativo *</div>
          <input class="f-input" id="v-indicativo" placeholder="Ej: A-10">
        </div>
        <div class="field">
          <div class="field-lbl">MatrÃ­cula *</div>
          <input class="f-input" id="v-matricula" placeholder="Ej: 1234 ABC">
        </div>
        <div class="field">
          <div class="field-lbl">Tipo de vehÃ­culo *</div>
          <select class="f-input f-select" id="v-tipo" style="width:100%">
            <option value="CamiÃ³n">CamiÃ³n</option>
            <option value="VehÃ­culo transporte personal">VehÃ­culo transporte personal</option>
            <option value="VehÃ­culo de transporte mixto">VehÃ­culo de transporte mixto</option>
            <option value="Ambulancia">Ambulancia</option>
            <option value="VehÃ­culo Todo terreno">VehÃ­culo Todo terreno</option>
          </select>
        </div>
        <div class="field" id="v-prov-row" style="margin-bottom: 0;">
          <div class="field-lbl">Oficina / Provincia *</div>
          <select class="f-input f-select" id="v-provincia" style="width:100%">
            <option value="AndalucÃ­a">Oficina AutonÃ³mica de AndalucÃ­a</option>
            <option value="AlmerÃ­a">Oficina Provincial de AlmerÃ­a</option>
            <option value="CÃ¡diz">Oficina Provincial de CÃ¡diz</option>
            <option value="CÃ³rdoba">Oficina Provincial de CÃ³rdoba</option>
            <option value="Granada">Oficina Provincial de Granada</option>
            <option value="Huelva">Oficina Provincial de Huelva</option>
            <option value="JaÃ©n">Oficina Provincial de JaÃ©n</option>
            <option value="MÃ¡laga">Oficina Provincial de MÃ¡laga</option>
            <option value="Sevilla">Oficina Provincial de Sevilla</option>
          </select>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn-cancel-m" onclick="cerrarModalVehiculo()">Cancelar</button>
        <button class="btn-create-m" id="btn-guardar-vehiculo" onclick="guardarVehiculo()">Guardar</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay-erbe">
    <div class="modal" style="width:420px;">
      <div class="modal-head">
        <div class="modal-title" id="modal-erbe-title">Nuevo ERBE</div>
        <button class="btn-close-dp" onclick="cerrarModalErbe()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <div class="field-lbl">Localidad *</div>
          <input class="f-input" id="e-localidad" placeholder="Ej: Dos Hermanas">
        </div>
        <div class="field" id="e-prov-row" style="margin-bottom: 0;">
          <div class="field-lbl">Oficina / Provincia *</div>
          <select class="f-input f-select" id="e-provincia" style="width:100%">
            <option value="AndalucÃ­a">Oficina AutonÃ³mica de AndalucÃ­a</option>
            <option value="AlmerÃ­a">Oficina Provincial de AlmerÃ­a</option>
            <option value="CÃ¡diz">Oficina Provincial de CÃ¡diz</option>
            <option value="CÃ³rdoba">Oficina Provincial de CÃ³rdoba</option>
            <option value="Granada">Oficina Provincial de Granada</option>
            <option value="Huelva">Oficina Provincial de Huelva</option>
            <option value="JaÃ©n">Oficina Provincial de JaÃ©n</option>
            <option value="MÃ¡laga">Oficina Provincial de MÃ¡laga</option>
            <option value="Sevilla">Oficina Provincial de Sevilla</option>
          </select>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn-cancel-m" onclick="cerrarModalErbe()">Cancelar</button>
        <button class="btn-create-m" id="btn-guardar-erbe" onclick="guardarErbe()">Guardar</button>
      </div>
    </div>
  </div>

  </div>

  <div class="overlay" id="overlay-erie">
    <div class="modal" style="width:420px;">
      <div class="modal-head">
        <div class="modal-title" id="modal-erie-title">Nuevo ERIE</div>
        <button class="btn-close-dp" onclick="cerrarModalErie()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <div class="field-lbl">Especialidad *</div>
          <select class="f-input f-select" id="erie-especialidad" style="width:100%">
            <option value="Asistencia Sanitaria">Asistencia Sanitaria</option>
            <option value="Prepi">Prepi</option>
            <option value="Albergue">Albergue</option>
            <option value="Psicosocial">Psicosocial</option>
            <option value="Comunicaciones y CoordinaciÃ³n">Comunicaciones y CoordinaciÃ³n</option>
            <option value="BÃºsqueda y Salvamento en medio acuÃ¡tico">BÃºsqueda y Salvamento en medio acuÃ¡tico</option>
            <option value="BÃºsqueda y Salvamento en medio terrestre">BÃºsqueda y Salvamento en medio terrestre</option>
          </select>
        </div>
        <div class="field" id="erie-prov-row" style="margin-bottom: 0;">
          <div class="field-lbl">Oficina / Provincia *</div>
          <select class="f-input f-select" id="erie-provincia" style="width:100%">
            <option value="AndalucÃ­a">Oficina AutonÃ³mica de AndalucÃ­a</option>
            <option value="AlmerÃ­a">Oficina Provincial de AlmerÃ­a</option>
            <option value="CÃ¡diz">Oficina Provincial de CÃ¡diz</option>
            <option value="CÃ³rdoba">Oficina Provincial de CÃ³rdoba</option>
            <option value="Granada">Oficina Provincial de Granada</option>
            <option value="Huelva">Oficina Provincial de Huelva</option>
            <option value="JaÃ©n">Oficina Provincial de JaÃ©n</option>
            <option value="MÃ¡laga">Oficina Provincial de MÃ¡laga</option>
            <option value="Sevilla">Oficina Provincial de Sevilla</option>
          </select>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn-cancel-m" onclick="cerrarModalErie()">Cancelar</button>
        <button class="btn-create-m" id="btn-guardar-erie" onclick="guardarErie()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- MODAL INFORME IA -->
  <div class="overlay" id="overlay-ai-report">
    <div class="modal" style="width:700px; max-width:98vw;">
      <div class="modal-head">
        <div class="modal-title">âœ¨ Informe Generado por Inteligencia Artificial</div>
        <button class="btn-close-dp" onclick="cerrarModalInformeIA()">âœ•</button>
      </div>
      <div class="modal-body ai-report-body" id="ai-report-content">
        <!-- El texto generado se incrustarÃ¡ aquÃ­ -->
      </div>
      <div class="modal-foot">
        <button class="btn-cancel-m" onclick="cerrarModalInformeIA()">Cerrar panel</button>
      </div>
    </div>
  </div>

  <!-- MODAL OLVIDÃ“ CONTRASEÃ‘A -->
  <div class="overlay" id="overlay-forgot">
    <div class="modal" style="width:400px;">
      <div class="modal-head">
        <div class="modal-title">Recuperar contraseÃ±a</div>
        <button class="btn-close-dp" onclick="cerrarModalForgot()">âœ•</button>
      </div>
      <div class="modal-body">
        <div style="font-size:13px; color:var(--text-3); margin-bottom:15px; line-height:1.4;">
          Introduce tu email y te enviaremos un enlace para que puedas crear una nueva contraseÃ±a.
        </div>
        <div class="field">
          <div class="field-lbl">Email</div>
          <input class="f-input" id="f-email-reset" type="email" placeholder="tu-email@organismo.es">
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn-cancel-m" onclick="cerrarModalForgot()">Cancelar</button>
        <button class="btn-create-m" id="btn-send-reset" onclick="requestResetEmail()">Enviar enlace de
          recuperaciÃ³n</button>
      </div>
    </div>
  </div>

  <!-- MODAL RESTABLECER (Desde link) -->
  <div class="overlay" id="overlay-reset">
    <div class="modal" style="width:400px;">
      <div class="modal-head">
        <div class="modal-title">Nueva contraseÃ±a</div>
      </div>
      <div class="modal-body">
        <div style="font-size:13px; color:var(--text-3); margin-bottom:15px; line-height:1.4;">
          Crea una nueva contraseÃ±a para tu cuenta de EmerCRE.
        </div>
        <div class="field">
          <div class="field-lbl">Nueva contraseÃ±a</div>
          <input class="f-input" id="r-pass1" type="password" placeholder="MÃ­nimo 6 caracteres">
        </div>
        <div class="field">
          <div class="field-lbl">Confirmar nueva contraseÃ±a</div>
          <input class="f-input" id="r-pass2" type="password" placeholder="Repite la contraseÃ±a">
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn-create-m" id="btn-reset-now" onclick="confirmReset()">Restablecer contraseÃ±a</button>
      </div>
    </div>
  </div>

  <!-- MODAL CAMBIAR (Usuario logueado) -->
  <div class="overlay" id="overlay-change-pass">
    <div class="modal" style="width:400px;">
      <div class="modal-head">
        <div class="modal-title">Cambiar contraseÃ±a</div>
        <button class="btn-close-dp" onclick="cerrarModalChangePass()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <div class="field-lbl">ContraseÃ±a actual</div>
          <input class="f-input" id="curr-pass" type="password" placeholder="Tu contraseÃ±a actual">
        </div>
        <div class="field">
          <div class="field-lbl">Nueva contraseÃ±a</div>
          <input class="f-input" id="new-pass" type="password" placeholder="MÃ­nimo 6 caracteres">
        </div>
        <div class="field">
          <div class="field-lbl">Confirmar nueva contraseÃ±a</div>
          <input class="f-input" id="new-pass-conf" type="password" placeholder="Repite la nueva contraseÃ±a">
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn-cancel-m" onclick="cerrarModalChangePass()">Cancelar</button>
        <button class="btn-create-m" id="btn-confirm-change" onclick="confirmChangePassword()">Cambiar
          contraseÃ±a</button>
      </div>
    </div>
  </div>

  <!-- MODAL LOG DE SESIONES -->
  <div class="overlay" id="overlay-user-log">
    <div class="modal" style="width:500px; max-width:95vw;">
      <div class="modal-head">
        <div class="modal-title">Historial de sesiones: <span id="log-user-name"></span></div>
        <button class="btn-close-dp" onclick="cerrarLogUsuario()">âœ•</button>
      </div>
      <div class="modal-body" style="max-height:60vh; overflow-y:auto; padding:0;">
        <table style="width:100%; border-collapse:collapse;">
          <thead style="position:sticky; top:0; background:var(--bg-1); z-index:1; box-shadow:0 1px 0 var(--border);">
            <tr>
              <th style="text-align:left; padding:12px; font-size:11px; text-transform:uppercase; color:var(--text-3);">
                Fecha y Hora</th>
              <th style="text-align:left; padding:12px; font-size:11px; text-transform:uppercase; color:var(--text-3);">
                Evento</th>
            </tr>
          </thead>
          <tbody id="log-tbody">
            <!-- Los logs se cargan aquÃ­ -->
          </tbody>
        </table>
      </div>
      <div class="modal-foot">
        <button class="btn-cancel-m" onclick="cerrarLogUsuario()">Cerrar historial</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    setInterval(() => {
      const el = document.getElementById('clock');
      if (el) el.textContent = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }, 1000);
  </script>
</body>

</html>