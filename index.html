<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIGECA ‚Äî Sistema de Gesti√≥n de Cat√°strofes</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600&family=IBM+Plex+Mono:wght@400;500&family=Fraunces:opsz,wght@9..144,300;9..144,700;9..144,900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc,
  onSnapshot, query, orderBy, serverTimestamp, getDoc, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const firebaseConfig = {
  apiKey: "AIzaSyAHtrxaBazArqa8znWsUIVYxTsS7zoOOmc",
  authDomain: "emercre.firebaseapp.com",
  projectId: "emercre",
  storageBucket: "emercre.firebasestorage.app",
  messagingSenderId: "277256770434",
  appId: "1:277256770434:web:225aa9c7ff6b862d72b59b"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

// ‚îÄ‚îÄ ESTADO GLOBAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentUser    = null;
let currentRole    = null;
let currentUserDoc = null;
let selOpId        = null;
let filtro         = 'all';
let picking        = false;
let coords         = null;
let map, markerLayer;
let unsubOps       = null;
let unsubAcciones  = null;
let ops            = {};   // { id: opData }
let editingUserId  = null;

// ‚îÄ‚îÄ TIPO / NIVEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TIPOS = {
  inundacion: { label:'Inundaci√≥n',        emoji:'üåä', color:'#2980b9' },
  incendio:   { label:'Incendio forestal', emoji:'üî•', color:'#c0392b' },
  seismo:     { label:'Se√≠smo',            emoji:'üåç', color:'#8e44ad' },
  temporal:   { label:'Temporal',          emoji:'üå™', color:'#16a085' },
  accidente:  { label:'Accidente',         emoji:'üöõ', color:'#d35400' },
  quimico:    { label:'Inc. Qu√≠mico',      emoji:'‚ò£Ô∏è', color:'#c0392b' },
  sanitaria:  { label:'Emerg. Sanitaria',  emoji:'ü¶†', color:'#e74c3c' },
  otro:       { label:'Otro',              emoji:'üìã', color:'#7f8c8d' }
};
const NIVEL_LABELS = { 1:'Emergencia Mayor', 2:'Emergencia', 3:'Alerta', 4:'Seguimiento' };
const ROL_LABELS   = { super_admin:'Super Admin', admin:'Administrador', usuario:'Usuario' };

// ‚îÄ‚îÄ AUTH STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
onAuthStateChanged(auth, async user => {
  if (user) {
    const snap = await getDoc(doc(db, 'users', user.uid));
    if (!snap.exists() || snap.data().activo === false) {
      await signOut(auth);
      mostrarError('login', 'Usuario no autorizado o desactivado.');
      return;
    }
    currentUser    = user;
    currentUserDoc = snap.data();
    currentRole    = currentUserDoc.role;
    mostrarApp();
    initApp();
  } else {
    currentUser = null;
    currentRole = null;
    mostrarLogin();
    detenerListeners();
  }
});

// ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.doLogin = async () => {
  const email = document.getElementById('l-email').value.trim();
  const pass  = document.getElementById('l-pass').value;
  if (!email || !pass) return;
  document.getElementById('btn-login').disabled = true;
  document.getElementById('btn-login').textContent = 'Accediendo‚Ä¶';
  try {
    await signInWithEmailAndPassword(auth, email, pass);
  } catch(e) {
    mostrarError('login', 'Email o contrase√±a incorrectos.');
    document.getElementById('btn-login').disabled = false;
    document.getElementById('btn-login').textContent = 'Acceder';
  }
};

window.doLogout = async () => {
  await signOut(auth);
};

// ‚îÄ‚îÄ INIT APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initApp() {
  // nombre usuario en header
  document.getElementById('hdr-user').textContent =
    `${currentUserDoc.nombre || currentUser.email}`;
  document.getElementById('hdr-role').textContent = ROL_LABELS[currentRole] || currentRole;

  // mostrar/ocultar controles seg√∫n rol
  applyRoleUI();

  // init mapa si no existe
  if (!map) initMap();
  else { map.invalidateSize(); renderMapa(); }

  // suscribir operaciones en tiempo real
  suscribirOps();

  // nav por defecto
  showSection('operaciones');
}

function applyRoleUI() {
  const isSA    = currentRole === 'super_admin';
  const isAdmin = currentRole === 'admin' || isSA;

  // Men√∫ usuarios solo super_admin
  document.getElementById('nav-usuarios').style.display = isSA ? 'flex' : 'none';
  // Bot√≥n nueva operaci√≥n
  document.getElementById('btn-nueva-op').style.display = isAdmin ? 'flex' : 'none';
}

function detenerListeners() {
  if (unsubOps)      { unsubOps();      unsubOps = null; }
  if (unsubAcciones) { unsubAcciones(); unsubAcciones = null; }
  ops = {};
}

// ‚îÄ‚îÄ SUSCRIPCI√ìN OPERACIONES TIEMPO REAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function suscribirOps() {
  if (unsubOps) unsubOps();
  const q = query(collection(db, 'operaciones'), orderBy('creadoEn', 'desc'));
  unsubOps = onSnapshot(q, snap => {
    snap.docChanges().forEach(change => {
      if (change.type === 'removed') {
        delete ops[change.doc.id];
      } else {
        ops[change.doc.id] = { id: change.doc.id, ...change.doc.data() };
      }
    });
    renderSidebar();
    renderMapa();
    actualizarContadores();
    if (selOpId && ops[selOpId]) renderDetalle(ops[selOpId]);
  });
}

// ‚îÄ‚îÄ MAPA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initMap() {
  map = L.map('map', { zoomControl: false }).setView([40.4, -3.7], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap', maxZoom: 19
  }).addTo(map);
  L.control.zoom({ position: 'bottomright' }).addTo(map);
  markerLayer = L.layerGroup().addTo(map);

  map.on('click', e => {
    if (!picking) return;
    coords = { lat: parseFloat(e.latlng.lat.toFixed(6)), lng: parseFloat(e.latlng.lng.toFixed(6)) };
    document.getElementById('coord-box').textContent = `üìç ${coords.lat}, ${coords.lng}`;
    document.getElementById('coord-box').classList.add('show');
    stopPick();
    abrirModalOp();
  });
}

function renderMapa() {
  if (!markerLayer) return;
  markerLayer.clearLayers();
  Object.values(ops).forEach(op => {
    if (!op.coords) return;
    const t    = TIPOS[op.tipo] || TIPOS.otro;
    const icon = L.divIcon({
      html: `<div class="cmark"><div class="cmark-body cmark-n${op.nivel}"><span>${t.emoji}</span></div></div>`,
      className: '', iconSize: [34,40], iconAnchor: [17,40], popupAnchor: [0,-42]
    });
    const m = L.marker([op.coords.lat, op.coords.lng], { icon }).addTo(markerLayer);
    m.bindPopup(`<div class="pop-inner">
      <div class="pop-name">${op.nombre}</div>
      <div class="pop-meta">${t.emoji} ${t.label} ¬∑ ${op.loc||''}</div>
      <div style="margin-bottom:10px"><span class="nivel-pill pill-${op.nivel}">N${op.nivel} ${NIVEL_LABELS[op.nivel]}</span></div>
      <button class="pop-btn" onclick="abrirDetalle('${op.id}');map && map.closePopup && map.closePopup()">Ver operaci√≥n ‚Üí</button>
    </div>`, { maxWidth: 260 });
  });
}

// ‚îÄ‚îÄ CONTADORES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function actualizarContadores() {
  [1,2,3,4].forEach(n => {
    const el = document.getElementById('cnt'+n);
    if (el) el.textContent = Object.values(ops).filter(o => o.nivel == n).length;
  });
}

// ‚îÄ‚îÄ RENDER SIDEBAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSidebar() {
  const list  = document.getElementById('ops-list');
  const empty = document.getElementById('empty-msg');
  list.querySelectorAll('.op-card').forEach(c => c.remove());

  let visible = Object.values(ops);
  if (filtro !== 'all') visible = visible.filter(o => String(o.nivel) === filtro);
  visible.sort((a,b) => a.nivel - b.nivel);

  if (!visible.length) { empty.classList.add('show'); return; }
  empty.classList.remove('show');

  visible.forEach(op => {
    const t    = TIPOS[op.tipo] || TIPOS.otro;
    const card = document.createElement('div');
    card.className = 'op-card' + (selOpId === op.id ? ' sel' : '');
    card.dataset.nivel = op.nivel;
    card.innerHTML = `
      <div class="card-top">
        <div>
          <div class="card-id">${op.id.substring(0,8).toUpperCase()}</div>
          <div class="card-name">${op.nombre}</div>
        </div>
        <span class="card-type-tag" style="color:${t.color};border-color:${t.color}30;background:${t.color}12">${t.emoji} ${t.label}</span>
      </div>
      <div class="card-meta">
        <span class="card-loc">üìç ${op.loc||'Sin ubicaci√≥n'}</span>
        <span class="nivel-pill pill-${op.nivel}">N${op.nivel} ${NIVEL_LABELS[op.nivel]}</span>
      </div>`;
    card.addEventListener('click', () => abrirDetalle(op.id));
    list.appendChild(card);
  });
}

// ‚îÄ‚îÄ FILTRO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.setFiltro = (f, btn) => {
  filtro = f;
  document.querySelectorAll('.ftab').forEach(b => b.classList.remove('on','on-n1','on-n2','on-n3','on-n4'));
  btn.classList.add(f === 'all' ? 'on' : `on-n${f}`);
  renderSidebar();
};

// ‚îÄ‚îÄ DETALLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.abrirDetalle = (id) => {
  selOpId = id;
  const op = ops[id];
  if (!op) return;
  document.getElementById('detail-panel').classList.add('open');
  renderDetalle(op);
  renderSidebar();
  if (op.coords) map.flyTo([op.coords.lat, op.coords.lng], 13, { duration: 1 });
  // suscribir acciones
  suscribirAcciones(id);
};

window.cerrarDetalle = () => {
  document.getElementById('detail-panel').classList.remove('open');
  selOpId = null;
  if (unsubAcciones) { unsubAcciones(); unsubAcciones = null; }
  renderSidebar();
};

function suscribirAcciones(opId) {
  if (unsubAcciones) unsubAcciones();
  const q = query(collection(db, 'operaciones', opId, 'acciones'), orderBy('timestamp', 'desc'));
  unsubAcciones = onSnapshot(q, snap => {
    const acciones = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderTimeline(acciones, ops[opId]);
  });
}

function renderDetalle(op) {
  const t          = TIPOS[op.tipo] || TIPOS.otro;
  const isAdmin    = currentRole === 'admin' || currentRole === 'super_admin';
  const isSA       = currentRole === 'super_admin';

  document.getElementById('dp-id').textContent   = op.id.substring(0,8).toUpperCase();
  document.getElementById('dp-name').textContent = op.nombre;
  document.getElementById('dp-loc').innerHTML    = op.loc ? `üìç ${op.loc}` : '';
  document.getElementById('dp-type-tag').innerHTML =
    `<span class="card-type-tag" style="color:${t.color};border-color:${t.color}30;background:${t.color}12">${t.emoji} ${t.label}</span>`;

  document.querySelectorAll('.nsel-opt').forEach(b => {
    b.classList.toggle('on', parseInt(b.dataset.n) === op.nivel);
    b.disabled = !isAdmin;
  });

  // info
  const ir = document.getElementById('dp-info-row');
  ir.innerHTML = '';
  if (op.dir) { ir.innerHTML += `<div class="dp-info-item"><strong>${op.dir}</strong>Director Operaciones</div>`; }
  if (op.org) { ir.innerHTML += `<div class="dp-info-item"><strong>${op.org}</strong>Organismos</div>`; }
  const ts = op.creadoEn?.toDate ? op.creadoEn.toDate().toLocaleString('es-ES',{day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit'}) : '‚Äî';
  ir.innerHTML += `<div class="dp-info-item"><strong>${ts}</strong>Inicio</div>`;

  // botones admin
  document.getElementById('dp-admin-btns').style.display = isSA ? 'flex' : 'none';
}

function renderTimeline(acciones, op) {
  const tl = document.getElementById('dp-timeline');
  const t  = op ? (TIPOS[op.tipo] || TIPOS.otro) : TIPOS.otro;
  const nivel = op ? op.nivel : 1;
  if (!acciones.length) {
    tl.innerHTML = '<div class="tl-empty">// Sin novedades registradas //</div>';
    return;
  }
  tl.innerHTML = acciones.map(a => {
    const ts = a.timestamp?.toDate ? a.timestamp.toDate().toLocaleString('es-ES',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : a.ts || '‚Äî';
    return `<div class="tl-entry">
      <div class="tl-node tl-node-${nivel}">${t.emoji}</div>
      <div class="tl-body">
        <div class="tl-meta">
          <span class="tl-ts">${ts}</span>
          <span class="tl-prio prio-${a.prioridad}">${a.prioridad}</span>
        </div>
        <div class="tl-text">${a.texto}</div>
        ${a.autor ? `<div class="tl-author">‚Äî ${a.autor}</div>` : ''}
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ CAMBIAR NIVEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.cambiarNivel = async (n) => {
  if (!selOpId) return;
  await updateDoc(doc(db, 'operaciones', selOpId), { nivel: n, actualizadoEn: serverTimestamp() });
};

// ‚îÄ‚îÄ A√ëADIR ACCI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addAccion = async () => {
  if (!selOpId) return;
  const texto = document.getElementById('a-texto').value.trim();
  if (!texto) { document.getElementById('a-texto').focus(); return; }
  const btn = document.getElementById('btn-reg-accion');
  btn.disabled = true;
  try {
    await addDoc(collection(db, 'operaciones', selOpId, 'acciones'), {
      texto,
      prioridad: document.getElementById('a-prio').value,
      autor:     document.getElementById('a-autor').value.trim() || currentUserDoc.nombre,
      uid:       currentUser.uid,
      timestamp: serverTimestamp()
    });
    await updateDoc(doc(db, 'operaciones', selOpId), { actualizadoEn: serverTimestamp() });
    document.getElementById('a-texto').value = '';
  } catch(e) { alert('Error al registrar: '+e.message); }
  btn.disabled = false;
};

// ‚îÄ‚îÄ BORRAR OPERACI√ìN (super_admin) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.borrarOp = async () => {
  if (!selOpId) return;
  if (!confirm('¬øBorrar esta operaci√≥n? Esta acci√≥n no se puede deshacer.')) return;
  await deleteDoc(doc(db, 'operaciones', selOpId));
  cerrarDetalle();
};

// ‚îÄ‚îÄ MODAL NUEVA OPERACI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.abrirModalOp = () => {
  document.getElementById('overlay-op').classList.add('open');
  document.getElementById('f-nombre').focus();
  if (coords) {
    document.getElementById('coord-box').textContent = `üìç ${coords.lat}, ${coords.lng}`;
    document.getElementById('coord-box').classList.add('show');
  }
};
window.cerrarModalOp = () => {
  document.getElementById('overlay-op').classList.remove('open');
  coords = null;
  document.getElementById('coord-box').classList.remove('show');
  ['f-nombre','f-desc','f-loc','f-dir','f-org'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('f-tipo').value = 'inundacion';
  document.getElementById('f-nivel').value = '3';
};

window.iniciarPick = () => {
  picking = true;
  document.getElementById('overlay-op').classList.remove('open');
  document.getElementById('pick-banner').classList.add('on');
  map.getContainer().style.cursor = 'crosshair';
  showSection('operaciones');
};
function stopPick() {
  picking = false;
  document.getElementById('pick-banner').classList.remove('on');
  map.getContainer().style.cursor = '';
}

window.crearOp = async () => {
  const nombre = document.getElementById('f-nombre').value.trim();
  if (!nombre) { document.getElementById('f-nombre').focus(); return; }
  const btn = document.getElementById('btn-crear-op');
  btn.disabled = true; btn.textContent = 'Creando‚Ä¶';
  try {
    const nivel = parseInt(document.getElementById('f-nivel').value);
    const desc  = document.getElementById('f-desc').value.trim();
    const ref   = await addDoc(collection(db, 'operaciones'), {
      nombre,
      tipo:         document.getElementById('f-tipo').value,
      nivel,
      loc:          document.getElementById('f-loc').value.trim(),
      dir:          document.getElementById('f-dir').value.trim(),
      org:          document.getElementById('f-org').value.trim(),
      coords:       coords || null,
      creadoPor:    currentUser.uid,
      creadoEn:     serverTimestamp(),
      actualizadoEn:serverTimestamp()
    });
    if (desc) {
      await addDoc(collection(db, 'operaciones', ref.id, 'acciones'), {
        texto:     desc,
        prioridad: nivel <= 2 ? 'Cr√≠tica' : nivel === 3 ? 'Alta' : 'Media',
        autor:     currentUserDoc.nombre || currentUser.email,
        uid:       currentUser.uid,
        timestamp: serverTimestamp()
      });
    }
    cerrarModalOp();
    abrirDetalle(ref.id);
  } catch(e) { alert('Error: '+e.message); }
  btn.disabled = false; btn.textContent = 'Crear operaci√≥n ‚Üí';
};

// ‚îÄ‚îÄ GESTI√ìN DE USUARIOS (super_admin) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.showSection = (sec) => {
  document.querySelectorAll('.nav-item').forEach(b => b.classList.toggle('on', b.dataset.sec === sec));
  document.getElementById('section-operaciones').style.display = sec === 'operaciones' ? 'flex' : 'none';
  document.getElementById('section-usuarios').style.display    = sec === 'usuarios'    ? 'flex' : 'none';
  if (sec === 'usuarios') cargarUsuarios();
  if (sec === 'operaciones' && map) setTimeout(() => map.invalidateSize(), 100);
};

async function cargarUsuarios() {
  const snap  = await getDocs(collection(db, 'users'));
  const tbody = document.getElementById('users-tbody');
  tbody.innerHTML = '';
  snap.forEach(d => {
    const u   = d.data();
    const tr  = document.createElement('tr');
    tr.innerHTML = `
      <td>${u.nombre||'‚Äî'}</td>
      <td>${u.email}</td>
      <td><span class="rol-badge rol-${u.role}">${ROL_LABELS[u.role]||u.role}</span></td>
      <td><span class="activo-badge ${u.activo!==false?'activo':'inactivo'}">${u.activo!==false?'Activo':'Inactivo'}</span></td>
      <td>
        <button class="tbl-btn" onclick="editarUsuario('${d.id}')">Editar</button>
        ${d.id !== currentUser.uid ? `<button class="tbl-btn danger" onclick="borrarUsuario('${d.id}')">Borrar</button>` : '<span style="font-size:11px;color:var(--text-4)">(t√∫)</span>'}
      </td>`;
    tbody.appendChild(tr);
  });
}

window.abrirModalUsuario = () => {
  editingUserId = null;
  document.getElementById('modal-user-title').textContent = 'Nuevo usuario';
  ['u-nombre','u-email','u-pass'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('u-role').value  = 'usuario';
  document.getElementById('u-activo').value = 'true';
  document.getElementById('u-pass-row').style.display = 'flex';
  document.getElementById('overlay-user').classList.add('open');
  document.getElementById('u-nombre').focus();
};

window.editarUsuario = async (uid) => {
  const snap = await getDoc(doc(db, 'users', uid));
  if (!snap.exists()) return;
  const u = snap.data();
  editingUserId = uid;
  document.getElementById('modal-user-title').textContent = 'Editar usuario';
  document.getElementById('u-nombre').value  = u.nombre || '';
  document.getElementById('u-email').value   = u.email  || '';
  document.getElementById('u-role').value    = u.role   || 'usuario';
  document.getElementById('u-activo').value  = u.activo === false ? 'false' : 'true';
  document.getElementById('u-pass-row').style.display = 'none'; // no cambiar pass aqu√≠
  document.getElementById('overlay-user').classList.add('open');
};

window.cerrarModalUsuario = () => {
  document.getElementById('overlay-user').classList.remove('open');
  editingUserId = null;
};

window.guardarUsuario = async () => {
  const nombre = document.getElementById('u-nombre').value.trim();
  const email  = document.getElementById('u-email').value.trim();
  const pass   = document.getElementById('u-pass').value;
  const role   = document.getElementById('u-role').value;
  const activo = document.getElementById('u-activo').value === 'true';

  if (!nombre || !email) { alert('Nombre y email son obligatorios.'); return; }
  const btn = document.getElementById('btn-guardar-user');
  btn.disabled = true; btn.textContent = 'Guardando‚Ä¶';

  try {
    if (editingUserId) {
      // Solo actualiza datos en Firestore (no cambia contrase√±a aqu√≠ ‚Äî requerir√≠a Admin SDK)
      await updateDoc(doc(db, 'users', editingUserId), { nombre, role, activo });
      mostrarToast('Usuario actualizado correctamente.');
    } else {
      // Crear usuario nuevo via Auth REST API
      const res = await fetch(
        `https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=AIzaSyAHtrxaBazArqa8znWsUIVYxTsS7zoOOmc`,
        { method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ email, password: pass, returnSecureToken: true }) }
      );
      const data = await res.json();
      if (data.error) throw new Error(data.error.message);
      await setDoc(doc(db, 'users', data.localId), {
        nombre, email, role, activo,
        creadoPor:  currentUser.uid,
        creadoEn:   serverTimestamp()
      });
      mostrarToast('Usuario creado correctamente.');
    }
    cerrarModalUsuario();
    cargarUsuarios();
  } catch(e) { alert('Error: '+e.message); }
  btn.disabled = false; btn.textContent = 'Guardar';
};

window.borrarUsuario = async (uid) => {
  if (!confirm('¬øEliminar este usuario de Firestore? No podr√° acceder.')) return;
  // Desactivar en lugar de borrar Auth (requiere Admin SDK para borrar Auth)
  await updateDoc(doc(db, 'users', uid), { activo: false });
  mostrarToast('Usuario desactivado.');
  cargarUsuarios();
};

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mostrarToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// ‚îÄ‚îÄ HELPERS UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mostrarLogin() {
  document.getElementById('screen-login').style.display = 'flex';
  document.getElementById('screen-app').style.display   = 'none';
}
function mostrarApp() {
  document.getElementById('screen-login').style.display = 'none';
  document.getElementById('screen-app').style.display   = 'flex';
}
function mostrarError(ctx, msg) {
  const el = document.getElementById(`err-${ctx}`);
  if (el) { el.textContent = msg; el.style.display = 'block'; }
}

// Enter en login
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('l-pass')?.addEventListener('keydown', e => {
    if (e.key === 'Enter') window.doLogin();
  });
  document.getElementById('l-email')?.addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('l-pass').focus();
  });
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    window.cerrarModalOp && cerrarModalOp();
    window.cerrarDetalle && cerrarDetalle();
    window.cerrarModalUsuario && cerrarModalUsuario();
    if (picking) stopPick();
  }
});

</script>

<style>
  :root {
    --bg:#f4f2ee; --bg-1:#ffffff; --bg-2:#f9f8f5; --bg-3:#eeece7; --bg-4:#e5e2da;
    --text-1:#1a1814; --text-2:#5c5848; --text-3:#9c9486; --text-4:#c8c0b2;
    --border:rgba(0,0,0,0.08); --border-mid:rgba(0,0,0,0.14); --border-dark:rgba(0,0,0,0.22);
    --crit-1:#c0392b; --crit-1-bg:#fdf1f0; --crit-1-border:#e8b4b0;
    --crit-2:#d35400; --crit-2-bg:#fef5ee; --crit-2-border:#f0c8a0;
    --crit-3:#c08c00; --crit-3-bg:#fefbee; --crit-3-border:#eadb94;
    --crit-4:#1a7a4a; --crit-4-bg:#f0faf4; --crit-4-border:#a8d8bc;
    --accent:#1a3a6e; --accent-lt:#eaf0fb;
    --shadow-sm:0 1px 4px rgba(0,0,0,0.08);
    --shadow-md:0 4px 16px rgba(0,0,0,0.10);
    --shadow-lg:0 8px 32px rgba(0,0,0,0.14);
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'IBM Plex Sans',sans-serif;background:var(--bg);color:var(--text-1);height:100vh;overflow:hidden;display:flex;flex-direction:column;font-size:14px;}

  /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
  #screen-login{
    display:flex; align-items:center; justify-content:center;
    height:100vh; background:var(--bg);
  }
  .login-card{
    background:var(--bg-1); border:1px solid var(--border-dark);
    border-radius:4px; padding:40px 40px 36px;
    width:380px; box-shadow:var(--shadow-lg);
    display:flex; flex-direction:column; gap:20px;
  }
  .login-logo{display:flex;align-items:center;gap:12px;margin-bottom:4px;}
  .login-icon{width:40px;height:40px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px;border-radius:2px;}
  .login-title{font-family:'Fraunces',serif;font-size:22px;font-weight:700;color:var(--accent);}
  .login-sub{font-size:10px;font-weight:600;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-3);}
  .login-field{display:flex;flex-direction:column;gap:5px;}
  .login-lbl{font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-3);}
  .login-input{background:var(--bg-2);border:1px solid var(--border-mid);color:var(--text-1);padding:9px 12px;font-family:'IBM Plex Sans',sans-serif;font-size:14px;outline:none;border-radius:2px;transition:border-color 0.12s;}
  .login-input:focus{border-color:var(--accent);}
  .btn-login{padding:11px;background:var(--accent);border:none;color:#fff;cursor:pointer;font-family:'IBM Plex Sans',sans-serif;font-size:14px;font-weight:600;border-radius:2px;transition:background 0.12s;}
  .btn-login:hover{background:#253d6e;}
  .btn-login:disabled{background:var(--text-4);cursor:not-allowed;}
  .login-err{font-size:12px;color:var(--crit-1);background:var(--crit-1-bg);border:1px solid var(--crit-1-border);padding:8px 12px;border-radius:2px;display:none;}

  /* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
  #screen-app{display:flex;flex-direction:column;height:100vh;overflow:hidden;}

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header{height:54px;background:var(--bg-1);border-bottom:1px solid var(--border-mid);display:flex;align-items:center;padding:0 18px;gap:16px;flex-shrink:0;box-shadow:var(--shadow-sm);z-index:200;}
  .logo-mark{display:flex;align-items:center;gap:9px;flex-shrink:0;}
  .logo-icon{width:30px;height:30px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#fff;font-size:15px;border-radius:2px;}
  .logo-text{font-family:'Fraunces',serif;font-size:17px;font-weight:700;color:var(--accent);}
  .logo-sub{font-size:8px;font-weight:600;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-3);}
  .hdr-div{width:1px;height:26px;background:var(--border-mid);flex-shrink:0;}
  .nivel-indicators{display:flex;gap:5px;}
  .nivel-chip{display:flex;align-items:center;gap:5px;padding:3px 9px;border-radius:2px;border:1px solid;}
  .nivel-chip-val{font-family:'IBM Plex Mono',monospace;font-size:14px;font-weight:500;}
  .nivel-chip-lbl{font-size:8px;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;}
  .chip-n1{background:var(--crit-1-bg);border-color:var(--crit-1-border);color:var(--crit-1);}
  .chip-n2{background:var(--crit-2-bg);border-color:var(--crit-2-border);color:var(--crit-2);}
  .chip-n3{background:var(--crit-3-bg);border-color:var(--crit-3-border);color:var(--crit-3);}
  .chip-n4{background:var(--crit-4-bg);border-color:var(--crit-4-border);color:var(--crit-4);}
  .hdr-right{display:flex;align-items:center;gap:10px;margin-left:auto;flex-shrink:0;}
  .hdr-user-info{text-align:right;}
  .hdr-user-name{font-size:13px;font-weight:600;color:var(--text-1);}
  .hdr-user-role{font-size:10px;color:var(--text-3);letter-spacing:0.04em;}
  .live-dot{width:7px;height:7px;border-radius:50%;background:#27ae60;box-shadow:0 0 0 2px rgba(39,174,96,0.25);animation:livepulse 2.5s infinite;}
  @keyframes livepulse{0%,100%{box-shadow:0 0 0 2px rgba(39,174,96,0.25)}50%{box-shadow:0 0 0 5px rgba(39,174,96,0.1)}}
  .clock{font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--text-2);}
  .btn-nueva{display:flex;align-items:center;gap:6px;background:var(--accent);color:#fff;border:none;cursor:pointer;padding:7px 14px;font-family:'IBM Plex Sans',sans-serif;font-size:12px;font-weight:600;border-radius:2px;transition:background 0.12s;white-space:nowrap;}
  .btn-nueva:hover{background:#253d6e;}
  .btn-logout{padding:6px 12px;background:transparent;border:1px solid var(--border-mid);color:var(--text-3);cursor:pointer;font-family:'IBM Plex Sans',sans-serif;font-size:11px;border-radius:2px;transition:all 0.12s;}
  .btn-logout:hover{border-color:var(--border-dark);color:var(--text-1);}

  /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
  .app-nav{display:flex;gap:0;border-bottom:1px solid var(--border-mid);background:var(--bg-1);flex-shrink:0;padding:0 18px;}
  .nav-item{display:flex;align-items:center;gap:6px;padding:10px 16px;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--text-3);cursor:pointer;font-family:'IBM Plex Sans',sans-serif;font-size:13px;font-weight:500;transition:all 0.12s;margin-bottom:-1px;}
  .nav-item:hover{color:var(--text-1);}
  .nav-item.on{color:var(--accent);border-bottom-color:var(--accent);font-weight:600;}

  /* ‚îÄ‚îÄ SECTIONS ‚îÄ‚îÄ */
  #section-operaciones{flex:1;overflow:hidden;display:flex;}
  #section-usuarios{flex:1;overflow:hidden;display:none;flex-direction:column;padding:24px;gap:16px;background:var(--bg);}

  /* ‚îÄ‚îÄ PANEL IZQUIERDO ‚îÄ‚îÄ */
  .panel-left{width:320px;flex-shrink:0;display:flex;flex-direction:column;background:var(--bg-1);border-right:1px solid var(--border-mid);}
  .panel-left-head{padding:12px 14px 10px;border-bottom:1px solid var(--border);flex-shrink:0;}
  .section-label{font-size:9px;font-weight:600;letter-spacing:0.14em;text-transform:uppercase;color:var(--text-3);margin-bottom:8px;}
  .filter-tabs{display:flex;border:1px solid var(--border-mid);border-radius:2px;overflow:hidden;}
  .ftab{flex:1;padding:5px 4px;background:var(--bg-2);border:none;border-right:1px solid var(--border);color:var(--text-3);cursor:pointer;font-family:'IBM Plex Sans',sans-serif;font-size:11px;font-weight:600;transition:all 0.12s;}
  .ftab:last-child{border-right:none;}
  .ftab.on{background:var(--bg-1);color:var(--text-1);}
  .ftab.on-n1{background:var(--crit-1-bg);color:var(--crit-1);}
  .ftab.on-n2{background:var(--crit-2-bg);color:var(--crit-2);}
  .ftab.on-n3{background:var(--crit-3-bg);color:var(--crit-3);}
  .ftab.on-n4{background:var(--crit-4-bg);color:var(--crit-4);}
  .ops-list{flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:5px;}
  .ops-list::-webkit-scrollbar{width:3px;}
  .ops-list::-webkit-scrollbar-thumb{background:var(--bg-4);}
  .empty-msg{display:none;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;gap:8px;color:var(--text-4);text-align:center;font-size:12px;}
  .empty-msg.show{display:flex;}

  .op-card{background:var(--bg-1);border:1px solid var(--border-mid);border-left:4px solid transparent;padding:10px 12px;cursor:pointer;transition:all 0.12s;border-radius:0 2px 2px 0;box-shadow:var(--shadow-sm);}
  .op-card:hover{box-shadow:var(--shadow-md);}
  .op-card.sel{background:var(--accent-lt);}
  .op-card[data-nivel="1"]{border-left-color:var(--crit-1);}
  .op-card[data-nivel="2"]{border-left-color:var(--crit-2);}
  .op-card[data-nivel="3"]{border-left-color:var(--crit-3);}
  .op-card[data-nivel="4"]{border-left-color:var(--crit-4);}
  .card-top{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:5px;}
  .card-id{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--text-3);margin-bottom:2px;}
  .card-name{font-size:13px;font-weight:600;line-height:1.2;}
  .card-type-tag{font-size:10px;font-weight:600;padding:2px 6px;border-radius:10px;white-space:nowrap;flex-shrink:0;border:1px solid;}
  .card-meta{display:flex;align-items:center;justify-content:space-between;font-size:11px;color:var(--text-3);}
  .nivel-pill{font-size:9px;font-weight:700;letter-spacing:0.04em;text-transform:uppercase;padding:2px 6px;border-radius:2px;border:1px solid;}
  .pill-1{background:var(--crit-1-bg);color:var(--crit-1);border-color:var(--crit-1-border);}
  .pill-2{background:var(--crit-2-bg);color:var(--crit-2);border-color:var(--crit-2-border);}
  .pill-3{background:var(--crit-3-bg);color:var(--crit-3);border-color:var(--crit-3-border);}
  .pill-4{background:var(--crit-4-bg);color:var(--crit-4);border-color:var(--crit-4-border);}

  /* ‚îÄ‚îÄ MAP ‚îÄ‚îÄ */
  .map-zone{flex:1;position:relative;overflow:hidden;}
  #map{width:100%;height:100%;}
  .pick-banner{display:none;position:absolute;top:14px;left:50%;transform:translateX(-50%);background:var(--accent);color:#fff;font-size:13px;font-weight:600;padding:9px 20px;z-index:600;border-radius:2px;box-shadow:var(--shadow-lg);pointer-events:none;animation:blinkS 1.4s infinite;}
  @keyframes blinkS{0%,100%{opacity:1}50%{opacity:0.7}}
  .pick-banner.on{display:block;}

  /* ‚îÄ‚îÄ DETAIL PANEL ‚îÄ‚îÄ */
  .detail-panel{position:absolute;top:12px;right:12px;width:370px;max-height:calc(100vh - 130px);background:var(--bg-1);border:1px solid var(--border-dark);border-radius:2px;box-shadow:var(--shadow-lg);display:none;flex-direction:column;z-index:500;}
  .detail-panel.open{display:flex;animation:panelIn 0.18s ease;}
  @keyframes panelIn{from{opacity:0;transform:translateX(14px)}to{opacity:1;transform:none}}
  .dp-header{padding:14px 16px 10px;border-bottom:1px solid var(--border);flex-shrink:0;}
  .dp-top-row{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:8px;}
  .dp-id{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--text-3);margin-bottom:2px;}
  .dp-name{font-family:'Fraunces',serif;font-size:18px;font-weight:700;line-height:1.1;}
  .btn-close-dp{background:var(--bg-3);border:1px solid var(--border-mid);color:var(--text-3);cursor:pointer;width:26px;height:26px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;border-radius:2px;transition:all 0.12s;}
  .btn-close-dp:hover{background:var(--bg-4);color:var(--text-1);}
  .dp-chips{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
  .dp-loc{font-size:12px;color:var(--text-2);font-weight:500;}
  .nivel-selector{display:flex;border:1px solid var(--border-mid);border-radius:2px;overflow:hidden;}
  .nsel-opt{padding:4px 8px;font-size:9px;font-weight:700;letter-spacing:0.04em;text-transform:uppercase;cursor:pointer;background:var(--bg-2);border:none;border-right:1px solid var(--border);color:var(--text-3);font-family:'IBM Plex Sans',sans-serif;transition:all 0.1s;}
  .nsel-opt:last-child{border-right:none;}
  .nsel-opt:disabled{cursor:not-allowed;opacity:0.5;}
  .nsel-opt[data-n="1"].on{background:var(--crit-1-bg);color:var(--crit-1);}
  .nsel-opt[data-n="2"].on{background:var(--crit-2-bg);color:var(--crit-2);}
  .nsel-opt[data-n="3"].on{background:var(--crit-3-bg);color:var(--crit-3);}
  .nsel-opt[data-n="4"].on{background:var(--crit-4-bg);color:var(--crit-4);}
  .dp-info-row{padding:8px 16px;border-bottom:1px solid var(--border);flex-shrink:0;display:flex;gap:16px;flex-wrap:wrap;}
  .dp-info-item{font-size:10px;color:var(--text-3);}
  .dp-info-item strong{display:block;font-size:11px;color:var(--text-2);font-weight:500;}
  .dp-timeline{flex:1;overflow-y:auto;padding:12px 16px;}
  .dp-timeline::-webkit-scrollbar{width:3px;}
  .dp-timeline::-webkit-scrollbar-thumb{background:var(--bg-4);}
  .tl-empty{text-align:center;padding:24px 0;color:var(--text-4);font-size:11px;font-family:'IBM Plex Mono',monospace;}
  .tl-entry{display:flex;gap:10px;position:relative;padding-bottom:14px;animation:entryIn 0.2s ease;}
  @keyframes entryIn{from{opacity:0;transform:translateY(5px)}to{opacity:1}}
  .tl-entry:not(:last-child)::before{content:'';position:absolute;left:11px;top:22px;bottom:0;width:1px;background:var(--border-mid);}
  .tl-node{width:22px;height:22px;border-radius:50%;flex-shrink:0;border:2px solid var(--border-dark);background:var(--bg-1);display:flex;align-items:center;justify-content:center;font-size:9px;z-index:1;position:relative;}
  .tl-node-1{border-color:var(--crit-1);background:var(--crit-1-bg);}
  .tl-node-2{border-color:var(--crit-2);background:var(--crit-2-bg);}
  .tl-node-3{border-color:var(--crit-3);background:var(--crit-3-bg);}
  .tl-node-4{border-color:var(--crit-4);background:var(--crit-4-bg);}
  .tl-body{flex:1;}
  .tl-meta{display:flex;align-items:center;gap:6px;margin-bottom:3px;}
  .tl-ts{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--text-4);}
  .tl-prio{font-size:9px;font-weight:700;padding:1px 5px;border-radius:10px;}
  .prio-Cr√≠tica{background:var(--crit-1-bg);color:var(--crit-1);}
  .prio-Alta{background:var(--crit-2-bg);color:var(--crit-2);}
  .prio-Media{background:var(--crit-3-bg);color:var(--crit-3);}
  .prio-Baja{background:var(--crit-4-bg);color:var(--crit-4);}
  .tl-text{font-size:12px;line-height:1.5;}
  .tl-author{font-size:10px;color:var(--text-3);margin-top:2px;font-style:italic;}
  .dp-addaction{padding:10px 16px 14px;border-top:1px solid var(--border-mid);flex-shrink:0;background:var(--bg-2);}
  .dp-admin-btns{display:none;gap:6px;padding:8px 16px;border-top:1px solid var(--border);flex-shrink:0;}
  .btn-danger{padding:6px 12px;background:var(--crit-1-bg);border:1px solid var(--crit-1-border);color:var(--crit-1);cursor:pointer;font-family:'IBM Plex Sans',sans-serif;font-size:11px;font-weight:600;border-radius:2px;}
  .btn-danger:hover{background:var(--crit-1);color:#fff;}

  /* ‚îÄ‚îÄ FORM INPUTS ‚îÄ‚îÄ */
  .f-input{background:var(--bg-1);border:1px solid var(--border-mid);color:var(--text-1);padding:7px 10px;font-family:'IBM Plex Sans',sans-serif;font-size:12px;outline:none;border-radius:2px;transition:border-color 0.12s;width:100%;}
  .f-input:focus{border-color:var(--accent);}
  .f-input::placeholder{color:var(--text-4);}
  .f-select{background:var(--bg-1);border:1px solid var(--border-mid);color:var(--text-2);padding:7px 8px;font-family:'IBM Plex Sans',sans-serif;font-size:12px;outline:none;cursor:pointer;border-radius:2px;flex-shrink:0;}
  .form-row{display:flex;gap:6px;margin-bottom:6px;}
  .btn-reg{width:100%;padding:8px;background:var(--accent);border:none;color:#fff;cursor:pointer;font-family:'IBM Plex Sans',sans-serif;font-size:12px;font-weight:600;border-radius:2px;transition:background 0.12s;margin-top:4px;}
  .btn-reg:hover{background:#253d6e;}
  .btn-reg:disabled{background:var(--text-4);cursor:not-allowed;}
  .coord-box{font-family:'IBM Plex Mono',monospace;font-size:11px;color:#1a7a4a;background:var(--crit-4-bg);border:1px solid var(--crit-4-border);padding:5px 10px;border-radius:2px;display:none;margin-top:4px;}
  .coord-box.show{display:block;}
  .btn-mapa{padding:7px 11px;background:var(--accent-lt);border:1px solid #c0cfe8;color:var(--accent);cursor:pointer;font-family:'IBM Plex Sans',sans-serif;font-size:12px;font-weight:600;border-radius:2px;white-space:nowrap;flex-shrink:0;}

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .overlay{display:none;position:fixed;inset:0;background:rgba(30,25,15,0.45);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
  .overlay.open{display:flex;animation:fadeO 0.15s ease;}
  @keyframes fadeO{from{opacity:0}to{opacity:1}}
  .modal{background:var(--bg-1);border:1px solid var(--border-dark);border-radius:3px;width:500px;max-width:96vw;box-shadow:var(--shadow-lg);animation:modalIn 0.18s ease;max-height:92vh;display:flex;flex-direction:column;overflow:hidden;}
  @keyframes modalIn{from{opacity:0;transform:translateY(-14px)}to{opacity:1;transform:none}}
  .modal-head{padding:18px 20px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
  .modal-title{font-family:'Fraunces',serif;font-size:18px;font-weight:700;}
  .modal-body{padding:16px 20px;display:flex;flex-direction:column;gap:12px;overflow-y:auto;}
  .field{display:flex;flex-direction:column;gap:4px;}
  .field-lbl{font-size:9px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-3);}
  .field-row{display:flex;gap:10px;}
  .modal-foot{padding:12px 20px 16px;display:flex;gap:8px;justify-content:flex-end;border-top:1px solid var(--border);flex-shrink:0;}
  .btn-cancel-m{padding:8px 16px;background:var(--bg-2);border:1px solid var(--border-mid);color:var(--text-2);cursor:pointer;font-family:'IBM Plex Sans',sans-serif;font-size:12px;font-weight:500;border-radius:2px;}
  .btn-create-m{padding:8px 20px;background:var(--accent);border:none;color:#fff;cursor:pointer;font-family:'IBM Plex Sans',sans-serif;font-size:12px;font-weight:600;border-radius:2px;transition:background 0.12s;}
  .btn-create-m:hover{background:#253d6e;}
  .btn-create-m:disabled{background:var(--text-4);cursor:not-allowed;}

  /* ‚îÄ‚îÄ TABLA USUARIOS ‚îÄ‚îÄ */
  .users-toolbar{display:flex;align-items:center;justify-content:space-between;}
  .users-table-wrap{flex:1;overflow:auto;background:var(--bg-1);border:1px solid var(--border-mid);border-radius:3px;box-shadow:var(--shadow-sm);}
  table{width:100%;border-collapse:collapse;}
  thead tr{background:var(--bg-2);border-bottom:2px solid var(--border-mid);}
  th{padding:10px 14px;text-align:left;font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-3);}
  td{padding:10px 14px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:middle;}
  tr:last-child td{border-bottom:none;}
  tr:hover td{background:var(--bg-2);}
  .rol-badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;letter-spacing:0.04em;}
  .rol-super_admin{background:#e8f0fb;color:var(--accent);border:1px solid #c0cfe8;}
  .rol-admin{background:var(--crit-3-bg);color:var(--crit-3);border:1px solid var(--crit-3-border);}
  .rol-usuario{background:var(--bg-3);color:var(--text-2);border:1px solid var(--border-mid);}
  .activo-badge{font-size:10px;font-weight:600;padding:2px 7px;border-radius:10px;}
  .activo{background:var(--crit-4-bg);color:var(--crit-4);border:1px solid var(--crit-4-border);}
  .inactivo{background:var(--crit-1-bg);color:var(--crit-1);border:1px solid var(--crit-1-border);}
  .tbl-btn{padding:4px 10px;background:var(--bg-2);border:1px solid var(--border-mid);color:var(--text-2);cursor:pointer;font-family:'IBM Plex Sans',sans-serif;font-size:11px;font-weight:500;border-radius:2px;margin-right:4px;transition:all 0.1s;}
  .tbl-btn:hover{background:var(--bg-3);}
  .tbl-btn.danger{color:var(--crit-1);border-color:var(--crit-1-border);}
  .tbl-btn.danger:hover{background:var(--crit-1);color:#fff;}

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  #toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(10px);background:var(--accent);color:#fff;padding:10px 22px;border-radius:2px;font-size:13px;font-weight:500;box-shadow:var(--shadow-lg);opacity:0;transition:all 0.25s;pointer-events:none;z-index:2000;}
  #toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

  /* ‚îÄ‚îÄ MAP MARKERS ‚îÄ‚îÄ */
  .cmark{display:flex;flex-direction:column;align-items:center;}
  .cmark-body{width:34px;height:34px;border-radius:50% 50% 50% 0;transform:rotate(-45deg);display:flex;align-items:center;justify-content:center;font-size:14px;box-shadow:0 3px 10px rgba(0,0,0,0.25);border:2px solid rgba(255,255,255,0.8);}
  .cmark-body span{transform:rotate(45deg);display:block;}
  .cmark-n1{background:var(--crit-1);}
  .cmark-n2{background:var(--crit-2);}
  .cmark-n3{background:var(--crit-3);}
  .cmark-n4{background:var(--crit-4);}
  .leaflet-popup-content-wrapper{background:#fff!important;border:1px solid var(--border-dark)!important;border-radius:3px!important;box-shadow:var(--shadow-lg)!important;padding:0!important;}
  .leaflet-popup-tip{background:#fff!important;}
  .leaflet-popup-content{margin:0!important;padding:0!important;color:var(--text-1)!important;}
  .pop-inner{padding:13px 15px;min-width:200px;}
  .pop-name{font-family:'Fraunces',serif;font-size:14px;font-weight:700;margin-bottom:3px;}
  .pop-meta{font-size:11px;color:var(--text-3);margin-bottom:3px;}
  .pop-btn{display:block;width:100%;padding:7px;background:var(--accent);border:none;color:#fff;cursor:pointer;font-family:'IBM Plex Sans',sans-serif;font-size:12px;font-weight:600;text-align:center;border-radius:2px;transition:background 0.12s;}
  .pop-btn:hover{background:#253d6e;}
</style>
</head>
<body>

<!-- ‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-login">
  <div class="login-card">
    <div class="login-logo">
      <div class="login-icon">‚ö†</div>
      <div>
        <div class="login-title">SIGECA</div>
        <div class="login-sub">Gesti√≥n de Cat√°strofes</div>
      </div>
    </div>
    <div class="login-field">
      <div class="login-lbl">Email</div>
      <input class="login-input" id="l-email" type="email" placeholder="usuario@organismo.es" autocomplete="username">
    </div>
    <div class="login-field">
      <div class="login-lbl">Contrase√±a</div>
      <input class="login-input" id="l-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
    </div>
    <div class="login-err" id="err-login"></div>
    <button class="btn-login" id="btn-login" onclick="doLogin()">Acceder</button>
  </div>
</div>

<!-- ‚ïê‚ïê APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-app" style="display:none">

  <!-- HEADER -->
  <header>
    <div class="logo-mark">
      <div class="logo-icon">‚ö†</div>
      <div>
        <div class="logo-text">SIGECA</div>
        <div class="logo-sub">Gesti√≥n de Cat√°strofes</div>
      </div>
    </div>
    <div class="hdr-div"></div>
    <div class="nivel-indicators">
      <div class="nivel-chip chip-n1"><span class="nivel-chip-val" id="cnt1">0</span><span class="nivel-chip-lbl">N1</span></div>
      <div class="nivel-chip chip-n2"><span class="nivel-chip-val" id="cnt2">0</span><span class="nivel-chip-lbl">N2</span></div>
      <div class="nivel-chip chip-n3"><span class="nivel-chip-val" id="cnt3">0</span><span class="nivel-chip-lbl">N3</span></div>
      <div class="nivel-chip chip-n4"><span class="nivel-chip-val" id="cnt4">0</span><span class="nivel-chip-lbl">N4</span></div>
    </div>
    <div class="hdr-right">
      <div class="live-dot"></div>
      <div class="clock" id="clock">--:--:--</div>
      <div class="hdr-user-info">
        <div class="hdr-user-name" id="hdr-user"></div>
        <div class="hdr-user-role" id="hdr-role"></div>
      </div>
      <button id="btn-nueva-op" class="btn-nueva" onclick="abrirModalOp()">+ Nueva operaci√≥n</button>
      <button class="btn-logout" onclick="doLogout()">Salir</button>
    </div>
  </header>

  <!-- NAV -->
  <nav class="app-nav">
    <button class="nav-item on" data-sec="operaciones" onclick="showSection('operaciones')">üó∫ Operaciones</button>
    <button class="nav-item" id="nav-usuarios" data-sec="usuarios" onclick="showSection('usuarios')" style="display:none">üë• Usuarios</button>
  </nav>

  <!-- ‚îÄ‚îÄ SECCI√ìN OPERACIONES ‚îÄ‚îÄ -->
  <div id="section-operaciones">
    <div class="panel-left">
      <div class="panel-left-head">
        <div class="section-label">Operaciones activas</div>
        <div class="filter-tabs">
          <button class="ftab on" onclick="setFiltro('all',this)">Todas</button>
          <button class="ftab" onclick="setFiltro('1',this)">N1</button>
          <button class="ftab" onclick="setFiltro('2',this)">N2</button>
          <button class="ftab" onclick="setFiltro('3',this)">N3</button>
          <button class="ftab" onclick="setFiltro('4',this)">N4</button>
        </div>
      </div>
      <div class="ops-list" id="ops-list">
        <div class="empty-msg show" id="empty-msg">
          <div style="font-size:28px;opacity:0.4">üìã</div>
          <span>Sin operaciones registradas.</span>
        </div>
      </div>
    </div>

    <div class="map-zone">
      <div class="pick-banner" id="pick-banner">üìç Haz clic en el mapa para fijar la ubicaci√≥n</div>
      <div id="map"></div>

      <!-- DETAIL -->
      <div class="detail-panel" id="detail-panel">
        <div class="dp-header">
          <div class="dp-top-row">
            <div>
              <div class="dp-id" id="dp-id"></div>
              <div class="dp-name" id="dp-name"></div>
            </div>
            <button class="btn-close-dp" onclick="cerrarDetalle()">‚úï</button>
          </div>
          <div class="dp-chips">
            <div id="dp-type-tag"></div>
            <div class="dp-loc" id="dp-loc"></div>
          </div>
        </div>
        <div style="padding:8px 16px;border-bottom:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;">
          <span style="font-size:10px;color:var(--text-3);font-weight:600;text-transform:uppercase;letter-spacing:0.08em;">Nivel:</span>
          <div class="nivel-selector">
            <button class="nsel-opt" data-n="1" onclick="cambiarNivel(1)">N1</button>
            <button class="nsel-opt" data-n="2" onclick="cambiarNivel(2)">N2</button>
            <button class="nsel-opt" data-n="3" onclick="cambiarNivel(3)">N3</button>
            <button class="nsel-opt" data-n="4" onclick="cambiarNivel(4)">N4</button>
          </div>
        </div>
        <div class="dp-info-row" id="dp-info-row"></div>
        <div class="dp-timeline" id="dp-timeline"></div>
        <div class="dp-addaction">
          <div class="section-label">Registrar novedad</div>
          <div class="form-row">
            <select class="f-select" id="a-prio">
              <option value="Cr√≠tica">üî¥ Cr√≠tica</option>
              <option value="Alta">üü† Alta</option>
              <option value="Media" selected>üü° Media</option>
              <option value="Baja">üü¢ Baja</option>
            </select>
            <input class="f-input" id="a-autor" placeholder="Unidad / Cargo" style="flex:1;">
          </div>
          <textarea class="f-input" id="a-texto" placeholder="Describe la novedad, acci√≥n o decisi√≥n‚Ä¶" style="resize:vertical;min-height:58px;margin-bottom:4px;"></textarea>
          <button class="btn-reg" id="btn-reg-accion" onclick="addAccion()">Registrar novedad</button>
        </div>
        <div class="dp-admin-btns" id="dp-admin-btns">
          <button class="btn-danger" onclick="borrarOp()">üóë Borrar operaci√≥n</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ SECCI√ìN USUARIOS ‚îÄ‚îÄ -->
  <div id="section-usuarios">
    <div class="users-toolbar">
      <div>
        <div style="font-family:'Fraunces',serif;font-size:20px;font-weight:700;">Gesti√≥n de usuarios</div>
        <div style="font-size:12px;color:var(--text-3);margin-top:2px;">Solo el Super Admin puede crear, editar y desactivar usuarios.</div>
      </div>
      <button class="btn-nueva" onclick="abrirModalUsuario()">+ Nuevo usuario</button>
    </div>
    <div class="users-table-wrap">
      <table>
        <thead>
          <tr>
            <th>Nombre</th><th>Email</th><th>Rol</th><th>Estado</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody id="users-tbody"></tbody>
      </table>
    </div>
  </div>

</div><!-- /screen-app -->

<!-- ‚ïê‚ïê MODAL NUEVA OPERACI√ìN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" id="overlay-op">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title">Nueva operaci√≥n</div>
      <button class="btn-close-dp" onclick="cerrarModalOp()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="field">
        <div class="field-lbl">Nombre *</div>
        <input class="f-input" id="f-nombre" placeholder="Ej: Inundaciones Cuenca del Ebro">
      </div>
      <div class="field-row">
        <div class="field" style="flex:1;">
          <div class="field-lbl">Tipo de cat√°strofe</div>
          <select class="f-input f-select" id="f-tipo" style="width:100%">
            <option value="inundacion">üåä Inundaci√≥n / DANA</option>
            <option value="incendio">üî• Incendio forestal</option>
            <option value="seismo">üåç Se√≠smo / Terremoto</option>
            <option value="temporal">üå™ Temporal / Viento</option>
            <option value="accidente">üöõ Accidente grave</option>
            <option value="quimico">‚ò£Ô∏è Incidente qu√≠mico</option>
            <option value="sanitaria">ü¶† Emergencia sanitaria</option>
            <option value="otro">üìã Otro</option>
          </select>
        </div>
        <div class="field" style="flex:1;">
          <div class="field-lbl">Nivel de activaci√≥n</div>
          <select class="f-input f-select" id="f-nivel" style="width:100%">
            <option value="1">N1 ‚Äî Emergencia Mayor</option>
            <option value="2">N2 ‚Äî Emergencia</option>
            <option value="3" selected>N3 ‚Äî Alerta</option>
            <option value="4">N4 ‚Äî Seguimiento</option>
          </select>
        </div>
      </div>
      <div class="field">
        <div class="field-lbl">Descripci√≥n inicial</div>
        <textarea class="f-input" id="f-desc" placeholder="Situaci√≥n inicial, recursos movilizados‚Ä¶" style="resize:vertical;min-height:68px;"></textarea>
      </div>
      <div class="field-row">
        <div class="field" style="flex:1;">
          <div class="field-lbl">Provincia / Municipio</div>
          <input class="f-input" id="f-loc" placeholder="Ej: Valencia, Paiporta">
        </div>
        <div class="field" style="flex:1;">
          <div class="field-lbl">Director de Operaciones</div>
          <input class="f-input" id="f-dir" placeholder="Nombre y cargo">
        </div>
      </div>
      <div class="field">
        <div class="field-lbl">Organismos coordinados</div>
        <input class="f-input" id="f-org" placeholder="Ej: 112, UME, Cruz Roja, DGT‚Ä¶">
      </div>
      <div class="field">
        <div class="field-lbl">Ubicaci√≥n en mapa</div>
        <div style="display:flex;gap:6px;">
          <input class="f-input" id="f-coord-label" placeholder="O haz clic en el mapa ‚Üí">
          <button class="btn-mapa" onclick="iniciarPick()">üó∫ Seleccionar</button>
        </div>
        <div class="coord-box" id="coord-box"></div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn-cancel-m" onclick="cerrarModalOp()">Cancelar</button>
      <button class="btn-create-m" id="btn-crear-op" onclick="crearOp()">Crear operaci√≥n ‚Üí</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê MODAL USUARIO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" id="overlay-user">
  <div class="modal" style="width:420px;">
    <div class="modal-head">
      <div class="modal-title" id="modal-user-title">Nuevo usuario</div>
      <button class="btn-close-dp" onclick="cerrarModalUsuario()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="field">
        <div class="field-lbl">Nombre completo *</div>
        <input class="f-input" id="u-nombre" placeholder="Nombre y apellidos">
      </div>
      <div class="field">
        <div class="field-lbl">Email *</div>
        <input class="f-input" id="u-email" type="email" placeholder="usuario@organismo.es">
      </div>
      <div class="field" id="u-pass-row">
        <div class="field-lbl">Contrase√±a inicial *</div>
        <input class="f-input" id="u-pass" type="password" placeholder="M√≠nimo 6 caracteres">
      </div>
      <div class="field-row">
        <div class="field" style="flex:1;">
          <div class="field-lbl">Rol</div>
          <select class="f-input f-select" id="u-role" style="width:100%">
            <option value="usuario">Usuario</option>
            <option value="admin">Administrador</option>
            <option value="super_admin">Super Admin</option>
          </select>
        </div>
        <div class="field" style="flex:1;">
          <div class="field-lbl">Estado</div>
          <select class="f-input f-select" id="u-activo" style="width:100%">
            <option value="true">Activo</option>
            <option value="false">Inactivo</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn-cancel-m" onclick="cerrarModalUsuario()">Cancelar</button>
      <button class="btn-create-m" id="btn-guardar-user" onclick="guardarUsuario()">Guardar</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
  // Reloj
  setInterval(() => {
    const el = document.getElementById('clock');
    if (el) el.textContent = new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  }, 1000);
</script>

</body>
</html>
